<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuConnect CRM - Phase 2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --text-dark: #1f2937; --text-gray: #6b7280; --bg-light: #f9fafb;
            --border: #e5e7eb; --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 6px rgba(0,0,0,0.1); --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
        }
        body { font-family: 'Inter', sans-serif; background: var(--gradient); min-height: 100vh; color: var(--text-dark); }
        .hidden { display: none !important; }
        
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: var(--white); padding: 60px 50px; border-radius: 24px; box-shadow: var(--shadow-lg); max-width: 450px; width: 100%; }
        .logo { font-size: 48px; text-align: center; margin-bottom: 10px; }
        .login-card h1 { color: var(--primary); font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .login-card p { color: var(--text-gray); text-align: center; margin-bottom: 40px; }
        
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 15px; color: var(--text-dark); }
        .form-group select, .form-group input, .form-group textarea { 
            width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; 
            font-size: 16px; font-family: inherit; background: var(--white); color: var(--text-dark);
        }
        .form-group select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; padding-right: 44px; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--gradient); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-small { padding: 10px 18px; font-size: 14px; }
        .btn-icon { padding: 8px 12px; font-size: 14px; border-radius: 8px; min-width: 36px; }
        .btn-full { width: 100%; }
        
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--white); box-shadow: var(--shadow-md); padding: 24px 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
        .sidebar-header h2 { color: var(--primary); font-size: 22px; font-weight: 800; margin-bottom: 4px; }
        .sidebar-nav { padding: 16px 0; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: var(--text-gray); cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 14px; }
        .nav-item:hover { background: var(--bg-light); color: var(--primary); }
        .nav-item.active { background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, transparent 100%); color: var(--primary); border-left: 4px solid var(--primary); }
        .nav-item-icon { font-size: 18px; margin-right: 12px; }
        .main-content { margin-left: 260px; flex: 1; padding: 24px; min-height: 100vh; }
        
        .top-bar { background: var(--white); padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .top-bar h1 { font-size: 24px; font-weight: 800; }
        .top-bar-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .profile-dropdown { position: relative; }
        .profile-btn { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .profile-btn:hover { background: var(--border); }
        .profile-menu { position: absolute; top: 100%; right: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); min-width: 220px; margin-top: 8px; display: none; z-index: 1000; overflow: hidden; }
        .profile-menu.active { display: block; }
        .profile-menu-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .profile-menu-item:hover { background: var(--bg-light); }
        .profile-menu-divider { height: 1px; background: var(--border); margin: 4px 0; }
        
        .search-container { position: relative; }
        .search-input { padding: 10px 16px 10px 40px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; width: 260px; font-family: inherit; }
        .search-input:focus { outline: none; border-color: var(--primary); width: 300px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 16px; color: var(--text-gray); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); margin-top: 8px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none; }
        .search-results.active { display: block; }
        .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .search-result-item:hover { background: var(--bg-light); }
        .search-result-type { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 2px; }
        .search-result-title { font-weight: 600; font-size: 14px; }
        .search-result-meta { font-size: 12px; color: var(--text-gray); }
        
        .filters-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; padding: 16px 20px; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-sm); }
        .filter-select, .filter-input { padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; font-family: inherit; }
        .filter-input { width: 200px; }
        .filter-select { min-width: 150px; }
        
        .greeting-banner { background: var(--gradient); color: white; padding: 20px 24px; border-radius: 16px; margin-bottom: 24px; }
        .greeting-text { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .greeting-sub { font-size: 14px; opacity: 0.9; }
        
        .nudge-container { margin-bottom: 24px; }
        .nudge-alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .nudge-alert.warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid var(--warning); }
        .nudge-alert.danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid var(--danger); }
        .nudge-alert.success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid var(--success); }
        .nudge-alert.info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid var(--primary); }
        .nudge-icon { font-size: 24px; }
        .nudge-text { flex: 1; font-weight: 500; font-size: 14px; }
        .nudge-dismiss { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.6; padding: 4px 8px; }
        .nudge-dismiss:hover { opacity: 1; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: var(--white); padding: 22px; border-radius: 14px; box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gradient); border-radius: 14px 0 0 14px; }
        .kpi-value { font-size: 34px; font-weight: 800; margin-bottom: 6px; }
        .kpi-label { font-size: 12px; font-weight: 600; color: var(--text-gray); text-transform: uppercase; }
        .progress-bar { width: 100%; height: 8px; background: var(--bg-light); border-radius: 8px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; border-radius: 8px; transition: width 0.5s ease; }
        
        .card { background: var(--white); padding: 24px; border-radius: 14px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .card-title { font-size: 18px; font-weight: 700; }
        
        .activity-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 14px; }
        .stat-card { text-align: center; padding: 18px 14px; background: var(--bg-light); border-radius: 12px; transition: all 0.2s; }
        .stat-card:hover { background: var(--white); box-shadow: var(--shadow-sm); }
        .stat-card.clickable { cursor: pointer; }
        .stat-card.clickable:hover { transform: translateY(-2px); }
        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 11px; color: var(--text-gray); margin-top: 4px; }
        
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-starter { background: #e5e7eb; color: #374151; }
        .badge-growth { background: #d1fae5; color: #065f46; }
        .badge-pro { background: #fef3c7; color: #92400e; }
        .badge-enterprise { background: #e0e7ff; color: #3730a3; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        .profile-card-header { background: var(--gradient); padding: 24px; color: white; }
        .profile-card-avatar { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 12px; }
        .profile-card-name { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .profile-card-subtitle { font-size: 14px; opacity: 0.9; }
        .profile-card-body { padding: 20px; }
        .profile-card-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
        .profile-card-row:last-child { border-bottom: none; }
        .profile-card-label { color: var(--text-gray); }
        .profile-card-value { font-weight: 600; text-align: right; max-width: 60%; }
        .profile-card-actions { padding: 16px 20px; background: var(--bg-light); display: flex; gap: 8px; flex-wrap: wrap; }
        
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-light); }
        th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; color: var(--text-gray); cursor: pointer; }
        th:hover { background: var(--border); }
        th.sortable::after { content: ' ‚Üï'; opacity: 0.4; }
        th.sort-asc::after { content: ' ‚Üë'; opacity: 1; }
        th.sort-desc::after { content: ' ‚Üì'; opacity: 1; }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:hover { background: rgba(102,126,234,0.02); }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: rgba(102,126,234,0.05); }
        .action-buttons { display: flex; gap: 6px; }
        
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .kanban-column { background: var(--bg-light); border-radius: 12px; padding: 16px; min-height: 400px; }
        .kanban-column.drag-over { background: #dbeafe; }
        .kanban-header { font-weight: 700; font-size: 14px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; }
        .kanban-count { background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; font-size: 12px; }
        .kanban-card { background: var(--white); padding: 16px; border-radius: 10px; margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: grab; transition: all 0.2s; border-left: 4px solid transparent; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kanban-card.dragging { opacity: 0.5; cursor: grabbing; }
        .kanban-card.stale { border-left-color: var(--warning); background: linear-gradient(90deg, rgba(245,158,11,0.05) 0%, transparent 100%); }
        .kanban-card-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .kanban-card-value { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .kanban-card-meta { font-size: 12px; color: var(--text-gray); margin-top: 8px; }
        .stale-indicator { display: inline-flex; align-items: center; gap: 4px; background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-top: 8px; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .chart-card { background: var(--white); padding: 20px; border-radius: 14px; box-shadow: var(--shadow-sm); }
        .chart-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; }
        .chart-container { position: relative; height: 280px; }
        
        .rep-card { background: var(--white); padding: 20px; border-radius: 14px; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; border-left: 4px solid var(--success); }
        .rep-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .rep-card.yellow { border-left-color: var(--warning); }
        .rep-card.red { border-left-color: var(--danger); }
        
        .leaderboard-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-light); border-radius: 10px; margin-bottom: 10px; }
        .leaderboard-rank { font-size: 24px; font-weight: 800; color: var(--primary); min-width: 40px; }
        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 700; font-size: 16px; }
        .leaderboard-stats { font-size: 13px; color: var(--text-gray); }
        .leaderboard-value { font-size: 20px; font-weight: 700; color: var(--success); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); padding: 32px; border-radius: 18px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-content.wide { max-width: 900px; }
        .modal-content.profile { max-width: 500px; padding: 0; overflow: hidden; }
        .modal-header { margin-bottom: 24px; }
        .modal-header h2 { font-size: 22px; font-weight: 700; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); }
        
        .celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; pointer-events: none; }
        .celebration-popup { background: white; padding: 40px 60px; border-radius: 24px; text-align: center; box-shadow: var(--shadow-lg); animation: popIn 0.5s ease; pointer-events: auto; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .celebration-icon { font-size: 80px; margin-bottom: 16px; }
        .celebration-title { font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
        .celebration-text { font-size: 16px; color: var(--text-gray); margin-bottom: 24px; }
        
        .checklist-section { background: var(--bg-light); padding: 16px; border-radius: 12px; margin-bottom: 16px; }
        .checklist-title { font-weight: 700; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .checklist-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; font-size: 13px; }
        .checklist-item input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; cursor: pointer; }
        .checklist-item.completed { text-decoration: line-through; opacity: 0.6; }
        .checklist-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .checklist-progress-text { font-size: 14px; font-weight: 600; }
        
        .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .clickable-link { color: var(--primary); cursor: pointer; text-decoration: underline; }
        .clickable-link:hover { color: #764ba2; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 20px; background: var(--bg-light); padding: 4px; border-radius: 10px; }
        .tab { padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .tab.active { background: var(--white); box-shadow: var(--shadow-sm); color: var(--primary); }
        .tab:hover:not(.active) { background: var(--border); }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .search-input { width: 180px; }
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="logo">üéØ</div>
            <h1>NuConnect CRM</h1>
            <p>Sign in to your account</p>
            <div class="form-group">
                <label>Team Member</label>
                <select id="userSelect"><option value="">Choose your name...</option></select>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="passwordInput" placeholder="Enter your password">
            </div>
            <div id="loginError" class="hidden" style="color: var(--danger); margin-bottom: 16px; font-size: 14px;"></div>
            <button class="btn btn-primary btn-full" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="appContainer" class="app-container hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üéØ NuConnect</h2>
                <p id="currentUserName" style="color: var(--text-gray); font-size: 13px; margin-top: 4px;"></p>
            </div>
            <nav class="sidebar-nav" id="sidebarNav"></nav>
        </aside>
        <main class="main-content">
            <div class="top-bar">
                <div><h1 id="pageTitle">Dashboard</h1></div>
                <div class="top-bar-actions">
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search..." oninput="handleSearch(this.value)">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <div class="profile-dropdown">
                        <button class="profile-btn" onclick="toggleProfileMenu()">
                            <span>üë§</span>
                            <span id="profileName">User</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="profile-menu" id="profileMenu">
                            <div class="profile-menu-item" onclick="openProfileSettings()">‚öôÔ∏è Account Settings</div>
                            <div class="profile-menu-divider"></div>
                            <div class="profile-menu-item" onclick="logout()" style="color: var(--danger);">üö™ Logout</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="contentArea"></div>
        </main>
    </div>
    <div id="modalContainer"></div>
    <div id="celebrationContainer"></div>

    <script>
// ============ STATE & CONFIG ============
var state = {
    currentUser: null,
    currentView: 'dashboard',
    baseId: localStorage.getItem('airtable_baseId') || '',
    apiKey: localStorage.getItem('airtable_apiKey') || '',
    charts: {},
    filterRep: null,
    dismissedNudges: JSON.parse(localStorage.getItem('dismissedNudges') || '[]'),
    celebratedToday: JSON.parse(localStorage.getItem('celebratedToday_' + new Date().toDateString()) || '[]'),
    dailyChecklist: JSON.parse(localStorage.getItem('dailyChecklist_' + new Date().toDateString()) || '{}'),
    data: { deals: [], activities: [], tasks: [], contacts: [], accounts: [], teamMembers: [], pricingRules: [] },
    teamMemberMap: {},
    filters: { contacts: { search: '', owner: '' }, accounts: { search: '', industry: '', owner: '' }, pipeline: { tier: '', owner: '' } },
    sorting: { contacts: { field: 'name', dir: 'asc' }, accounts: { field: 'name', dir: 'asc' } }
};

var savedSession = localStorage.getItem('nuconnect_session');
if (savedSession) { try { state.currentUser = JSON.parse(savedSession); } catch(e) {} }

var savedPasswords = JSON.parse(localStorage.getItem('nuconnect_passwords') || '{}');
var defaultPasswords = { 'Javonte': 'nuconnect2025', 'Teslim': 'nuconnect2025', 'Israel': 'nuconnect2025', 'Conrad': 'nuconnect2025', 'Test User': 'test2024', 'Test Leadership': 'testleader2024', 'Ramallah': 'admin2025', 'Keyna': 'admin2025' };
var userPasswords = {};
for (var k in defaultPasswords) userPasswords[k] = defaultPasswords[k];
for (var k in savedPasswords) userPasswords[k] = savedPasswords[k];

var userTimezones = JSON.parse(localStorage.getItem('nuconnect_timezones') || '{}');

var tierPricing = { 'Starter': 750, 'Growth': 1250, 'Pro': 2000, 'Enterprise': 4200 };
var tierColors = { 'Starter': '#9e9e9e', 'Growth': '#22c55e', 'Pro': '#f59e0b', 'Enterprise': '#667eea' };

var industryOptions = ['Technology', 'Finance & Banking', 'Healthcare', 'Education', 'Retail & E-commerce', 'Real Estate', 'Manufacturing', 'Entertainment & Media', 'Non-Profit', 'Government', 'Legal Services', 'Hospitality & Events', 'Sports & Fitness', 'Food & Beverage', 'Transportation & Logistics', 'Energy & Utilities', 'Construction', 'Agriculture', 'Telecommunications', 'Marketing & Advertising', 'Professional Services', 'Insurance', 'Automotive', 'Aerospace', 'Pharmaceuticals', 'Biotechnology', 'Fashion & Apparel', 'Beauty & Cosmetics', 'Travel & Tourism', 'Gaming & Esports', 'Music & Arts', 'Consulting', 'Human Resources', 'Security Services', 'Environmental Services', 'Other'];

var TOUCHPOINT_CADENCE = [
    { week: 1, action: 'Intro Email + Pitch Deck', goal: 'Position NuConnect as a strategic partner' },
    { week: 2, action: 'Value Add, Demo Invite, Case Study', goal: 'Build trust with proof of impact' },
    { week: 3, action: 'Follow-up Email, Pricing & Legal', goal: 'Drive engagement, show polish' },
    { week: 4, action: 'Objection Handling', goal: 'Address concerns, clarify value' },
    { week: 5, action: 'LinkedIn Touchpoint', goal: 'Reinforce brand presence' },
    { week: 6, action: 'Call or Meeting', goal: 'Close the deal, align on scope' },
    { week: 7, action: 'Review Contract', goal: 'Finalize terms' },
    { week: 8, action: 'Secure Payment', goal: 'Complete the sale' },
    { week: 9, action: 'Onboarding Kickoff', goal: 'Begin setup & collaboration' }
];

var DAILY_CHECKLIST = [
    { id: 'morning', title: 'üåÖ Morning Login & Hygiene', items: [
        'Logged in by 9:00am local time', 'Checked inbox (responded to all new replies)', 'Reviewed calendar for today', 'Cleared all overdue tasks', 'Reviewed pipeline for follow-ups'
    ]},
    { id: 'pipeline-review', title: 'üìã Pipeline Review (Start of Day)', items: [
        'Review pipeline (What deals can move today)', 'Identify 3 priority deals to push forward', 'Pull follow-ups due today', 'Add 3-5 new leads to CRM'
    ]},
    { id: 'leads', title: 'üéØ New Lead Generation (Top of Funnel)', items: [
        'Added 20-25 new qualified leads', 'All leads logged in CRM', 'All new leads enrolled into email cadence same day', 'Lead source noted (event, list, referral, LinkedIn, etc.)'
    ]},
    { id: 'outbound', title: 'üì§ Outbound Outreach', items: [
        'Sent 20-25 new outbound emails', 'Sent 5-10 LinkedIn touches', 'First-touch messages personalized', 'CTAs clearly stated (discovery call or reply)'
    ]},
    { id: 'followups', title: 'üîÑ Follow-Ups & Replies', items: [
        'Completed 10-15 follow-ups', 'Responded to all warm replies same day (when possible)', 'Nudged leads toward next step (call, proposal, close)'
    ]},
    { id: 'daily-activity', title: 'üîÅ DAILY ACTIVITY (NON-NEGOTIABLE)', items: [
        'Complete 20-25 total touchpoints (email, LinkedIn, calls, follow-ups)', '10 follow-ups minimum', '5-10 outbound messages minimum', '2-5 call attempts minimum', 'Log every touchpoint in CRM (no exceptions)'
    ]},
    { id: 'discovery', title: 'üìû DISCOVERY & PIPELINE MOVEMENT', items: [
        'Book at least 1 discovery call OR complete a scheduled discovery OR send a proposal', 'At least ONE deal moved to next stage today'
    ]},
    { id: 'qualification', title: 'üéØ QUALIFICATION CHECK (PROTECT PRICING)', items: [
        'Confirm attendee count for discoveries', 'Confirm event date', 'Confirm budget range', 'Assign correct tier (Starter/Growth/Pro/Enterprise)', 'Max 1 Starter deal per month - Push Growth or Pro by default'
    ]},
    { id: 'deal-progression', title: 'üíº DEAL PROGRESSION TASKS', items: [
        'Proposal sent within 48 hours of discovery', 'Follow-up task scheduled', 'Decision maker identified', 'Next step scheduled on calendar'
    ]},
    { id: 'pipeline', title: 'üìà Pipeline Movement', items: [
        'Moved 1-2 leads forward in pipeline stage', 'Updated deal stage accurately', 'Notes added for any meaningful conversation'
    ]},
    { id: 'eod', title: 'üïî END OF DAY CHECK (5 MIN)', items: [
        'Did I complete 20-25 touchpoints?', 'Did I add new leads?', 'Did I move at least one deal forward?', 'Did I log everything in CRM?', 'Tomorrow\'s follow-ups scheduled', 'Pipeline reviewed for momentum gaps', 'Calendar prepped for next business day'
    ]}
];

var KPI_TARGETS = {
    BDR: { monthlyRevenueMin: 9750, monthlyRevenueMax: 12700, monthlyEventsMin: 6, monthlyEventsMax: 7, dailyTouchpointsMin: 20, dailyTouchpointsMax: 25, dailyCalls: 15, dailyEmails: 10, dailyLinkedIn: 5, quota: 45000 },
    AE: { monthlyRevenueMin: 15000, monthlyRevenueMax: 20000, monthlyEventsMin: 4, monthlyEventsMax: 6, dailyTouchpointsMin: 15, dailyTouchpointsMax: 20, dailyCalls: 10, dailyEmails: 8, dailyLinkedIn: 3, quota: 60000 },
    Team: { monthlyRevenueMin: 28000, monthlyRevenueMax: 35000, monthlyEventsMin: 18, monthlyEventsMax: 22 }
};

function getKPITargets(role) { return role === 'AE' ? KPI_TARGETS.AE : KPI_TARGETS.BDR; }

var allNavItems = [
    { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
    { id: 'checklist', icon: '‚úÖ', label: 'Daily Checklist' },
    { id: 'pipeline', icon: 'üìà', label: 'Pipeline' },
    { id: 'contacts', icon: 'üë•', label: 'Contacts' },
    { id: 'accounts', icon: 'üè¢', label: 'Accounts' },
    { id: 'events', icon: 'üéâ', label: 'Events' },
    { id: 'activity', icon: 'üìù', label: 'Activities' },
    { id: 'reports', icon: 'üìë', label: 'Reports' }
];
var leadershipNavItems = [
    { id: 'leadership', icon: 'üëî', label: 'Analytics' },
    { id: 'team', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', label: 'Team Overview' }
];

// ============ GREETING & TIME ============
function getGreeting() {
    var tz = userTimezones[state.currentUser ? state.currentUser.name : ''] || Intl.DateTimeFormat().resolvedOptions().timeZone;
    var hour = parseInt(new Date().toLocaleString('en-US', { hour: 'numeric', hour12: false, timeZone: tz }));
    if (hour < 12) return 'Good morning';
    if (hour < 17) return 'Good afternoon';
    return 'Good evening';
}

// ============ PROFILE MENU ============
function toggleProfileMenu() {
    document.getElementById('profileMenu').classList.toggle('active');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.profile-dropdown')) {
        var menu = document.getElementById('profileMenu');
        if (menu) menu.classList.remove('active');
    }
});

function openProfileSettings() {
    var currentTz = userTimezones[state.currentUser.name] || Intl.DateTimeFormat().resolvedOptions().timeZone;
    var timezones = ['Africa/Lagos', 'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles', 'America/Phoenix', 'America/Anchorage', 'Pacific/Honolulu', 'Europe/London', 'Europe/Paris', 'Asia/Tokyo', 'Asia/Shanghai', 'Australia/Sydney'];
    
    var tzOptions = '';
    for (var i = 0; i < timezones.length; i++) {
        tzOptions += '<option value="' + timezones[i] + '"' + (currentTz === timezones[i] ? ' selected' : '') + '>' + timezones[i] + '</option>';
    }
    
    var isLeadership = state.currentUser.role === 'Leadership';
    var repOptions = '';
    if (isLeadership) {
        var reps = state.data.teamMembers.filter(function(m) { return m.role !== 'Leadership'; });
        for (var i = 0; i < reps.length; i++) {
            repOptions += '<option value="' + reps[i].name + '">' + reps[i].name + ' (' + reps[i].role + ')</option>';
        }
    }
    
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚öôÔ∏è Account Settings</h2></div>' +
        '<div class="form-group"><label>Your Name</label><input type="text" value="' + state.currentUser.name + '" disabled></div>' +
        '<div class="form-group"><label>Role</label><input type="text" value="' + state.currentUser.role + '" disabled></div>' +
        '<div class="form-group"><label>Timezone</label><select id="timezoneSelect">' + tzOptions + '</select></div>' +
        '<hr style="margin:20px 0;border:none;border-top:1px solid var(--border);">' +
        '<h3 style="margin-bottom:16px;">üîê Change Password</h3>' +
        '<div class="form-group"><label>Current Password</label><input type="password" id="currentPassword" placeholder="Enter current password"></div>' +
        '<div class="form-group"><label>New Password</label><input type="password" id="newPassword" placeholder="Enter new password (min 6 chars)"></div>' +
        '<div class="form-group"><label>Confirm New Password</label><input type="password" id="confirmPassword" placeholder="Confirm new password"></div>';
    
    if (isLeadership) {
        html += '<hr style="margin:20px 0;border:none;border-top:1px solid var(--border);">' +
            '<h3 style="margin-bottom:16px;">üîë Reset Rep Password</h3>' +
            '<div class="form-group"><label>Select Rep</label><select id="resetRepSelect"><option value="">Choose rep...</option>' + repOptions + '</select></div>' +
            '<div class="form-group"><label>New Password for Rep</label><input type="password" id="resetRepPassword" placeholder="New password for rep"></div>' +
            '<button class="btn btn-warning btn-small" onclick="resetRepPassword()">Reset Rep Password</button>';
    }
    
    html += '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveProfileSettings()">Save Settings</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
    toggleProfileMenu();
}

function saveProfileSettings() {
    var tz = document.getElementById('timezoneSelect').value;
    userTimezones[state.currentUser.name] = tz;
    localStorage.setItem('nuconnect_timezones', JSON.stringify(userTimezones));
    
    var current = document.getElementById('currentPassword').value;
    var newPass = document.getElementById('newPassword').value;
    var confirm = document.getElementById('confirmPassword').value;
    
    if (current || newPass || confirm) {
        if (userPasswords[state.currentUser.name] !== current) { alert('Current password is incorrect'); return; }
        if (newPass.length < 6) { alert('New password must be at least 6 characters'); return; }
        if (newPass !== confirm) { alert('New passwords do not match'); return; }
        
        userPasswords[state.currentUser.name] = newPass;
        savedPasswords[state.currentUser.name] = newPass;
        localStorage.setItem('nuconnect_passwords', JSON.stringify(savedPasswords));
        alert('Password changed successfully!');
    }
    
    closeModal();
    renderView(state.currentView);
}

function resetRepPassword() {
    var repName = document.getElementById('resetRepSelect').value;
    var newPass = document.getElementById('resetRepPassword').value;
    
    if (!repName) { alert('Please select a rep'); return; }
    if (newPass.length < 6) { alert('Password must be at least 6 characters'); return; }
    
    userPasswords[repName] = newPass;
    savedPasswords[repName] = newPass;
    localStorage.setItem('nuconnect_passwords', JSON.stringify(savedPasswords));
    alert('Password reset successfully for ' + repName + '!');
    document.getElementById('resetRepSelect').value = '';
    document.getElementById('resetRepPassword').value = '';
}

// ============ CELEBRATIONS ============
function showCelebration(type, message) {
    if (state.celebratedToday.indexOf(type) !== -1) return;
    
    state.celebratedToday.push(type);
    localStorage.setItem('celebratedToday_' + new Date().toDateString(), JSON.stringify(state.celebratedToday));
    
    var icons = { 'deal-moved': 'üöÄ', 'kpi-hit': 'üèÜ', 'revenue-goal': 'üí∞', 'close-to-goal': 'üî•', 'deal-won': 'üéâ' };
    var titles = { 'deal-moved': 'Deal Advanced!', 'kpi-hit': 'KPI Achieved!', 'revenue-goal': 'Revenue Goal Hit!', 'close-to-goal': 'Almost There!', 'deal-won': 'Deal Won!' };
    
    document.getElementById('celebrationContainer').innerHTML = 
        '<div class="celebration-overlay" onclick="closeCelebration()">' +
        '<div class="celebration-popup">' +
        '<div class="celebration-icon">' + (icons[type] || 'üéâ') + '</div>' +
        '<div class="celebration-title">' + (titles[type] || 'Congratulations!') + '</div>' +
        '<div class="celebration-text">' + message + '</div>' +
        '<button class="btn btn-primary" onclick="closeCelebration()">Awesome!</button>' +
        '</div></div>';
    
    if (typeof confetti === 'function') {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }
}

function closeCelebration() {
    document.getElementById('celebrationContainer').innerHTML = '';
}

function checkAchievements() {
    if (!state.currentUser || state.currentUser.role === 'Leadership') return;
    
    var today = new Date().toISOString().split('T')[0];
    var targets = getKPITargets(state.currentUser.role);
    var userActivities = state.data.activities.filter(function(a) { return a.owner === state.currentUser.name; });
    var todayActivities = userActivities.filter(function(a) { return a.date && a.date.split('T')[0] === today; });
    
    if (todayActivities.length >= targets.dailyTouchpointsMin) {
        showCelebration('kpi-hit', 'You hit your daily touchpoint goal of ' + targets.dailyTouchpointsMin + '+ activities!');
    } else if (todayActivities.length >= targets.dailyTouchpointsMin - 3 && todayActivities.length < targets.dailyTouchpointsMin) {
        showCelebration('close-to-goal', 'Only ' + (targets.dailyTouchpointsMin - todayActivities.length) + ' more touchpoints to hit your daily goal!');
    }
}

// ============ SEARCH ============
var searchTimeout = null;
window.searchResults = [];

function handleSearch(query) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() { performSearch(query); }, 300);
}

function performSearch(query) {
    var resultsDiv = document.getElementById('searchResults');
    if (!query || query.length < 2) { resultsDiv.innerHTML = ''; resultsDiv.classList.remove('active'); return; }
    var q = query.toLowerCase();
    var results = [];

    for (var i = 0; i < state.data.deals.length; i++) {
        var deal = state.data.deals[i];
        if (deal.name.toLowerCase().indexOf(q) !== -1) {
            results.push({ type: 'Deal', title: deal.name, meta: deal.tier + ' ‚Ä¢ $' + deal.value.toLocaleString(), action: function() { closeSearch(); renderView('pipeline'); }});
        }
    }
    for (var i = 0; i < state.data.contacts.length; i++) {
        var contact = state.data.contacts[i];
        if (contact.name.toLowerCase().indexOf(q) !== -1 || (contact.email && contact.email.toLowerCase().indexOf(q) !== -1)) {
            (function(c) {
                results.push({ type: 'Contact', title: c.name, meta: c.email || 'No email', action: function() { closeSearch(); openContactDetailModal(c.id); }});
            })(contact);
        }
    }
    for (var i = 0; i < state.data.accounts.length; i++) {
        var account = state.data.accounts[i];
        if (account.name.toLowerCase().indexOf(q) !== -1) {
            (function(a) {
                results.push({ type: 'Account', title: a.name, meta: a.industry || 'No industry', action: function() { closeSearch(); openAccountDetailModal(a.id); }});
            })(account);
        }
    }

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item"><div class="search-result-title">No results found</div></div>';
    } else {
        var html = '';
        for (var i = 0; i < Math.min(results.length, 8); i++) {
            html += '<div class="search-result-item" onmousedown="window.searchResults[' + i + '].action()">' +
                '<div class="search-result-type">' + results[i].type + '</div>' +
                '<div class="search-result-title">' + results[i].title + '</div>' +
                '<div class="search-result-meta">' + results[i].meta + '</div></div>';
        }
        resultsDiv.innerHTML = html;
        window.searchResults = results;
    }
    resultsDiv.classList.add('active');
}

function closeSearch() { 
    document.getElementById('globalSearch').value = ''; 
    document.getElementById('searchResults').classList.remove('active'); 
}

// ============ NUDGES ============
function dismissNudge(nudgeId, btn) {
    state.dismissedNudges.push(nudgeId);
    localStorage.setItem('dismissedNudges', JSON.stringify(state.dismissedNudges));
    btn.parentElement.remove();
}

function generateNudges() {
    var nudges = [];
    if (!state.currentUser || state.currentUser.role === 'Leadership') return nudges;
    
    var now = new Date();
    var today = now.toISOString().split('T')[0];
    var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    var targets = getKPITargets(state.currentUser.role);
    
    var userActivities = state.data.activities.filter(function(a) { return a.owner === state.currentUser.name; });
    var todayActivities = userActivities.filter(function(a) { return a.date && a.date.split('T')[0] === today; });
    var todayTouchpoints = todayActivities.length;
    
    var userDeals = state.data.deals.filter(function(d) { return d.owner === state.currentUser.name; });
    var monthClosedDeals = userDeals.filter(function(d) {
        if (d.stage.toLowerCase().indexOf('won') === -1) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var monthRevenue = 0;
    for (var i = 0; i < monthClosedDeals.length; i++) monthRevenue += monthClosedDeals[i].value;
    var revenuePercent = (monthRevenue / targets.monthlyRevenueMin) * 100;
    
    if (revenuePercent < 50 && state.dismissedNudges.indexOf('revenue-low') === -1) {
        nudges.push({ id: 'revenue-low', type: 'danger', icon: 'üö®', text: 'You\'re at ' + revenuePercent.toFixed(0) + '% of target. Let\'s pick up the pace!' });
    } else if (revenuePercent >= 100 && state.dismissedNudges.indexOf('revenue-hit-' + today) === -1) {
        nudges.push({ id: 'revenue-hit-' + today, type: 'success', icon: 'üéâ', text: 'Amazing! You\'ve hit ' + revenuePercent.toFixed(0) + '% of your target!' });
    }
    
    if (now.getHours() >= 15 && todayTouchpoints < 15 && state.dismissedNudges.indexOf('touchpoints-' + today) === -1) {
        nudges.push({ id: 'touchpoints-' + today, type: 'warning', icon: '‚è∞', text: 'Only ' + todayTouchpoints + '/' + targets.dailyTouchpointsMax + ' touchpoints today. Time to hustle!' });
    }
    
    var pipelineDeals = userDeals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') === -1 && d.stage.toLowerCase().indexOf('lost') === -1; });
    var staleCount = 0;
    for (var i = 0; i < pipelineDeals.length; i++) {
        var deal = pipelineDeals[i];
        var lastActivity = null;
        for (var j = 0; j < userActivities.length; j++) {
            if (userActivities[j].account && deal.name.toLowerCase().indexOf(userActivities[j].account.toLowerCase()) !== -1) {
                if (!lastActivity || new Date(userActivities[j].date) > new Date(lastActivity.date)) {
                    lastActivity = userActivities[j];
                }
            }
        }
        if (!lastActivity || getDaysSince(lastActivity.date) >= 5) staleCount++;
    }
    
    if (staleCount > 0 && state.dismissedNudges.indexOf('stale-' + today) === -1) {
        nudges.push({ id: 'stale-' + today, type: 'info', icon: 'üìå', text: staleCount + ' deal' + (staleCount > 1 ? 's need' : ' needs') + ' attention! Move to next touchpoint.' });
    }
    
    return nudges.slice(0, 4);
}

function renderNudges() {
    var nudges = generateNudges();
    if (nudges.length === 0) return '';
    var html = '<div class="nudge-container">';
    for (var i = 0; i < nudges.length; i++) {
        var n = nudges[i];
        html += '<div class="nudge-alert ' + n.type + '">' +
            '<span class="nudge-icon">' + n.icon + '</span>' +
            '<span class="nudge-text">' + n.text + '</span>' +
            '<button class="nudge-dismiss" onclick="dismissNudge(\'' + n.id + '\', this)">√ó</button></div>';
    }
    html += '</div>';
    return html;
}

// ============ CHARTS ============
function destroyCharts() {
    for (var key in state.charts) {
        if (state.charts[key] && typeof state.charts[key].destroy === 'function') state.charts[key].destroy();
    }
    state.charts = {};
}

function renderRevenueTrendChart(canvasId, deals, label) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var currentMonth = new Date().getMonth();
    var currentYear = new Date().getFullYear();
    
    var monthlyData = [], labels = [];
    for (var i = 5; i >= 0; i--) {
        var month = currentMonth - i, year = currentYear;
        if (month < 0) { month += 12; year -= 1; }
        var monthStart = new Date(year, month, 1), monthEnd = new Date(year, month + 1, 0);
        var monthDeals = deals.filter(function(d) {
            if (d.stage.toLowerCase().indexOf('won') === -1) return false;
            var closeDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return closeDate && closeDate >= monthStart && closeDate <= monthEnd;
        });
        var total = 0;
        for (var j = 0; j < monthDeals.length; j++) total += monthDeals[j].value;
        monthlyData.push(total);
        labels.push(monthNames[month]);
    }
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: label || 'Revenue', data: monthlyData, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', fill: true, tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: function(v) { return '$' + (v/1000).toFixed(0) + 'K'; } } } } }
    });
}

function renderRevenueByTierChart(canvasId, deals) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var wonDeals = deals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') !== -1; });
    var tierData = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    for (var i = 0; i < wonDeals.length; i++) {
        if (tierData.hasOwnProperty(wonDeals[i].tier)) tierData[wonDeals[i].tier] += wonDeals[i].value;
    }
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'pie',
        data: { labels: Object.keys(tierData), datasets: [{ data: [tierData.Starter, tierData.Growth, tierData.Pro, tierData.Enterprise], backgroundColor: [tierColors.Starter, tierColors.Growth, tierColors.Pro, tierColors.Enterprise] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
}

// ============ HELPERS ============
function formatDateShort(dateString) {
    if (!dateString) return '-';
    try { return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    catch (e) { return dateString; }
}

function getDaysSince(dateString) {
    if (!dateString) return null;
    return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24));
}

function getOwnerName(ownerField) {
    if (Array.isArray(ownerField) && ownerField.length > 0) {
        for (var i = 0; i < state.data.teamMembers.length; i++) {
            if (state.data.teamMembers[i].id === ownerField[0]) return state.data.teamMembers[i].name;
        }
    }
    return ownerField || '';
}

function getAccountName(accountField) {
    if (Array.isArray(accountField) && accountField.length > 0) {
        for (var i = 0; i < state.data.accounts.length; i++) {
            if (state.data.accounts[i].id === accountField[0]) return state.data.accounts[i].name;
        }
    }
    return '';
}

function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }

function getActivityStats(activities) {
    var stats = { calls: 0, emails: 0, linkedin: 0, demos: 0, proposals: 0, meetings: 0, followups: 0 };
    for (var i = 0; i < activities.length; i++) {
        var type = (activities[i].type || '').toLowerCase();
        if (type.indexOf('call') !== -1) stats.calls++;
        else if (type.indexOf('email') !== -1) stats.emails++;
        else if (type.indexOf('linkedin') !== -1) stats.linkedin++;
        else if (type.indexOf('demo') !== -1) stats.demos++;
        else if (type.indexOf('proposal') !== -1) stats.proposals++;
        else if (type.indexOf('meeting') !== -1) stats.meetings++;
        else if (type.indexOf('follow') !== -1) stats.followups++;
    }
    return stats;
}

// ============ INITIALIZATION ============
function init() {
    console.log('%cüöÄ NuConnect CRM v6.0', 'background: #667eea; color: white; font-size: 16px; padding: 10px;');
    
    if (state.baseId && state.apiKey) {
        loadTeamMembers().then(function() {
            if (state.currentUser) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                initApp();
            } else {
                populateLoginSelect();
            }
        });
    } else {
        showConfigPrompt();
    }
}

function showConfigPrompt() {
    document.getElementById('loginScreen').innerHTML = 
        '<div class="login-card"><div class="logo">‚öôÔ∏è</div><h1>Setup Required</h1><p>Configure your Airtable connection</p>' +
        '<div class="form-group"><label>Airtable Base ID</label><input type="text" id="setupBaseId" placeholder="appXXXXXXXXXXXXXX" value="' + state.baseId + '"></div>' +
        '<div class="form-group"><label>Airtable API Key</label><input type="password" id="setupApiKey" placeholder="patXXXXXXXXXXXXXX"></div>' +
        '<button class="btn btn-primary btn-full" onclick="saveConfig()">Connect to Airtable</button></div>';
}

function saveConfig() {
    var baseId = document.getElementById('setupBaseId').value.trim();
    var apiKey = document.getElementById('setupApiKey').value.trim();
    if (baseId && apiKey) { localStorage.setItem('airtable_baseId', baseId); localStorage.setItem('airtable_apiKey', apiKey); location.reload(); }
    else alert('Please fill in both fields');
}

function loadTeamMembers() {
    return fetchFromAirtable('Team Members').then(function(response) {
        if (response && response.records) {
            state.data.teamMembers = [];
            state.teamMemberMap = {};
            for (var i = 0; i < response.records.length; i++) {
                var r = response.records[i];
                state.data.teamMembers.push({ id: r.id, name: r.fields.Name || '', role: r.fields.Role || '', quota: r.fields['Monthly Quota'] || (r.fields.Role === 'AE' ? 60000 : 45000) });
                if (r.fields.Name) state.teamMemberMap[r.fields.Name] = r.id;
            }
        }
    }).catch(function(error) {
        console.error('Error loading team members:', error);
        state.data.teamMembers = [
            { id: 'rec1', name: 'Javonte', role: 'BDR', quota: 45000 }, { id: 'rec2', name: 'Teslim', role: 'BDR', quota: 45000 },
            { id: 'rec3', name: 'Israel', role: 'BDR', quota: 45000 }, { id: 'rec4', name: 'Conrad', role: 'AE', quota: 60000 },
            { id: 'rec5', name: 'Test User', role: 'BDR', quota: 45000 }, { id: 'rec6', name: 'Test Leadership', role: 'Leadership', quota: 0 },
            { id: 'rec7', name: 'Ramallah', role: 'Leadership', quota: 0 }, { id: 'rec8', name: 'Keyna', role: 'Leadership', quota: 0 }
        ];
        state.teamMemberMap = { 'Javonte': 'rec1', 'Teslim': 'rec2', 'Israel': 'rec3', 'Conrad': 'rec4', 'Test User': 'rec5', 'Test Leadership': 'rec6', 'Ramallah': 'rec7', 'Keyna': 'rec8' };
    });
}

function populateLoginSelect() {
    var select = document.getElementById('userSelect');
    if (!select) return;
    for (var i = 0; i < state.data.teamMembers.length; i++) {
        var member = state.data.teamMembers[i];
        var option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name + ' (' + member.role + ')';
        select.appendChild(option);
    }
}

function handleLogin() {
    var select = document.getElementById('userSelect');
    var passwordInput = document.getElementById('passwordInput');
    var errorDiv = document.getElementById('loginError');
    var selectedName = select.value, enteredPassword = passwordInput.value;
    
    if (!selectedName) { errorDiv.textContent = 'Please select a team member'; errorDiv.classList.remove('hidden'); return; }
    if (!enteredPassword) { errorDiv.textContent = 'Please enter your password'; errorDiv.classList.remove('hidden'); return; }
    if (userPasswords[selectedName] !== enteredPassword) { errorDiv.textContent = 'Incorrect password'; errorDiv.classList.remove('hidden'); passwordInput.value = ''; return; }
    
    for (var i = 0; i < state.data.teamMembers.length; i++) {
        if (state.data.teamMembers[i].name === selectedName) {
            state.currentUser = state.data.teamMembers[i];
            localStorage.setItem('nuconnect_session', JSON.stringify(state.currentUser));
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            initApp();
            break;
        }
    }
}

function initApp() {
    document.getElementById('currentUserName').textContent = state.currentUser.name + ' ‚Ä¢ ' + state.currentUser.role;
    document.getElementById('profileName').textContent = state.currentUser.name;
    buildNavigation();
    loadAllData().then(function() {
        renderView('dashboard');
    });
    setInterval(function() { loadAllData(); }, 5 * 60 * 1000);
}

function buildNavigation() {
    var nav = document.getElementById('sidebarNav');
    var items = allNavItems.slice();
    if (state.currentUser.role === 'Leadership') {
        items = items.filter(function(item) { return item.id !== 'checklist'; });
        items = items.concat(leadershipNavItems);
    }
    var html = '';
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        html += '<div class="nav-item' + (item.id === state.currentView ? ' active' : '') + '" onclick="renderView(\'' + item.id + '\')">' +
            '<span class="nav-item-icon">' + item.icon + '</span><span>' + item.label + '</span></div>';
    }
    nav.innerHTML = html;
}

function logout() { 
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('nuconnect_session');
        location.reload(); 
    }
}

// ============ AIRTABLE API ============
function fetchFromAirtable(tableName, method, body) {
    method = method || 'GET';
    var url = 'https://api.airtable.com/v0/' + state.baseId + '/' + encodeURIComponent(tableName);
    var options = { method: method, headers: { 'Authorization': 'Bearer ' + state.apiKey, 'Content-Type': 'application/json' } };
    if (body && (method === 'POST' || method === 'PATCH' || method === 'PUT')) options.body = JSON.stringify(body);
    return fetch(url, options).then(function(response) {
        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
        return response.json();
    });
}

function deleteFromAirtable(tableName, recordId) {
    var url = 'https://api.airtable.com/v0/' + state.baseId + '/' + encodeURIComponent(tableName) + '/' + recordId;
    return fetch(url, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + state.apiKey } }).then(function(response) {
        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
        return true;
    });
}

function updateInAirtable(tableName, recordId, fields) {
    var url = 'https://api.airtable.com/v0/' + state.baseId + '/' + encodeURIComponent(tableName) + '/' + recordId;
    return fetch(url, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + state.apiKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields: fields }) }).then(function(response) {
        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
        return response.json();
    });
}

function loadAllData() {
    return Promise.all([loadDeals(), loadActivities(), loadContacts(), loadAccounts()]).catch(function(error) {
        console.error('Error loading data:', error);
    });
}

function loadDeals() {
    return fetchFromAirtable('Deals').then(function(response) {
        if (response && response.records) {
            state.data.deals = [];
            for (var i = 0; i < response.records.length; i++) {
                var r = response.records[i];
                state.data.deals.push({
                    id: r.id, name: r.fields['Deal Name'] || '', owner: getOwnerName(r.fields.Owner),
                    tier: Array.isArray(r.fields['Tier (lookup)']) ? r.fields['Tier (lookup)'][0] : r.fields['Tier (lookup)'] || '',
                    stage: r.fields.Stage || '', value: r.fields.Amount || 0, eventName: r.fields['Event Name'] || '',
                    closeDate: r.fields['Close Date'] || '', createdTime: r.createdTime,
                    pricingType: r.fields['Pricing Type'] || 'Public Price', status: r.fields['Status'] || 'Active'
                });
            }
        }
    });
}

function loadActivities() {
    return fetchFromAirtable('Activities').then(function(response) {
        if (response && response.records) {
            state.data.activities = [];
            for (var i = 0; i < response.records.length; i++) {
                var r = response.records[i];
                state.data.activities.push({
                    id: r.id, name: r.fields['Activity Name'] || '', type: r.fields.Type || '',
                    date: r.fields['Activity Date/Time'] || r.fields.Date || '', owner: r.fields.Owner || '',
                    account: r.fields.Account || '', result: r.fields.Result || '', createdTime: r.createdTime
                });
            }
        }
    });
}

function loadContacts() {
    return fetchFromAirtable('Contacts').then(function(response) {
        if (response && response.records) {
            state.data.contacts = [];
            for (var i = 0; i < response.records.length; i++) {
                var r = response.records[i];
                state.data.contacts.push({
                    id: r.id, name: r.fields['Full Name'] || '', email: r.fields.Email || '', phone: r.fields.Phone || '',
                    company: getAccountName(r.fields.Account), accountId: Array.isArray(r.fields.Account) ? r.fields.Account[0] : null,
                    role: r.fields.Title || '', owner: getOwnerName(r.fields['Contact Owner']), createdTime: r.createdTime
                });
            }
        }
    });
}

function loadAccounts() {
    return fetchFromAirtable('Accounts').then(function(response) {
        if (response && response.records) {
            state.data.accounts = [];
            for (var i = 0; i < response.records.length; i++) {
                var r = response.records[i];
                state.data.accounts.push({
                    id: r.id, name: r.fields['Account Name'] || '', industry: r.fields.Industry || '',
                    website: r.fields.Website || '', phone: r.fields.Phone || '', address: r.fields.Address || '',
                    owner: getOwnerName(r.fields['Account Owner']), createdTime: r.createdTime
                });
            }
        }
    });
}

function getUserDeals() {
    if (state.currentUser.role === 'Leadership') return state.data.deals;
    return state.data.deals.filter(function(d) { return d.owner === state.currentUser.name; });
}

// ============ CRUD OPERATIONS ============
function createDeal(dealData) {
    fetchFromAirtable('Deals', 'POST', { fields: dealData }).then(function(response) {
        if (response && response.id) { 
            loadDeals().then(function() { 
                closeModal(); 
                renderView('pipeline'); 
                alert('Deal created!'); 
            }); 
        }
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function createContact(contactData) {
    fetchFromAirtable('Contacts', 'POST', { fields: contactData }).then(function(response) {
        if (response && response.id) { 
            loadContacts().then(function() { 
                closeModal(); 
                renderView('contacts'); 
                alert('Contact created!'); 
            }); 
        }
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function createAccount(accountData) {
    fetchFromAirtable('Accounts', 'POST', { fields: accountData }).then(function(response) {
        if (response && response.id) { 
            loadAccounts().then(function() { 
                closeModal(); 
                renderView('accounts'); 
                alert('Account created!'); 
            }); 
        }
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function logActivity(activityData) {
    fetchFromAirtable('Activities', 'POST', { fields: activityData }).then(function(response) {
        if (response && response.id) { 
            loadActivities().then(function() { 
                closeModal(); 
                renderView(state.currentView); 
                alert('Activity logged!'); 
                checkAchievements();
            }); 
        }
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function deleteContact(contactId) {
    if (!confirm('Delete this contact?')) return;
    deleteFromAirtable('Contacts', contactId).then(function() {
        loadContacts().then(function() { closeModal(); renderView('contacts'); });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function deleteAccount(accountId) {
    if (!confirm('Delete this account?')) return;
    deleteFromAirtable('Accounts', accountId).then(function() {
        loadAccounts().then(function() { closeModal(); renderView('accounts'); });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function deleteDeal(dealId) {
    if (!confirm('Delete this deal?')) return;
    deleteFromAirtable('Deals', dealId).then(function() {
        loadDeals().then(function() { closeModal(); renderView('pipeline'); });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function deleteActivity(activityId) {
    if (!confirm('Delete this activity?')) return;
    deleteFromAirtable('Activities', activityId).then(function() {
        loadActivities().then(function() { renderView('activity'); });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

// ============ DETAIL MODALS ============
function openAccountDetailModal(accountId) {
    var account = null;
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (state.data.accounts[i].id === accountId) { account = state.data.accounts[i]; break; }
    }
    if (!account) return;
    
    var contacts = state.data.contacts.filter(function(c) { return c.accountId === accountId || c.company === account.name; });
    var deals = state.data.deals.filter(function(d) { return d.name.toLowerCase().indexOf(account.name.toLowerCase()) !== -1; });
    var activities = state.data.activities.filter(function(a) { return a.account === account.name; });
    var isLeadership = state.currentUser.role === 'Leadership';
    
    var contactsList = '';
    for (var i = 0; i < Math.min(contacts.length, 5); i++) {
        contactsList += '<div class="clickable-link" onclick="closeModal();openContactDetailModal(\'' + contacts[i].id + '\')">' + contacts[i].name + '</div>';
    }
    if (contacts.length === 0) contactsList = '<div style="color:var(--text-gray);">No contacts</div>';
    
    var dealsList = '';
    for (var i = 0; i < Math.min(deals.length, 5); i++) {
        dealsList += '<div class="clickable-link" onclick="closeModal();openDealDetailsModal(\'' + deals[i].id + '\')">' + deals[i].name + ' ($' + deals[i].value.toLocaleString() + ')</div>';
    }
    if (deals.length === 0) dealsList = '<div style="color:var(--text-gray);">No deals</div>';
    
    var activitiesList = '';
    var sortedActivities = activities.sort(function(a,b) { return new Date(b.date) - new Date(a.date); });
    for (var i = 0; i < Math.min(sortedActivities.length, 5); i++) {
        activitiesList += '<div style="font-size:12px;padding:4px 0;">' + sortedActivities[i].type + ' - ' + formatDateShort(sortedActivities[i].date) + '</div>';
    }
    if (activities.length === 0) activitiesList = '<div style="color:var(--text-gray);">No activities</div>';
    
    var html = '<div class="modal active"><div class="modal-content profile">' +
        '<div class="profile-card-header" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);">' +
        '<div class="profile-card-avatar">üè¢</div>' +
        '<div class="profile-card-name">' + account.name + '</div>' +
        '<div class="profile-card-subtitle">' + (account.industry || 'No industry') + '</div></div>' +
        '<div class="profile-card-body">' +
        '<div class="profile-card-row"><span class="profile-card-label">Owner</span><span class="profile-card-value">' + (account.owner || 'Unassigned') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Website</span><span class="profile-card-value">' + (account.website || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Phone</span><span class="profile-card-value">' + (account.phone || '-') + '</span></div>' +
        '<div style="margin-top:16px;"><div style="font-weight:600;font-size:13px;margin-bottom:8px;">üë• Contacts (' + contacts.length + ')</div>' + contactsList + '</div>' +
        '<div style="margin-top:12px;"><div style="font-weight:600;font-size:13px;margin-bottom:8px;">üí∞ Deals (' + deals.length + ')</div>' + dealsList + '</div>' +
        '<div style="margin-top:12px;"><div style="font-weight:600;font-size:13px;margin-bottom:8px;">üìù Recent Activities (' + activities.length + ')</div>' + activitiesList + '</div>' +
        '</div>' +
        '<div class="profile-card-actions">' +
        '<button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>';
    if (isLeadership) {
        html += '<button class="btn btn-secondary btn-small" onclick="closeModal();openEditAccountModal(\'' + accountId + '\')">‚úèÔ∏è Edit</button>';
        html += '<button class="btn btn-danger btn-small" onclick="deleteAccount(\'' + accountId + '\')">üóëÔ∏è</button>';
    }
    html += '<button class="btn btn-primary btn-small" onclick="closeModal();openLogActivityModalForAccount(\'' + account.name + '\')">üìù Activity</button>' +
        '</div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function openContactDetailModal(contactId) {
    var contact = null;
    for (var i = 0; i < state.data.contacts.length; i++) {
        if (state.data.contacts[i].id === contactId) { contact = state.data.contacts[i]; break; }
    }
    if (!contact) return;
    
    var activities = state.data.activities.filter(function(a) { return a.contact === contactId; });
    var isLeadership = state.currentUser.role === 'Leadership';
    
    var accountLink = '';
    if (contact.company) {
        var account = null;
        for (var i = 0; i < state.data.accounts.length; i++) {
            if (state.data.accounts[i].name === contact.company || state.data.accounts[i].id === contact.accountId) {
                account = state.data.accounts[i]; break;
            }
        }
        if (account) {
            accountLink = '<span class="clickable-link" onclick="closeModal();openAccountDetailModal(\'' + account.id + '\')">' + contact.company + '</span>';
        } else {
            accountLink = contact.company;
        }
    } else {
        accountLink = '-';
    }
    
    var html = '<div class="modal active"><div class="modal-content profile">' +
        '<div class="profile-card-header">' +
        '<div class="profile-card-avatar">üë§</div>' +
        '<div class="profile-card-name">' + contact.name + '</div>' +
        '<div class="profile-card-subtitle">' + (contact.role || 'No role') + '</div></div>' +
        '<div class="profile-card-body">' +
        '<div class="profile-card-row"><span class="profile-card-label">Email</span><span class="profile-card-value">' + (contact.email || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Phone</span><span class="profile-card-value">' + (contact.phone || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Company</span><span class="profile-card-value">' + accountLink + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Owner</span><span class="profile-card-value">' + (contact.owner || 'Unassigned') + '</span></div>' +
        '<div style="margin-top:16px;background:var(--bg-light);padding:14px;border-radius:8px;text-align:center;">' +
        '<div style="font-size:24px;font-weight:700;color:var(--primary);">' + activities.length + '</div>' +
        '<div style="font-size:12px;color:var(--text-gray);">Total Activities</div></div></div>' +
        '<div class="profile-card-actions">' +
        '<button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>';
    if (isLeadership) {
        html += '<button class="btn btn-secondary btn-small" onclick="closeModal();openEditContactModal(\'' + contactId + '\')">‚úèÔ∏è Edit</button>';
        html += '<button class="btn btn-danger btn-small" onclick="deleteContact(\'' + contactId + '\')">üóëÔ∏è</button>';
    }
    html += '<button class="btn btn-primary btn-small" onclick="closeModal();openLogActivityModal()">üìù Activity</button>' +
        '</div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function openEditContactModal(contactId) {
    var contact = null;
    for (var i = 0; i < state.data.contacts.length; i++) {
        if (state.data.contacts[i].id === contactId) { contact = state.data.contacts[i]; break; }
    }
    if (!contact) return;
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Contact</h2></div>' +
        '<div class="form-group"><label>Full Name *</label><input type="text" id="editContactName" value="' + contact.name + '"></div>' +
        '<div class="form-group"><label>Email *</label><input type="email" id="editContactEmail" value="' + contact.email + '"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="editContactPhone" value="' + (contact.phone || '') + '"></div>' +
        '<div class="form-group"><label>Title / Role</label><input type="text" id="editContactRole" value="' + (contact.role || '') + '"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditContact(\'' + contactId + '\')">Save</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function saveEditContact(contactId) {
    var fields = { 'Full Name': document.getElementById('editContactName').value, 'Email': document.getElementById('editContactEmail').value, 'Phone': document.getElementById('editContactPhone').value, 'Title': document.getElementById('editContactRole').value };
    updateInAirtable('Contacts', contactId, fields).then(function() {
        loadContacts().then(function() { closeModal(); renderView('contacts'); });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

function openEditAccountModal(accountId) {
    var account = null;
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (state.data.accounts[i].id === accountId) { account = state.data.accounts[i]; break; }
    }
    if (!account) return;
    var indOptions = '';
    for (var i = 0; i < industryOptions.length; i++) {
        indOptions += '<option value="' + industryOptions[i] + '"' + (account.industry === industryOptions[i] ? ' selected' : '') + '>' + industryOptions[i] + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Account</h2></div>' +
        '<div class="form-group"><label>Account Name *</label><input type="text" id="editAccountName" value="' + account.name + '"></div>' +
        '<div class="form-group"><label>Industry</label><select id="editAccountIndustry"><option value="">Select...</option>' + indOptions + '</select></div>' +
        '<div class="form-group"><label>Website</label><input type="url" id="editAccountWebsite" value="' + (account.website || '') + '"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="editAccountPhone" value="' + (account.phone || '') + '"></div>' +
        '<div class="form-group"><label>Address</label><input type="text" id="editAccountAddress" value="' + (account.address || '') + '"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditAccount(\'' + accountId + '\')">Save</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function saveEditAccount(accountId) {
    var fields = { 'Account Name': document.getElementById('editAccountName').value, 'Industry': document.getElementById('editAccountIndustry').value, 'Website': document.getElementById('editAccountWebsite').value, 'Phone': document.getElementById('editAccountPhone').value, 'Address': document.getElementById('editAccountAddress').value };
    updateInAirtable('Accounts', accountId, fields).then(function() {
        loadAccounts().then(function() { closeModal(); renderView('accounts'); });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

// ============ ADD MODALS ============
function openAddDealModal() {
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Deal</h2></div>' +
        '<div class="form-group"><label>Deal Name *</label><input type="text" id="dealName" placeholder="Enter deal name"></div>' +
        '<div class="form-group"><label>Tier *</label><select id="dealTier" onchange="updateDealValue()"><option value="">Select tier...</option>' +
        '<option value="Starter">Starter ($750)</option><option value="Growth">Growth ($1,250)</option>' +
        '<option value="Pro">Pro ($2,000)</option><option value="Enterprise">Enterprise ($4,200)</option></select></div>' +
        '<div class="form-group"><label>Deal Value *</label><input type="number" id="dealValue" readonly style="background:var(--bg-light);"></div>' +
        '<div class="form-group"><label>Stage</label><select id="dealStage"><option value="Qualified">Qualified</option>' +
        '<option value="Proposal Sent">Proposal Sent</option><option value="Negotiation">Negotiation</option><option value="Closed Won">Closed Won</option></select></div>' +
        '<div class="form-group"><label>Event Name</label><input type="text" id="dealEventName" placeholder="Name of the event"></div>' +
        '<div class="form-group"><label>Close Date</label><input type="date" id="dealCloseDate"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Create Deal</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function updateDealValue() {
    var tier = document.getElementById('dealTier').value;
    document.getElementById('dealValue').value = tier && tierPricing[tier] ? tierPricing[tier] : '';
}

function saveDeal() {
    var dealName = document.getElementById('dealName').value.trim();
    var dealTier = document.getElementById('dealTier').value;
    var dealValue = parseFloat(document.getElementById('dealValue').value) || 0;
    if (!dealName || !dealTier) { alert('Please fill in Deal Name and select Tier'); return; }
    
    var dealData = { 'Deal Name': dealName, 'Amount': dealValue, 'Stage': document.getElementById('dealStage').value };
    if (state.teamMemberMap[state.currentUser.name]) dealData['Owner'] = [state.teamMemberMap[state.currentUser.name]];
    var eventName = document.getElementById('dealEventName').value.trim();
    var closeDate = document.getElementById('dealCloseDate').value;
    if (eventName) dealData['Event Name'] = eventName;
    if (closeDate) dealData['Close Date'] = closeDate;
    createDeal(dealData);
}

function openAddContactModal() {
    var accountOptions = '';
    for (var i = 0; i < state.data.accounts.length; i++) {
        accountOptions += '<option value="' + state.data.accounts[i].id + '">' + state.data.accounts[i].name + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Contact</h2></div>' +
        '<div class="form-group"><label>Full Name *</label><input type="text" id="contactName" placeholder="John Smith"></div>' +
        '<div class="form-group"><label>Email *</label><input type="email" id="contactEmail" placeholder="john@company.com"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="contactPhone" placeholder="(555) 123-4567"></div>' +
        '<div class="form-group"><label>Company / Account</label><select id="contactAccount"><option value="">Select...</option>' + accountOptions + '</select></div>' +
        '<div class="form-group"><label>Title / Role</label><input type="text" id="contactRole" placeholder="Event Coordinator"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveContact()">Create Contact</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function saveContact() {
    var contactData = { 'Full Name': document.getElementById('contactName').value, 'Email': document.getElementById('contactEmail').value, 'Phone': document.getElementById('contactPhone').value, 'Title': document.getElementById('contactRole').value };
    if (!contactData['Full Name'] || !contactData['Email']) { alert('Please fill in Name and Email'); return; }
    if (state.teamMemberMap[state.currentUser.name]) contactData['Contact Owner'] = [state.teamMemberMap[state.currentUser.name]];
    var accountId = document.getElementById('contactAccount').value;
    if (accountId) contactData['Account'] = [accountId];
    createContact(contactData);
}

function openAddAccountModal() {
    var indOptions = '';
    for (var i = 0; i < industryOptions.length; i++) {
        indOptions += '<option value="' + industryOptions[i] + '">' + industryOptions[i] + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Account</h2></div>' +
        '<div class="form-group"><label>Account Name *</label><input type="text" id="accountName" placeholder="Company Name Inc."></div>' +
        '<div class="form-group"><label>Industry *</label><select id="accountIndustry"><option value="">Select...</option>' + indOptions + '</select></div>' +
        '<div class="form-group"><label>Website</label><input type="url" id="accountWebsite" placeholder="https://company.com"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="accountPhone" placeholder="(555) 123-4567"></div>' +
        '<div class="form-group"><label>Address</label><input type="text" id="accountAddress" placeholder="123 Main St, City, State"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveAccount()">Create Account</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function saveAccount() {
    var accountData = { 'Account Name': document.getElementById('accountName').value, 'Industry': document.getElementById('accountIndustry').value, 'Website': document.getElementById('accountWebsite').value, 'Phone': document.getElementById('accountPhone').value, 'Address': document.getElementById('accountAddress').value };
    if (!accountData['Account Name']) { alert('Please enter account name'); return; }
    if (state.teamMemberMap[state.currentUser.name]) accountData['Account Owner'] = [state.teamMemberMap[state.currentUser.name]];
    createAccount(accountData);
}

function openLogActivityModal() {
    var accountOptions = '';
    for (var i = 0; i < state.data.accounts.length; i++) {
        accountOptions += '<option value="' + state.data.accounts[i].id + '">' + state.data.accounts[i].name + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìù Log Activity</h2></div>' +
        '<div class="form-group"><label>Activity Type *</label><select id="activityType">' +
        '<option value="Call">üìû Call</option><option value="Email">üìß Email</option><option value="LinkedIn">üíº LinkedIn Message</option>' +
        '<option value="Discovery Call">üîç Discovery Call</option><option value="Demo">üé• Demo</option>' +
        '<option value="Proposal">üìÑ Proposal Sent</option><option value="Follow-up">üîÑ Follow-up</option><option value="Meeting">üìÖ Meeting</option></select></div>' +
        '<div class="form-group"><label>Account *</label><select id="activityAccount"><option value="">Select...</option>' + accountOptions + '</select></div>' +
        '<div class="form-group"><label>Result / Outcome *</label><textarea id="activityResult" placeholder="What happened?"></textarea></div>' +
        '<div class="form-group"><label>Next Steps</label><textarea id="activityNextSteps" placeholder="What\'s next?" style="min-height:80px;"></textarea></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveActivity()">Log Activity</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function openLogActivityModalForAccount(accountName) {
    openLogActivityModal();
    setTimeout(function() {
        var accountSelect = document.getElementById('activityAccount');
        for (var i = 0; i < state.data.accounts.length; i++) {
            if (state.data.accounts[i].name === accountName) {
                accountSelect.value = state.data.accounts[i].id;
                break;
            }
        }
    }, 100);
}

function saveActivity() {
    var accountRecordId = document.getElementById('activityAccount').value;
    var result = document.getElementById('activityResult').value;
    if (!accountRecordId || !result) { alert('Please select an Account and enter Result'); return; }
    
    var account = null;
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (state.data.accounts[i].id === accountRecordId) { account = state.data.accounts[i]; break; }
    }
    var accountName = account ? account.name : '';
    var activityType = document.getElementById('activityType').value;
    var now = new Date();
    
    var activityData = { 'Activity Name': activityType + ' - ' + accountName, 'Type': activityType, 'Date': now.toISOString().split('T')[0], 'Activity Date/Time': now.toISOString(), 'Account': accountName, 'Owner': state.currentUser.name, 'Result': result };
    var nextSteps = document.getElementById('activityNextSteps').value;
    if (nextSteps) activityData['Next Steps'] = nextSteps;
    logActivity(activityData);
}

function openDealDetailsModal(dealId) {
    var deal = null;
    for (var i = 0; i < state.data.deals.length; i++) {
        if (state.data.deals[i].id === dealId) { deal = state.data.deals[i]; break; }
    }
    if (!deal) return;
    var isLeadership = state.currentUser.role === 'Leadership';
    var dealAge = getDaysSince(deal.createdTime);
    var currentWeek = Math.min(Math.ceil(dealAge / 7) || 1, 9);
    var cadenceItem = TOUCHPOINT_CADENCE[currentWeek - 1];
    
    var stageOptions = '<option value="Qualified"' + (deal.stage === 'Qualified' ? ' selected' : '') + '>Qualified</option>' +
        '<option value="Proposal Sent"' + (deal.stage === 'Proposal Sent' ? ' selected' : '') + '>Proposal Sent</option>' +
        '<option value="Negotiation"' + (deal.stage === 'Negotiation' ? ' selected' : '') + '>Negotiation</option>' +
        '<option value="Closed Won"' + (deal.stage === 'Closed Won' ? ' selected' : '') + '>Closed Won</option>' +
        '<option value="Closed Lost"' + (deal.stage === 'Closed Lost' ? ' selected' : '') + '>Closed Lost</option>';
    
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìä ' + deal.name + '</h2></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;">' +
        '<div style="background:var(--bg-light);padding:14px;border-radius:10px;text-align:center;"><div style="font-size:26px;font-weight:700;color:var(--primary);">$' + deal.value.toLocaleString() + '</div><div style="font-size:12px;color:var(--text-gray);">Deal Value</div></div>' +
        '<div style="background:var(--bg-light);padding:14px;border-radius:10px;text-align:center;"><span class="badge badge-' + deal.tier.toLowerCase() + '" style="font-size:13px;">' + deal.tier + '</span><div style="font-size:12px;color:var(--text-gray);margin-top:6px;">Tier</div></div></div>' +
        '<div style="background:#dbeafe;padding:16px;border-radius:10px;margin-bottom:20px;">' +
        '<div style="font-weight:700;font-size:14px;margin-bottom:8px;">üìÖ Week ' + currentWeek + ' - ' + cadenceItem.action + '</div>' +
        '<div style="font-size:13px;color:var(--text-gray);">' + cadenceItem.goal + '</div></div>' +
        '<div class="form-group"><label>Event Name</label><input type="text" value="' + (deal.eventName || 'Not set') + '" disabled></div>' +
        '<div class="form-group"><label>Owner</label><input type="text" value="' + deal.owner + '" disabled></div>' +
        '<div class="form-group"><label>Current Stage</label><select id="dealStageEdit">' + stageOptions + '</select></div>' +
        '<div class="modal-actions">';
    if (isLeadership) html += '<button class="btn btn-danger" onclick="deleteDeal(\'' + dealId + '\')">üóëÔ∏è Delete</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="updateDealStage(\'' + dealId + '\')">Update</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function updateDealStage(dealId, newStage) {
    if (!newStage) newStage = document.getElementById('dealStageEdit').value;
    var oldDeal = null;
    for (var i = 0; i < state.data.deals.length; i++) {
        if (state.data.deals[i].id === dealId) { oldDeal = state.data.deals[i]; break; }
    }
    var oldStage = oldDeal ? oldDeal.stage : '';
    
    var url = 'https://api.airtable.com/v0/' + state.baseId + '/Deals/' + dealId;
    fetch(url, {
        method: 'PATCH', headers: { 'Authorization': 'Bearer ' + state.apiKey, 'Content-Type': 'application/json' },
        body: JSON.stringify({ fields: { 'Stage': newStage } })
    }).then(function() {
        loadDeals().then(function() {
            closeModal();
            renderView('pipeline');
            
            if (oldStage && newStage !== oldStage && newStage !== 'Closed Lost') {
                if (newStage === 'Closed Won') {
                    showCelebration('deal-won', 'You closed the deal! ' + oldDeal.name + ' is now won!');
                } else {
                    showCelebration('deal-moved', oldDeal.name + ' moved from ' + oldStage + ' to ' + newStage + '!');
                }
            }
        });
    }).catch(function(error) { alert('Error: ' + error.message); });
}

// ============ VIEW RENDERING ============
function renderView(viewName) {
    destroyCharts();
    state.currentView = viewName;
    state.filterRep = null;
    var titles = { 'dashboard': 'Dashboard', 'checklist': 'Daily Checklist', 'pipeline': 'Pipeline', 'contacts': 'Contacts', 'accounts': 'Accounts', 'events': 'Events', 'activity': 'Activities', 'reports': 'Reports', 'leadership': 'Analytics', 'team': 'Team Overview' };
    document.getElementById('pageTitle').textContent = titles[viewName] || viewName;
    
    if (viewName === 'dashboard') renderDashboard();
    else if (viewName === 'checklist') renderChecklist();
    else if (viewName === 'pipeline') renderPipeline();
    else if (viewName === 'contacts') renderContacts();
    else if (viewName === 'accounts') renderAccounts();
    else if (viewName === 'events') renderEvents();
    else if (viewName === 'activity') renderActivityView();
    else if (viewName === 'reports') renderReports();
    else if (viewName === 'leadership') renderLeadershipAnalytics();
    else if (viewName === 'team') renderTeamOverview();
    
    buildNavigation();
}

function renderDashboard() {
    if (state.currentUser.role === 'Leadership') { renderLeadershipDashboard(); return; }
    renderRepDashboard();
}

function renderRepDashboard() {
    var deals = getUserDeals();
    var targets = getKPITargets(state.currentUser.role);
    var today = new Date();
    var todayISO = today.toISOString().split('T')[0];
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    var userActivities = state.data.activities.filter(function(a) { return a.owner === state.currentUser.name; });
    var todayActivities = userActivities.filter(function(a) { return a.date && a.date.split('T')[0] === todayISO; });
    var todayTouchpoints = todayActivities.length;
    var todayNewLeads = state.data.contacts.filter(function(c) { return c.owner === state.currentUser.name && c.createdTime && c.createdTime.split('T')[0] === todayISO; }).length;
    
    var todayStats = getActivityStats(todayActivities);
    var allTimeStats = getActivityStats(userActivities);
    
    var monthClosedDeals = deals.filter(function(d) {
        if (d.stage.toLowerCase().indexOf('won') === -1) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var monthRevenue = 0;
    for (var i = 0; i < monthClosedDeals.length; i++) monthRevenue += monthClosedDeals[i].value;
    var revenuePercentOfMax = (monthRevenue / targets.monthlyRevenueMax) * 100;
    var eventsPercentOfMax = (monthClosedDeals.length / targets.monthlyEventsMax) * 100;
    
    var growthPlusCount = monthClosedDeals.filter(function(d) { return d.tier !== 'Starter'; }).length;
    var qualityScore = monthClosedDeals.length > 0 ? (growthPlusCount / monthClosedDeals.length) * 100 : 0;
    
    var pipelineDeals = deals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') === -1 && d.stage.toLowerCase().indexOf('lost') === -1; });
    var staleDeals = [];
    for (var i = 0; i < pipelineDeals.length; i++) {
        var deal = pipelineDeals[i];
        var lastActivity = null;
        for (var j = 0; j < userActivities.length; j++) {
            if (userActivities[j].account && deal.name.toLowerCase().indexOf(userActivities[j].account.toLowerCase()) !== -1) {
                if (!lastActivity || new Date(userActivities[j].date) > new Date(lastActivity.date)) lastActivity = userActivities[j];
            }
        }
        if (!lastActivity || getDaysSince(lastActivity.date) >= 5) staleDeals.push(deal);
    }
    
    var allClosedDeals = deals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') !== -1; }).sort(function(a, b) { return new Date(b.closeDate || b.createdTime) - new Date(a.closeDate || a.createdTime); });
    
    function getStatusColor(value, target) { return value >= target ? 'var(--success)' : value >= target * 0.5 ? 'var(--warning)' : 'var(--danger)'; }
    function getStatusIcon(value, target) { return value >= target ? '‚úÖ' : value >= target * 0.5 ? '‚ö†Ô∏è' : '‚ùå'; }
    
    var greeting = getGreeting() + ', ' + state.currentUser.name + '!';
    var dateStr = today.toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric'});

    var html = '<div class="greeting-banner"><div class="greeting-text">' + greeting + '</div><div class="greeting-sub">"Talk to people. Move deals. Protect pricing."</div></div>' +
        renderNudges() +
        '<div class="quick-actions">' +
        '<button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï New Deal</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openLogActivityModal()">üìù Log Activity</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddContactModal()">üë§ Contact</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddAccountModal()">üè¢ Account</button>' +
        '<button class="btn btn-success btn-small" onclick="renderView(\'checklist\')">‚úÖ Daily Checklist</button></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìÖ Daily Scorecard</h2><span style="font-size:13px;color:var(--text-gray);">' + dateStr + '</span></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;">' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Touchpoints</span><span>' + getStatusIcon(todayTouchpoints,targets.dailyTouchpointsMin) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin) + ';">' + todayTouchpoints + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyTouchpointsMin + '-' + targets.dailyTouchpointsMax + '</div><div class="progress-bar"><div class="progress-fill" style="width:' + Math.min((todayTouchpoints/targets.dailyTouchpointsMax)*100,100) + '%;background:' + getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin) + ';"></div></div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.calls,targets.dailyCalls) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Calls Made</span><span>' + getStatusIcon(todayStats.calls,targets.dailyCalls) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.calls,targets.dailyCalls) + ';">' + todayStats.calls + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyCalls + '+</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.emails,targets.dailyEmails) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Emails Sent</span><span>' + getStatusIcon(todayStats.emails,targets.dailyEmails) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.emails,targets.dailyEmails) + ';">' + todayStats.emails + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyEmails + '+</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.linkedin,targets.dailyLinkedIn) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">LinkedIn</span><span>' + getStatusIcon(todayStats.linkedin,targets.dailyLinkedIn) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.linkedin,targets.dailyLinkedIn) + ';">' + todayStats.linkedin + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyLinkedIn + '+</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.followups,10) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Follow-ups</span><span>' + getStatusIcon(todayStats.followups,10) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.followups,10) + ';">' + todayStats.followups + '</div><div style="font-size:12px;color:var(--text-gray);">Target: 10-15</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + (staleDeals.length > 0 ? 'var(--warning)' : 'var(--success)') + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Needs Attention</span><span>' + (staleDeals.length > 0 ? '‚ö†Ô∏è' : '‚úÖ') + '</span></div><div class="kpi-value" style="color:' + (staleDeals.length > 0 ? 'var(--warning)' : 'var(--success)') + ';">' + staleDeals.length + '</div><div style="font-size:12px;color:var(--text-gray);">Stale 5+ days</div></div>' +
        '</div></div>' +
        
        '<div class="kpi-grid">' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üí∞ MONTHLY REVENUE</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">$' + (monthRevenue/1000).toFixed(1) + 'K</div><div style="font-size:13px;opacity:0.9;margin-bottom:12px;">Target: $' + (targets.monthlyRevenueMin/1000).toFixed(1) + 'K - $' + (targets.monthlyRevenueMax/1000).toFixed(1) + 'K</div><div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;"><div style="width:' + Math.min(revenuePercentOfMax,100) + '%;height:100%;background:white;border-radius:4px;"></div></div><div style="font-size:13px;font-weight:600;margin-top:8px;">' + revenuePercentOfMax.toFixed(0) + '% of Max</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üéâ EVENTS CLOSED</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">' + monthClosedDeals.length + '</div><div style="font-size:13px;opacity:0.9;margin-bottom:12px;">Target: ' + targets.monthlyEventsMin + '-' + targets.monthlyEventsMax + '</div><div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;"><div style="width:' + Math.min(eventsPercentOfMax,100) + '%;height:100%;background:white;border-radius:4px;"></div></div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üìä QUALITY SCORE</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">' + qualityScore.toFixed(0) + '%</div><div style="font-size:13px;opacity:0.9;">' + (qualityScore >= 70 ? '‚úÖ' : '‚ö†Ô∏è') + ' 70%+ Growth+ Required</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üíµ AVG DEAL SIZE</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">' + (monthClosedDeals.length > 0 ? '$' + Math.round(monthRevenue/monthClosedDeals.length).toLocaleString() : '$0') + '</div><div style="font-size:13px;opacity:0.9;">This month</div></div>' +
        '</div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä Activity Breakdown (All Time)</h2></div>' +
        '<div class="activity-stats">' +
        '<div class="stat-card"><div class="stat-icon">üìû</div><div class="stat-value">' + allTimeStats.calls + '</div><div class="stat-label">Calls Made</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìß</div><div class="stat-value">' + allTimeStats.emails + '</div><div class="stat-label">Emails Sent</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üíº</div><div class="stat-value">' + allTimeStats.linkedin + '</div><div class="stat-label">LinkedIn</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üîÑ</div><div class="stat-value">' + allTimeStats.followups + '</div><div class="stat-label">Follow-ups</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üé•</div><div class="stat-value">' + allTimeStats.demos + '</div><div class="stat-label">Demos</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìÑ</div><div class="stat-value">' + allTimeStats.proposals + '</div><div class="stat-label">Proposals</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üéâ</div><div class="stat-value">' + allClosedDeals.length + '</div><div class="stat-label">Total Wins</div></div>' +
        '</div></div>';
    
    // Recent wins
    if (allClosedDeals.length > 0) {
        html += '<div class="card"><div class="card-header"><h2 class="card-title">üèÜ Recent Wins</h2></div><div style="display:flex;flex-direction:column;gap:10px;">';
        for (var i = 0; i < Math.min(allClosedDeals.length, 5); i++) {
            var deal = allClosedDeals[i];
            var daysAgo = getDaysSince(deal.closeDate);
            html += '<div style="background:var(--bg-light);padding:14px 18px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;" onclick="openDealDetailsModal(\'' + deal.id + '\')">' +
                '<div><div style="font-weight:600;font-size:15px;margin-bottom:4px;">' + deal.name + '</div><div style="font-size:12px;color:var(--text-gray);"><span class="badge badge-' + deal.tier.toLowerCase() + '">' + deal.tier + '</span> ' + (daysAgo !== null ? (daysAgo === 0 ? '‚Ä¢ Today' : '‚Ä¢ ' + daysAgo + ' days ago') : '') + '</div></div>' +
                '<div style="font-size:20px;font-weight:700;color:var(--primary);">$' + deal.value.toLocaleString() + '</div></div>';
        }
        html += '</div></div>';
    }
    
    html += '<div class="charts-grid">' +
        '<div class="chart-card"><h3>üìà Revenue Trend (6 Months)</h3><div class="chart-container"><canvas id="repRevenueTrendChart"></canvas></div></div>' +
        '<div class="chart-card"><h3>ü•ß Revenue by Tier</h3><div class="chart-container"><canvas id="repRevenueByTierChart"></canvas></div></div></div>';
    
    document.getElementById('contentArea').innerHTML = html;
    
    setTimeout(function() {
        renderRevenueTrendChart('repRevenueTrendChart', deals);
        renderRevenueByTierChart('repRevenueByTierChart', deals);
    }, 100);
}

// Daily Checklist
function renderChecklist() {
    var totalItems = 0, completedItems = 0;
    for (var i = 0; i < DAILY_CHECKLIST.length; i++) {
        totalItems += DAILY_CHECKLIST[i].items.length;
        for (var j = 0; j < DAILY_CHECKLIST[i].items.length; j++) {
            var key = DAILY_CHECKLIST[i].id + '-' + j;
            if (state.dailyChecklist[key]) completedItems++;
        }
    }
    var progress = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
    
    var today = new Date().toLocaleDateString('en-US', {weekday:'long',month:'long',day:'numeric',year:'numeric'});
    
    var html = '<div class="greeting-banner"><div class="greeting-text">‚úÖ Daily Checklist</div><div class="greeting-sub">' + today + '</div></div>' +
        '<div class="card"><div class="card-header"><h2 class="card-title">üìå Daily Mantra</h2></div>' +
        '<div style="text-align:center;padding:20px;font-size:24px;font-weight:700;color:var(--primary);">"Talk to people. Move deals. Protect pricing."</div></div>' +
        
        '<div class="card"><div class="checklist-progress"><div class="checklist-progress-text">' + completedItems + '/' + totalItems + ' completed</div>' +
        '<div style="flex:1;"><div class="progress-bar" style="height:12px;"><div class="progress-fill" style="width:' + progress + '%;background:var(--success);"></div></div></div>' +
        '<div style="font-weight:700;color:' + (progress >= 100 ? 'var(--success)' : 'var(--primary)') + ';">' + progress.toFixed(0) + '%</div></div>';
    
    for (var i = 0; i < DAILY_CHECKLIST.length; i++) {
        var section = DAILY_CHECKLIST[i];
        var sectionCompleted = 0;
        for (var j = 0; j < section.items.length; j++) {
            if (state.dailyChecklist[section.id + '-' + j]) sectionCompleted++;
        }
        
        html += '<div class="checklist-section"><div class="checklist-title">' + section.title + ' <span style="font-weight:400;color:var(--text-gray);">(' + sectionCompleted + '/' + section.items.length + ')</span></div>';
        for (var j = 0; j < section.items.length; j++) {
            var key = section.id + '-' + j;
            var checked = state.dailyChecklist[key] ? ' checked' : '';
            var completedClass = state.dailyChecklist[key] ? ' completed' : '';
            html += '<div class="checklist-item' + completedClass + '">' +
                '<input type="checkbox" id="' + key + '"' + checked + ' onchange="toggleChecklistItem(\'' + key + '\')">' +
                '<label for="' + key + '">' + section.items[j] + '</label></div>';
        }
        html += '</div>';
    }
    
    html += '</div>' +
        '<div class="card" style="background:linear-gradient(135deg,#dbeafe 0%,#bfdbfe 100%);border-left:4px solid var(--primary);">' +
        '<div style="font-weight:700;margin-bottom:8px;">‚ùå If any End of Day answer is NO ‚Üí tomorrow starts behind.</div></div>' +
        '<div class="card" style="background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);">' +
        '<div style="font-weight:700;margin-bottom:8px;">‚úî A "Good Day" at NuConnect Means:</div>' +
        '<ul style="margin-left:20px;font-size:14px;"><li>Consistent lead volume</li><li>Clean pipeline</li><li>Momentum toward meetings and closes</li></ul>' +
        '<div style="margin-top:12px;font-style:italic;color:var(--text-gray);">Consistency beats intensity. Show up, follow the system, and results will follow.</div></div>' +
;
    
    document.getElementById('contentArea').innerHTML = html;
}

function toggleChecklistItem(key) {
    state.dailyChecklist[key] = !state.dailyChecklist[key];
    localStorage.setItem('dailyChecklist_' + new Date().toDateString(), JSON.stringify(state.dailyChecklist));
    
    var totalItems = 0, completedItems = 0;
    for (var i = 0; i < DAILY_CHECKLIST.length; i++) {
        totalItems += DAILY_CHECKLIST[i].items.length;
        for (var j = 0; j < DAILY_CHECKLIST[i].items.length; j++) {
            if (state.dailyChecklist[DAILY_CHECKLIST[i].id + '-' + j]) completedItems++;
        }
    }
    
    if (completedItems === totalItems) {
        showCelebration('kpi-hit', 'You completed your entire daily checklist! Amazing work!');
    }
    
    renderChecklist();
}

// Leadership Dashboard
function renderLeadershipDashboard() {
    var allDeals = state.data.deals;
    var allActivities = state.data.activities;
    var today = new Date();
    var todayISO = today.toISOString().split('T')[0];
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    var todayActivities = allActivities.filter(function(a) { return a.date && a.date.split('T')[0] === todayISO; });
    var teamStats = getActivityStats(todayActivities);
    
    var monthClosedDeals = allDeals.filter(function(d) {
        if (d.stage.toLowerCase().indexOf('won') === -1) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var monthRevenue = 0;
    for (var i = 0; i < monthClosedDeals.length; i++) monthRevenue += monthClosedDeals[i].value;
    var growthPlusDeals = monthClosedDeals.filter(function(d) { return d.tier !== 'Starter'; }).length;
    var qualityScore = monthClosedDeals.length > 0 ? (growthPlusDeals / monthClosedDeals.length) * 100 : 0;
    
    var greeting = getGreeting() + ', ' + state.currentUser.name + '!';
    
    // Build rep cards
    var repCardsHtml = '';
    var reps = state.data.teamMembers.filter(function(m) { return m.role !== 'Leadership'; });
    
    for (var i = 0; i < reps.length; i++) {
        var member = reps[i];
        var memberDeals = allDeals.filter(function(d) { return d.owner === member.name; });
        var memberActivities = allActivities.filter(function(a) { return a.owner === member.name; });
        var memberTodayActivities = todayActivities.filter(function(a) { return a.owner === member.name; });
        var memberStats = getActivityStats(memberTodayActivities);
        
        var memberMonthWon = memberDeals.filter(function(d) {
            if (d.stage.toLowerCase().indexOf('won') === -1) return false;
            var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return dealDate && dealDate >= monthStart;
        });
        var memberRevenue = 0;
        for (var j = 0; j < memberMonthWon.length; j++) memberRevenue += memberMonthWon[j].value;
        var targets = getKPITargets(member.role);
        var attainment = (memberRevenue / targets.monthlyRevenueMax) * 100;
        
        var cardClass = attainment >= 100 ? '' : attainment >= 70 ? ' yellow' : ' red';
        var statusEmoji = attainment >= 100 ? 'üü¢' : attainment >= 70 ? 'üü°' : 'üî¥';
        
        repCardsHtml += '<div class="rep-card' + cardClass + '" onclick="openRepDetailsModal(\'' + member.id + '\')">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:12px;">' +
            '<div><div style="font-size:16px;font-weight:700;">' + statusEmoji + ' ' + member.name + '</div><div style="font-size:12px;color:var(--text-gray);">' + member.role + '</div></div></div>' +
            '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;text-align:center;">' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberStats.calls + '</div><div style="font-size:10px;color:var(--text-gray);">Calls</div></div>' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberStats.emails + '</div><div style="font-size:10px;color:var(--text-gray);">Emails</div></div>' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberStats.linkedin + '</div><div style="font-size:10px;color:var(--text-gray);">LinkedIn</div></div>' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberTodayActivities.length + '</div><div style="font-size:10px;color:var(--text-gray);">Total</div></div></div>' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
            '<div><div style="font-size:12px;color:var(--text-gray);">Month Revenue</div><div style="font-size:22px;font-weight:700;color:var(--primary);">$' + (memberRevenue/1000).toFixed(1) + 'K</div></div>' +
            '<div style="text-align:right;"><div style="font-size:12px;color:var(--text-gray);">% of Max</div><div style="font-size:22px;font-weight:700;color:var(--primary);">' + attainment.toFixed(0) + '%</div></div></div>' +
            '<div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(attainment,100) + '%;background:' + (attainment >= 100 ? 'var(--success)' : attainment >= 70 ? 'var(--warning)' : 'var(--danger)') + ';"></div></div></div>';
    }

    // Recent wins
    var allWonDeals = allDeals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') !== -1; })
        .sort(function(a,b) { return new Date(b.closeDate || b.createdTime) - new Date(a.closeDate || a.createdTime); });
    
    var recentWinsHtml = '';
    for (var i = 0; i < Math.min(allWonDeals.length, 5); i++) {
        var deal = allWonDeals[i];
        var daysAgo = getDaysSince(deal.closeDate);
        recentWinsHtml += '<div style="background:var(--bg-light);padding:14px 18px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;margin-bottom:10px;" onclick="openDealDetailsModal(\'' + deal.id + '\')">' +
            '<div><div style="font-weight:600;font-size:15px;margin-bottom:4px;">' + deal.name + '</div><div style="font-size:12px;color:var(--text-gray);">' + deal.owner + ' ‚Ä¢ <span class="badge badge-' + deal.tier.toLowerCase() + '">' + deal.tier + '</span> ' + (daysAgo !== null ? (daysAgo === 0 ? '‚Ä¢ Today' : '‚Ä¢ ' + daysAgo + ' days ago') : '') + '</div></div>' +
            '<div style="font-size:20px;font-weight:700;color:var(--primary);">$' + deal.value.toLocaleString() + '</div></div>';
    }

    var html = '<div class="greeting-banner"><div class="greeting-text">' + greeting + '</div><div class="greeting-sub">Here\'s how the team is performing.</div></div>' +
        '<div class="quick-actions">' +
        '<button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï Deal</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openLogActivityModal()">üìù Activity</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddContactModal()">üë§ Contact</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddAccountModal()">üè¢ Account</button></div>' +
        
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px;">' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üí∞ TEAM REVENUE</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">$' + (monthRevenue/1000).toFixed(1) + 'K</div><div style="font-size:12px;opacity:0.9;">Target: $' + KPI_TARGETS.Team.monthlyRevenueMin/1000 + 'K-$' + KPI_TARGETS.Team.monthlyRevenueMax/1000 + 'K</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üéâ TEAM EVENTS</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">' + monthClosedDeals.length + '</div><div style="font-size:12px;opacity:0.9;">Target: ' + KPI_TARGETS.Team.monthlyEventsMin + '-' + KPI_TARGETS.Team.monthlyEventsMax + '</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üìä QUALITY</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">' + qualityScore.toFixed(0) + '%</div><div style="font-size:12px;opacity:0.9;">Growth+ (70% Target)</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üî• TODAY</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">' + todayActivities.length + '</div><div style="font-size:12px;opacity:0.9;">Touchpoints</div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä Team Activity Today</h2></div>' +
        '<div class="activity-stats">' +
        '<div class="stat-card"><div class="stat-icon">üìû</div><div class="stat-value">' + teamStats.calls + '</div><div class="stat-label">Calls</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìß</div><div class="stat-value">' + teamStats.emails + '</div><div class="stat-label">Emails</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üíº</div><div class="stat-value">' + teamStats.linkedin + '</div><div class="stat-label">LinkedIn</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üîÑ</div><div class="stat-value">' + teamStats.followups + '</div><div class="stat-label">Follow-ups</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üé•</div><div class="stat-value">' + teamStats.demos + '</div><div class="stat-label">Demos</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìÑ</div><div class="stat-value">' + teamStats.proposals + '</div><div class="stat-label">Proposals</div></div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üë• Sales Team</h2></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">' + repCardsHtml + '</div></div>';
    
    if (allWonDeals.length > 0) {
        html += '<div class="card"><div class="card-header"><h2 class="card-title">üèÜ Recent Wins</h2></div>' + recentWinsHtml + '</div>';
    }
    
    document.getElementById('contentArea').innerHTML = html;
}

function openRepDetailsModal(memberId) {
    var member = null;
    for (var i = 0; i < state.data.teamMembers.length; i++) {
        if (state.data.teamMembers[i].id === memberId) { member = state.data.teamMembers[i]; break; }
    }
    if (!member) return;
    
    var today = new Date();
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    var todayISO = today.toISOString().split('T')[0];
    var targets = getKPITargets(member.role);
    
    var memberDeals = state.data.deals.filter(function(d) { return d.owner === member.name; });
    var memberActivities = state.data.activities.filter(function(a) { return a.owner === member.name; });
    var memberTodayActivities = memberActivities.filter(function(a) { return a.date && a.date.split('T')[0] === todayISO; });
    
    var memberMonthWon = memberDeals.filter(function(d) {
        if (d.stage.toLowerCase().indexOf('won') === -1) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var todayStats = getActivityStats(memberTodayActivities);
    var allStats = getActivityStats(memberActivities);
    var memberRevenue = 0;
    for (var i = 0; i < memberMonthWon.length; i++) memberRevenue += memberMonthWon[i].value;
    var revenuePercentOfMax = (memberRevenue / targets.monthlyRevenueMax) * 100;
    
    // All time deals
    var allWon = memberDeals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') !== -1; });
    var allTimeRevenue = 0;
    for (var i = 0; i < allWon.length; i++) allTimeRevenue += allWon[i].value;
    
    // Recent activities list (clickable)
    var recentActivities = memberActivities.sort(function(a,b) { return new Date(b.date) - new Date(a.date); }).slice(0, 5);
    var activitiesHtml = '';
    for (var i = 0; i < recentActivities.length; i++) {
        var a = recentActivities[i];
        activitiesHtml += '<div class="clickable-link" style="padding:6px 0;border-bottom:1px solid var(--border);" onclick="closeModal();state.filterRep=\'' + member.name + '\';renderView(\'activity\');">' + a.type + ' - ' + a.account + ' (' + formatDateShort(a.date) + ')</div>';
    }
    if (recentActivities.length === 0) activitiesHtml = '<div style="color:var(--text-gray);">No recent activities</div>';
    
    var html = '<div class="modal active"><div class="modal-content wide"><div class="modal-header"><h2>' + member.name + ' - Performance</h2></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px;margin-bottom:20px;">' +
        '<div class="stat-card clickable" onclick="closeModal();state.filterRep=\'' + member.name + '\';renderView(\'activity\');"><div style="font-size:10px;color:var(--text-gray);">Today Calls</div><div style="font-size:24px;font-weight:700;color:var(--primary);">' + todayStats.calls + '</div></div>' +
        '<div class="stat-card clickable" onclick="closeModal();state.filterRep=\'' + member.name + '\';renderView(\'activity\');"><div style="font-size:10px;color:var(--text-gray);">Today Emails</div><div style="font-size:24px;font-weight:700;color:var(--primary);">' + todayStats.emails + '</div></div>' +
        '<div class="stat-card clickable" onclick="closeModal();state.filterRep=\'' + member.name + '\';renderView(\'activity\');"><div style="font-size:10px;color:var(--text-gray);">Today LinkedIn</div><div style="font-size:24px;font-weight:700;color:var(--primary);">' + todayStats.linkedin + '</div></div>' +
        '<div class="stat-card clickable" onclick="closeModal();state.filterRep=\'' + member.name + '\';renderView(\'activity\');"><div style="font-size:10px;color:var(--text-gray);">Today Follow-ups</div><div style="font-size:24px;font-weight:700;color:var(--primary);">' + todayStats.followups + '</div></div>' +
        '<div class="stat-card"><div style="font-size:10px;color:var(--text-gray);">All Calls</div><div style="font-size:24px;font-weight:700;">' + allStats.calls + '</div></div>' +
        '<div class="stat-card"><div style="font-size:10px;color:var(--text-gray);">All Emails</div><div style="font-size:24px;font-weight:700;">' + allStats.emails + '</div></div>' +
        '<div class="stat-card"><div style="font-size:10px;color:var(--text-gray);">All LinkedIn</div><div style="font-size:24px;font-weight:700;">' + allStats.linkedin + '</div></div>' +
        '<div class="stat-card"><div style="font-size:10px;color:var(--text-gray);">Total Activities</div><div style="font-size:24px;font-weight:700;">' + memberActivities.length + '</div></div></div>' +
        
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">' +
        '<div style="background:var(--bg-light);padding:20px;border-radius:12px;">' +
        '<div style="font-size:12px;color:var(--text-gray);margin-bottom:8px;">Monthly Revenue</div>' +
        '<div style="font-size:32px;font-weight:800;color:var(--primary);">$' + (memberRevenue/1000).toFixed(1) + 'K</div>' +
        '<div style="font-size:12px;color:var(--text-gray);">Target: $' + (targets.monthlyRevenueMin/1000).toFixed(1) + 'K-$' + (targets.monthlyRevenueMax/1000).toFixed(1) + 'K</div>' +
        '<div class="progress-bar" style="height:10px;margin-top:10px;"><div class="progress-fill" style="width:' + Math.min(revenuePercentOfMax,100) + '%;background:var(--success);"></div></div>' +
        '<div style="text-align:right;font-size:13px;font-weight:700;margin-top:4px;">' + revenuePercentOfMax.toFixed(0) + '%</div></div>' +
        
        '<div style="background:var(--bg-light);padding:20px;border-radius:12px;">' +
        '<div style="font-size:12px;color:var(--text-gray);margin-bottom:8px;">All-Time Stats</div>' +
        '<div style="font-size:32px;font-weight:800;color:var(--success);">$' + (allTimeRevenue/1000).toFixed(1) + 'K</div>' +
        '<div style="font-size:12px;color:var(--text-gray);">' + allWon.length + ' deals won all time</div></div></div>' +
        
        '<div style="margin-bottom:20px;"><div style="font-weight:600;margin-bottom:10px;">üìù Recent Activities (Click to view all)</div>' + activitiesHtml + '</div>' +
        
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Close</button>' +
        '<button class="btn btn-primary" onclick="closeModal();state.filterRep=\'' + member.name + '\';renderView(\'activity\');">View All Activities</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function renderLeadershipAnalytics() {
    var allDeals = state.data.deals;
    var allActivities = state.data.activities;
    var today = new Date();
    var yearStart = new Date(today.getFullYear(), 0, 1);
    
    var yearDeals = allDeals.filter(function(d) { var dt = d.createdTime ? new Date(d.createdTime) : null; return dt && dt >= yearStart; });
    var floorDeals = yearDeals.filter(function(d) { return d.pricingType === 'Floor Price'; });
    var totalFloorUsed = floorDeals.length;
    
    // All time stats by rep
    var reps = state.data.teamMembers.filter(function(m) { return m.role !== 'Leadership'; });
    var repStatsHtml = '<table><thead><tr><th>Rep</th><th>Role</th><th>All-Time Revenue</th><th>All-Time Deals</th><th>Total Activities</th><th>Calls</th><th>Emails</th><th>LinkedIn</th></tr></thead><tbody>';
    
    for (var i = 0; i < reps.length; i++) {
        var rep = reps[i];
        var repDeals = allDeals.filter(function(d) { return d.owner === rep.name && d.stage.toLowerCase().indexOf('won') !== -1; });
        var repActivities = allActivities.filter(function(a) { return a.owner === rep.name; });
        var repStats = getActivityStats(repActivities);
        var repRevenue = 0;
        for (var j = 0; j < repDeals.length; j++) repRevenue += repDeals[j].value;
        
        repStatsHtml += '<tr onclick="openRepDetailsModal(\'' + rep.id + '\')" class="clickable">' +
            '<td><strong>' + rep.name + '</strong></td>' +
            '<td>' + rep.role + '</td>' +
            '<td>$' + repRevenue.toLocaleString() + '</td>' +
            '<td>' + repDeals.length + '</td>' +
            '<td>' + repActivities.length + '</td>' +
            '<td>' + repStats.calls + '</td>' +
            '<td>' + repStats.emails + '</td>' +
            '<td>' + repStats.linkedin + '</td></tr>';
    }
    repStatsHtml += '</tbody></table>';

    var html = '<div class="tabs">' +
        '<div class="tab active" onclick="renderLeadershipAnalytics()">üìä Analytics</div>' +
        '<div class="tab" onclick="renderTeamOverview()">üë• Team Overview</div></div>' +
        
        '<div class="charts-grid">' +
        '<div class="chart-card"><h3>üìà Team Revenue (6 Months)</h3><div class="chart-container"><canvas id="teamRevenueTrendChart"></canvas></div></div>' +
        '<div class="chart-card"><h3>ü•ß Revenue by Tier</h3><div class="chart-container"><canvas id="teamRevenueByTierChart"></canvas></div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä All-Time Rep Performance</h2></div>' + repStatsHtml + '</div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üö® Floor-Price Capacity (' + today.getFullYear() + ')</h2></div>' +
        '<div style="text-align:center;padding:30px;"><div style="width:160px;height:160px;margin:0 auto 16px;border-radius:50%;background:var(--gradient);display:flex;flex-direction:column;align-items:center;justify-content:center;color:white;box-shadow:0 8px 24px rgba(102,126,234,0.3);">' +
        '<div style="font-size:42px;font-weight:800;">' + totalFloorUsed + '/10</div><div style="font-size:13px;opacity:0.9;">used</div></div>' +
        '<p style="color:var(--text-gray);">Remaining: <strong>' + (10 - totalFloorUsed) + '</strong> floor-price events</p></div></div>';
    
    document.getElementById('contentArea').innerHTML = html;
    
    setTimeout(function() {
        renderRevenueTrendChart('teamRevenueTrendChart', allDeals, 'Team Revenue');
        renderRevenueByTierChart('teamRevenueByTierChart', allDeals);
    }, 100);
}

function renderTeamOverview() {
    var monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    var html = '<div class="tabs">' +
        '<div class="tab" onclick="renderLeadershipAnalytics()">üìä Analytics</div>' +
        '<div class="tab active" onclick="renderTeamOverview()">üë• Team Overview</div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Team Performance</h2></div><table><thead><tr><th>Name</th><th>Role</th><th>Target</th><th>Revenue</th><th>% of Max</th><th>Wins</th></tr></thead><tbody>';
    
    var reps = state.data.teamMembers.filter(function(m) { return m.role !== 'Leadership'; });
    for (var i = 0; i < reps.length; i++) {
        var m = reps[i];
        var memberDeals = state.data.deals.filter(function(d) { return d.owner === m.name; });
        var monthWon = memberDeals.filter(function(d) {
            if (d.stage.toLowerCase().indexOf('won') === -1) return false;
            var dt = d.closeDate ? new Date(d.closeDate) : null;
            return dt && dt >= monthStart;
        });
        var revenue = 0;
        for (var j = 0; j < monthWon.length; j++) revenue += monthWon[j].value;
        var targets = getKPITargets(m.role);
        var attainment = (revenue / targets.monthlyRevenueMax) * 100;
        var badgeClass = attainment >= 100 ? 'badge-success' : attainment >= 70 ? 'badge-warning' : 'badge-danger';
        
        html += '<tr class="clickable" onclick="openRepDetailsModal(\'' + m.id + '\')"><td><strong>' + m.name + '</strong></td><td>' + m.role + '</td><td>$' + targets.monthlyRevenueMax.toLocaleString() + '</td><td>$' + revenue.toLocaleString() + '</td>' +
            '<td><span class="badge ' + badgeClass + '">' + attainment.toFixed(0) + '%</span></td><td>' + monthWon.length + '</td></tr>';
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

// ============ PIPELINE VIEW ============
var draggedDealId = null;

function renderPipeline() {
    var deals = getUserDeals();
    var stages = ['Qualified', 'Proposal Sent', 'Negotiation', 'Closed Won', 'Closed Lost'];
    
    var tierFilter = state.filters.pipeline.tier;
    var ownerFilter = state.filters.pipeline.owner;
    
    if (tierFilter) deals = deals.filter(function(d) { return d.tier === tierFilter; });
    if (ownerFilter) deals = deals.filter(function(d) { return d.owner === ownerFilter; });
    
    var ownerOptions = '<option value="">All Owners</option>';
    var owners = [];
    for (var i = 0; i < state.data.deals.length; i++) {
        if (owners.indexOf(state.data.deals[i].owner) === -1 && state.data.deals[i].owner) owners.push(state.data.deals[i].owner);
    }
    for (var i = 0; i < owners.length; i++) {
        ownerOptions += '<option value="' + owners[i] + '"' + (ownerFilter === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    }
    
    var html = '<div class="filters-bar">' +
        '<select class="filter-select" onchange="state.filters.pipeline.tier=this.value;renderPipeline();">' +
        '<option value="">All Tiers</option><option value="Starter"' + (tierFilter === 'Starter' ? ' selected' : '') + '>Starter</option>' +
        '<option value="Growth"' + (tierFilter === 'Growth' ? ' selected' : '') + '>Growth</option>' +
        '<option value="Pro"' + (tierFilter === 'Pro' ? ' selected' : '') + '>Pro</option>' +
        '<option value="Enterprise"' + (tierFilter === 'Enterprise' ? ' selected' : '') + '>Enterprise</option></select>' +
        '<select class="filter-select" onchange="state.filters.pipeline.owner=this.value;renderPipeline();">' + ownerOptions + '</select>' +
        '<button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï Add Deal</button></div>' +
        '<div class="kanban-board">';
    
    for (var s = 0; s < stages.length; s++) {
        var stage = stages[s];
        var stageDeals = deals.filter(function(d) { return d.stage === stage; });
        var stageTotal = 0;
        for (var i = 0; i < stageDeals.length; i++) stageTotal += stageDeals[i].value;
        
        html += '<div class="kanban-column" ondrop="handleDrop(event,\'' + stage + '\')" ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">' +
            '<div class="kanban-header"><span>' + stage + '</span><span class="kanban-count">' + stageDeals.length + ' ‚Ä¢ $' + (stageTotal/1000).toFixed(1) + 'K</span></div>';
        
        for (var i = 0; i < stageDeals.length; i++) {
            var deal = stageDeals[i];
            var dealAge = getDaysSince(deal.createdTime);
            var userActivities = state.data.activities.filter(function(a) { return a.owner === deal.owner; });
            var lastActivity = null;
            for (var j = 0; j < userActivities.length; j++) {
                if (userActivities[j].account && deal.name.toLowerCase().indexOf(userActivities[j].account.toLowerCase()) !== -1) {
                    if (!lastActivity || new Date(userActivities[j].date) > new Date(lastActivity.date)) lastActivity = userActivities[j];
                }
            }
            var daysSinceActivity = lastActivity ? getDaysSince(lastActivity.date) : null;
            var isStale = daysSinceActivity === null || daysSinceActivity >= 5;
            
            html += '<div class="kanban-card' + (isStale && stage !== 'Closed Won' && stage !== 'Closed Lost' ? ' stale' : '') + '" draggable="true" ondragstart="handleDragStart(event,\'' + deal.id + '\')" ondragend="handleDragEnd(event)" onclick="openDealDetailsModal(\'' + deal.id + '\')">' +
                '<div class="kanban-card-title">' + deal.name + '</div>' +
                '<div class="kanban-card-value">$' + deal.value.toLocaleString() + '</div>' +
                '<span class="badge badge-' + deal.tier.toLowerCase() + '">' + deal.tier + '</span>' +
                '<div class="kanban-card-meta">üë§ ' + deal.owner + (dealAge !== null ? ' ‚Ä¢ ' + dealAge + ' days' : '') + '</div>';
            if (isStale && stage !== 'Closed Won' && stage !== 'Closed Lost') {
                html += '<div class="stale-indicator">‚ö†Ô∏è ' + (daysSinceActivity !== null ? daysSinceActivity + ' days since touch' : 'No activity') + '</div>';
            }
            html += '</div>';
        }
        html += '</div>';
    }
    html += '</div>';
    document.getElementById('contentArea').innerHTML = html;
}

function handleDragStart(e, dealId) {
    draggedDealId = dealId;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    var cols = document.querySelectorAll('.kanban-column');
    for (var i = 0; i < cols.length; i++) cols[i].classList.remove('drag-over');
}

function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
    e.preventDefault();
    if (e.target.classList.contains('kanban-column')) e.target.classList.add('drag-over');
}

function handleDragLeave(e) {
    if (e.target.classList.contains('kanban-column')) e.target.classList.remove('drag-over');
}

function handleDrop(e, newStage) {
    e.preventDefault();
    var cols = document.querySelectorAll('.kanban-column');
    for (var i = 0; i < cols.length; i++) cols[i].classList.remove('drag-over');
    if (draggedDealId) {
        updateDealStage(draggedDealId, newStage);
        draggedDealId = null;
    }
}

// ============ CONTACTS VIEW ============
function renderContacts() {
    var contacts = state.data.contacts.slice();
    var searchFilter = state.filters.contacts.search;
    var ownerFilter = state.filters.contacts.owner;
    
    if (searchFilter) {
        var q = searchFilter.toLowerCase();
        contacts = contacts.filter(function(c) { return c.name.toLowerCase().indexOf(q) !== -1 || (c.email && c.email.toLowerCase().indexOf(q) !== -1) || (c.company && c.company.toLowerCase().indexOf(q) !== -1); });
    }
    if (ownerFilter) contacts = contacts.filter(function(c) { return c.owner === ownerFilter; });
    
    // Sorting
    var sortField = state.sorting.contacts.field;
    var sortDir = state.sorting.contacts.dir;
    contacts.sort(function(a, b) {
        var aVal = (a[sortField] || '').toString().toLowerCase();
        var bVal = (b[sortField] || '').toString().toLowerCase();
        if (sortDir === 'asc') return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
    });
    
    var ownerOptions = '<option value="">All Owners</option>';
    var owners = [];
    for (var i = 0; i < state.data.contacts.length; i++) {
        if (owners.indexOf(state.data.contacts[i].owner) === -1 && state.data.contacts[i].owner) owners.push(state.data.contacts[i].owner);
    }
    for (var i = 0; i < owners.length; i++) {
        ownerOptions += '<option value="' + owners[i] + '"' + (ownerFilter === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    }
    
    function getSortClass(field) {
        if (state.sorting.contacts.field !== field) return 'sortable';
        return state.sorting.contacts.dir === 'asc' ? 'sortable sort-asc' : 'sortable sort-desc';
    }
    
    var html = '<div class="filters-bar">' +
        '<input type="text" class="filter-input" placeholder="Search contacts..." value="' + (searchFilter || '') + '" oninput="state.filters.contacts.search=this.value;renderContacts();">' +
        '<select class="filter-select" onchange="state.filters.contacts.owner=this.value;renderContacts();">' + ownerOptions + '</select>' +
        '<select class="filter-select" onchange="handleContactSort(this.value)">' +
        '<option value="name-asc"' + (sortField === 'name' && sortDir === 'asc' ? ' selected' : '') + '>Name A-Z</option>' +
        '<option value="name-desc"' + (sortField === 'name' && sortDir === 'desc' ? ' selected' : '') + '>Name Z-A</option>' +
        '<option value="company-asc"' + (sortField === 'company' && sortDir === 'asc' ? ' selected' : '') + '>Company A-Z</option>' +
        '<option value="company-desc"' + (sortField === 'company' && sortDir === 'desc' ? ' selected' : '') + '>Company Z-A</option>' +
        '<option value="createdTime-desc"' + (sortField === 'createdTime' && sortDir === 'desc' ? ' selected' : '') + '>Newest First</option>' +
        '<option value="createdTime-asc"' + (sortField === 'createdTime' && sortDir === 'asc' ? ' selected' : '') + '>Oldest First</option></select>' +
        '<button class="btn btn-primary btn-small" onclick="openAddContactModal()">‚ûï Add Contact</button></div>' +
        '<div class="card"><table><thead><tr>' +
        '<th class="' + getSortClass('name') + '" onclick="toggleContactSort(\'name\')">Name</th>' +
        '<th>Email</th><th>Phone</th>' +
        '<th class="' + getSortClass('company') + '" onclick="toggleContactSort(\'company\')">Company</th>' +
        '<th>Role</th><th>Owner</th></tr></thead><tbody>';
    
    for (var i = 0; i < contacts.length; i++) {
        var c = contacts[i];
        var companyLink = c.company ? '<span class="clickable-link" onclick="event.stopPropagation();openAccountByName(\'' + c.company.replace(/'/g, "\\'") + '\')">' + c.company + '</span>' : '-';
        html += '<tr class="clickable" onclick="openContactDetailModal(\'' + c.id + '\')">' +
            '<td><strong>' + c.name + '</strong></td>' +
            '<td>' + (c.email || '-') + '</td>' +
            '<td>' + (c.phone || '-') + '</td>' +
            '<td>' + companyLink + '</td>' +
            '<td>' + (c.role || '-') + '</td>' +
            '<td>' + (c.owner || '-') + '</td></tr>';
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

function handleContactSort(value) {
    var parts = value.split('-');
    state.sorting.contacts.field = parts[0];
    state.sorting.contacts.dir = parts[1];
    renderContacts();
}

function toggleContactSort(field) {
    if (state.sorting.contacts.field === field) {
        state.sorting.contacts.dir = state.sorting.contacts.dir === 'asc' ? 'desc' : 'asc';
    } else {
        state.sorting.contacts.field = field;
        state.sorting.contacts.dir = 'asc';
    }
    renderContacts();
}

function openAccountByName(accountName) {
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (state.data.accounts[i].name === accountName) {
            openAccountDetailModal(state.data.accounts[i].id);
            return;
        }
    }
}

// ============ ACCOUNTS VIEW ============
function renderAccounts() {
    var accounts = state.data.accounts.slice();
    var searchFilter = state.filters.accounts.search;
    var industryFilter = state.filters.accounts.industry;
    var ownerFilter = state.filters.accounts.owner;
    
    if (searchFilter) {
        var q = searchFilter.toLowerCase();
        accounts = accounts.filter(function(a) { return a.name.toLowerCase().indexOf(q) !== -1; });
    }
    if (industryFilter) accounts = accounts.filter(function(a) { return a.industry === industryFilter; });
    if (ownerFilter) accounts = accounts.filter(function(a) { return a.owner === ownerFilter; });
    
    // Sorting
    var sortField = state.sorting.accounts.field;
    var sortDir = state.sorting.accounts.dir;
    accounts.sort(function(a, b) {
        var aVal = (a[sortField] || '').toString().toLowerCase();
        var bVal = (b[sortField] || '').toString().toLowerCase();
        if (sortDir === 'asc') return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
    });
    
    var industryOptions = '<option value="">All Industries</option>';
    var industries = [];
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (industries.indexOf(state.data.accounts[i].industry) === -1 && state.data.accounts[i].industry) industries.push(state.data.accounts[i].industry);
    }
    industries.sort();
    for (var i = 0; i < industries.length; i++) {
        industryOptions += '<option value="' + industries[i] + '"' + (industryFilter === industries[i] ? ' selected' : '') + '>' + industries[i] + '</option>';
    }
    
    var ownerOptions = '<option value="">All Owners</option>';
    var owners = [];
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (owners.indexOf(state.data.accounts[i].owner) === -1 && state.data.accounts[i].owner) owners.push(state.data.accounts[i].owner);
    }
    for (var i = 0; i < owners.length; i++) {
        ownerOptions += '<option value="' + owners[i] + '"' + (ownerFilter === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    }
    
    function getSortClass(field) {
        if (state.sorting.accounts.field !== field) return 'sortable';
        return state.sorting.accounts.dir === 'asc' ? 'sortable sort-asc' : 'sortable sort-desc';
    }
    
    var html = '<div class="filters-bar">' +
        '<input type="text" class="filter-input" placeholder="Search accounts..." value="' + (searchFilter || '') + '" oninput="state.filters.accounts.search=this.value;renderAccounts();">' +
        '<select class="filter-select" onchange="state.filters.accounts.industry=this.value;renderAccounts();">' + industryOptions + '</select>' +
        '<select class="filter-select" onchange="state.filters.accounts.owner=this.value;renderAccounts();">' + ownerOptions + '</select>' +
        '<select class="filter-select" onchange="handleAccountSort(this.value)">' +
        '<option value="name-asc"' + (sortField === 'name' && sortDir === 'asc' ? ' selected' : '') + '>Name A-Z</option>' +
        '<option value="name-desc"' + (sortField === 'name' && sortDir === 'desc' ? ' selected' : '') + '>Name Z-A</option>' +
        '<option value="industry-asc"' + (sortField === 'industry' && sortDir === 'asc' ? ' selected' : '') + '>Industry A-Z</option>' +
        '<option value="industry-desc"' + (sortField === 'industry' && sortDir === 'desc' ? ' selected' : '') + '>Industry Z-A</option>' +
        '<option value="createdTime-desc"' + (sortField === 'createdTime' && sortDir === 'desc' ? ' selected' : '') + '>Newest First</option>' +
        '<option value="createdTime-asc"' + (sortField === 'createdTime' && sortDir === 'asc' ? ' selected' : '') + '>Oldest First</option></select>' +
        '<button class="btn btn-primary btn-small" onclick="openAddAccountModal()">‚ûï Add Account</button></div>' +
        '<div class="card"><table><thead><tr>' +
        '<th class="' + getSortClass('name') + '" onclick="toggleAccountSort(\'name\')">Account Name</th>' +
        '<th class="' + getSortClass('industry') + '" onclick="toggleAccountSort(\'industry\')">Industry</th>' +
        '<th>Contacts</th><th>Deals</th><th>Website</th><th>Owner</th></tr></thead><tbody>';
    
    for (var i = 0; i < accounts.length; i++) {
        var a = accounts[i];
        var contactCount = state.data.contacts.filter(function(c) { return c.company === a.name || c.accountId === a.id; }).length;
        var dealCount = state.data.deals.filter(function(d) { return d.name.toLowerCase().indexOf(a.name.toLowerCase()) !== -1; }).length;
        
        html += '<tr class="clickable" onclick="openAccountDetailModal(\'' + a.id + '\')">' +
            '<td><strong>' + a.name + '</strong></td>' +
            '<td>' + (a.industry || '-') + '</td>' +
            '<td><span class="clickable-link" onclick="event.stopPropagation();filterContactsByAccount(\'' + a.name.replace(/'/g, "\\'") + '\')">' + contactCount + ' contacts</span></td>' +
            '<td><span class="clickable-link" onclick="event.stopPropagation();filterPipelineByAccount(\'' + a.name.replace(/'/g, "\\'") + '\')">' + dealCount + ' deals</span></td>' +
            '<td>' + (a.website ? '<a href="' + a.website + '" target="_blank" onclick="event.stopPropagation();">üîó</a>' : '-') + '</td>' +
            '<td>' + (a.owner || '-') + '</td></tr>';
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

function handleAccountSort(value) {
    var parts = value.split('-');
    state.sorting.accounts.field = parts[0];
    state.sorting.accounts.dir = parts[1];
    renderAccounts();
}

function toggleAccountSort(field) {
    if (state.sorting.accounts.field === field) {
        state.sorting.accounts.dir = state.sorting.accounts.dir === 'asc' ? 'desc' : 'asc';
    } else {
        state.sorting.accounts.field = field;
        state.sorting.accounts.dir = 'asc';
    }
    renderAccounts();
}

function filterContactsByAccount(accountName) {
    state.filters.contacts.search = accountName;
    renderView('contacts');
}

function filterPipelineByAccount(accountName) {
    // Simple implementation - show pipeline and filter message
    renderView('pipeline');
    alert('Showing deals related to: ' + accountName);
}

// ============ EVENTS VIEW ============
function renderEvents() {
    var deals = getUserDeals();
    var eventsWithDates = deals.filter(function(d) { return d.eventName || d.closeDate; });
    eventsWithDates.sort(function(a, b) {
        var dateA = a.closeDate ? new Date(a.closeDate) : new Date(0);
        var dateB = b.closeDate ? new Date(b.closeDate) : new Date(0);
        return dateA - dateB;
    });
    
    var html = '<div class="card"><div class="card-header"><h2 class="card-title">üìÖ Events Calendar</h2><button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï Add Event</button></div>' +
        '<table><thead><tr><th>Event Name</th><th>Client</th><th>Date</th><th>Status</th><th>Tier</th><th>Value</th></tr></thead><tbody>';
    
    for (var i = 0; i < eventsWithDates.length; i++) {
        var deal = eventsWithDates[i];
        var eventDate = deal.closeDate ? new Date(deal.closeDate) : null;
        var isPast = eventDate && eventDate < new Date();
        var statusBadge = deal.stage.toLowerCase().indexOf('won') !== -1 ? '<span class="badge badge-success">Confirmed</span>' :
            deal.stage.toLowerCase().indexOf('lost') !== -1 ? '<span class="badge badge-danger">Lost</span>' :
            '<span class="badge badge-warning">Pending</span>';
        
        html += '<tr class="clickable" onclick="openDealDetailsModal(\'' + deal.id + '\')" style="' + (isPast ? 'opacity:0.6;' : '') + '">' +
            '<td><strong>' + (deal.eventName || deal.name) + '</strong></td>' +
            '<td>' + deal.name + '</td>' +
            '<td>' + (eventDate ? eventDate.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : '-') + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td><span class="badge badge-' + deal.tier.toLowerCase() + '">' + deal.tier + '</span></td>' +
            '<td>$' + deal.value.toLocaleString() + '</td></tr>';
    }
    if (eventsWithDates.length === 0) html += '<tr><td colspan="6" style="text-align:center;color:var(--text-gray);">No events scheduled</td></tr>';
    html += '</tbody></table></div>';
    
    document.getElementById('contentArea').innerHTML = html;
}

// ============ ACTIVITIES VIEW ============
function renderActivityView() {
    var activities = state.data.activities.slice();
    
    // Filter by rep if set (from leadership clicking on rep)
    if (state.filterRep) {
        activities = activities.filter(function(a) { return a.owner === state.filterRep; });
    } else if (state.currentUser.role !== 'Leadership') {
        activities = activities.filter(function(a) { return a.owner === state.currentUser.name; });
    }
    
    activities.sort(function(a, b) { return new Date(b.date || b.createdTime) - new Date(a.date || a.createdTime); });
    
    var typeIcons = { 'Call': 'üìû', 'Email': 'üìß', 'LinkedIn': 'üíº', 'Demo': 'üé•', 'Proposal': 'üìÑ', 'Follow-up': 'üîÑ', 'Meeting': 'üìÖ', 'Discovery Call': 'üîç' };
    
    var filterText = state.filterRep ? ' for ' + state.filterRep : '';
    
    var html = '<div class="filters-bar">' +
        (state.filterRep ? '<button class="btn btn-secondary btn-small" onclick="state.filterRep=null;renderActivityView();">‚úï Clear filter (' + state.filterRep + ')</button>' : '') +
        '<button class="btn btn-primary btn-small" onclick="openLogActivityModal()">üìù Log Activity</button></div>' +
        '<div class="card"><div class="card-header"><h2 class="card-title">üìù Activity Log' + filterText + '</h2><span style="color:var(--text-gray);">' + activities.length + ' activities</span></div>' +
        '<table><thead><tr><th>Date</th><th>Type</th><th>Account</th><th>Result</th><th>Owner</th><th>Actions</th></tr></thead><tbody>';
    
    for (var i = 0; i < Math.min(activities.length, 100); i++) {
        var a = activities[i];
        var icon = typeIcons[a.type] || 'üìå';
        html += '<tr>' +
            '<td>' + formatDateShort(a.date) + '</td>' +
            '<td>' + icon + ' ' + a.type + '</td>' +
            '<td>' + (a.account || '-') + '</td>' +
            '<td style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (a.result || '-') + '</td>' +
            '<td>' + (a.owner || '-') + '</td>' +
            '<td><button class="btn btn-danger btn-icon" onclick="deleteActivity(\'' + a.id + '\')">üóëÔ∏è</button></td></tr>';
    }
    if (activities.length === 0) html += '<tr><td colspan="6" style="text-align:center;color:var(--text-gray);">No activities logged</td></tr>';
    html += '</tbody></table></div>';
    
    document.getElementById('contentArea').innerHTML = html;
}

// ============ REPORTS VIEW ============
function renderReports() {
    var deals = getUserDeals();
    var today = new Date();
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    var lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    var lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
    
    var thisMonthWon = deals.filter(function(d) {
        if (d.stage.toLowerCase().indexOf('won') === -1) return false;
        var dt = d.closeDate ? new Date(d.closeDate) : null;
        return dt && dt >= monthStart;
    });
    var lastMonthWon = deals.filter(function(d) {
        if (d.stage.toLowerCase().indexOf('won') === -1) return false;
        var dt = d.closeDate ? new Date(d.closeDate) : null;
        return dt && dt >= lastMonthStart && dt <= lastMonthEnd;
    });
    
    var thisMonthRevenue = 0, lastMonthRevenue = 0;
    for (var i = 0; i < thisMonthWon.length; i++) thisMonthRevenue += thisMonthWon[i].value;
    for (var i = 0; i < lastMonthWon.length; i++) lastMonthRevenue += lastMonthWon[i].value;
    var revenueChange = lastMonthRevenue > 0 ? ((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue * 100) : 0;
    
    var tierBreakdown = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    for (var i = 0; i < thisMonthWon.length; i++) {
        if (tierBreakdown.hasOwnProperty(thisMonthWon[i].tier)) tierBreakdown[thisMonthWon[i].tier]++;
    }
    
    var html = '<div class="kpi-grid">' +
        '<div class="kpi-card"><div class="kpi-label">This Month Revenue</div><div class="kpi-value" style="color:var(--primary);">$' + thisMonthRevenue.toLocaleString() + '</div>' +
        '<div style="font-size:13px;color:' + (revenueChange >= 0 ? 'var(--success)' : 'var(--danger)') + ';">' + (revenueChange >= 0 ? '‚Üë' : '‚Üì') + ' ' + Math.abs(revenueChange).toFixed(1) + '% vs last month</div></div>' +
        '<div class="kpi-card"><div class="kpi-label">Deals Closed</div><div class="kpi-value">' + thisMonthWon.length + '</div><div style="font-size:13px;color:var(--text-gray);">Last month: ' + lastMonthWon.length + '</div></div>' +
        '<div class="kpi-card"><div class="kpi-label">Avg Deal Size</div><div class="kpi-value">$' + (thisMonthWon.length > 0 ? Math.round(thisMonthRevenue / thisMonthWon.length).toLocaleString() : '0') + '</div></div>' +
        '<div class="kpi-card"><div class="kpi-label">Pipeline Value</div><div class="kpi-value">$' + deals.filter(function(d) { return d.stage.toLowerCase().indexOf('won') === -1 && d.stage.toLowerCase().indexOf('lost') === -1; }).reduce(function(sum, d) { return sum + d.value; }, 0).toLocaleString() + '</div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä Tier Breakdown (This Month)</h2></div>' +
        '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center;">';
    
    for (var tier in tierBreakdown) {
        html += '<div style="padding:20px;background:var(--bg-light);border-radius:10px;"><div style="font-size:32px;font-weight:700;color:' + tierColors[tier] + ';">' + tierBreakdown[tier] + '</div><div style="font-size:13px;color:var(--text-gray);">' + tier + '</div></div>';
    }
    html += '</div></div>' +
        '<div class="charts-grid">' +
        '<div class="chart-card"><h3>Revenue Trend</h3><div class="chart-container"><canvas id="reportRevenueTrendChart"></canvas></div></div>' +
        '<div class="chart-card"><h3>Revenue by Tier (All Time)</h3><div class="chart-container"><canvas id="reportRevenueByTierChart"></canvas></div></div></div>';
    
    document.getElementById('contentArea').innerHTML = html;
    setTimeout(function() {
        renderRevenueTrendChart('reportRevenueTrendChart', deals);
        renderRevenueByTierChart('reportRevenueByTierChart', deals);
    }, 100);
}

// ============ INITIALIZE ============
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
