<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuConnect CRM - Phase 2 Complete</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
        }
        body { font-family: 'Inter', sans-serif; background: var(--gradient); min-height: 100vh; color: var(--text-dark); }
        .hidden { display: none !important; }
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: var(--white); padding: 60px 50px; border-radius: 24px; box-shadow: var(--shadow-lg); max-width: 450px; width: 100%; }
        .logo { font-size: 48px; text-align: center; margin-bottom: 10px; }
        .login-card h1 { color: var(--primary); font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .login-card p { color: var(--text-gray); text-align: center; margin-bottom: 40px; }
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        .form-group select, .form-group input, .form-group textarea { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 16px; font-family: inherit; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; }
        .btn-primary { width: 100%; background: var(--gradient); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: var(--bg-light); color: var(--text-dark); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-small { padding: 8px 16px; font-size: 14px; }
        .btn-icon { padding: 6px 10px; font-size: 14px; border-radius: 8px; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--white); box-shadow: var(--shadow-md); padding: 24px 0; position: fixed; height: 100vh; overflow-y: auto; }
        .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
        .sidebar-header h2 { color: var(--primary); font-size: 24px; font-weight: 800; margin-bottom: 4px; }
        .sidebar-nav { padding: 24px 0; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: var(--text-gray); cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .nav-item:hover { background: var(--bg-light); color: var(--primary); }
        .nav-item.active { background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, transparent 100%); color: var(--primary); border-left: 3px solid var(--primary); }
        .nav-item-icon { font-size: 20px; margin-right: 12px; }
        .main-content { margin-left: 280px; flex: 1; padding: 24px; }
        .top-bar { background: var(--white); padding: 20px 30px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .top-bar h1 { font-size: 28px; font-weight: 800; }
        .top-bar-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .search-container { position: relative; }
        .search-input { padding: 10px 16px 10px 40px; border: 2px solid var(--border); border-radius: 12px; font-size: 14px; width: 280px; font-family: inherit; transition: all 0.3s; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); width: 320px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 16px; color: var(--text-gray); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); margin-top: 8px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none; }
        .search-results.active { display: block; }
        .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .search-result-item:hover { background: var(--bg-light); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-type { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--primary); margin-bottom: 4px; }
        .search-result-title { font-weight: 600; margin-bottom: 2px; }
        .search-result-meta { font-size: 12px; color: var(--text-gray); }
        .nudge-container { margin-bottom: 20px; }
        .nudge-alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .nudge-alert.warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid var(--warning); }
        .nudge-alert.danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid var(--danger); }
        .nudge-alert.success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid var(--success); }
        .nudge-icon { font-size: 24px; }
        .nudge-text { flex: 1; font-weight: 500; }
        .nudge-dismiss { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .nudge-dismiss:hover { opacity: 1; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: var(--white); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-sm); position: relative; }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gradient); border-radius: 16px 0 0 16px; }
        .kpi-value { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
        .progress-bar { width: 100%; height: 8px; background: var(--bg-light); border-radius: 10px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { height: 100%; background: var(--gradient); border-radius: 10px; transition: width 0.5s ease; }
        .card { background: var(--white); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .card-title { font-size: 20px; font-weight: 700; }
        .wins-list { display: flex; flex-direction: column; gap: 12px; }
        .win-card { background: var(--bg-light); padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .win-info { flex: 1; }
        .win-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .win-meta { font-size: 13px; color: var(--text-gray); }
        .win-value { font-size: 20px; font-weight: 700; color: var(--primary); }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-right: 8px; }
        .badge-starter { background: #dbeafe; color: #1e40af; }
        .badge-growth { background: #d1fae5; color: #065f46; }
        .badge-pro { background: #fef3c7; color: #92400e; }
        .badge-enterprise { background: #e0e7ff; color: #3730a3; }
        .quality-badge { padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .quality-badge.success { background: #d1fae5; color: #065f46; }
        .quality-badge.warning { background: #fef3c7; color: #92400e; }
        .activity-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 20px; }
        .stat-card { text-align: center; padding: 16px; background: var(--bg-light); border-radius: 12px; }
        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 13px; color: var(--text-gray); margin-top: 4px; }
        .floor-tracker { text-align: center; padding: 30px; }
        .capacity-circle { width: 180px; height: 180px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 20px rgba(102,126,234,0.3); }
        .capacity-number { font-size: 48px; font-weight: 700; }
        .capacity-label { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        .capacity-percentage { font-size: 18px; font-weight: 600; color: #667eea; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-light); }
        th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; }
        td { padding: 16px; border-bottom: 1px solid var(--border); }
        tr:hover { background: var(--bg-light); }
        .action-buttons { display: flex; gap: 8px; }
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .kanban-column { background: var(--bg-light); border-radius: 12px; padding: 16px; min-height: 400px; }
        .kanban-header { font-weight: 700; font-size: 14px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; }
        .kanban-card { background: var(--white); padding: 16px; border-radius: 8px; margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kanban-card-title { font-weight: 600; margin-bottom: 8px; }
        .kanban-card-value { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content.wide { max-width: 900px; }
        .modal-header h2 { font-size: 24px; font-weight: 700; margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: var(--white); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-sm); }
        .chart-card h3 { font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--text-dark); }
        .chart-container { position: relative; height: 280px; }
        .clickable-stat { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .clickable-stat:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kpi-alerts { margin-top: 24px; }
        .kpi-alert-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-light); border-radius: 8px; margin-bottom: 8px; }
        .kpi-alert-item.needs-attention { background: #fee2e2; border-left: 3px solid var(--danger); }
        .kpi-alert-item.on-track { background: #d1fae5; border-left: 3px solid var(--success); }
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .search-input { width: 200px; }
            .search-input:focus { width: 240px; }
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="logo">üéØ</div>
            <h1>NuConnect CRM</h1>
            <p>Sign in to your account</p>
            <div class="form-group">
                <label>Team Member</label>
                <select id="userSelect"><option value="">Choose your name...</option></select>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="passwordInput" placeholder="Enter your password">
            </div>
            <div id="loginError" class="hidden" style="color: var(--danger); margin-bottom: 16px; font-size: 14px;"></div>
            <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="appContainer" class="app-container hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üéØ NuConnect</h2>
                <p id="currentUserName"></p>
            </div>
            <nav class="sidebar-nav" id="sidebarNav"></nav>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div><h1 id="pageTitle">Dashboard</h1></div>
                <div class="top-bar-actions">
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search deals, contacts, accounts..." oninput="handleSearch(this.value)" onfocus="showSearchResults()" onblur="hideSearchResults()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="openSettings()">‚öôÔ∏è</button>
                    <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
                </div>
            </div>
            <div id="contentArea"></div>
        </main>
    </div>
    <div id="modalContainer"></div>

    <script>
// ============ STATE & CONFIG ============
const state = {
    currentUser: null,
    currentView: 'dashboard',
    baseId: localStorage.getItem('airtable_baseId') || '',
    apiKey: localStorage.getItem('airtable_apiKey') || '',
    charts: {},
    filterRep: null,
    filterMonth: null,
    data: { deals: [], activities: [], tasks: [], contacts: [], accounts: [], teamMembers: [], pricingRules: [] },
    teamMemberMap: {},
    pricingRuleMap: {}
};

const userPasswords = {
    'Javonte': 'nuconnect2025', 'Teslim': 'nuconnect2025', 'Israel': 'nuconnect2025', 'Conrad': 'nuconnect2025',
    'Test User': 'test2024', 'Test Leadership': 'testleader2024', 'Ramallah': 'admin2025', 'Keyna': 'admin2025'
};

const tierPricing = { 'Starter': 750, 'Growth': 1250, 'Pro': 2000, 'Enterprise': 4200 };
const tierColors = { 'Starter': '#9e9e9e', 'Growth': '#22c55e', 'Pro': '#f59e0b', 'Enterprise': '#667eea' };

const KPI_TARGETS = {
    BDR: { monthlyRevenueMin: 9750, monthlyRevenueMax: 12700, monthlyEventsMin: 6, monthlyEventsMax: 7,
           dailyTouchpointsMin: 20, dailyTouchpointsMax: 25, dailyCalls: 15, dailyDiscovery: 1, dailyDealsMoved: 1, quota: 45000 },
    AE: { monthlyRevenueMin: 15000, monthlyRevenueMax: 20000, monthlyEventsMin: 4, monthlyEventsMax: 6,
          dailyTouchpointsMin: 15, dailyTouchpointsMax: 20, dailyCalls: 10, dailyDiscovery: 2, dailyDealsMoved: 1, quota: 60000 },
    Team: { monthlyRevenueMin: 28000, monthlyRevenueMax: 35000, monthlyEventsMin: 18, monthlyEventsMax: 22 }
};

function getKPITargets(role) { return role === 'AE' ? KPI_TARGETS.AE : KPI_TARGETS.BDR; }

const allNavItems = [
    { id: 'dashboard', icon: 'üìä', label: 'Dashboard' }, { id: 'pipeline', icon: 'üìà', label: 'Pipeline' },
    { id: 'tasks', icon: '‚úÖ', label: 'Tasks' }, { id: 'contacts', icon: 'üë•', label: 'Contacts' },
    { id: 'accounts', icon: 'üè¢', label: 'Accounts' }, { id: 'activity', icon: 'üìù', label: 'Log Activity' },
    { id: 'reports', icon: 'üìë', label: 'Reports' }
];
const leadershipNavItems = [{ id: 'leadership', icon: 'üëî', label: 'Leadership' }, { id: 'team', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', label: 'Team Overview' }];

// ============ GLOBAL SEARCH ============
let searchTimeout = null;
window.searchResults = [];

function handleSearch(query) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(query), 300);
}

function performSearch(query) {
    const resultsDiv = document.getElementById('searchResults');
    if (!query || query.length < 2) { resultsDiv.innerHTML = ''; resultsDiv.classList.remove('active'); return; }
    const q = query.toLowerCase();
    const results = [];

    state.data.deals.forEach(deal => {
        if (deal.name.toLowerCase().includes(q) || (deal.eventName && deal.eventName.toLowerCase().includes(q))) {
            results.push({ type: 'Deal', title: deal.name, meta: `${deal.tier} ‚Ä¢ $${deal.value.toLocaleString()} ‚Ä¢ ${deal.stage}`, action: () => { renderView('pipeline'); closeSearch(); }});
        }
    });
    state.data.contacts.forEach(contact => {
        if (contact.name.toLowerCase().includes(q) || (contact.email && contact.email.toLowerCase().includes(q)) || (contact.company && contact.company.toLowerCase().includes(q))) {
            results.push({ type: 'Contact', title: contact.name, meta: `${contact.email} ‚Ä¢ ${contact.company || 'No company'}`, action: () => { renderView('contacts'); closeSearch(); }});
        }
    });
    state.data.accounts.forEach(account => {
        if (account.name.toLowerCase().includes(q) || (account.industry && account.industry.toLowerCase().includes(q))) {
            results.push({ type: 'Account', title: account.name, meta: `${account.industry || 'No industry'} ‚Ä¢ Owner: ${account.owner}`, action: () => { renderView('accounts'); closeSearch(); }});
        }
    });
    state.data.activities.forEach(activity => {
        if ((activity.account && activity.account.toLowerCase().includes(q)) || (activity.result && activity.result.toLowerCase().includes(q))) {
            results.push({ type: 'Activity', title: `${activity.type} - ${activity.account}`, meta: `${activity.date} ‚Ä¢ ${activity.owner}`, action: () => { renderView('activity'); closeSearch(); }});
        }
    });

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item"><div class="search-result-title">No results found</div></div>';
    } else {
        resultsDiv.innerHTML = results.slice(0, 10).map((r, i) => `
            <div class="search-result-item" onmousedown="window.searchResults[${i}].action()">
                <div class="search-result-type">${r.type}</div>
                <div class="search-result-title">${r.title}</div>
                <div class="search-result-meta">${r.meta}</div>
            </div>
        `).join('');
        window.searchResults = results;
    }
    resultsDiv.classList.add('active');
}

function showSearchResults() { const r = document.getElementById('searchResults'); if (r.innerHTML) r.classList.add('active'); }
function hideSearchResults() { setTimeout(() => document.getElementById('searchResults').classList.remove('active'), 200); }
function closeSearch() { document.getElementById('globalSearch').value = ''; document.getElementById('searchResults').classList.remove('active'); }

// ============ NUDGE NOTIFICATIONS ============
function generateNudges() {
    const nudges = [];
    if (state.currentUser.role === 'Leadership') return nudges;
    
    const now = new Date();
    const hour = now.getHours();
    const targets = getKPITargets(state.currentUser.role);
    const today = now.toISOString().split('T')[0];
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    const userActivities = state.data.activities.filter(a => a.owner === state.currentUser.name);
    const todayActivities = userActivities.filter(a => a.date && a.date.split('T')[0] === today);
    const todayTouchpoints = todayActivities.length;
    
    const userDeals = state.data.deals.filter(d => d.owner === state.currentUser.name);
    const monthClosedDeals = userDeals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const monthRevenue = monthClosedDeals.reduce((sum, d) => sum + d.value, 0);
    const revenuePercent = (monthRevenue / targets.monthlyRevenueMin) * 100;
    
    const growthPlusDeals = monthClosedDeals.filter(d => d.tier !== 'Starter').length;
    const qualityScore = monthClosedDeals.length > 0 ? (growthPlusDeals / monthClosedDeals.length) * 100 : 100;
    
    if (revenuePercent < 50) {
        nudges.push({ type: 'danger', icon: 'üö®', text: `You're at ${revenuePercent.toFixed(0)}% of minimum target ($${(targets.monthlyRevenueMin/1000).toFixed(1)}K). Let's pick up the pace!` });
    } else if (revenuePercent >= 100) {
        nudges.push({ type: 'success', icon: 'üéâ', text: `You're at ${revenuePercent.toFixed(0)}% of minimum target! Amazing work - keep pushing!` });
    }
    
    if (hour >= 15 && todayTouchpoints < 15) {
        nudges.push({ type: 'warning', icon: '‚ö†Ô∏è', text: `Only ${todayTouchpoints}/${targets.dailyTouchpointsMax} touchpoints today. Keep going!` });
    }
    
    if (qualityScore < 70 && monthClosedDeals.length >= 2) {
        nudges.push({ type: 'warning', icon: 'üìä', text: `Quality score is ${qualityScore.toFixed(0)}%. Focus on Growth+ deals to hit 70%!` });
    }
    
    return nudges;
}

function renderNudges() {
    const nudges = generateNudges();
    if (nudges.length === 0) return '';
    return `<div class="nudge-container">${nudges.map(n => `
        <div class="nudge-alert ${n.type}">
            <span class="nudge-icon">${n.icon}</span>
            <span class="nudge-text">${n.text}</span>
            <button class="nudge-dismiss" onclick="this.parentElement.remove()">√ó</button>
        </div>
    `).join('')}</div>`;
}

// ============ CHART RENDERING ============
function destroyCharts() {
    Object.values(state.charts).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
    state.charts = {};
}

function renderRevenueTrendChart(canvasId, deals, label = 'Revenue') {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    const monthlyData = [], labels = [];
    for (let i = 5; i >= 0; i--) {
        let month = currentMonth - i, year = currentYear;
        if (month < 0) { month += 12; year -= 1; }
        const monthStart = new Date(year, month, 1), monthEnd = new Date(year, month + 1, 0);
        const monthDeals = deals.filter(d => {
            if (!d.stage.toLowerCase().includes('won')) return false;
            const closeDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return closeDate && closeDate >= monthStart && closeDate <= monthEnd;
        });
        monthlyData.push(monthDeals.reduce((sum, d) => sum + d.value, 0));
        labels.push(monthNames[month]);
    }
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label, data: monthlyData, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', fill: true, tension: 0.4, pointBackgroundColor: '#667eea', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 6 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' } } } }
    });
}

function renderRevenueByTierChart(canvasId, deals) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const wonDeals = deals.filter(d => d.stage.toLowerCase().includes('won'));
    const tierData = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    wonDeals.forEach(d => { if (tierData.hasOwnProperty(d.tier)) tierData[d.tier] += d.value; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'pie',
        data: { labels: Object.keys(tierData), datasets: [{ data: Object.values(tierData), backgroundColor: [tierColors.Starter, tierColors.Growth, tierColors.Pro, tierColors.Enterprise], borderWidth: 2, borderColor: '#fff' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } }, tooltip: { callbacks: { label: ctx => '$' + ctx.raw.toLocaleString() } } } }
    });
}

function renderEventsByTierChart(canvasId, deals) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const wonDeals = deals.filter(d => d.stage.toLowerCase().includes('won'));
    const tierCounts = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    wonDeals.forEach(d => { if (tierCounts.hasOwnProperty(d.tier)) tierCounts[d.tier]++; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: { labels: Object.keys(tierCounts), datasets: [{ label: 'Events', data: Object.values(tierCounts), backgroundColor: [tierColors.Starter, tierColors.Growth, tierColors.Pro, tierColors.Enterprise], borderRadius: 8 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
}

function renderRevenueByPricingChart(canvasId, deals) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const wonDeals = deals.filter(d => d.stage.toLowerCase().includes('won'));
    let publicRevenue = 0, floorRevenue = 0;
    wonDeals.forEach(d => { if (d.pricingType === 'Floor Price') floorRevenue += d.value; else publicRevenue += d.value; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Public Price', 'Floor Price'], datasets: [{ data: [publicRevenue, floorRevenue], backgroundColor: ['#667eea', '#f59e0b'], borderWidth: 2, borderColor: '#fff' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 15 } }, tooltip: { callbacks: { label: ctx => '$' + ctx.raw.toLocaleString() } } } }
    });
}

// ============ INITIALIZATION ============
async function init() {
    console.log('%cüöÄ NuConnect CRM v2.2 - Phase 2 COMPLETE', 'background: #667eea; color: white; font-size: 16px; padding: 10px; font-weight: bold;');
    console.log('‚ú® Features: Charts, Correct KPIs, Edit/Delete, Enhanced Modals, Search, Nudges');
    console.log('üìÖ Build: January 6, 2026');
    
    if (state.baseId && state.apiKey) {
        await loadTeamMembers();
        await loadPricingRules();
        populateLoginSelect();
    } else {
        showConfigPrompt();
    }
}

function showConfigPrompt() {
    document.getElementById('loginScreen').innerHTML = `
        <div class="login-card">
            <div class="logo">‚öôÔ∏è</div><h1>Setup Required</h1><p>Configure your Airtable connection</p>
            <div class="form-group"><label>Airtable Base ID</label><input type="text" id="setupBaseId" placeholder="appXXXXXXXXXXXXXX" value="${state.baseId}"></div>
            <div class="form-group"><label>Airtable API Key</label><input type="password" id="setupApiKey" placeholder="patXXXXXXXXXXXXXX"></div>
            <button class="btn btn-primary" onclick="saveConfig()">Connect</button>
        </div>`;
}

function saveConfig() {
    const baseId = document.getElementById('setupBaseId').value.trim();
    const apiKey = document.getElementById('setupApiKey').value.trim();
    if (baseId && apiKey) { localStorage.setItem('airtable_baseId', baseId); localStorage.setItem('airtable_apiKey', apiKey); location.reload(); }
    else alert('Please fill in both fields');
}

function openSettings() {
    const modal = document.getElementById('modalContainer');
    const tokenPreview = state.apiKey ? `${state.apiKey.substring(0,8)}...${state.apiKey.substring(state.apiKey.length-4)}` : 'Not set';
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚öôÔ∏è Settings</h2></div>
        <div class="form-group"><label>Airtable Base ID</label><input type="text" id="settingsBaseId" value="${state.baseId}" style="font-family:monospace;"></div>
        <div class="form-group"><label>Airtable API Key</label><input type="password" id="settingsApiKey" value="${state.apiKey}" style="font-family:monospace;"><p style="font-size:12px;color:var(--success);margin-top:4px;">Current: ${tokenPreview}</p></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveSettings()">Save & Reload</button></div>
    </div></div>`;
}

function saveSettings() {
    const baseId = document.getElementById('settingsBaseId').value.trim();
    const apiKey = document.getElementById('settingsApiKey').value.trim();
    if (!baseId || !apiKey) { alert('Both fields required'); return; }
    localStorage.setItem('airtable_baseId', baseId); localStorage.setItem('airtable_apiKey', apiKey);
    alert('Settings saved! Reloading...'); location.reload();
}

async function loadTeamMembers() {
    try {
        const response = await fetchFromAirtable('Team Members');
        if (response && response.records) {
            state.data.teamMembers = response.records.map(r => ({ id: r.id, name: r.fields.Name || '', role: r.fields.Role || '', quota: r.fields['Monthly Quota'] || (r.fields.Role === 'AE' ? 60000 : 45000) }));
            state.teamMemberMap = {};
            response.records.forEach(r => { if (r.fields.Name) state.teamMemberMap[r.fields.Name] = r.id; });
        }
    } catch (error) {
        console.error('Error loading team members:', error);
        state.data.teamMembers = [
            { id: 'rec1', name: 'Javonte', role: 'BDR', quota: 45000 }, { id: 'rec2', name: 'Teslim', role: 'BDR', quota: 45000 },
            { id: 'rec3', name: 'Israel', role: 'BDR', quota: 45000 }, { id: 'rec4', name: 'Conrad', role: 'AE', quota: 60000 },
            { id: 'rec5', name: 'Test User', role: 'BDR', quota: 45000 }, { id: 'rec6', name: 'Test Leadership', role: 'Leadership', quota: 0 },
            { id: 'rec7', name: 'Ramallah', role: 'Leadership', quota: 0 }, { id: 'rec8', name: 'Keyna', role: 'Leadership', quota: 0 }
        ];
        state.teamMemberMap = { 'Javonte': 'rec1', 'Teslim': 'rec2', 'Israel': 'rec3', 'Conrad': 'rec4', 'Test User': 'rec5', 'Test Leadership': 'rec6', 'Ramallah': 'rec7', 'Keyna': 'rec8' };
    }
}

async function loadPricingRules() {
    try {
        const response = await fetchFromAirtable('Pricing Rules');
        if (response && response.records) {
            state.data.pricingRules = response.records.map(r => ({ id: r.id, tier: r.fields.Tier || '', basePrice: r.fields['Base Price'] || 0 }));
            state.pricingRuleMap = {};
            response.records.forEach(r => { if (r.fields.Tier) state.pricingRuleMap[r.fields.Tier] = r.id; });
        }
    } catch (error) { console.error('Error loading pricing rules:', error); }
}

function populateLoginSelect() {
    const select = document.getElementById('userSelect');
    if (!select) return;
    state.data.teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = `${member.name} (${member.role})`;
        select.appendChild(option);
    });
}

async function handleLogin() {
    const select = document.getElementById('userSelect');
    const passwordInput = document.getElementById('passwordInput');
    const errorDiv = document.getElementById('loginError');
    const selectedName = select.value, enteredPassword = passwordInput.value;
    
    if (!selectedName) { errorDiv.textContent = 'Please select a team member'; errorDiv.classList.remove('hidden'); return; }
    if (!enteredPassword) { errorDiv.textContent = 'Please enter your password'; errorDiv.classList.remove('hidden'); return; }
    if (userPasswords[selectedName] !== enteredPassword) { errorDiv.textContent = 'Incorrect password'; errorDiv.classList.remove('hidden'); passwordInput.value = ''; return; }
    
    const user = state.data.teamMembers.find(m => m.name === selectedName);
    if (user) { state.currentUser = user; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); await initApp(); }
}

async function initApp() {
    document.getElementById('currentUserName').textContent = state.currentUser.name;
    buildNavigation();
    await loadAllData();
    renderView('dashboard');
    setInterval(async () => { await loadAllData(); }, 5 * 60 * 1000);
}

function buildNavigation() {
    const nav = document.getElementById('sidebarNav');
    let items = [...allNavItems];
    if (state.currentUser.role === 'Leadership') items = items.concat(leadershipNavItems);
    nav.innerHTML = items.map(item => `
        <div class="nav-item ${item.id === state.currentView ? 'active' : ''}" onclick="renderView('${item.id}')">
            <span class="nav-item-icon">${item.icon}</span><span>${item.label}</span>
        </div>
    `).join('');
}

function logout() { if (confirm('Are you sure you want to logout?')) location.reload(); }

// ============ AIRTABLE API ============
async function fetchFromAirtable(tableName, method = 'GET', body = null) {
    try {
        let url = `https://api.airtable.com/v0/${state.baseId}/${encodeURIComponent(tableName)}`;
        const options = { method, headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' } };
        if (body && ['POST', 'PATCH', 'PUT'].includes(method)) options.body = JSON.stringify(body);
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) { console.error(`Error with ${tableName}:`, error); throw error; }
}

async function deleteFromAirtable(tableName, recordId) {
    const url = `https://api.airtable.com/v0/${state.baseId}/${encodeURIComponent(tableName)}/${recordId}`;
    const response = await fetch(url, { method: 'DELETE', headers: { 'Authorization': `Bearer ${state.apiKey}` } });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return true;
}

async function updateInAirtable(tableName, recordId, fields) {
    const url = `https://api.airtable.com/v0/${state.baseId}/${encodeURIComponent(tableName)}/${recordId}`;
    const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields }) });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return await response.json();
}

async function loadAllData() {
    try { await Promise.all([loadDeals(), loadActivities(), loadTasks(), loadContacts(), loadAccounts()]); }
    catch (error) { console.error('Error loading data:', error); }
}

function getOwnerName(ownerField) {
    if (Array.isArray(ownerField) && ownerField.length > 0) {
        const member = state.data.teamMembers.find(m => m.id === ownerField[0]);
        return member ? member.name : '';
    }
    return ownerField || '';
}

function getAccountName(accountField) {
    if (Array.isArray(accountField) && accountField.length > 0) {
        const account = state.data.accounts.find(a => a.id === accountField[0]);
        return account ? account.name : '';
    }
    return '';
}

function formatDateCST(dateString) {
    if (!dateString) return '-';
    try { return new Date(dateString).toLocaleString('en-US', { timeZone: 'America/Chicago', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); }
    catch (e) { return dateString; }
}

function calculateCycleTime(deal) {
    if (!deal.createdTime || !deal.closeDate) return null;
    return Math.floor((new Date(deal.closeDate) - new Date(deal.createdTime)) / (1000 * 60 * 60 * 24));
}

function daysSinceClosed(closeDate) {
    if (!closeDate) return null;
    return Math.floor((new Date() - new Date(closeDate)) / (1000 * 60 * 60 * 24));
}

async function loadDeals() {
    const response = await fetchFromAirtable('Deals');
    if (response && response.records) {
        state.data.deals = response.records.map(r => ({
            id: r.id, name: r.fields['Deal Name'] || '', owner: getOwnerName(r.fields.Owner),
            tier: Array.isArray(r.fields['Tier (lookup)']) ? r.fields['Tier (lookup)'][0] : r.fields['Tier (lookup)'] || '',
            stage: r.fields.Stage || '', value: r.fields.Amount || 0, eventName: r.fields['Event Name'] || '',
            closeDate: r.fields['Close Date'] || '', createdTime: r.createdTime,
            pricingType: r.fields['Pricing Type'] || 'Public Price', cycleTime: r.fields['Cycle Time (Days)'], daysSince: r.fields['Days Since Closed']
        }));
    }
}

async function loadActivities() {
    const response = await fetchFromAirtable('Activities');
    if (response && response.records) {
        state.data.activities = response.records.map(r => ({
            id: r.id, name: r.fields['Activity Name'] || '', type: r.fields.Type || '',
            date: r.fields['Activity Date/Time'] || r.fields.Date || '', owner: r.fields.Owner || '',
            account: r.fields.Account || '', contact: Array.isArray(r.fields.Contact) ? r.fields.Contact[0] : r.fields.Contact || '',
            result: r.fields.Result || '', nextSteps: r.fields['Next Steps'] || '', createdTime: r.createdTime
        }));
    }
}

async function loadTasks() {
    const response = await fetchFromAirtable('Tasks');
    if (response && response.records) {
        state.data.tasks = response.records.map(r => ({
            id: r.id, name: r.fields['Task Name'] || '', owner: getOwnerName(r.fields.Owner),
            dueDate: r.fields['Due Date'] || '', status: r.fields.Status || 'Open', type: r.fields.Type || ''
        }));
    }
}

async function loadContacts() {
    const response = await fetchFromAirtable('Contacts');
    if (response && response.records) {
        state.data.contacts = response.records.map(r => ({
            id: r.id, name: r.fields['Full Name'] || '', email: r.fields.Email || '', phone: r.fields.Phone || '',
            company: getAccountName(r.fields.Account), role: r.fields.Title || '', owner: getOwnerName(r.fields['Contact Owner']), createdTime: r.createdTime
        }));
    }
}

async function loadAccounts() {
    const response = await fetchFromAirtable('Accounts');
    if (response && response.records) {
        state.data.accounts = response.records.map(r => ({
            id: r.id, name: r.fields['Account Name'] || '', industry: r.fields.Industry || '',
            owner: getOwnerName(r.fields['Account Owner']), createdTime: r.createdTime
        }));
    }
}

function getUserDeals() {
    if (state.currentUser.role === 'Leadership') return state.data.deals;
    return state.data.deals.filter(d => d.owner === state.currentUser.name);
}

// ============ CRUD OPERATIONS ============
async function createDeal(dealData) {
    try {
        const response = await fetchFromAirtable('Deals', 'POST', { fields: dealData });
        if (response && response.id) { await loadDeals(); closeModal(); renderView('pipeline'); alert('Deal created successfully!'); }
        else alert('Failed to create deal: ' + (response?.error?.message || 'Unknown error'));
    } catch (error) { alert('Error creating deal: ' + error.message); }
}

async function createContact(contactData) {
    try {
        const response = await fetchFromAirtable('Contacts', 'POST', { fields: contactData });
        if (response && response.id) { await loadContacts(); closeModal(); renderView('contacts'); alert('Contact created! +1 New Lead!'); }
    } catch (error) { alert('Error creating contact: ' + error.message); }
}

async function createAccount(accountData) {
    try {
        const response = await fetchFromAirtable('Accounts', 'POST', { fields: accountData });
        if (response && response.id) { await loadAccounts(); closeModal(); renderView('accounts'); alert('Account created! +1 New Lead!'); }
    } catch (error) { alert('Error creating account: ' + error.message); }
}

async function logActivity(activityData) {
    try {
        const response = await fetchFromAirtable('Activities', 'POST', { fields: activityData });
        if (response && response.id) { await loadActivities(); closeModal(); renderView(state.currentView); alert('Activity logged! +1 Touchpoint!'); }
    } catch (error) { alert('Error logging activity: ' + error.message); }
}

// ============ DELETE FUNCTIONS (Leadership) ============
async function deleteContact(contactId) {
    if (!confirm('Delete this contact? This cannot be undone.')) return;
    try { await deleteFromAirtable('Contacts', contactId); await loadContacts(); renderView('contacts'); alert('Contact deleted!'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteAccount(accountId) {
    if (!confirm('Delete this account? This cannot be undone.')) return;
    try { await deleteFromAirtable('Accounts', accountId); await loadAccounts(); renderView('accounts'); alert('Account deleted!'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteDeal(dealId) {
    if (!confirm('Delete this deal? This cannot be undone.')) return;
    try { await deleteFromAirtable('Deals', dealId); await loadDeals(); renderView('pipeline'); alert('Deal deleted!'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteActivity(activityId) {
    if (!confirm('Delete this activity? This cannot be undone.')) return;
    try { await deleteFromAirtable('Activities', activityId); await loadActivities(); renderView('activity'); alert('Activity deleted!'); }
    catch (error) { alert('Error: ' + error.message); }
}

// ============ EDIT MODALS (Leadership) ============
function openEditContactModal(contactId) {
    const contact = state.data.contacts.find(c => c.id === contactId);
    if (!contact) return;
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Contact</h2></div>
        <div class="form-group"><label>Name *</label><input type="text" id="editContactName" value="${contact.name}"></div>
        <div class="form-group"><label>Email *</label><input type="email" id="editContactEmail" value="${contact.email}"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="editContactPhone" value="${contact.phone || ''}"></div>
        <div class="form-group"><label>Role</label><input type="text" id="editContactRole" value="${contact.role || ''}"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditContact('${contactId}')">Save</button></div>
    </div></div>`;
}

async function saveEditContact(contactId) {
    const fields = { 'Full Name': document.getElementById('editContactName').value, 'Email': document.getElementById('editContactEmail').value, 'Phone': document.getElementById('editContactPhone').value, 'Title': document.getElementById('editContactRole').value };
    try { await updateInAirtable('Contacts', contactId, fields); await loadContacts(); closeModal(); renderView('contacts'); alert('Contact updated!'); }
    catch (error) { alert('Error: ' + error.message); }
}

function openEditAccountModal(accountId) {
    const account = state.data.accounts.find(a => a.id === accountId);
    if (!account) return;
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Account</h2></div>
        <div class="form-group"><label>Account Name *</label><input type="text" id="editAccountName" value="${account.name}"></div>
        <div class="form-group"><label>Industry</label><input type="text" id="editAccountIndustry" list="industryOpts" value="${account.industry || ''}">
            <datalist id="industryOpts"><option value="Technology"><option value="Finance"><option value="Education"><option value="Healthcare"><option value="Retail"><option value="Other"></datalist></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditAccount('${accountId}')">Save</button></div>
    </div></div>`;
}

async function saveEditAccount(accountId) {
    const fields = { 'Account Name': document.getElementById('editAccountName').value, 'Industry': document.getElementById('editAccountIndustry').value };
    try { await updateInAirtable('Accounts', accountId, fields); await loadAccounts(); closeModal(); renderView('accounts'); alert('Account updated!'); }
    catch (error) { alert('Error: ' + error.message); }
}

function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }

// ============ ADD MODALS ============
function openAddDealModal() {
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>Add New Deal</h2></div>
        <div class="form-group"><label>Deal Name *</label><input type="text" id="dealName" placeholder="Enter deal name"></div>
        <div class="form-group"><label>Tier * (auto-fills value)</label><select id="dealTier" onchange="updateDealValue()"><option value="">Select tier...</option><option value="Starter">Starter ($750)</option><option value="Growth">Growth ($1,250)</option><option value="Pro">Pro ($2,000)</option><option value="Enterprise">Enterprise ($4,200)</option></select></div>
        <div class="form-group"><label>Deal Value *</label><input type="number" id="dealValue" readonly style="background:var(--bg-light);"></div>
        <div class="form-group"><label>Stage *</label><select id="dealStage"><option value="Qualified">Qualified</option><option value="Proposal Sent">Proposal Sent</option><option value="Negotiation">Negotiation</option><option value="Closed Won">Closed Won</option></select></div>
        <div class="form-group"><label>Event Name</label><input type="text" id="dealEventName"></div>
        <div class="form-group"><label>Close Date</label><input type="date" id="dealCloseDate"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Create Deal</button></div>
    </div></div>`;
}

function updateDealValue() {
    const tier = document.getElementById('dealTier').value;
    document.getElementById('dealValue').value = tier && tierPricing[tier] ? tierPricing[tier] : '';
}

function saveDeal() {
    const dealName = document.getElementById('dealName').value.trim();
    const dealTier = document.getElementById('dealTier').value;
    const dealValue = parseFloat(document.getElementById('dealValue').value) || 0;
    if (!dealName || !dealTier || !dealValue) { alert('Please fill in Deal Name and select Tier'); return; }
    
    const dealData = { 'Deal Name': dealName, 'Amount': dealValue, 'Stage': document.getElementById('dealStage').value };
    if (state.pricingRuleMap[dealTier]) dealData['Pricing Tier'] = [state.pricingRuleMap[dealTier]];
    if (state.teamMemberMap[state.currentUser.name]) dealData['Owner'] = [state.teamMemberMap[state.currentUser.name]];
    const eventName = document.getElementById('dealEventName').value.trim();
    const closeDate = document.getElementById('dealCloseDate').value;
    if (eventName) dealData['Event Name'] = eventName;
    if (closeDate) dealData['Close Date'] = closeDate;
    createDeal(dealData);
}

function openAddContactModal() {
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>Add New Contact</h2></div>
        <div class="form-group"><label>Name *</label><input type="text" id="contactName"></div>
        <div class="form-group"><label>Email *</label><input type="email" id="contactEmail"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="contactPhone"></div>
        <div class="form-group"><label>Company/Account</label><select id="contactAccount"><option value="">Select company...</option>${state.data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}</select></div>
        <div class="form-group"><label>Role</label><input type="text" id="contactRole"></div>
        <p style="font-size:13px;color:var(--text-gray);margin-top:10px;">Owner: ${state.currentUser.name} (auto-assigned)<br>Counts as +1 New Lead!</p>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveContact()">Create</button></div>
    </div></div>`;
}

function saveContact() {
    const contactData = { 'Full Name': document.getElementById('contactName').value, 'Email': document.getElementById('contactEmail').value, 'Phone': document.getElementById('contactPhone').value, 'Title': document.getElementById('contactRole').value };
    if (!contactData['Full Name'] || !contactData['Email']) { alert('Please fill in Name and Email'); return; }
    if (state.teamMemberMap[state.currentUser.name]) contactData['Contact Owner'] = [state.teamMemberMap[state.currentUser.name]];
    const accountId = document.getElementById('contactAccount').value;
    if (accountId) contactData['Account'] = [accountId];
    createContact(contactData);
}

function openAddAccountModal() {
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>Add New Account</h2></div>
        <div class="form-group"><label>Account Name *</label><input type="text" id="accountName" placeholder="Enter account name"></div>
        <div class="form-group"><label>Industry</label><input type="text" id="accountIndustry" list="industryOptions" placeholder="Type to search...">
            <datalist id="industryOptions"><option value="Technology"><option value="Finance"><option value="Education"><option value="Healthcare"><option value="Retail"><option value="Other"></datalist></div>
        <p style="font-size:13px;color:var(--text-gray);margin-top:10px;">Owner: ${state.currentUser.name} (auto-assigned)<br>Counts as +1 New Lead!</p>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveAccount()">Create</button></div>
    </div></div>`;
}

function saveAccount() {
    const accountData = { 'Account Name': document.getElementById('accountName').value, 'Industry': document.getElementById('accountIndustry').value };
    if (!accountData['Account Name']) { alert('Please enter account name'); return; }
    if (state.teamMemberMap[state.currentUser.name]) accountData['Account Owner'] = [state.teamMemberMap[state.currentUser.name]];
    createAccount(accountData);
}

function openLogActivityModal() {
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>Log Activity</h2></div>
        <div class="form-group"><label>Activity Type *</label><select id="activityType"><option value="Call">Call</option><option value="Email">Email</option><option value="LinkedIn">LinkedIn Message</option><option value="Discovery Call">Discovery Call</option><option value="Demo">Demo</option><option value="Proposal">Proposal Sent</option><option value="Follow-up">Follow-up</option><option value="Meeting Booked">Meeting Booked</option><option value="Meeting Held">Meeting Held</option></select></div>
        <div class="form-group"><label>Account *</label><select id="activityAccount"><option value="">Select account...</option>${state.data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}</select></div>
        <div class="form-group"><label>Contact</label><select id="activityContact"><option value="">Select contact...</option>${state.data.contacts.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
        <div class="form-group"><label>Result/Outcome *</label><textarea id="activityResult" placeholder="What happened?"></textarea></div>
        <div class="form-group"><label>Next Steps</label><textarea id="activityNextSteps" placeholder="What needs to happen next?"></textarea></div>
        <p style="font-size:13px;color:var(--text-gray);margin-top:10px;">Counts as +1 Touchpoint!</p>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveActivity()">Log Activity</button></div>
    </div></div>`;
}

function saveActivity() {
    const accountRecordId = document.getElementById('activityAccount').value;
    const result = document.getElementById('activityResult').value;
    if (!accountRecordId || !result) { alert('Please select an Account and enter Result'); return; }
    
    const account = state.data.accounts.find(a => a.id === accountRecordId);
    const accountName = account ? account.name : '';
    const activityType = document.getElementById('activityType').value;
    const now = new Date();
    
    const activityData = {
        'Activity Name': `${activityType} - ${accountName}`, 'Type': activityType,
        'Date': now.toISOString().split('T')[0], 'Activity Date/Time': now.toISOString(),
        'Account': accountName, 'Owner': state.currentUser.name, 'Result': result
    };
    
    const contactId = document.getElementById('activityContact').value;
    const nextSteps = document.getElementById('activityNextSteps').value;
    if (contactId) activityData['Contact'] = [contactId];
    if (nextSteps) activityData['Next Steps'] = nextSteps;
    logActivity(activityData);
}

function openDealDetailsModal(dealId) {
    const deal = state.data.deals.find(d => d.id === dealId);
    if (!deal) { alert('Deal not found'); return; }
    const isLeadership = state.currentUser.role === 'Leadership';
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìä ${deal.name}</h2></div>
        <div class="form-group"><label>Deal Value</label><input type="text" value="$${deal.value.toLocaleString()}" disabled style="background:var(--bg-light);font-weight:600;font-size:18px;"></div>
        <div class="form-group"><label>Tier</label><div><span class="badge badge-${deal.tier.toLowerCase()}">${deal.tier}</span></div></div>
        <div class="form-group"><label>Current Stage</label><select id="dealStageEdit"><option value="Qualified" ${deal.stage==='Qualified'?'selected':''}>Qualified</option><option value="Proposal Sent" ${deal.stage==='Proposal Sent'?'selected':''}>Proposal Sent</option><option value="Negotiation" ${deal.stage==='Negotiation'?'selected':''}>Negotiation</option><option value="Closed Won" ${deal.stage==='Closed Won'?'selected':''}>Closed Won</option><option value="Closed Lost" ${deal.stage==='Closed Lost'?'selected':''}>Closed Lost</option></select></div>
        <div class="modal-actions">${isLeadership ? `<button class="btn btn-danger" onclick="deleteDeal('${dealId}')">üóëÔ∏è Delete</button>` : ''}<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="updateDealStage('${dealId}')">Update Stage</button></div>
    </div></div>`;
}

async function updateDealStage(dealId, newStage) {
    if (!newStage) newStage = document.getElementById('dealStageEdit').value;
    const deal = state.data.deals.find(d => d.id === dealId);
    if (!deal) { alert('Deal not found'); return; }
    if (newStage === deal.stage) { closeModal(); return; }
    
    try {
        await fetch(`https://api.airtable.com/v0/${state.baseId}/Deals/${dealId}`, {
            method: 'PATCH', headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Stage': newStage } })
        });
        await loadDeals(); closeModal(); renderView('pipeline'); alert(`Deal moved to ${newStage}!`);
    } catch (error) { alert(`Error: ${error.message}`); }
}

// ============ VIEW RENDERING ============
function renderView(viewName) {
    destroyCharts();
    state.currentView = viewName;
    state.filterRep = null;
    state.filterMonth = null;
    document.getElementById('pageTitle').textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
    
    const views = { 'dashboard': renderDashboard, 'pipeline': renderPipeline, 'tasks': renderTasks, 'contacts': renderContacts, 'accounts': renderAccounts, 'activity': renderActivityView, 'reports': renderReports, 'leadership': renderLeadershipDashboard, 'team': renderTeamOverview };
    if (views[viewName]) { views[viewName](); buildNavigation(); }
}

function renderDashboard() {
    if (state.currentUser.role === 'Leadership') { renderLeadershipDashboard(); return; }
    
    const deals = getUserDeals();
    const targets = getKPITargets(state.currentUser.role);
    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const userActivities = state.data.activities.filter(a => a.owner === state.currentUser.name);
    const todayActivities = userActivities.filter(a => a.date && a.date.split('T')[0] === todayISO);
    
    const calls = userActivities.filter(a => a.type && a.type.toLowerCase().includes('call')).length;
    const emails = userActivities.filter(a => a.type && a.type.toLowerCase().includes('email')).length;
    const linkedin = userActivities.filter(a => a.type && (a.type.toLowerCase().includes('linkedin') || a.type.toLowerCase().includes('message'))).length;
    const demos = userActivities.filter(a => a.type && a.type.toLowerCase().includes('demo')).length;
    const proposals = userActivities.filter(a => a.type && a.type.toLowerCase().includes('proposal')).length;
    
    const todayTouchpoints = todayActivities.length;
    const todayNewLeads = state.data.contacts.filter(c => c.owner === state.currentUser.name && c.createdTime && c.createdTime.split('T')[0] === todayISO).length;
    const todayDiscoveryCalls = todayActivities.filter(a => a.type && (a.type.toLowerCase().includes('discovery') || a.type.toLowerCase().includes('call'))).length;
    const todayDealsMovedCount = todayActivities.filter(a => a.result && a.result.toLowerCase().includes('moved')).length;
    
    const monthClosedDeals = deals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const monthRevenue = monthClosedDeals.reduce((sum, d) => sum + d.value, 0);
    const revenuePercentOfMax = (monthRevenue / targets.monthlyRevenueMax) * 100;
    const eventsPercentOfMax = (monthClosedDeals.length / targets.monthlyEventsMax) * 100;
    
    const starterDeals = monthClosedDeals.filter(d => d.tier === 'Starter');
    const growthDeals = monthClosedDeals.filter(d => d.tier === 'Growth');
    const proDeals = monthClosedDeals.filter(d => d.tier === 'Pro');
    const enterpriseDeals = monthClosedDeals.filter(d => d.tier === 'Enterprise');
    
    const growthPlusCount = growthDeals.length + proDeals.length + enterpriseDeals.length;
    const qualityScore = monthClosedDeals.length > 0 ? (growthPlusCount / monthClosedDeals.length) * 100 : 0;
    const qualityMet = qualityScore >= 70;
    
    const pipelineDeals = deals.filter(d => !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost'));
    const allClosedDeals = deals.filter(d => d.stage.toLowerCase().includes('won')).sort((a, b) => new Date(b.closeDate || b.createdTime) - new Date(a.closeDate || a.createdTime));
    
    const getStatusColor = (value, target) => value >= target ? 'var(--success)' : value >= target * 0.5 ? '#ff9800' : 'var(--danger)';
    const getStatusIcon = (value, target) => value >= target ? '‚úÖ' : value >= target * 0.5 ? '‚ö†Ô∏è' : '‚ùå';

    const content = document.getElementById('contentArea');
    content.innerHTML = `
        ${renderNudges()}
        
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìÖ Daily Scorecard - ${new Date().toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric'})}</h2></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;padding:20px;">
                <div class="kpi-card" style="border-left:4px solid ${getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin)};">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;"><div style="font-size:13px;color:var(--text-gray);font-weight:600;">TOUCHPOINTS TODAY</div><div style="font-size:24px;">${getStatusIcon(todayTouchpoints,targets.dailyTouchpointsMin)}</div></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin)};">${todayTouchpoints}</div>
                    <div style="font-size:13px;color:var(--text-gray);margin-top:8px;">Target: ${targets.dailyTouchpointsMin}-${targets.dailyTouchpointsMax}/day</div>
                    <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" style="width:${Math.min((todayTouchpoints/targets.dailyTouchpointsMax)*100,100)}%;background:${getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin)};"></div></div>
                </div>
                <div class="kpi-card" style="border-left:4px solid ${getStatusColor(todayNewLeads,3)};">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;"><div style="font-size:13px;color:var(--text-gray);font-weight:600;">NEW LEADS TODAY</div><div style="font-size:24px;">${getStatusIcon(todayNewLeads,3)}</div></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayNewLeads,3)};">${todayNewLeads}</div>
                    <div style="font-size:13px;color:var(--text-gray);margin-top:8px;">Target: 3-5/day</div>
                    <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" style="width:${Math.min((todayNewLeads/5)*100,100)}%;background:${getStatusColor(todayNewLeads,3)};"></div></div>
                </div>
                <div class="kpi-card" style="border-left:4px solid ${getStatusColor(todayDiscoveryCalls,targets.dailyDiscovery)};">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;"><div style="font-size:13px;color:var(--text-gray);font-weight:600;">DISCOVERY CALLS</div><div style="font-size:24px;">${getStatusIcon(todayDiscoveryCalls,targets.dailyDiscovery)}</div></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayDiscoveryCalls,targets.dailyDiscovery)};">${todayDiscoveryCalls}</div>
                    <div style="font-size:13px;color:var(--text-gray);margin-top:8px;">Target: ${targets.dailyDiscovery}+/day</div>
                    <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" style="width:${Math.min(todayDiscoveryCalls*100,100)}%;background:${getStatusColor(todayDiscoveryCalls,targets.dailyDiscovery)};"></div></div>
                </div>
                <div class="kpi-card" style="border-left:4px solid ${getStatusColor(todayDealsMovedCount,targets.dailyDealsMoved)};">
                    <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;"><div style="font-size:13px;color:var(--text-gray);font-weight:600;">DEALS MOVED FORWARD</div><div style="font-size:24px;">${getStatusIcon(todayDealsMovedCount,targets.dailyDealsMoved)}</div></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayDealsMovedCount,targets.dailyDealsMoved)};">${todayDealsMovedCount}</div>
                    <div style="font-size:13px;color:var(--text-gray);margin-top:8px;">Target: ${targets.dailyDealsMoved}+/day</div>
                    <div class="progress-bar" style="margin-top:12px;"><div class="progress-fill" style="width:${Math.min(todayDealsMovedCount*100,100)}%;background:${getStatusColor(todayDealsMovedCount,targets.dailyDealsMoved)};"></div></div>
                </div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üí∞ MONTHLY REVENUE</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">$${(monthRevenue/1000).toFixed(1)}K</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: $${(targets.monthlyRevenueMin/1000).toFixed(1)}K - $${(targets.monthlyRevenueMax/1000).toFixed(1)}K</div>
                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;"><div style="width:${Math.min(revenuePercentOfMax,100)}%;height:100%;background:white;"></div></div>
                <div style="font-size:13px;font-weight:600;margin-top:8px;">${revenuePercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üéâ EVENTS CLOSED</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">${monthClosedDeals.length}</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: ${targets.monthlyEventsMin}-${targets.monthlyEventsMax} events</div>
                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;"><div style="width:${Math.min(eventsPercentOfMax,100)}%;height:100%;background:white;"></div></div>
                <div style="font-size:13px;font-weight:600;margin-top:8px;">${eventsPercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üìä QUALITY SCORE</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">${qualityScore.toFixed(0)}%</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">${qualityMet ? '‚úÖ' : '‚ö†Ô∏è'} 70%+ Growth+ Required</div>
                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;"><div style="width:${Math.min(qualityScore,100)}%;height:100%;background:white;"></div></div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üíµ AVG DEAL SIZE</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">${monthClosedDeals.length > 0 ? '$' + Math.round(monthRevenue/monthClosedDeals.length).toLocaleString() : '$0'}</div>
                <div style="font-size:14px;opacity:0.9;">This month</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card"><h3>üìà Revenue Trend (6 Months)</h3><div class="chart-container"><canvas id="repRevenueTrendChart"></canvas></div></div>
            <div class="chart-card"><h3>ü•ß Revenue by Tier</h3><div class="chart-container"><canvas id="repRevenueByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üìä Events by Tier</h3><div class="chart-container"><canvas id="repEventsByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üí∞ Revenue by Pricing Type</h3><div class="chart-container"><canvas id="repRevenueByPricingChart"></canvas></div></div>
        </div>

        <div class="card">
            <div class="card-header"><h2 class="card-title">üéØ Monthly Deal Mix</h2><span class="quality-badge ${qualityMet ? 'success' : 'warning'}">${qualityMet ? '‚úÖ Quality Goal Met' : '‚ö†Ô∏è Need More Growth+ Deals'}</span></div>
            <table>
                <thead><tr><th>Tier</th><th>Target</th><th>Closed</th><th>Pipeline</th><th>Revenue</th></tr></thead>
                <tbody>
                    <tr><td><span class="badge badge-starter">Starter</span></td><td>1</td><td><strong>${starterDeals.length}</strong></td><td>${pipelineDeals.filter(d=>d.tier==='Starter').length}</td><td>$${(starterDeals.reduce((s,d)=>s+d.value,0)/1000).toFixed(1)}K</td></tr>
                    <tr><td><span class="badge badge-growth">Growth</span></td><td>2-3</td><td><strong>${growthDeals.length}</strong></td><td>${pipelineDeals.filter(d=>d.tier==='Growth').length}</td><td>$${(growthDeals.reduce((s,d)=>s+d.value,0)/1000).toFixed(1)}K</td></tr>
                    <tr><td><span class="badge badge-pro">Pro</span></td><td>2</td><td><strong>${proDeals.length}</strong></td><td>${pipelineDeals.filter(d=>d.tier==='Pro').length}</td><td>$${(proDeals.reduce((s,d)=>s+d.value,0)/1000).toFixed(1)}K</td></tr>
                    <tr><td><span class="badge badge-enterprise">Enterprise</span></td><td>0-1</td><td><strong>${enterpriseDeals.length}</strong></td><td>${pipelineDeals.filter(d=>d.tier==='Enterprise').length}</td><td>$${(enterpriseDeals.reduce((s,d)=>s+d.value,0)/1000).toFixed(1)}K</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìä Activity Breakdown</h2></div>
            <div class="activity-stats">
                <div class="stat-card"><div class="stat-icon">üìû</div><div class="stat-value">${calls}</div><div class="stat-label">Calls Made</div></div>
                <div class="stat-card"><div class="stat-icon">üìß</div><div class="stat-value">${emails}</div><div class="stat-label">Emails Sent</div></div>
                <div class="stat-card"><div class="stat-icon">üíº</div><div class="stat-value">${linkedin}</div><div class="stat-label">Messages</div></div>
                <div class="stat-card"><div class="stat-icon">üé•</div><div class="stat-value">${demos}</div><div class="stat-label">Demos</div></div>
                <div class="stat-card"><div class="stat-icon">üìÑ</div><div class="stat-value">${proposals}</div><div class="stat-label">Proposals</div></div>
                <div class="stat-card"><div class="stat-icon">üéâ</div><div class="stat-value">${allClosedDeals.length}</div><div class="stat-label">Total Wins</div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><h2 class="card-title">üèÜ Recent Wins</h2></div>
            <div class="wins-list">
                ${allClosedDeals.length === 0 ? '<p style="text-align:center;color:var(--text-gray);padding:40px;">No wins yet. Keep closing!</p>' : allClosedDeals.slice(0,5).map(deal => {
                    const cycleTime = calculateCycleTime(deal);
                    const daysAgo = daysSinceClosed(deal.closeDate);
                    return `<div class="win-card"><div class="win-info"><div class="win-name">${deal.name}</div><div class="win-meta"><span class="badge badge-${deal.tier.toLowerCase()}">${deal.tier}</span><span style="color:var(--text-gray);font-size:13px;">üìÖ ${deal.eventName || 'Event TBD'}${cycleTime ? ` ‚Ä¢ ‚è±Ô∏è ${cycleTime} days` : ''}${daysAgo !== null ? ` ‚Ä¢ üïê ${daysAgo === 0 ? 'Today' : daysAgo + ' days ago'}` : ''}</span></div></div><div class="win-value">$${deal.value.toLocaleString()}</div></div>`;
                }).join('')}
            </div>
        </div>
    `;
    
    // Render charts after DOM is ready
    setTimeout(() => {
        renderRevenueTrendChart('repRevenueTrendChart', deals);
        renderRevenueByTierChart('repRevenueByTierChart', deals);
        renderEventsByTierChart('repEventsByTierChart', deals);
        renderRevenueByPricingChart('repRevenueByPricingChart', deals);
    }, 100);
}

function renderLeadershipDashboard() {
    const allDeals = state.data.deals;
    const allActivities = state.data.activities;
    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const yearStart = new Date(today.getFullYear(), 0, 1);
    
    const todayActivities = allActivities.filter(a => a.date && a.date.split('T')[0] === todayISO);
    const todayTouchpoints = todayActivities.length;
    const todayDiscoveryCalls = todayActivities.filter(a => a.type && (a.type.toLowerCase().includes('discovery') || a.type.toLowerCase().includes('call'))).length;
    const todayNewLeads = state.data.contacts.filter(c => c.createdTime && c.createdTime.split('T')[0] === todayISO).length;
    
    const monthClosedDeals = allDeals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const monthRevenue = monthClosedDeals.reduce((sum, d) => sum + d.value, 0);
    const revenuePercentOfMax = (monthRevenue / KPI_TARGETS.Team.monthlyRevenueMax) * 100;
    const eventsPercentOfMax = (monthClosedDeals.length / KPI_TARGETS.Team.monthlyEventsMax) * 100;
    
    const starterDeals = monthClosedDeals.filter(d => d.tier === 'Starter');
    const growthDeals = monthClosedDeals.filter(d => d.tier === 'Growth');
    const proDeals = monthClosedDeals.filter(d => d.tier === 'Pro');
    const enterpriseDeals = monthClosedDeals.filter(d => d.tier === 'Enterprise');
    const growthPlusDeals = growthDeals.length + proDeals.length + enterpriseDeals.length;
    const qualityScore = monthClosedDeals.length > 0 ? (growthPlusDeals / monthClosedDeals.length) * 100 : 0;
    
    // Floor Pricing
    const yearDeals = allDeals.filter(d => { const dt = d.createdTime ? new Date(d.createdTime) : null; return dt && dt >= yearStart; });
    const floorDeals = yearDeals.filter(d => d.pricingType === 'Floor Price');
    const floorStarter = floorDeals.filter(d => d.tier === 'Starter').length;
    const floorGrowth = floorDeals.filter(d => d.tier === 'Growth').length;
    const floorPro = floorDeals.filter(d => d.tier === 'Pro').length;
    const floorEnterprise = floorDeals.filter(d => d.tier === 'Enterprise').length;
    const totalFloorUsed = floorStarter + floorGrowth + floorPro + floorEnterprise;
    const floorCapacity = { total: 10, starter: { max: 2, used: floorStarter }, growth: { max: 2, used: floorGrowth }, pro: { max: 3, used: floorPro }, enterprise: { max: 3, used: floorEnterprise } };
    
    // Rep performance
    const repCards = state.data.teamMembers.filter(m => m.role !== 'Leadership').map(member => {
        const memberDeals = allDeals.filter(d => d.owner === member.name);
        const memberMonthWon = memberDeals.filter(d => {
            if (!d.stage.toLowerCase().includes('won')) return false;
            const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return dealDate && dealDate >= monthStart;
        });
        const memberRevenue = memberMonthWon.reduce((sum, d) => sum + d.value, 0);
        const targets = getKPITargets(member.role);
        const attainment = (memberRevenue / targets.monthlyRevenueMax) * 100;
        const memberTouchpoints = todayActivities.filter(a => a.owner === member.name).length;
        
        let statusClass = 'rep-card-green';
        if (attainment < 70) statusClass = 'rep-card-red';
        else if (attainment < 100) statusClass = 'rep-card-yellow';
        
        return { id: member.id, name: member.name, role: member.role, quota: targets.monthlyRevenueMax, revenue: memberRevenue, attainment, deals: memberMonthWon.length, touchpoints: memberTouchpoints, statusClass, activePipeline: memberDeals.filter(d => !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost')).length };
    });
    
    // KPI Alerts
    const needsAttention = repCards.filter(r => r.attainment < 70);
    const onTrack = repCards.filter(r => r.attainment >= 100);

    const content = document.getElementById('contentArea');
    content.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px;">
            <div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üí∞ TEAM MONTHLY REVENUE</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">$${(monthRevenue/1000).toFixed(1)}K</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: $${KPI_TARGETS.Team.monthlyRevenueMin/1000}K - $${KPI_TARGETS.Team.monthlyRevenueMax/1000}K</div>
                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;"><div style="width:${Math.min(revenuePercentOfMax,100)}%;height:100%;background:white;"></div></div>
                <div style="font-size:13px;font-weight:600;margin-top:8px;">${revenuePercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üéâ TEAM EVENTS CLOSED</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">${monthClosedDeals.length}</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: ${KPI_TARGETS.Team.monthlyEventsMin}-${KPI_TARGETS.Team.monthlyEventsMax} events</div>
                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;"><div style="width:${Math.min(eventsPercentOfMax,100)}%;height:100%;background:white;"></div></div>
                <div style="font-size:13px;font-weight:600;margin-top:8px;">${eventsPercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üìä QUALITY SCORE</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">${qualityScore.toFixed(0)}%</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Growth+ Tier Deals (Target: 70%)</div>
                <div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;overflow:hidden;"><div style="width:${Math.min(qualityScore,100)}%;height:100%;background:white;"></div></div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üî• TEAM ACTIVITY TODAY</div>
                <div style="font-size:42px;font-weight:700;margin-bottom:8px;">${todayTouchpoints}</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:8px;">Touchpoints Logged</div>
                <div style="font-size:13px;opacity:0.8;">${todayDiscoveryCalls} Discovery Calls ‚Ä¢ ${todayNewLeads} New Leads</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card"><h3>üìà Team Revenue Trend (6 Months)</h3><div class="chart-container"><canvas id="teamRevenueTrendChart"></canvas></div></div>
            <div class="chart-card"><h3>ü•ß Team Revenue by Tier</h3><div class="chart-container"><canvas id="teamRevenueByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üìä Team Events by Tier</h3><div class="chart-container"><canvas id="teamEventsByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üí∞ Team Revenue by Pricing</h3><div class="chart-container"><canvas id="teamRevenueByPricingChart"></canvas></div></div>
        </div>

        <div class="card">
            <div class="card-header"><h2 class="card-title">üö® Floor-Price Event Capacity (${new Date().getFullYear()})</h2></div>
            <div class="floor-tracker">
                <div class="capacity-circle"><div class="capacity-number">${totalFloorUsed}/${floorCapacity.total}</div><div class="capacity-label">events used</div></div>
                <div class="capacity-percentage">${((totalFloorUsed/floorCapacity.total)*100).toFixed(0)}% Utilized</div>
                <p style="color:var(--text-gray);margin-bottom:20px;">Remaining: ${floorCapacity.total - totalFloorUsed}</p>
                <table>
                    <thead><tr><th>Tier</th><th>Max</th><th>Used</th><th>Remaining</th></tr></thead>
                    <tbody>
                        <tr style="background:${floorCapacity.starter.used >= floorCapacity.starter.max ? '#fadbd8' : 'transparent'};"><td><span class="badge badge-starter">Starter</span></td><td>${floorCapacity.starter.max}</td><td><strong>${floorCapacity.starter.used}</strong></td><td>${floorCapacity.starter.max - floorCapacity.starter.used} ${floorCapacity.starter.used >= floorCapacity.starter.max ? '‚ö†Ô∏è' : ''}</td></tr>
                        <tr style="background:${floorCapacity.growth.used >= floorCapacity.growth.max ? '#fadbd8' : 'transparent'};"><td><span class="badge badge-growth">Growth</span></td><td>${floorCapacity.growth.max}</td><td><strong>${floorCapacity.growth.used}</strong></td><td>${floorCapacity.growth.max - floorCapacity.growth.used} ${floorCapacity.growth.used >= floorCapacity.growth.max ? '‚ö†Ô∏è' : ''}</td></tr>
                        <tr style="background:${floorCapacity.pro.used >= floorCapacity.pro.max ? '#fadbd8' : 'transparent'};"><td><span class="badge badge-pro">Pro</span></td><td>${floorCapacity.pro.max}</td><td><strong>${floorCapacity.pro.used}</strong></td><td>${floorCapacity.pro.max - floorCapacity.pro.used} ${floorCapacity.pro.used >= floorCapacity.pro.max ? '‚ö†Ô∏è' : ''}</td></tr>
                        <tr style="background:${floorCapacity.enterprise.used >= floorCapacity.enterprise.max ? '#fadbd8' : 'transparent'};"><td><span class="badge badge-enterprise">Enterprise</span></td><td>${floorCapacity.enterprise.max}</td><td><strong>${floorCapacity.enterprise.used}</strong></td><td>${floorCapacity.enterprise.max - floorCapacity.enterprise.used} ${floorCapacity.enterprise.used >= floorCapacity.enterprise.max ? '‚ö†Ô∏è' : ''}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        ${needsAttention.length > 0 || onTrack.length > 0 ? `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìã KPI Alerts</h2></div>
            <div class="kpi-alerts">
                ${needsAttention.map(r => `<div class="kpi-alert-item needs-attention">üî¥ <strong>${r.name}</strong> is at ${r.attainment.toFixed(0)}% of max target - needs coaching</div>`).join('')}
                ${onTrack.map(r => `<div class="kpi-alert-item on-track">üü¢ <strong>${r.name}</strong> is at ${r.attainment.toFixed(0)}% of max target - exceeding!</div>`).join('')}
            </div>
        </div>
        ` : ''}

        <div class="card">
            <div class="card-header"><h2 class="card-title">üë• Sales Team Performance</h2><p style="font-size:13px;color:var(--text-gray);">Click any card for detailed insights</p></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;padding:20px;">
                ${repCards.map(rep => `
                    <div class="kpi-card ${rep.statusClass}" onclick="openRepDetailsModal('${rep.id}')" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='';this.style.boxShadow='';">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:16px;">
                            <div><div style="font-size:16px;font-weight:700;color:var(--text-dark);">${rep.name}</div><div style="font-size:13px;color:var(--text-gray);">${rep.role}</div></div>
                            <div style="font-size:32px;">üë§</div>
                        </div>
                        <div style="display:flex;justify-content:space-between;align-items:end;margin-bottom:12px;">
                            <div><div style="font-size:13px;color:var(--text-gray);margin-bottom:4px;">This Month</div><div style="font-size:28px;font-weight:700;color:var(--primary);">$${(rep.revenue/1000).toFixed(1)}K</div></div>
                            <div style="text-align:right;"><div style="font-size:13px;color:var(--text-gray);">Today</div><div style="font-size:24px;font-weight:700;color:var(--primary);">${rep.touchpoints}</div><div style="font-size:11px;color:var(--text-gray);">touchpoints</div></div>
                        </div>
                        <div style="font-size:13px;color:var(--text-gray);margin-bottom:12px;">${rep.deals} deals ‚Ä¢ ${rep.activePipeline} in pipeline</div>
                        <div style="background:var(--bg-light);height:6px;border-radius:3px;overflow:hidden;margin-bottom:8px;"><div style="width:${Math.min(rep.attainment,100)}%;height:100%;background:${rep.attainment >= 100 ? 'var(--success)' : rep.attainment >= 70 ? 'var(--warning)' : 'var(--danger)'};"></div></div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;"><span style="color:var(--text-gray);">Max: $${(rep.quota/1000).toFixed(0)}K</span><span style="font-weight:600;color:${rep.attainment >= 100 ? 'var(--success)' : rep.attainment >= 70 ? 'var(--warning)' : 'var(--danger)'};">${rep.attainment.toFixed(0)}%</span></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    setTimeout(() => {
        renderRevenueTrendChart('teamRevenueTrendChart', allDeals, 'Team Revenue');
        renderRevenueByTierChart('teamRevenueByTierChart', allDeals);
        renderEventsByTierChart('teamEventsByTierChart', allDeals);
        renderRevenueByPricingChart('teamRevenueByPricingChart', allDeals);
    }, 100);
}

function openRepDetailsModal(memberId) {
    const member = state.data.teamMembers.find(m => m.id === memberId);
    if (!member) return;
    
    const today = new Date();
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const todayISO = today.toISOString().split('T')[0];
    const targets = getKPITargets(member.role);
    
    const memberDeals = state.data.deals.filter(d => d.owner === member.name);
    const memberMonthWon = memberDeals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const memberActivities = state.data.activities.filter(a => a.owner === member.name);
    const memberTodayActivities = memberActivities.filter(a => a.date && a.date.split('T')[0] === todayISO);
    const memberMonthActivities = memberActivities.filter(a => { const dt = a.date ? new Date(a.date) : null; return dt && dt >= monthStart; });
    
    const calls = memberActivities.filter(a => a.type && a.type.toLowerCase().includes('call')).length;
    const emails = memberActivities.filter(a => a.type && a.type.toLowerCase().includes('email')).length;
    const linkedin = memberActivities.filter(a => a.type && (a.type.toLowerCase().includes('linkedin') || a.type.toLowerCase().includes('message'))).length;
    const demos = memberActivities.filter(a => a.type && a.type.toLowerCase().includes('demo')).length;
    const proposals = memberActivities.filter(a => a.type && a.type.toLowerCase().includes('proposal')).length;
    
    const starterDeals = memberMonthWon.filter(d => d.tier === 'Starter').length;
    const growthDeals = memberMonthWon.filter(d => d.tier === 'Growth').length;
    const proDeals = memberMonthWon.filter(d => d.tier === 'Pro').length;
    const enterpriseDeals = memberMonthWon.filter(d => d.tier === 'Enterprise').length;
    
    const memberRevenue = memberMonthWon.reduce((sum, d) => sum + d.value, 0);
    const revenuePercentOfMax = (memberRevenue / targets.monthlyRevenueMax) * 100;
    const eventsPercentOfMax = (memberMonthWon.length / targets.monthlyEventsMax) * 100;
    
    const todayCalls = memberTodayActivities.filter(a => a.type && a.type.toLowerCase().includes('call')).length;
    const todayDiscovery = memberTodayActivities.filter(a => a.type && a.type.toLowerCase().includes('discovery')).length;
    
    const getStatusColor = (value, target) => value >= target ? 'var(--success)' : value >= target * 0.5 ? '#ff9800' : 'var(--danger)';
    const getStatusIcon = (value, target) => value >= target ? '‚úÖ' : value >= target * 0.5 ? '‚ö†Ô∏è' : '‚ùå';
    
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `
        <div class="modal active"><div class="modal-content wide" style="max-width:900px;">
            <div class="modal-header"><h2>${member.name} - Full Performance Insights</h2></div>
            <div style="padding:20px;">
                <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;">üìÖ Today's KPIs</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:30px;">
                    <div class="stat-card clickable-stat" onclick="state.filterRep='${member.name}';closeModal();renderView('activity');">
                        <div style="font-size:13px;color:var(--text-gray);margin-bottom:8px;">Touchpoints Today</div>
                        <div style="font-size:32px;font-weight:700;color:${getStatusColor(memberTodayActivities.length,targets.dailyTouchpointsMin)};">${memberTodayActivities.length}</div>
                        <div style="font-size:12px;color:var(--text-gray);">Target: ${targets.dailyTouchpointsMin}-${targets.dailyTouchpointsMax} ${getStatusIcon(memberTodayActivities.length,targets.dailyTouchpointsMin)}</div>
                        <div style="font-size:11px;color:var(--primary);margin-top:8px;">Click to view ‚Üí</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size:13px;color:var(--text-gray);margin-bottom:8px;">Calls</div>
                        <div style="font-size:32px;font-weight:700;color:${getStatusColor(todayCalls,targets.dailyCalls)};">${todayCalls}</div>
                        <div style="font-size:12px;color:var(--text-gray);">Target: ${targets.dailyCalls}+ ${getStatusIcon(todayCalls,targets.dailyCalls)}</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size:13px;color:var(--text-gray);margin-bottom:8px;">Discovery Calls</div>
                        <div style="font-size:32px;font-weight:700;color:${getStatusColor(todayDiscovery,targets.dailyDiscovery)};">${todayDiscovery}</div>
                        <div style="font-size:12px;color:var(--text-gray);">Target: ${targets.dailyDiscovery}+ ${getStatusIcon(todayDiscovery,targets.dailyDiscovery)}</div>
                    </div>
                    <div class="stat-card clickable-stat" onclick="state.filterRep='${member.name}';state.filterMonth=true;closeModal();renderView('activity');">
                        <div style="font-size:13px;color:var(--text-gray);margin-bottom:8px;">Activities This Month</div>
                        <div style="font-size:32px;font-weight:700;color:var(--primary);">${memberMonthActivities.length}</div>
                        <div style="font-size:11px;color:var(--primary);margin-top:8px;">Click to view ‚Üí</div>
                    </div>
                </div>
                
                <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;">üí∞ Monthly KPIs</h3>
                <div style="background:var(--bg-light);padding:24px;border-radius:12px;margin-bottom:30px;">
                    <div style="display:flex;justify-content:space-between;align-items:end;margin-bottom:16px;">
                        <div><div style="font-size:13px;color:var(--text-gray);margin-bottom:4px;">Revenue</div><div style="font-size:36px;font-weight:700;color:var(--primary);">$${(memberRevenue/1000).toFixed(1)}K</div></div>
                        <div style="text-align:right;"><div style="font-size:13px;color:var(--text-gray);margin-bottom:4px;">Target</div><div style="font-size:20px;font-weight:600;color:var(--text-gray);">$${(targets.monthlyRevenueMin/1000).toFixed(1)}K - $${(targets.monthlyRevenueMax/1000).toFixed(1)}K</div></div>
                    </div>
                    <div style="background:white;height:12px;border-radius:6px;overflow:hidden;margin-bottom:12px;"><div style="width:${Math.min(revenuePercentOfMax,100)}%;height:100%;background:var(--success);"></div></div>
                    <div style="display:flex;justify-content:space-between;"><span style="font-size:14px;color:var(--text-gray);">${memberMonthWon.length} events (Target: ${targets.monthlyEventsMin}-${targets.monthlyEventsMax})</span><span style="font-size:16px;font-weight:700;color:var(--success);">${revenuePercentOfMax.toFixed(1)}% of Max Target</span></div>
                </div>
                
                <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;">üìä Activity Breakdown (All Time)</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-bottom:30px;">
                    <div class="stat-card"><div style="font-size:28px;">üìû</div><div style="font-size:24px;font-weight:700;margin-top:8px;">${calls}</div><div style="font-size:12px;color:var(--text-gray);">Calls</div></div>
                    <div class="stat-card"><div style="font-size:28px;">üìß</div><div style="font-size:24px;font-weight:700;margin-top:8px;">${emails}</div><div style="font-size:12px;color:var(--text-gray);">Emails</div></div>
                    <div class="stat-card"><div style="font-size:28px;">üíº</div><div style="font-size:24px;font-weight:700;margin-top:8px;">${linkedin}</div><div style="font-size:12px;color:var(--text-gray);">Messages</div></div>
                    <div class="stat-card"><div style="font-size:28px;">üé•</div><div style="font-size:24px;font-weight:700;margin-top:8px;">${demos}</div><div style="font-size:12px;color:var(--text-gray);">Demos</div></div>
                    <div class="stat-card"><div style="font-size:28px;">üìÑ</div><div style="font-size:24px;font-weight:700;margin-top:8px;">${proposals}</div><div style="font-size:12px;color:var(--text-gray);">Proposals</div></div>
                </div>
                
                <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;">üìä Deal Mix This Month</h3>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
                    <div class="stat-card"><span class="badge badge-starter">Starter</span><div style="font-size:28px;font-weight:700;margin-top:12px;">${starterDeals}</div></div>
                    <div class="stat-card"><span class="badge badge-growth">Growth</span><div style="font-size:28px;font-weight:700;margin-top:12px;">${growthDeals}</div></div>
                    <div class="stat-card"><span class="badge badge-pro">Pro</span><div style="font-size:28px;font-weight:700;margin-top:12px;">${proDeals}</div></div>
                    <div class="stat-card"><span class="badge badge-enterprise">Enterprise</span><div style="font-size:28px;font-weight:700;margin-top:12px;">${enterpriseDeals}</div></div>
                </div>
            </div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>
        </div></div>
    `;
}

function renderTeamOverview() {
    const content = document.getElementById('contentArea');
    const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    
    const teamPerformance = state.data.teamMembers.filter(m => m.role !== 'Leadership').map(member => {
        const memberDeals = state.data.deals.filter(d => d.owner === member.name);
        const won = memberDeals.filter(d => d.stage.toLowerCase().includes('won'));
        const monthWon = won.filter(d => { const dt = d.closeDate ? new Date(d.closeDate) : null; return dt && dt >= monthStart; });
        const revenue = monthWon.reduce((sum, d) => sum + d.value, 0);
        const targets = getKPITargets(member.role);
        const attainment = (revenue / targets.monthlyRevenueMax) * 100;
        return { name: member.name, role: member.role, quota: targets.monthlyRevenueMax, revenue, attainment, deals: memberDeals.length, won: monthWon.length };
    });
    
    content.innerHTML = `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Team Performance</h2></div>
            <table>
                <thead><tr><th>Name</th><th>Role</th><th>Max Target</th><th>Revenue</th><th>% of Max</th><th>Deals</th><th>Wins</th></tr></thead>
                <tbody>
                    ${teamPerformance.map(m => `
                        <tr>
                            <td>${m.name}</td><td>${m.role}</td><td>$${m.quota.toLocaleString()}</td><td>$${m.revenue.toLocaleString()}</td>
                            <td><span class="badge ${m.attainment >= 100 ? 'badge-growth' : m.attainment >= 70 ? 'badge-pro' : 'badge-starter'}">${m.attainment.toFixed(1)}%</span></td>
                            <td>${m.deals}</td><td>${m.won}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderPipeline() {
    const deals = getUserDeals();
    const stages = ['Qualified', 'Proposal Sent', 'Negotiation', 'Closed Won'];
    const isLeadership = state.currentUser.role === 'Leadership';
    
    const content = document.getElementById('contentArea');
    content.innerHTML = `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìä Pipeline</h2><button class="btn btn-primary btn-small" onclick="openAddDealModal()">+ Add Deal</button></div>
            <div class="kanban-board">
                ${stages.map(stage => {
                    const stageDeals = deals.filter(d => d.stage === stage);
                    return `
                        <div class="kanban-column" data-stage="${stage}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                            <div class="kanban-header"><span>${stage}</span><span style="background:var(--primary);color:white;padding:2px 8px;border-radius:10px;font-size:12px;">${stageDeals.length}</span></div>
                            <div class="kanban-cards">
                                ${stageDeals.length === 0 ? '<p style="color:var(--text-gray);text-align:center;padding:20px;font-size:13px;">No deals</p>' : stageDeals.map(deal => `
                                    <div class="kanban-card" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" onclick="openDealDetailsModal('${deal.id}')" data-deal-id="${deal.id}">
                                        <div style="display:flex;justify-content:space-between;align-items:start;">
                                            <div class="kanban-card-title">${deal.name}</div>
                                            ${isLeadership ? `<div class="action-buttons"><button class="btn btn-icon btn-secondary" onclick="event.stopPropagation();openDealDetailsModal('${deal.id}')">‚úèÔ∏è</button><button class="btn btn-icon btn-danger" onclick="event.stopPropagation();deleteDeal('${deal.id}')">üóëÔ∏è</button></div>` : ''}
                                        </div>
                                        <div class="kanban-card-value">$${deal.value.toLocaleString()}</div>
                                        <span class="badge badge-${deal.tier.toLowerCase()}">${deal.tier}</span>
                                        <div style="font-size:12px;color:var(--text-gray);margin-top:8px;">Owner: ${deal.owner}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

let draggedDealId = null;
function handleDragStart(event) { draggedDealId = event.target.getAttribute('data-deal-id'); event.target.style.opacity = '0.5'; }
function handleDragEnd(event) { event.target.style.opacity = '1'; }
function handleDragOver(event) { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; }
function handleDrop(event) {
    event.preventDefault();
    const column = event.target.closest('.kanban-column');
    const newStage = column?.getAttribute('data-stage');
    if (draggedDealId && newStage) updateDealStage(draggedDealId, newStage);
    draggedDealId = null;
}

function renderTasks() {
    document.getElementById('contentArea').innerHTML = `<div class="card"><div class="card-header"><h2 class="card-title">‚úÖ Tasks</h2></div><p style="text-align:center;padding:40px;color:var(--text-gray);">Task management coming soon</p></div>`;
}

function renderContacts() {
    const contacts = state.data.contacts;
    const isLeadership = state.currentUser.role === 'Leadership';
    
    document.getElementById('contentArea').innerHTML = `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üë• Contacts</h2><button class="btn btn-primary btn-small" onclick="openAddContactModal()">+ Add Contact</button></div>
            <table>
                <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Role</th>${isLeadership ? '<th>Actions</th>' : ''}</tr></thead>
                <tbody>
                    ${contacts.length === 0 ? `<tr><td colspan="${isLeadership ? 6 : 5}" style="text-align:center;padding:40px;">No contacts found</td></tr>` : contacts.map(c => `
                        <tr>
                            <td><strong>${c.name}</strong></td><td>${c.email}</td><td>${c.phone}</td><td>${c.company || '-'}</td><td>${c.role}</td>
                            ${isLeadership ? `<td class="action-buttons"><button class="btn btn-icon btn-secondary" onclick="openEditContactModal('${c.id}')">‚úèÔ∏è</button><button class="btn btn-icon btn-danger" onclick="deleteContact('${c.id}')">üóëÔ∏è</button></td>` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderAccounts() {
    const accounts = state.data.accounts;
    const isLeadership = state.currentUser.role === 'Leadership';
    
    document.getElementById('contentArea').innerHTML = `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üè¢ Accounts</h2><button class="btn btn-primary btn-small" onclick="openAddAccountModal()">+ Add Account</button></div>
            <table>
                <thead><tr><th>Name</th><th>Industry</th><th>Owner</th>${isLeadership ? '<th>Actions</th>' : ''}</tr></thead>
                <tbody>
                    ${accounts.length === 0 ? `<tr><td colspan="${isLeadership ? 4 : 3}" style="text-align:center;padding:40px;">No accounts found</td></tr>` : accounts.map(a => `
                        <tr>
                            <td>${a.name}</td><td>${a.industry}</td><td>${a.owner}</td>
                            ${isLeadership ? `<td class="action-buttons"><button class="btn btn-icon btn-secondary" onclick="openEditAccountModal('${a.id}')">‚úèÔ∏è</button><button class="btn btn-icon btn-danger" onclick="deleteAccount('${a.id}')">üóëÔ∏è</button></td>` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderActivityView() {
    let activities = state.data.activities;
    const isLeadership = state.currentUser.role === 'Leadership';
    
    // Apply filters from rep modal clicks
    if (state.filterRep) {
        activities = activities.filter(a => a.owner === state.filterRep);
    } else if (!isLeadership) {
        activities = activities.filter(a => a.owner === state.currentUser.name);
    }
    
    if (state.filterMonth) {
        const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        activities = activities.filter(a => { const dt = a.date ? new Date(a.date) : null; return dt && dt >= monthStart; });
    }
    
    const filterInfo = state.filterRep ? `<p style="margin-bottom:16px;color:var(--primary);font-weight:600;">Showing activities for: ${state.filterRep} ${state.filterMonth ? '(This Month)' : ''} <button class="btn btn-secondary btn-small" onclick="state.filterRep=null;state.filterMonth=null;renderView('activity');">Clear Filter</button></p>` : '';
    
    document.getElementById('contentArea').innerHTML = `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìù Activity Log</h2><button class="btn btn-primary btn-small" onclick="openLogActivityModal()">+ Log Activity</button></div>
            ${filterInfo}
            <table>
                <thead><tr><th>Date</th><th>Type</th><th>Account</th><th>Owner</th><th>Result</th>${isLeadership ? '<th>Actions</th>' : ''}</tr></thead>
                <tbody>
                    ${activities.length === 0 ? `<tr><td colspan="${isLeadership ? 6 : 5}" style="text-align:center;padding:40px;">No activities logged yet.</td></tr>` : activities.map(a => `
                        <tr>
                            <td>${formatDateCST(a.date)}</td><td><span class="badge" style="background:var(--primary);color:white;">${a.type}</span></td><td><strong>${a.account}</strong></td><td>${a.owner}</td><td>${a.result || '-'}</td>
                            ${isLeadership ? `<td class="action-buttons"><button class="btn btn-icon btn-danger" onclick="deleteActivity('${a.id}')">üóëÔ∏è</button></td>` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderReports() {
    document.getElementById('contentArea').innerHTML = `<div class="card"><div class="card-header"><h2 class="card-title">üìë Reports</h2></div><p style="text-align:center;padding:40px;color:var(--text-gray);">Advanced reporting coming soon</p></div>`;
}

window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
