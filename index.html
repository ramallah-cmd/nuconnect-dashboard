<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuConnect CRM - Phase 2</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea; --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444;
            --text-dark: #1f2937; --text-gray: #6b7280; --bg-light: #f9fafb;
            --border: #e5e7eb; --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 6px rgba(0,0,0,0.1); --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
        }
        body { font-family: 'Inter', sans-serif; background: var(--gradient); min-height: 100vh; color: var(--text-dark); }
        .hidden { display: none !important; }
        
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: var(--white); padding: 60px 50px; border-radius: 24px; box-shadow: var(--shadow-lg); max-width: 450px; width: 100%; }
        .logo { font-size: 48px; text-align: center; margin-bottom: 10px; }
        .login-card h1 { color: var(--primary); font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .login-card p { color: var(--text-gray); text-align: center; margin-bottom: 40px; }
        
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 15px; color: var(--text-dark); }
        .form-group select, .form-group input, .form-group textarea { 
            width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; 
            font-size: 16px; font-family: inherit; background: var(--white); color: var(--text-dark);
        }
        .form-group select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; padding-right: 44px; }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--gradient); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-small { padding: 10px 18px; font-size: 14px; }
        .btn-icon { padding: 8px 12px; font-size: 14px; border-radius: 8px; min-width: 36px; }
        .btn-full { width: 100%; }
        
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--white); box-shadow: var(--shadow-md); padding: 24px 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
        .sidebar-header h2 { color: var(--primary); font-size: 22px; font-weight: 800; margin-bottom: 4px; }
        .sidebar-nav { padding: 16px 0; }
        .nav-item { display: flex; align-items: center; padding: 12px 24px; color: var(--text-gray); cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 14px; }
        .nav-item:hover { background: var(--bg-light); color: var(--primary); }
        .nav-item.active { background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, transparent 100%); color: var(--primary); border-left: 4px solid var(--primary); }
        .nav-item-icon { font-size: 18px; margin-right: 12px; }
        .main-content { margin-left: 260px; flex: 1; padding: 24px; min-height: 100vh; }
        
        .top-bar { background: var(--white); padding: 16px 24px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .top-bar h1 { font-size: 24px; font-weight: 800; }
        .top-bar-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .profile-dropdown { position: relative; }
        .profile-btn { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .profile-btn:hover { background: var(--border); }
        .profile-menu { position: absolute; top: 100%; right: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); min-width: 200px; margin-top: 8px; display: none; z-index: 1000; overflow: hidden; }
        .profile-menu.active { display: block; }
        .profile-menu-item { padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .profile-menu-item:hover { background: var(--bg-light); }
        .profile-menu-divider { height: 1px; background: var(--border); margin: 4px 0; }
        
        .search-container { position: relative; }
        .search-input { padding: 10px 16px 10px 40px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; width: 260px; font-family: inherit; }
        .search-input:focus { outline: none; border-color: var(--primary); width: 300px; }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 16px; color: var(--text-gray); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); margin-top: 8px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none; }
        .search-results.active { display: block; }
        .search-result-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border); }
        .search-result-item:hover { background: var(--bg-light); }
        .search-result-type { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 2px; }
        .search-result-title { font-weight: 600; font-size: 14px; }
        .search-result-meta { font-size: 12px; color: var(--text-gray); }
        
        .filters-bar { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; padding: 16px 20px; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-sm); }
        .filter-select, .filter-input { padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; font-family: inherit; }
        .filter-input { width: 200px; }
        .filter-select { min-width: 150px; }
        
        .greeting-banner { background: var(--gradient); color: white; padding: 20px 24px; border-radius: 16px; margin-bottom: 24px; }
        .greeting-text { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
        .greeting-sub { font-size: 14px; opacity: 0.9; }
        
        .nudge-container { margin-bottom: 24px; }
        .nudge-alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .nudge-alert.warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid var(--warning); }
        .nudge-alert.danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 4px solid var(--danger); }
        .nudge-alert.success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid var(--success); }
        .nudge-alert.info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid var(--primary); }
        .nudge-icon { font-size: 24px; }
        .nudge-text { flex: 1; font-weight: 500; font-size: 14px; }
        .nudge-dismiss { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.6; padding: 4px 8px; }
        .nudge-dismiss:hover { opacity: 1; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: var(--white); padding: 22px; border-radius: 14px; box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--gradient); border-radius: 14px 0 0 14px; }
        .kpi-value { font-size: 34px; font-weight: 800; margin-bottom: 6px; }
        .kpi-label { font-size: 12px; font-weight: 600; color: var(--text-gray); text-transform: uppercase; }
        .progress-bar { width: 100%; height: 8px; background: var(--bg-light); border-radius: 8px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; border-radius: 8px; transition: width 0.5s ease; }
        
        .card { background: var(--white); padding: 24px; border-radius: 14px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .card-title { font-size: 18px; font-weight: 700; }
        
        .activity-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 14px; }
        .stat-card { text-align: center; padding: 18px 14px; background: var(--bg-light); border-radius: 12px; transition: all 0.2s; }
        .stat-card:hover { background: var(--white); box-shadow: var(--shadow-sm); }
        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 11px; color: var(--text-gray); margin-top: 4px; }
        
        .badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; }
        .badge-starter { background: #e5e7eb; color: #374151; }
        .badge-growth { background: #d1fae5; color: #065f46; }
        .badge-pro { background: #fef3c7; color: #92400e; }
        .badge-enterprise { background: #e0e7ff; color: #3730a3; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        .profile-card-header { background: var(--gradient); padding: 24px; color: white; }
        .profile-card-avatar { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 26px; margin-bottom: 12px; }
        .profile-card-name { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .profile-card-subtitle { font-size: 14px; opacity: 0.9; }
        .profile-card-body { padding: 20px; }
        .profile-card-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
        .profile-card-row:last-child { border-bottom: none; }
        .profile-card-label { color: var(--text-gray); }
        .profile-card-value { font-weight: 600; text-align: right; max-width: 60%; }
        .profile-card-actions { padding: 16px 20px; background: var(--bg-light); display: flex; gap: 8px; flex-wrap: wrap; }
        
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-light); }
        th { padding: 12px 16px; text-align: left; font-weight: 600; font-size: 12px; text-transform: uppercase; color: var(--text-gray); }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:hover { background: rgba(102,126,234,0.02); }
        tr.clickable { cursor: pointer; }
        tr.clickable:hover { background: rgba(102,126,234,0.05); }
        .action-buttons { display: flex; gap: 6px; }
        
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
        .kanban-column { background: var(--bg-light); border-radius: 12px; padding: 16px; min-height: 400px; }
        .kanban-column.drag-over { background: #dbeafe; }
        .kanban-header { font-weight: 700; font-size: 14px; margin-bottom: 14px; padding-bottom: 12px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; }
        .kanban-count { background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; font-size: 12px; }
        .kanban-card { background: var(--white); padding: 16px; border-radius: 10px; margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: grab; transition: all 0.2s; border-left: 4px solid transparent; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kanban-card.dragging { opacity: 0.5; cursor: grabbing; }
        .kanban-card.stale { border-left-color: var(--warning); background: linear-gradient(90deg, rgba(245,158,11,0.05) 0%, transparent 100%); }
        .kanban-card-title { font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .kanban-card-value { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
        .kanban-card-meta { font-size: 12px; color: var(--text-gray); margin-top: 8px; }
        .stale-indicator { display: inline-flex; align-items: center; gap: 4px; background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-top: 8px; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .chart-card { background: var(--white); padding: 20px; border-radius: 14px; box-shadow: var(--shadow-sm); }
        .chart-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 16px; }
        .chart-container { position: relative; height: 280px; }
        
        .floor-tracker { text-align: center; padding: 24px; }
        .capacity-circle { width: 160px; height: 160px; margin: 0 auto 16px; border-radius: 50%; background: var(--gradient); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 24px rgba(102,126,234,0.3); }
        .capacity-number { font-size: 42px; font-weight: 800; }
        .capacity-label { font-size: 13px; opacity: 0.9; }
        
        .rep-card { background: var(--white); padding: 20px; border-radius: 14px; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; border-left: 4px solid var(--success); }
        .rep-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .rep-card.yellow { border-left-color: var(--warning); }
        .rep-card.red { border-left-color: var(--danger); }
        
        .leaderboard-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-light); border-radius: 10px; margin-bottom: 10px; }
        .leaderboard-rank { font-size: 24px; font-weight: 800; color: var(--primary); min-width: 40px; }
        .leaderboard-info { flex: 1; }
        .leaderboard-name { font-weight: 700; font-size: 16px; }
        .leaderboard-stats { font-size: 13px; color: var(--text-gray); }
        .leaderboard-value { font-size: 20px; font-weight: 700; color: var(--success); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); padding: 32px; border-radius: 18px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-content.wide { max-width: 900px; }
        .modal-content.profile { max-width: 480px; padding: 0; overflow: hidden; }
        .modal-header { margin-bottom: 24px; }
        .modal-header h2 { font-size: 22px; font-weight: 700; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); }
        
        .celebration-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2000; pointer-events: none; }
        .celebration-popup { background: white; padding: 40px 60px; border-radius: 24px; text-align: center; box-shadow: var(--shadow-lg); animation: popIn 0.5s ease; pointer-events: auto; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .celebration-icon { font-size: 80px; margin-bottom: 16px; }
        .celebration-title { font-size: 28px; font-weight: 800; color: var(--primary); margin-bottom: 8px; }
        .celebration-text { font-size: 16px; color: var(--text-gray); margin-bottom: 24px; }
        
        .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .search-input { width: 180px; }
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="logo">üéØ</div>
            <h1>NuConnect CRM</h1>
            <p>Sign in to your account</p>
            <div class="form-group">
                <label>Team Member</label>
                <select id="userSelect"><option value="">Choose your name...</option></select>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="passwordInput" placeholder="Enter your password">
            </div>
            <div id="loginError" class="hidden" style="color: var(--danger); margin-bottom: 16px; font-size: 14px;"></div>
            <button class="btn btn-primary btn-full" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="appContainer" class="app-container hidden">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>üéØ NuConnect</h2>
                <p id="currentUserName" style="color: var(--text-gray); font-size: 13px; margin-top: 4px;"></p>
            </div>
            <nav class="sidebar-nav" id="sidebarNav"></nav>
        </aside>
        <main class="main-content">
            <div class="top-bar">
                <div><h1 id="pageTitle">Dashboard</h1></div>
                <div class="top-bar-actions">
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search..." oninput="handleSearch(this.value)">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <div class="profile-dropdown">
                        <button class="profile-btn" onclick="toggleProfileMenu()">
                            <span>üë§</span>
                            <span id="profileName">User</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="profile-menu" id="profileMenu">
                            <div class="profile-menu-item" onclick="openProfileSettings()">‚öôÔ∏è Settings</div>
                            <div class="profile-menu-item" onclick="openChangePasswordModal()">üîê Change Password</div>
                            <div class="profile-menu-divider"></div>
                            <div class="profile-menu-item" onclick="logout()" style="color: var(--danger);">üö™ Logout</div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="contentArea"></div>
        </main>
    </div>
    <div id="modalContainer"></div>
    <div id="celebrationContainer"></div>

    <script>
// ============ STATE & CONFIG ============
const state = {
    currentUser: null,
    currentView: 'dashboard',
    baseId: localStorage.getItem('airtable_baseId') || '',
    apiKey: localStorage.getItem('airtable_apiKey') || '',
    charts: {},
    filterRep: null,
    dismissedNudges: JSON.parse(localStorage.getItem('dismissedNudges') || '[]'),
    celebratedAchievements: JSON.parse(localStorage.getItem('celebratedAchievements') || '[]'),
    data: { deals: [], activities: [], tasks: [], contacts: [], accounts: [], teamMembers: [], pricingRules: [] },
    teamMemberMap: {},
    filters: { contacts: { search: '', owner: '' }, accounts: { search: '', industry: '', owner: '' }, pipeline: { tier: '', owner: '' } }
};

const savedSession = localStorage.getItem('nuconnect_session');
if (savedSession) { try { state.currentUser = JSON.parse(savedSession); } catch(e) {} }

const savedPasswords = JSON.parse(localStorage.getItem('nuconnect_passwords') || '{}');
const defaultPasswords = { 'Javonte': 'nuconnect2025', 'Teslim': 'nuconnect2025', 'Israel': 'nuconnect2025', 'Conrad': 'nuconnect2025', 'Test User': 'test2024', 'Test Leadership': 'testleader2024', 'Ramallah': 'admin2025', 'Keyna': 'admin2025' };
const userPasswords = { ...defaultPasswords, ...savedPasswords };

const userTimezones = JSON.parse(localStorage.getItem('nuconnect_timezones') || '{}');

const tierPricing = { 'Starter': 750, 'Growth': 1250, 'Pro': 2000, 'Enterprise': 4200 };
const tierColors = { 'Starter': '#9e9e9e', 'Growth': '#22c55e', 'Pro': '#f59e0b', 'Enterprise': '#667eea' };

const industryOptions = ['Technology', 'Finance & Banking', 'Healthcare', 'Education', 'Retail & E-commerce', 'Real Estate', 'Manufacturing', 'Entertainment & Media', 'Non-Profit', 'Government', 'Legal Services', 'Hospitality & Events', 'Sports & Fitness', 'Food & Beverage', 'Transportation & Logistics', 'Energy & Utilities', 'Construction', 'Agriculture', 'Telecommunications', 'Marketing & Advertising', 'Professional Services', 'Insurance', 'Automotive', 'Aerospace', 'Pharmaceuticals', 'Biotechnology', 'Fashion & Apparel', 'Beauty & Cosmetics', 'Travel & Tourism', 'Gaming & Esports', 'Music & Arts', 'Consulting', 'Human Resources', 'Security Services', 'Environmental Services', 'Other'];

const TOUCHPOINT_CADENCE = [
    { week: 1, action: 'Intro Email + Pitch Deck', goal: 'Position NuConnect as a strategic partner' },
    { week: 2, action: 'Value Add, Demo Invite, Case Study', goal: 'Build trust with proof of impact' },
    { week: 3, action: 'Follow-up Email, Pricing & Legal', goal: 'Drive engagement, show polish' },
    { week: 4, action: 'Objection Handling', goal: 'Address concerns, clarify value' },
    { week: 5, action: 'LinkedIn Touchpoint', goal: 'Reinforce brand presence' },
    { week: 6, action: 'Call or Meeting', goal: 'Close the deal, align on scope' },
    { week: 7, action: 'Review Contract', goal: 'Finalize terms' },
    { week: 8, action: 'Secure Payment', goal: 'Complete the sale' },
    { week: 9, action: 'Onboarding Kickoff', goal: 'Begin setup & collaboration' }
];

const KPI_TARGETS = {
    BDR: { monthlyRevenueMin: 9750, monthlyRevenueMax: 12700, monthlyEventsMin: 6, monthlyEventsMax: 7, dailyTouchpointsMin: 20, dailyTouchpointsMax: 25, dailyCalls: 15, dailyEmails: 10, dailyLinkedIn: 5, quota: 45000 },
    AE: { monthlyRevenueMin: 15000, monthlyRevenueMax: 20000, monthlyEventsMin: 4, monthlyEventsMax: 6, dailyTouchpointsMin: 15, dailyTouchpointsMax: 20, dailyCalls: 10, dailyEmails: 8, dailyLinkedIn: 3, quota: 60000 },
    Team: { monthlyRevenueMin: 28000, monthlyRevenueMax: 35000, monthlyEventsMin: 18, monthlyEventsMax: 22 }
};

function getKPITargets(role) { return role === 'AE' ? KPI_TARGETS.AE : KPI_TARGETS.BDR; }

const allNavItems = [
    { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
    { id: 'pipeline', icon: 'üìà', label: 'Pipeline' },
    { id: 'contacts', icon: 'üë•', label: 'Contacts' },
    { id: 'accounts', icon: 'üè¢', label: 'Accounts' },
    { id: 'events', icon: 'üéâ', label: 'Events' },
    { id: 'activity', icon: 'üìù', label: 'Activities' },
    { id: 'reports', icon: 'üìë', label: 'Reports' }
];
const leadershipNavItems = [
    { id: 'leadership', icon: 'üëî', label: 'Analytics' },
    { id: 'team', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', label: 'Team Overview' }
];

// ============ GREETING & TIME ============
function getGreeting() {
    const tz = userTimezones[state.currentUser?.name] || Intl.DateTimeFormat().resolvedOptions().timeZone;
    const hour = new Date().toLocaleString('en-US', { hour: 'numeric', hour12: false, timeZone: tz });
    const h = parseInt(hour);
    if (h < 12) return 'Good morning';
    if (h < 17) return 'Good afternoon';
    return 'Good evening';
}

// ============ PROFILE MENU ============
function toggleProfileMenu() {
    document.getElementById('profileMenu').classList.toggle('active');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.profile-dropdown')) {
        document.getElementById('profileMenu')?.classList.remove('active');
    }
});

function openProfileSettings() {
    const currentTz = userTimezones[state.currentUser.name] || Intl.DateTimeFormat().resolvedOptions().timeZone;
    const timezones = ['America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles', 'America/Phoenix', 'America/Anchorage', 'Pacific/Honolulu', 'Europe/London', 'Europe/Paris', 'Asia/Tokyo', 'Asia/Shanghai', 'Australia/Sydney'];
    
    let tzOptions = timezones.map(tz => '<option value="' + tz + '"' + (currentTz === tz ? ' selected' : '') + '>' + tz + '</option>').join('');
    
    document.getElementById('modalContainer').innerHTML = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚öôÔ∏è Profile Settings</h2></div>' +
        '<div class="form-group"><label>Your Name</label><input type="text" value="' + state.currentUser.name + '" disabled></div>' +
        '<div class="form-group"><label>Role</label><input type="text" value="' + state.currentUser.role + '" disabled></div>' +
        '<div class="form-group"><label>Timezone</label><select id="timezoneSelect">' + tzOptions + '</select></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveProfileSettings()">Save</button></div>' +
        '</div></div>';
    toggleProfileMenu();
}

function saveProfileSettings() {
    const tz = document.getElementById('timezoneSelect').value;
    userTimezones[state.currentUser.name] = tz;
    localStorage.setItem('nuconnect_timezones', JSON.stringify(userTimezones));
    closeModal();
    renderView(state.currentView);
}

function openChangePasswordModal() {
    document.getElementById('modalContainer').innerHTML = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üîê Change Password</h2></div>' +
        '<div class="form-group"><label>Current Password</label><input type="password" id="currentPassword" placeholder="Enter current password"></div>' +
        '<div class="form-group"><label>New Password</label><input type="password" id="newPassword" placeholder="Enter new password (min 6 chars)"></div>' +
        '<div class="form-group"><label>Confirm New Password</label><input type="password" id="confirmPassword" placeholder="Confirm new password"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="changePassword()">Change Password</button></div>' +
        '</div></div>';
    toggleProfileMenu();
}

function changePassword() {
    const current = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    
    if (userPasswords[state.currentUser.name] !== current) { alert('Current password is incorrect'); return; }
    if (newPass.length < 6) { alert('New password must be at least 6 characters'); return; }
    if (newPass !== confirm) { alert('New passwords do not match'); return; }
    
    userPasswords[state.currentUser.name] = newPass;
    savedPasswords[state.currentUser.name] = newPass;
    localStorage.setItem('nuconnect_passwords', JSON.stringify(savedPasswords));
    closeModal();
    alert('Password changed successfully!');
}

function openResetPasswordModal(memberName) {
    document.getElementById('modalContainer').innerHTML = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üîë Reset Password for ' + memberName + '</h2></div>' +
        '<div class="form-group"><label>New Password</label><input type="password" id="resetNewPassword" placeholder="Enter new password (min 6 chars)"></div>' +
        '<div class="form-group"><label>Confirm Password</label><input type="password" id="resetConfirmPassword" placeholder="Confirm new password"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="resetPassword(\'' + memberName + '\')">Reset Password</button></div>' +
        '</div></div>';
}

function resetPassword(memberName) {
    const newPass = document.getElementById('resetNewPassword').value;
    const confirm = document.getElementById('resetConfirmPassword').value;
    
    if (newPass.length < 6) { alert('Password must be at least 6 characters'); return; }
    if (newPass !== confirm) { alert('Passwords do not match'); return; }
    
    userPasswords[memberName] = newPass;
    savedPasswords[memberName] = newPass;
    localStorage.setItem('nuconnect_passwords', JSON.stringify(savedPasswords));
    closeModal();
    alert('Password reset successfully for ' + memberName + '!');
}

// ============ CELEBRATIONS ============
function showCelebration(type, message) {
    const achievementId = type + '-' + new Date().toDateString();
    if (state.celebratedAchievements.includes(achievementId)) return;
    
    state.celebratedAchievements.push(achievementId);
    localStorage.setItem('celebratedAchievements', JSON.stringify(state.celebratedAchievements));
    
    const icons = { 'deal-moved': 'üöÄ', 'kpi-hit': 'üèÜ', 'revenue-goal': 'üí∞', 'close-to-goal': 'üî•' };
    const titles = { 'deal-moved': 'Deal Advanced!', 'kpi-hit': 'KPI Achieved!', 'revenue-goal': 'Revenue Goal Hit!', 'close-to-goal': 'Almost There!' };
    
    document.getElementById('celebrationContainer').innerHTML = 
        '<div class="celebration-overlay" onclick="closeCelebration()">' +
        '<div class="celebration-popup">' +
        '<div class="celebration-icon">' + (icons[type] || 'üéâ') + '</div>' +
        '<div class="celebration-title">' + (titles[type] || 'Congratulations!') + '</div>' +
        '<div class="celebration-text">' + message + '</div>' +
        '<button class="btn btn-primary" onclick="closeCelebration()">Awesome!</button>' +
        '</div></div>';
    
    if (typeof confetti === 'function') {
        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    }
}

function closeCelebration() {
    document.getElementById('celebrationContainer').innerHTML = '';
}

function checkAchievements() {
    if (state.currentUser.role === 'Leadership') return;
    
    const today = new Date().toISOString().split('T')[0];
    const targets = getKPITargets(state.currentUser.role);
    const userActivities = state.data.activities.filter(a => a.owner === state.currentUser.name);
    const todayActivities = userActivities.filter(a => a.date && a.date.split('T')[0] === today);
    
    // Check touchpoints
    if (todayActivities.length >= targets.dailyTouchpointsMin) {
        showCelebration('kpi-hit', 'You hit your daily touchpoint goal of ' + targets.dailyTouchpointsMin + '+ activities!');
    } else if (todayActivities.length >= targets.dailyTouchpointsMin - 3 && todayActivities.length < targets.dailyTouchpointsMin) {
        showCelebration('close-to-goal', 'Only ' + (targets.dailyTouchpointsMin - todayActivities.length) + ' more touchpoints to hit your daily goal!');
    }
}

// ============ SEARCH ============
let searchTimeout = null;
window.searchResults = [];

function handleSearch(query) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(function() { performSearch(query); }, 300);
}

function performSearch(query) {
    const resultsDiv = document.getElementById('searchResults');
    if (!query || query.length < 2) { resultsDiv.innerHTML = ''; resultsDiv.classList.remove('active'); return; }
    const q = query.toLowerCase();
    const results = [];

    state.data.deals.forEach(function(deal) {
        if (deal.name.toLowerCase().includes(q)) {
            results.push({ type: 'Deal', title: deal.name, meta: deal.tier + ' ‚Ä¢ $' + deal.value.toLocaleString(), action: function() { closeSearch(); renderView('pipeline'); }});
        }
    });
    state.data.contacts.forEach(function(contact) {
        if (contact.name.toLowerCase().includes(q) || (contact.email && contact.email.toLowerCase().includes(q))) {
            results.push({ type: 'Contact', title: contact.name, meta: contact.email || 'No email', action: function() { closeSearch(); openContactDetailModal(contact.id); }});
        }
    });
    state.data.accounts.forEach(function(account) {
        if (account.name.toLowerCase().includes(q)) {
            results.push({ type: 'Account', title: account.name, meta: account.industry || 'No industry', action: function() { closeSearch(); openAccountDetailModal(account.id); }});
        }
    });

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item"><div class="search-result-title">No results found</div></div>';
    } else {
        var html = '';
        for (var i = 0; i < Math.min(results.length, 8); i++) {
            html += '<div class="search-result-item" onmousedown="window.searchResults[' + i + '].action()">' +
                '<div class="search-result-type">' + results[i].type + '</div>' +
                '<div class="search-result-title">' + results[i].title + '</div>' +
                '<div class="search-result-meta">' + results[i].meta + '</div></div>';
        }
        resultsDiv.innerHTML = html;
        window.searchResults = results;
    }
    resultsDiv.classList.add('active');
}

function closeSearch() { 
    document.getElementById('globalSearch').value = ''; 
    document.getElementById('searchResults').classList.remove('active'); 
}

// ============ NUDGES ============
function dismissNudge(nudgeId, btn) {
    state.dismissedNudges.push(nudgeId);
    localStorage.setItem('dismissedNudges', JSON.stringify(state.dismissedNudges));
    btn.parentElement.remove();
}

function generateNudges() {
    var nudges = [];
    if (state.currentUser.role === 'Leadership') return nudges;
    
    var now = new Date();
    var today = now.toISOString().split('T')[0];
    var monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    var targets = getKPITargets(state.currentUser.role);
    
    var userActivities = state.data.activities.filter(function(a) { return a.owner === state.currentUser.name; });
    var todayActivities = userActivities.filter(function(a) { return a.date && a.date.split('T')[0] === today; });
    var todayTouchpoints = todayActivities.length;
    
    var userDeals = state.data.deals.filter(function(d) { return d.owner === state.currentUser.name; });
    var monthClosedDeals = userDeals.filter(function(d) {
        if (!d.stage.toLowerCase().includes('won')) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var monthRevenue = monthClosedDeals.reduce(function(sum, d) { return sum + d.value; }, 0);
    var revenuePercent = (monthRevenue / targets.monthlyRevenueMin) * 100;
    
    if (revenuePercent < 50 && !state.dismissedNudges.includes('revenue-low')) {
        nudges.push({ id: 'revenue-low', type: 'danger', icon: 'üö®', text: 'You\'re at ' + revenuePercent.toFixed(0) + '% of target. Let\'s pick up the pace!' });
    } else if (revenuePercent >= 100 && !state.dismissedNudges.includes('revenue-hit-' + today)) {
        nudges.push({ id: 'revenue-hit-' + today, type: 'success', icon: 'üéâ', text: 'Amazing! You\'ve hit ' + revenuePercent.toFixed(0) + '% of your target!' });
    }
    
    if (now.getHours() >= 15 && todayTouchpoints < 15 && !state.dismissedNudges.includes('touchpoints-' + today)) {
        nudges.push({ id: 'touchpoints-' + today, type: 'warning', icon: '‚è∞', text: 'Only ' + todayTouchpoints + '/' + targets.dailyTouchpointsMax + ' touchpoints today. Time to hustle!' });
    }
    
    var pipelineDeals = userDeals.filter(function(d) { return !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost'); });
    var staleDeals = pipelineDeals.filter(function(d) {
        var lastActivity = userActivities.filter(function(a) { return a.account && d.name.toLowerCase().includes(a.account.toLowerCase()); }).sort(function(x,y) { return new Date(y.date) - new Date(x.date); })[0];
        if (!lastActivity) return true;
        return getDaysSince(lastActivity.date) >= 5;
    });
    
    if (staleDeals.length > 0 && !state.dismissedNudges.includes('stale-' + today)) {
        nudges.push({ id: 'stale-' + today, type: 'info', icon: 'üìå', text: staleDeals.length + ' deal' + (staleDeals.length > 1 ? 's need' : ' needs') + ' attention! Move to next touchpoint.' });
    }
    
    return nudges.slice(0, 4);
}

function renderNudges() {
    var nudges = generateNudges();
    if (nudges.length === 0) return '';
    var html = '<div class="nudge-container">';
    for (var i = 0; i < nudges.length; i++) {
        var n = nudges[i];
        html += '<div class="nudge-alert ' + n.type + '">' +
            '<span class="nudge-icon">' + n.icon + '</span>' +
            '<span class="nudge-text">' + n.text + '</span>' +
            '<button class="nudge-dismiss" onclick="dismissNudge(\'' + n.id + '\', this)">√ó</button></div>';
    }
    html += '</div>';
    return html;
}

// ============ CHARTS ============
function destroyCharts() {
    Object.values(state.charts).forEach(function(chart) { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
    state.charts = {};
}

function renderRevenueTrendChart(canvasId, deals, label) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    var currentMonth = new Date().getMonth();
    var currentYear = new Date().getFullYear();
    
    var monthlyData = [], labels = [];
    for (var i = 5; i >= 0; i--) {
        var month = currentMonth - i, year = currentYear;
        if (month < 0) { month += 12; year -= 1; }
        var monthStart = new Date(year, month, 1), monthEnd = new Date(year, month + 1, 0);
        var monthDeals = deals.filter(function(d) {
            if (!d.stage.toLowerCase().includes('won')) return false;
            var closeDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return closeDate && closeDate >= monthStart && closeDate <= monthEnd;
        });
        monthlyData.push(monthDeals.reduce(function(sum, d) { return sum + d.value; }, 0));
        labels.push(monthNames[month]);
    }
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: label || 'Revenue', data: monthlyData, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', fill: true, tension: 0.4 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: function(v) { return '$' + (v/1000).toFixed(0) + 'K'; } } } } }
    });
}

function renderRevenueByTierChart(canvasId, deals) {
    var canvas = document.getElementById(canvasId);
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var wonDeals = deals.filter(function(d) { return d.stage.toLowerCase().includes('won'); });
    var tierData = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    wonDeals.forEach(function(d) { if (tierData.hasOwnProperty(d.tier)) tierData[d.tier] += d.value; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'pie',
        data: { labels: Object.keys(tierData), datasets: [{ data: Object.values(tierData), backgroundColor: [tierColors.Starter, tierColors.Growth, tierColors.Pro, tierColors.Enterprise] }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });
}

// ============ HELPERS ============
function formatDateShort(dateString) {
    if (!dateString) return '-';
    try { return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    catch (e) { return dateString; }
}

function getDaysSince(dateString) {
    if (!dateString) return null;
    return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24));
}

function getOwnerName(ownerField) {
    if (Array.isArray(ownerField) && ownerField.length > 0) {
        var member = state.data.teamMembers.find(function(m) { return m.id === ownerField[0]; });
        return member ? member.name : '';
    }
    return ownerField || '';
}

function getAccountName(accountField) {
    if (Array.isArray(accountField) && accountField.length > 0) {
        var account = state.data.accounts.find(function(a) { return a.id === accountField[0]; });
        return account ? account.name : '';
    }
    return '';
}

function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }

// ============ INITIALIZATION ============
async function init() {
    console.log('%cüöÄ NuConnect CRM v5.0', 'background: #667eea; color: white; font-size: 16px; padding: 10px;');
    
    if (state.baseId && state.apiKey) {
        await loadTeamMembers();
        
        if (state.currentUser) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            await initApp();
        } else {
            populateLoginSelect();
        }
    } else {
        showConfigPrompt();
    }
}

function showConfigPrompt() {
    document.getElementById('loginScreen').innerHTML = 
        '<div class="login-card"><div class="logo">‚öôÔ∏è</div><h1>Setup Required</h1><p>Configure your Airtable connection</p>' +
        '<div class="form-group"><label>Airtable Base ID</label><input type="text" id="setupBaseId" placeholder="appXXXXXXXXXXXXXX" value="' + state.baseId + '"></div>' +
        '<div class="form-group"><label>Airtable API Key</label><input type="password" id="setupApiKey" placeholder="patXXXXXXXXXXXXXX"></div>' +
        '<button class="btn btn-primary btn-full" onclick="saveConfig()">Connect to Airtable</button></div>';
}

function saveConfig() {
    var baseId = document.getElementById('setupBaseId').value.trim();
    var apiKey = document.getElementById('setupApiKey').value.trim();
    if (baseId && apiKey) { localStorage.setItem('airtable_baseId', baseId); localStorage.setItem('airtable_apiKey', apiKey); location.reload(); }
    else alert('Please fill in both fields');
}

async function loadTeamMembers() {
    try {
        var response = await fetchFromAirtable('Team Members');
        if (response && response.records) {
            state.data.teamMembers = response.records.map(function(r) { 
                return { id: r.id, name: r.fields.Name || '', role: r.fields.Role || '', quota: r.fields['Monthly Quota'] || (r.fields.Role === 'AE' ? 60000 : 45000) }; 
            });
            state.teamMemberMap = {};
            response.records.forEach(function(r) { if (r.fields.Name) state.teamMemberMap[r.fields.Name] = r.id; });
        }
    } catch (error) {
        console.error('Error loading team members:', error);
        state.data.teamMembers = [
            { id: 'rec1', name: 'Javonte', role: 'BDR', quota: 45000 }, { id: 'rec2', name: 'Teslim', role: 'BDR', quota: 45000 },
            { id: 'rec3', name: 'Israel', role: 'BDR', quota: 45000 }, { id: 'rec4', name: 'Conrad', role: 'AE', quota: 60000 },
            { id: 'rec5', name: 'Test User', role: 'BDR', quota: 45000 }, { id: 'rec6', name: 'Test Leadership', role: 'Leadership', quota: 0 },
            { id: 'rec7', name: 'Ramallah', role: 'Leadership', quota: 0 }, { id: 'rec8', name: 'Keyna', role: 'Leadership', quota: 0 }
        ];
        state.teamMemberMap = { 'Javonte': 'rec1', 'Teslim': 'rec2', 'Israel': 'rec3', 'Conrad': 'rec4', 'Test User': 'rec5', 'Test Leadership': 'rec6', 'Ramallah': 'rec7', 'Keyna': 'rec8' };
    }
}

function populateLoginSelect() {
    var select = document.getElementById('userSelect');
    if (!select) return;
    state.data.teamMembers.forEach(function(member) {
        var option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name + ' (' + member.role + ')';
        select.appendChild(option);
    });
}

async function handleLogin() {
    var select = document.getElementById('userSelect');
    var passwordInput = document.getElementById('passwordInput');
    var errorDiv = document.getElementById('loginError');
    var selectedName = select.value, enteredPassword = passwordInput.value;
    
    if (!selectedName) { errorDiv.textContent = 'Please select a team member'; errorDiv.classList.remove('hidden'); return; }
    if (!enteredPassword) { errorDiv.textContent = 'Please enter your password'; errorDiv.classList.remove('hidden'); return; }
    if (userPasswords[selectedName] !== enteredPassword) { errorDiv.textContent = 'Incorrect password'; errorDiv.classList.remove('hidden'); passwordInput.value = ''; return; }
    
    var user = state.data.teamMembers.find(function(m) { return m.name === selectedName; });
    if (user) { 
        state.currentUser = user; 
        localStorage.setItem('nuconnect_session', JSON.stringify(user));
        document.getElementById('loginScreen').classList.add('hidden'); 
        document.getElementById('appContainer').classList.remove('hidden'); 
        await initApp(); 
    }
}

async function initApp() {
    document.getElementById('currentUserName').textContent = state.currentUser.name + ' ‚Ä¢ ' + state.currentUser.role;
    document.getElementById('profileName').textContent = state.currentUser.name;
    buildNavigation();
    await loadAllData();
    renderView('dashboard');
    setInterval(async function() { await loadAllData(); }, 5 * 60 * 1000);
}

function buildNavigation() {
    var nav = document.getElementById('sidebarNav');
    var items = allNavItems.slice();
    if (state.currentUser.role === 'Leadership') items = items.concat(leadershipNavItems);
    var html = '';
    for (var i = 0; i < items.length; i++) {
        var item = items[i];
        html += '<div class="nav-item' + (item.id === state.currentView ? ' active' : '') + '" onclick="renderView(\'' + item.id + '\')">' +
            '<span class="nav-item-icon">' + item.icon + '</span><span>' + item.label + '</span></div>';
    }
    nav.innerHTML = html;
}

function logout() { 
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('nuconnect_session');
        location.reload(); 
    }
}

// ============ AIRTABLE API ============
async function fetchFromAirtable(tableName, method, body) {
    method = method || 'GET';
    try {
        var url = 'https://api.airtable.com/v0/' + state.baseId + '/' + encodeURIComponent(tableName);
        var options = { method: method, headers: { 'Authorization': 'Bearer ' + state.apiKey, 'Content-Type': 'application/json' } };
        if (body && ['POST', 'PATCH', 'PUT'].includes(method)) options.body = JSON.stringify(body);
        var response = await fetch(url, options);
        if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
        return await response.json();
    } catch (error) { console.error('Error with ' + tableName + ':', error); throw error; }
}

async function deleteFromAirtable(tableName, recordId) {
    var url = 'https://api.airtable.com/v0/' + state.baseId + '/' + encodeURIComponent(tableName) + '/' + recordId;
    var response = await fetch(url, { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + state.apiKey } });
    if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
    return true;
}

async function updateInAirtable(tableName, recordId, fields) {
    var url = 'https://api.airtable.com/v0/' + state.baseId + '/' + encodeURIComponent(tableName) + '/' + recordId;
    var response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + state.apiKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields: fields }) });
    if (!response.ok) throw new Error('HTTP error! status: ' + response.status);
    return await response.json();
}

async function loadAllData() {
    try { await Promise.all([loadDeals(), loadActivities(), loadContacts(), loadAccounts()]); }
    catch (error) { console.error('Error loading data:', error); }
}

async function loadDeals() {
    var response = await fetchFromAirtable('Deals');
    if (response && response.records) {
        state.data.deals = response.records.map(function(r) {
            return {
                id: r.id, name: r.fields['Deal Name'] || '', owner: getOwnerName(r.fields.Owner),
                tier: Array.isArray(r.fields['Tier (lookup)']) ? r.fields['Tier (lookup)'][0] : r.fields['Tier (lookup)'] || '',
                stage: r.fields.Stage || '', value: r.fields.Amount || 0, eventName: r.fields['Event Name'] || '',
                closeDate: r.fields['Close Date'] || '', createdTime: r.createdTime,
                pricingType: r.fields['Pricing Type'] || 'Public Price', status: r.fields['Status'] || 'Active'
            };
        });
    }
}

async function loadActivities() {
    var response = await fetchFromAirtable('Activities');
    if (response && response.records) {
        state.data.activities = response.records.map(function(r) {
            return {
                id: r.id, name: r.fields['Activity Name'] || '', type: r.fields.Type || '',
                date: r.fields['Activity Date/Time'] || r.fields.Date || '', owner: r.fields.Owner || '',
                account: r.fields.Account || '', result: r.fields.Result || '', createdTime: r.createdTime
            };
        });
    }
}

async function loadContacts() {
    var response = await fetchFromAirtable('Contacts');
    if (response && response.records) {
        state.data.contacts = response.records.map(function(r) {
            return {
                id: r.id, name: r.fields['Full Name'] || '', email: r.fields.Email || '', phone: r.fields.Phone || '',
                company: getAccountName(r.fields.Account), accountId: Array.isArray(r.fields.Account) ? r.fields.Account[0] : null,
                role: r.fields.Title || '', owner: getOwnerName(r.fields['Contact Owner']), createdTime: r.createdTime
            };
        });
    }
}

async function loadAccounts() {
    var response = await fetchFromAirtable('Accounts');
    if (response && response.records) {
        state.data.accounts = response.records.map(function(r) {
            return {
                id: r.id, name: r.fields['Account Name'] || '', industry: r.fields.Industry || '',
                website: r.fields.Website || '', phone: r.fields.Phone || '', address: r.fields.Address || '',
                owner: getOwnerName(r.fields['Account Owner']), createdTime: r.createdTime
            };
        });
    }
}

function getUserDeals() {
    if (state.currentUser.role === 'Leadership') return state.data.deals;
    return state.data.deals.filter(function(d) { return d.owner === state.currentUser.name; });
}

// ============ CRUD OPERATIONS ============
async function createDeal(dealData) {
    try {
        var response = await fetchFromAirtable('Deals', 'POST', { fields: dealData });
        if (response && response.id) { await loadDeals(); closeModal(); renderView('pipeline'); alert('Deal created!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function createContact(contactData) {
    try {
        var response = await fetchFromAirtable('Contacts', 'POST', { fields: contactData });
        if (response && response.id) { await loadContacts(); closeModal(); renderView('contacts'); alert('Contact created!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function createAccount(accountData) {
    try {
        var response = await fetchFromAirtable('Accounts', 'POST', { fields: accountData });
        if (response && response.id) { await loadAccounts(); closeModal(); renderView('accounts'); alert('Account created!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function logActivity(activityData) {
    try {
        var response = await fetchFromAirtable('Activities', 'POST', { fields: activityData });
        if (response && response.id) { 
            await loadActivities(); 
            closeModal(); 
            renderView(state.currentView); 
            alert('Activity logged!'); 
            checkAchievements();
        }
    } catch (error) { alert('Error: ' + error.message); }
}

async function deleteContact(contactId) {
    if (!confirm('Delete this contact?')) return;
    try { await deleteFromAirtable('Contacts', contactId); await loadContacts(); closeModal(); renderView('contacts'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteAccount(accountId) {
    if (!confirm('Delete this account?')) return;
    try { await deleteFromAirtable('Accounts', accountId); await loadAccounts(); closeModal(); renderView('accounts'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteDeal(dealId) {
    if (!confirm('Delete this deal?')) return;
    try { await deleteFromAirtable('Deals', dealId); await loadDeals(); closeModal(); renderView('pipeline'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteActivity(activityId) {
    if (!confirm('Delete this activity?')) return;
    try { await deleteFromAirtable('Activities', activityId); await loadActivities(); renderView('activity'); }
    catch (error) { alert('Error: ' + error.message); }
}

// ============ DETAIL MODALS ============
function openAccountDetailModal(accountId) {
    var account = state.data.accounts.find(function(a) { return a.id === accountId; });
    if (!account) return;
    
    var contacts = state.data.contacts.filter(function(c) { return c.accountId === accountId || c.company === account.name; });
    var deals = state.data.deals.filter(function(d) { return d.name.toLowerCase().includes(account.name.toLowerCase()); });
    var activities = state.data.activities.filter(function(a) { return a.account === account.name; });
    var isLeadership = state.currentUser.role === 'Leadership';
    
    var html = '<div class="modal active"><div class="modal-content profile">' +
        '<div class="profile-card-header" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);">' +
        '<div class="profile-card-avatar">üè¢</div>' +
        '<div class="profile-card-name">' + account.name + '</div>' +
        '<div class="profile-card-subtitle">' + (account.industry || 'No industry') + '</div></div>' +
        '<div class="profile-card-body">' +
        '<div class="profile-card-row"><span class="profile-card-label">Owner</span><span class="profile-card-value">' + (account.owner || 'Unassigned') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Website</span><span class="profile-card-value">' + (account.website || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Phone</span><span class="profile-card-value">' + (account.phone || '-') + '</span></div>' +
        '<div style="margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">' +
        '<div style="background:var(--bg-light);padding:12px;border-radius:8px;"><div style="font-size:22px;font-weight:700;color:var(--primary);">' + contacts.length + '</div><div style="font-size:11px;color:var(--text-gray);">Contacts</div></div>' +
        '<div style="background:var(--bg-light);padding:12px;border-radius:8px;"><div style="font-size:22px;font-weight:700;color:var(--primary);">' + deals.length + '</div><div style="font-size:11px;color:var(--text-gray);">Deals</div></div>' +
        '<div style="background:var(--bg-light);padding:12px;border-radius:8px;"><div style="font-size:22px;font-weight:700;color:var(--primary);">' + activities.length + '</div><div style="font-size:11px;color:var(--text-gray);">Activities</div></div>' +
        '</div></div>' +
        '<div class="profile-card-actions">' +
        '<button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>';
    if (isLeadership) {
        html += '<button class="btn btn-secondary btn-small" onclick="closeModal();openEditAccountModal(\'' + accountId + '\')">‚úèÔ∏è Edit</button>';
        html += '<button class="btn btn-danger btn-small" onclick="deleteAccount(\'' + accountId + '\')">üóëÔ∏è</button>';
    }
    html += '<button class="btn btn-primary btn-small" onclick="closeModal();openLogActivityModalForAccount(\'' + account.name + '\')">üìù Activity</button>' +
        '</div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function openContactDetailModal(contactId) {
    var contact = state.data.contacts.find(function(c) { return c.id === contactId; });
    if (!contact) return;
    
    var activities = state.data.activities.filter(function(a) { return a.contact === contactId; });
    var isLeadership = state.currentUser.role === 'Leadership';
    
    var html = '<div class="modal active"><div class="modal-content profile">' +
        '<div class="profile-card-header">' +
        '<div class="profile-card-avatar">üë§</div>' +
        '<div class="profile-card-name">' + contact.name + '</div>' +
        '<div class="profile-card-subtitle">' + (contact.role || 'No role') + (contact.company ? ' at ' + contact.company : '') + '</div></div>' +
        '<div class="profile-card-body">' +
        '<div class="profile-card-row"><span class="profile-card-label">Email</span><span class="profile-card-value">' + (contact.email || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Phone</span><span class="profile-card-value">' + (contact.phone || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Company</span><span class="profile-card-value">' + (contact.company || '-') + '</span></div>' +
        '<div class="profile-card-row"><span class="profile-card-label">Owner</span><span class="profile-card-value">' + (contact.owner || 'Unassigned') + '</span></div>' +
        '<div style="margin-top:16px;background:var(--bg-light);padding:14px;border-radius:8px;text-align:center;">' +
        '<div style="font-size:24px;font-weight:700;color:var(--primary);">' + activities.length + '</div>' +
        '<div style="font-size:12px;color:var(--text-gray);">Total Activities</div></div></div>' +
        '<div class="profile-card-actions">' +
        '<button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>';
    if (isLeadership) {
        html += '<button class="btn btn-secondary btn-small" onclick="closeModal();openEditContactModal(\'' + contactId + '\')">‚úèÔ∏è Edit</button>';
        html += '<button class="btn btn-danger btn-small" onclick="deleteContact(\'' + contactId + '\')">üóëÔ∏è</button>';
    }
    html += '<button class="btn btn-primary btn-small" onclick="closeModal();openLogActivityModal()">üìù Activity</button>' +
        '</div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

// Edit modals
function openEditContactModal(contactId) {
    var contact = state.data.contacts.find(function(c) { return c.id === contactId; });
    if (!contact) return;
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Contact</h2></div>' +
        '<div class="form-group"><label>Full Name *</label><input type="text" id="editContactName" value="' + contact.name + '"></div>' +
        '<div class="form-group"><label>Email *</label><input type="email" id="editContactEmail" value="' + contact.email + '"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="editContactPhone" value="' + (contact.phone || '') + '"></div>' +
        '<div class="form-group"><label>Title / Role</label><input type="text" id="editContactRole" value="' + (contact.role || '') + '"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditContact(\'' + contactId + '\')">Save</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

async function saveEditContact(contactId) {
    var fields = { 'Full Name': document.getElementById('editContactName').value, 'Email': document.getElementById('editContactEmail').value, 'Phone': document.getElementById('editContactPhone').value, 'Title': document.getElementById('editContactRole').value };
    try { await updateInAirtable('Contacts', contactId, fields); await loadContacts(); closeModal(); renderView('contacts'); }
    catch (error) { alert('Error: ' + error.message); }
}

function openEditAccountModal(accountId) {
    var account = state.data.accounts.find(function(a) { return a.id === accountId; });
    if (!account) return;
    var indOptions = '';
    for (var i = 0; i < industryOptions.length; i++) {
        indOptions += '<option value="' + industryOptions[i] + '"' + (account.industry === industryOptions[i] ? ' selected' : '') + '>' + industryOptions[i] + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Account</h2></div>' +
        '<div class="form-group"><label>Account Name *</label><input type="text" id="editAccountName" value="' + account.name + '"></div>' +
        '<div class="form-group"><label>Industry</label><select id="editAccountIndustry"><option value="">Select...</option>' + indOptions + '</select></div>' +
        '<div class="form-group"><label>Website</label><input type="url" id="editAccountWebsite" value="' + (account.website || '') + '"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="editAccountPhone" value="' + (account.phone || '') + '"></div>' +
        '<div class="form-group"><label>Address</label><input type="text" id="editAccountAddress" value="' + (account.address || '') + '"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditAccount(\'' + accountId + '\')">Save</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

async function saveEditAccount(accountId) {
    var fields = { 'Account Name': document.getElementById('editAccountName').value, 'Industry': document.getElementById('editAccountIndustry').value, 'Website': document.getElementById('editAccountWebsite').value, 'Phone': document.getElementById('editAccountPhone').value, 'Address': document.getElementById('editAccountAddress').value };
    try { await updateInAirtable('Accounts', accountId, fields); await loadAccounts(); closeModal(); renderView('accounts'); }
    catch (error) { alert('Error: ' + error.message); }
}

// ============ ADD MODALS ============
function openAddDealModal() {
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Deal</h2></div>' +
        '<div class="form-group"><label>Deal Name *</label><input type="text" id="dealName" placeholder="Enter deal name"></div>' +
        '<div class="form-group"><label>Tier *</label><select id="dealTier" onchange="updateDealValue()"><option value="">Select tier...</option>' +
        '<option value="Starter">Starter ($750)</option><option value="Growth">Growth ($1,250)</option>' +
        '<option value="Pro">Pro ($2,000)</option><option value="Enterprise">Enterprise ($4,200)</option></select></div>' +
        '<div class="form-group"><label>Deal Value *</label><input type="number" id="dealValue" readonly style="background:var(--bg-light);"></div>' +
        '<div class="form-group"><label>Stage</label><select id="dealStage"><option value="Qualified">Qualified</option>' +
        '<option value="Proposal Sent">Proposal Sent</option><option value="Negotiation">Negotiation</option><option value="Closed Won">Closed Won</option></select></div>' +
        '<div class="form-group"><label>Event Name</label><input type="text" id="dealEventName" placeholder="Name of the event"></div>' +
        '<div class="form-group"><label>Close Date</label><input type="date" id="dealCloseDate"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Create Deal</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function updateDealValue() {
    var tier = document.getElementById('dealTier').value;
    document.getElementById('dealValue').value = tier && tierPricing[tier] ? tierPricing[tier] : '';
}

function saveDeal() {
    var dealName = document.getElementById('dealName').value.trim();
    var dealTier = document.getElementById('dealTier').value;
    var dealValue = parseFloat(document.getElementById('dealValue').value) || 0;
    if (!dealName || !dealTier) { alert('Please fill in Deal Name and select Tier'); return; }
    
    var dealData = { 'Deal Name': dealName, 'Amount': dealValue, 'Stage': document.getElementById('dealStage').value };
    if (state.teamMemberMap[state.currentUser.name]) dealData['Owner'] = [state.teamMemberMap[state.currentUser.name]];
    var eventName = document.getElementById('dealEventName').value.trim();
    var closeDate = document.getElementById('dealCloseDate').value;
    if (eventName) dealData['Event Name'] = eventName;
    if (closeDate) dealData['Close Date'] = closeDate;
    createDeal(dealData);
}

function openAddContactModal() {
    var accountOptions = '';
    for (var i = 0; i < state.data.accounts.length; i++) {
        accountOptions += '<option value="' + state.data.accounts[i].id + '">' + state.data.accounts[i].name + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Contact</h2></div>' +
        '<div class="form-group"><label>Full Name *</label><input type="text" id="contactName" placeholder="John Smith"></div>' +
        '<div class="form-group"><label>Email *</label><input type="email" id="contactEmail" placeholder="john@company.com"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="contactPhone" placeholder="(555) 123-4567"></div>' +
        '<div class="form-group"><label>Company / Account</label><select id="contactAccount"><option value="">Select...</option>' + accountOptions + '</select></div>' +
        '<div class="form-group"><label>Title / Role</label><input type="text" id="contactRole" placeholder="Event Coordinator"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveContact()">Create Contact</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function saveContact() {
    var contactData = { 'Full Name': document.getElementById('contactName').value, 'Email': document.getElementById('contactEmail').value, 'Phone': document.getElementById('contactPhone').value, 'Title': document.getElementById('contactRole').value };
    if (!contactData['Full Name'] || !contactData['Email']) { alert('Please fill in Name and Email'); return; }
    if (state.teamMemberMap[state.currentUser.name]) contactData['Contact Owner'] = [state.teamMemberMap[state.currentUser.name]];
    var accountId = document.getElementById('contactAccount').value;
    if (accountId) contactData['Account'] = [accountId];
    createContact(contactData);
}

function openAddAccountModal() {
    var indOptions = '';
    for (var i = 0; i < industryOptions.length; i++) {
        indOptions += '<option value="' + industryOptions[i] + '">' + industryOptions[i] + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Account</h2></div>' +
        '<div class="form-group"><label>Account Name *</label><input type="text" id="accountName" placeholder="Company Name Inc."></div>' +
        '<div class="form-group"><label>Industry *</label><select id="accountIndustry"><option value="">Select...</option>' + indOptions + '</select></div>' +
        '<div class="form-group"><label>Website</label><input type="url" id="accountWebsite" placeholder="https://company.com"></div>' +
        '<div class="form-group"><label>Phone</label><input type="tel" id="accountPhone" placeholder="(555) 123-4567"></div>' +
        '<div class="form-group"><label>Address</label><input type="text" id="accountAddress" placeholder="123 Main St, City, State"></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveAccount()">Create Account</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function saveAccount() {
    var accountData = { 'Account Name': document.getElementById('accountName').value, 'Industry': document.getElementById('accountIndustry').value, 'Website': document.getElementById('accountWebsite').value, 'Phone': document.getElementById('accountPhone').value, 'Address': document.getElementById('accountAddress').value };
    if (!accountData['Account Name']) { alert('Please enter account name'); return; }
    if (state.teamMemberMap[state.currentUser.name]) accountData['Account Owner'] = [state.teamMemberMap[state.currentUser.name]];
    createAccount(accountData);
}

function openLogActivityModal() {
    var accountOptions = '';
    for (var i = 0; i < state.data.accounts.length; i++) {
        accountOptions += '<option value="' + state.data.accounts[i].id + '">' + state.data.accounts[i].name + '</option>';
    }
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìù Log Activity</h2></div>' +
        '<div class="form-group"><label>Activity Type *</label><select id="activityType">' +
        '<option value="Call">üìû Call</option><option value="Email">üìß Email</option><option value="LinkedIn">üíº LinkedIn Message</option>' +
        '<option value="Discovery Call">üîç Discovery Call</option><option value="Demo">üé• Demo</option>' +
        '<option value="Proposal">üìÑ Proposal Sent</option><option value="Follow-up">üîÑ Follow-up</option><option value="Meeting">üìÖ Meeting</option></select></div>' +
        '<div class="form-group"><label>Account *</label><select id="activityAccount"><option value="">Select...</option>' + accountOptions + '</select></div>' +
        '<div class="form-group"><label>Result / Outcome *</label><textarea id="activityResult" placeholder="What happened?"></textarea></div>' +
        '<div class="form-group"><label>Next Steps</label><textarea id="activityNextSteps" placeholder="What\'s next?" style="min-height:80px;"></textarea></div>' +
        '<div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveActivity()">Log Activity</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function openLogActivityModalForAccount(accountName) {
    openLogActivityModal();
    setTimeout(function() {
        var accountSelect = document.getElementById('activityAccount');
        var account = state.data.accounts.find(function(a) { return a.name === accountName; });
        if (account && accountSelect) accountSelect.value = account.id;
    }, 100);
}

function saveActivity() {
    var accountRecordId = document.getElementById('activityAccount').value;
    var result = document.getElementById('activityResult').value;
    if (!accountRecordId || !result) { alert('Please select an Account and enter Result'); return; }
    
    var account = state.data.accounts.find(function(a) { return a.id === accountRecordId; });
    var accountName = account ? account.name : '';
    var activityType = document.getElementById('activityType').value;
    var now = new Date();
    
    var activityData = { 'Activity Name': activityType + ' - ' + accountName, 'Type': activityType, 'Date': now.toISOString().split('T')[0], 'Activity Date/Time': now.toISOString(), 'Account': accountName, 'Owner': state.currentUser.name, 'Result': result };
    var nextSteps = document.getElementById('activityNextSteps').value;
    if (nextSteps) activityData['Next Steps'] = nextSteps;
    logActivity(activityData);
}

function openDealDetailsModal(dealId) {
    var deal = state.data.deals.find(function(d) { return d.id === dealId; });
    if (!deal) return;
    var isLeadership = state.currentUser.role === 'Leadership';
    var dealAge = getDaysSince(deal.createdTime);
    var currentWeek = Math.min(Math.ceil(dealAge / 7) || 1, 9);
    var cadenceItem = TOUCHPOINT_CADENCE[currentWeek - 1];
    
    var stageOptions = '<option value="Qualified"' + (deal.stage === 'Qualified' ? ' selected' : '') + '>Qualified</option>' +
        '<option value="Proposal Sent"' + (deal.stage === 'Proposal Sent' ? ' selected' : '') + '>Proposal Sent</option>' +
        '<option value="Negotiation"' + (deal.stage === 'Negotiation' ? ' selected' : '') + '>Negotiation</option>' +
        '<option value="Closed Won"' + (deal.stage === 'Closed Won' ? ' selected' : '') + '>Closed Won</option>' +
        '<option value="Closed Lost"' + (deal.stage === 'Closed Lost' ? ' selected' : '') + '>Closed Lost</option>';
    
    var html = '<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìä ' + deal.name + '</h2></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;">' +
        '<div style="background:var(--bg-light);padding:14px;border-radius:10px;text-align:center;"><div style="font-size:26px;font-weight:700;color:var(--primary);">$' + deal.value.toLocaleString() + '</div><div style="font-size:12px;color:var(--text-gray);">Deal Value</div></div>' +
        '<div style="background:var(--bg-light);padding:14px;border-radius:10px;text-align:center;"><span class="badge badge-' + deal.tier.toLowerCase() + '" style="font-size:13px;">' + deal.tier + '</span><div style="font-size:12px;color:var(--text-gray);margin-top:6px;">Tier</div></div></div>' +
        '<div style="background:#dbeafe;padding:16px;border-radius:10px;margin-bottom:20px;">' +
        '<div style="font-weight:700;font-size:14px;margin-bottom:8px;">üìÖ Week ' + currentWeek + ' - ' + cadenceItem.action + '</div>' +
        '<div style="font-size:13px;color:var(--text-gray);">' + cadenceItem.goal + '</div></div>' +
        '<div class="form-group"><label>Event Name</label><input type="text" value="' + (deal.eventName || 'Not set') + '" disabled></div>' +
        '<div class="form-group"><label>Owner</label><input type="text" value="' + deal.owner + '" disabled></div>' +
        '<div class="form-group"><label>Current Stage</label><select id="dealStageEdit">' + stageOptions + '</select></div>' +
        '<div class="modal-actions">';
    if (isLeadership) html += '<button class="btn btn-danger" onclick="deleteDeal(\'' + dealId + '\')">üóëÔ∏è Delete</button>';
    html += '<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>' +
        '<button class="btn btn-primary" onclick="updateDealStage(\'' + dealId + '\')">Update</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

async function updateDealStage(dealId, newStage) {
    if (!newStage) newStage = document.getElementById('dealStageEdit').value;
    var oldDeal = state.data.deals.find(function(d) { return d.id === dealId; });
    var oldStage = oldDeal ? oldDeal.stage : '';
    
    try {
        await fetch('https://api.airtable.com/v0/' + state.baseId + '/Deals/' + dealId, {
            method: 'PATCH', headers: { 'Authorization': 'Bearer ' + state.apiKey, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Stage': newStage } })
        });
        await loadDeals(); 
        closeModal(); 
        renderView('pipeline');
        
        // Celebrate stage advancement
        if (oldStage && newStage !== oldStage && newStage !== 'Closed Lost') {
            if (newStage === 'Closed Won') {
                showCelebration('deal-moved', 'You closed the deal! ' + oldDeal.name + ' is now won!');
            } else {
                showCelebration('deal-moved', oldDeal.name + ' moved from ' + oldStage + ' to ' + newStage + '!');
            }
        }
    } catch (error) { alert('Error: ' + error.message); }
}

// ============ VIEW RENDERING ============
function renderView(viewName) {
    destroyCharts();
    state.currentView = viewName;
    state.filterRep = null;
    var titles = { 'dashboard': 'Dashboard', 'pipeline': 'Pipeline', 'contacts': 'Contacts', 'accounts': 'Accounts', 'events': 'Events', 'activity': 'Activities', 'reports': 'Reports', 'leadership': 'Analytics', 'team': 'Team Overview' };
    document.getElementById('pageTitle').textContent = titles[viewName] || viewName;
    
    if (viewName === 'dashboard') renderDashboard();
    else if (viewName === 'pipeline') renderPipeline();
    else if (viewName === 'contacts') renderContacts();
    else if (viewName === 'accounts') renderAccounts();
    else if (viewName === 'events') renderEvents();
    else if (viewName === 'activity') renderActivityView();
    else if (viewName === 'reports') renderReports();
    else if (viewName === 'leadership') renderLeadershipAnalytics();
    else if (viewName === 'team') renderTeamOverview();
    
    buildNavigation();
}

function renderDashboard() {
    if (state.currentUser.role === 'Leadership') { renderLeadershipDashboard(); return; }
    renderRepDashboard();
}

function getActivityStats(activities) {
    var stats = { calls: 0, emails: 0, linkedin: 0, demos: 0, proposals: 0, meetings: 0 };
    for (var i = 0; i < activities.length; i++) {
        var type = (activities[i].type || '').toLowerCase();
        if (type.includes('call')) stats.calls++;
        else if (type.includes('email')) stats.emails++;
        else if (type.includes('linkedin')) stats.linkedin++;
        else if (type.includes('demo')) stats.demos++;
        else if (type.includes('proposal')) stats.proposals++;
        else if (type.includes('meeting')) stats.meetings++;
    }
    return stats;
}

function renderRepDashboard() {
    var deals = getUserDeals();
    var targets = getKPITargets(state.currentUser.role);
    var today = new Date();
    var todayISO = today.toISOString().split('T')[0];
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    var userActivities = state.data.activities.filter(function(a) { return a.owner === state.currentUser.name; });
    var todayActivities = userActivities.filter(function(a) { return a.date && a.date.split('T')[0] === todayISO; });
    var todayTouchpoints = todayActivities.length;
    var todayNewLeads = state.data.contacts.filter(function(c) { return c.owner === state.currentUser.name && c.createdTime && c.createdTime.split('T')[0] === todayISO; }).length;
    
    var todayStats = getActivityStats(todayActivities);
    var allTimeStats = getActivityStats(userActivities);
    
    var monthClosedDeals = deals.filter(function(d) {
        if (!d.stage.toLowerCase().includes('won')) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var monthRevenue = monthClosedDeals.reduce(function(sum, d) { return sum + d.value; }, 0);
    var revenuePercentOfMax = (monthRevenue / targets.monthlyRevenueMax) * 100;
    var eventsPercentOfMax = (monthClosedDeals.length / targets.monthlyEventsMax) * 100;
    
    var growthPlusCount = monthClosedDeals.filter(function(d) { return d.tier !== 'Starter'; }).length;
    var qualityScore = monthClosedDeals.length > 0 ? (growthPlusCount / monthClosedDeals.length) * 100 : 0;
    
    var pipelineDeals = deals.filter(function(d) { return !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost'); });
    var staleDeals = pipelineDeals.filter(function(d) {
        var lastActivity = userActivities.filter(function(a) { return a.account && d.name.toLowerCase().includes(a.account.toLowerCase()); }).sort(function(x,y) { return new Date(y.date) - new Date(x.date); })[0];
        if (!lastActivity) return true;
        return getDaysSince(lastActivity.date) >= 5;
    });
    
    var allClosedDeals = deals.filter(function(d) { return d.stage.toLowerCase().includes('won'); }).sort(function(a, b) { return new Date(b.closeDate || b.createdTime) - new Date(a.closeDate || a.createdTime); });
    
    function getStatusColor(value, target) { return value >= target ? 'var(--success)' : value >= target * 0.5 ? 'var(--warning)' : 'var(--danger)'; }
    function getStatusIcon(value, target) { return value >= target ? '‚úÖ' : value >= target * 0.5 ? '‚ö†Ô∏è' : '‚ùå'; }
    
    var greeting = getGreeting() + ', ' + state.currentUser.name + '!';
    var dateStr = today.toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric'});

    var html = '<div class="greeting-banner"><div class="greeting-text">' + greeting + '</div><div class="greeting-sub">Let\'s crush those goals today!</div></div>' +
        renderNudges() +
        '<div class="quick-actions">' +
        '<button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï New Deal</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openLogActivityModal()">üìù Log Activity</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddContactModal()">üë§ Contact</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddAccountModal()">üè¢ Account</button></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìÖ Daily Scorecard</h2><span style="font-size:13px;color:var(--text-gray);">' + dateStr + '</span></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;">' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Touchpoints</span><span>' + getStatusIcon(todayTouchpoints,targets.dailyTouchpointsMin) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin) + ';">' + todayTouchpoints + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyTouchpointsMin + '-' + targets.dailyTouchpointsMax + '</div><div class="progress-bar"><div class="progress-fill" style="width:' + Math.min((todayTouchpoints/targets.dailyTouchpointsMax)*100,100) + '%;background:' + getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin) + ';"></div></div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.calls,targets.dailyCalls) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Calls Made</span><span>' + getStatusIcon(todayStats.calls,targets.dailyCalls) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.calls,targets.dailyCalls) + ';">' + todayStats.calls + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyCalls + '+</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.emails,targets.dailyEmails) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Emails Sent</span><span>' + getStatusIcon(todayStats.emails,targets.dailyEmails) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.emails,targets.dailyEmails) + ';">' + todayStats.emails + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyEmails + '+</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayStats.linkedin,targets.dailyLinkedIn) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">LinkedIn</span><span>' + getStatusIcon(todayStats.linkedin,targets.dailyLinkedIn) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayStats.linkedin,targets.dailyLinkedIn) + ';">' + todayStats.linkedin + '</div><div style="font-size:12px;color:var(--text-gray);">Target: ' + targets.dailyLinkedIn + '+</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + getStatusColor(todayNewLeads,3) + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">New Leads</span><span>' + getStatusIcon(todayNewLeads,3) + '</span></div><div class="kpi-value" style="color:' + getStatusColor(todayNewLeads,3) + ';">' + todayNewLeads + '</div><div style="font-size:12px;color:var(--text-gray);">Target: 3-5</div></div>' +
        '<div class="kpi-card" style="border-left:4px solid ' + (staleDeals.length > 0 ? 'var(--warning)' : 'var(--success)') + ';"><div style="display:flex;justify-content:space-between;"><span class="kpi-label">Needs Attention</span><span>' + (staleDeals.length > 0 ? '‚ö†Ô∏è' : '‚úÖ') + '</span></div><div class="kpi-value" style="color:' + (staleDeals.length > 0 ? 'var(--warning)' : 'var(--success)') + ';">' + staleDeals.length + '</div><div style="font-size:12px;color:var(--text-gray);">Stale 5+ days</div></div>' +
        '</div></div>' +
        
        '<div class="kpi-grid">' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üí∞ MONTHLY REVENUE</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">$' + (monthRevenue/1000).toFixed(1) + 'K</div><div style="font-size:13px;opacity:0.9;margin-bottom:12px;">Target: $' + (targets.monthlyRevenueMin/1000).toFixed(1) + 'K - $' + (targets.monthlyRevenueMax/1000).toFixed(1) + 'K</div><div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;"><div style="width:' + Math.min(revenuePercentOfMax,100) + '%;height:100%;background:white;border-radius:4px;"></div></div><div style="font-size:13px;font-weight:600;margin-top:8px;">' + revenuePercentOfMax.toFixed(0) + '% of Max</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üéâ EVENTS CLOSED</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">' + monthClosedDeals.length + '</div><div style="font-size:13px;opacity:0.9;margin-bottom:12px;">Target: ' + targets.monthlyEventsMin + '-' + targets.monthlyEventsMax + '</div><div style="background:rgba(255,255,255,0.2);height:8px;border-radius:4px;"><div style="width:' + Math.min(eventsPercentOfMax,100) + '%;height:100%;background:white;border-radius:4px;"></div></div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üìä QUALITY SCORE</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">' + qualityScore.toFixed(0) + '%</div><div style="font-size:13px;opacity:0.9;">' + (qualityScore >= 70 ? '‚úÖ' : '‚ö†Ô∏è') + ' 70%+ Growth+ Required</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;"><div style="font-size:12px;font-weight:600;margin-bottom:12px;opacity:0.9;">üíµ AVG DEAL SIZE</div><div style="font-size:40px;font-weight:800;margin-bottom:6px;">' + (monthClosedDeals.length > 0 ? '$' + Math.round(monthRevenue/monthClosedDeals.length).toLocaleString() : '$0') + '</div><div style="font-size:13px;opacity:0.9;">This month</div></div>' +
        '</div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä Activity Breakdown (All Time)</h2></div>' +
        '<div class="activity-stats">' +
        '<div class="stat-card"><div class="stat-icon">üìû</div><div class="stat-value">' + allTimeStats.calls + '</div><div class="stat-label">Calls Made</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìß</div><div class="stat-value">' + allTimeStats.emails + '</div><div class="stat-label">Emails Sent</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üíº</div><div class="stat-value">' + allTimeStats.linkedin + '</div><div class="stat-label">LinkedIn</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üé•</div><div class="stat-value">' + allTimeStats.demos + '</div><div class="stat-label">Demos</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìÑ</div><div class="stat-value">' + allTimeStats.proposals + '</div><div class="stat-label">Proposals</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-value">' + allTimeStats.meetings + '</div><div class="stat-label">Meetings</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üéâ</div><div class="stat-value">' + allClosedDeals.length + '</div><div class="stat-label">Total Wins</div></div>' +
        '</div></div>' +
        
        '<div class="charts-grid">' +
        '<div class="chart-card"><h3>üìà Revenue Trend (6 Months)</h3><div class="chart-container"><canvas id="repRevenueTrendChart"></canvas></div></div>' +
        '<div class="chart-card"><h3>ü•ß Revenue by Tier</h3><div class="chart-container"><canvas id="repRevenueByTierChart"></canvas></div></div></div>';
    
    // Recent wins
    if (allClosedDeals.length > 0) {
        html += '<div class="card"><div class="card-header"><h2 class="card-title">üèÜ Recent Wins</h2></div><div style="display:flex;flex-direction:column;gap:10px;">';
        for (var i = 0; i < Math.min(allClosedDeals.length, 5); i++) {
            var deal = allClosedDeals[i];
            var daysAgo = getDaysSince(deal.closeDate);
            html += '<div style="background:var(--bg-light);padding:14px 18px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;">' +
                '<div><div style="font-weight:600;font-size:15px;margin-bottom:4px;">' + deal.name + '</div><div style="font-size:12px;color:var(--text-gray);"><span class="badge badge-' + deal.tier.toLowerCase() + '">' + deal.tier + '</span> ' + (daysAgo !== null ? (daysAgo === 0 ? '‚Ä¢ Today' : '‚Ä¢ ' + daysAgo + ' days ago') : '') + '</div></div>' +
                '<div style="font-size:20px;font-weight:700;color:var(--primary);">$' + deal.value.toLocaleString() + '</div></div>';
        }
        html += '</div></div>';
    }
    
    document.getElementById('contentArea').innerHTML = html;
    
    setTimeout(function() {
        renderRevenueTrendChart('repRevenueTrendChart', deals);
        renderRevenueByTierChart('repRevenueByTierChart', deals);
    }, 100);
}

// Leadership Dashboard
function renderLeadershipDashboard() {
    var allDeals = state.data.deals;
    var allActivities = state.data.activities;
    var today = new Date();
    var todayISO = today.toISOString().split('T')[0];
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    var todayActivities = allActivities.filter(function(a) { return a.date && a.date.split('T')[0] === todayISO; });
    var teamStats = getActivityStats(todayActivities);
    
    var monthClosedDeals = allDeals.filter(function(d) {
        if (!d.stage.toLowerCase().includes('won')) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var monthRevenue = monthClosedDeals.reduce(function(sum, d) { return sum + d.value; }, 0);
    var growthPlusDeals = monthClosedDeals.filter(function(d) { return d.tier !== 'Starter'; }).length;
    var qualityScore = monthClosedDeals.length > 0 ? (growthPlusDeals / monthClosedDeals.length) * 100 : 0;
    
    var greeting = getGreeting() + ', ' + state.currentUser.name + '!';
    
    // Build rep cards
    var repCardsHtml = '';
    var needsAttentionHtml = '';
    var onTrackHtml = '';
    
    var reps = state.data.teamMembers.filter(function(m) { return m.role !== 'Leadership'; });
    for (var i = 0; i < reps.length; i++) {
        var member = reps[i];
        var memberDeals = allDeals.filter(function(d) { return d.owner === member.name; });
        var memberActivities = allActivities.filter(function(a) { return a.owner === member.name; });
        var memberTodayActivities = todayActivities.filter(function(a) { return a.owner === member.name; });
        var memberStats = getActivityStats(memberTodayActivities);
        var memberAllStats = getActivityStats(memberActivities);
        
        var memberMonthWon = memberDeals.filter(function(d) {
            if (!d.stage.toLowerCase().includes('won')) return false;
            var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return dealDate && dealDate >= monthStart;
        });
        var memberRevenue = memberMonthWon.reduce(function(sum, d) { return sum + d.value; }, 0);
        var targets = getKPITargets(member.role);
        var attainment = (memberRevenue / targets.monthlyRevenueMax) * 100;
        
        var cardClass = attainment >= 100 ? '' : attainment >= 70 ? ' yellow' : ' red';
        var statusEmoji = attainment >= 100 ? 'üü¢' : attainment >= 70 ? 'üü°' : 'üî¥';
        
        repCardsHtml += '<div class="rep-card' + cardClass + '" onclick="openRepDetailsModal(\'' + member.id + '\')">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:12px;">' +
            '<div><div style="font-size:16px;font-weight:700;">' + statusEmoji + ' ' + member.name + '</div><div style="font-size:12px;color:var(--text-gray);">' + member.role + '</div></div></div>' +
            '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;text-align:center;">' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberStats.calls + '</div><div style="font-size:10px;color:var(--text-gray);">Calls</div></div>' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberStats.emails + '</div><div style="font-size:10px;color:var(--text-gray);">Emails</div></div>' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberStats.linkedin + '</div><div style="font-size:10px;color:var(--text-gray);">LinkedIn</div></div>' +
            '<div><div style="font-size:18px;font-weight:700;color:var(--primary);">' + memberTodayActivities.length + '</div><div style="font-size:10px;color:var(--text-gray);">Total</div></div></div>' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">' +
            '<div><div style="font-size:12px;color:var(--text-gray);">Month Revenue</div><div style="font-size:22px;font-weight:700;color:var(--primary);">$' + (memberRevenue/1000).toFixed(1) + 'K</div></div>' +
            '<div style="text-align:right;"><div style="font-size:12px;color:var(--text-gray);">% of Max</div><div style="font-size:22px;font-weight:700;color:var(--primary);">' + attainment.toFixed(0) + '%</div></div></div>' +
            '<div class="progress-bar"><div class="progress-fill" style="width:' + Math.min(attainment,100) + '%;background:' + (attainment >= 100 ? 'var(--success)' : attainment >= 70 ? 'var(--warning)' : 'var(--danger)') + ';"></div></div></div>';
        
        if (attainment < 70) {
            needsAttentionHtml += '<div class="kpi-alert-item needs-attention" style="background:#fee2e2;padding:12px 16px;border-radius:8px;margin-bottom:8px;border-left:4px solid var(--danger);">üî¥ <strong>' + member.name + '</strong> at ' + attainment.toFixed(0) + '% - needs coaching <button class="btn btn-small btn-secondary" style="margin-left:auto;font-size:11px;" onclick="event.stopPropagation();openResetPasswordModal(\'' + member.name + '\')">Reset Password</button></div>';
        } else if (attainment >= 100) {
            onTrackHtml += '<div class="kpi-alert-item on-track" style="background:#d1fae5;padding:12px 16px;border-radius:8px;margin-bottom:8px;border-left:4px solid var(--success);">üü¢ <strong>' + member.name + '</strong> at ' + attainment.toFixed(0) + '% - exceeding!</div>';
        }
    }

    var html = '<div class="greeting-banner"><div class="greeting-text">' + greeting + '</div><div class="greeting-sub">Here\'s how the team is performing.</div></div>' +
        '<div class="quick-actions">' +
        '<button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï Deal</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openLogActivityModal()">üìù Activity</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddContactModal()">üë§ Contact</button>' +
        '<button class="btn btn-secondary btn-small" onclick="openAddAccountModal()">üè¢ Account</button></div>' +
        
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px;">' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üí∞ TEAM REVENUE</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">$' + (monthRevenue/1000).toFixed(1) + 'K</div><div style="font-size:12px;opacity:0.9;">Target: $' + KPI_TARGETS.Team.monthlyRevenueMin/1000 + 'K-$' + KPI_TARGETS.Team.monthlyRevenueMax/1000 + 'K</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üéâ TEAM EVENTS</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">' + monthClosedDeals.length + '</div><div style="font-size:12px;opacity:0.9;">Target: ' + KPI_TARGETS.Team.monthlyEventsMin + '-' + KPI_TARGETS.Team.monthlyEventsMax + '</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üìä QUALITY</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">' + qualityScore.toFixed(0) + '%</div><div style="font-size:12px;opacity:0.9;">Growth+ (70% Target)</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;"><div style="font-size:11px;font-weight:600;margin-bottom:10px;opacity:0.9;">üî• TODAY</div><div style="font-size:36px;font-weight:800;margin-bottom:6px;">' + todayActivities.length + '</div><div style="font-size:12px;opacity:0.9;">Touchpoints</div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä Team Activity Today</h2></div>' +
        '<div class="activity-stats">' +
        '<div class="stat-card"><div class="stat-icon">üìû</div><div class="stat-value">' + teamStats.calls + '</div><div class="stat-label">Calls</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìß</div><div class="stat-value">' + teamStats.emails + '</div><div class="stat-label">Emails</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üíº</div><div class="stat-value">' + teamStats.linkedin + '</div><div class="stat-label">LinkedIn</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üé•</div><div class="stat-value">' + teamStats.demos + '</div><div class="stat-label">Demos</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìÑ</div><div class="stat-value">' + teamStats.proposals + '</div><div class="stat-label">Proposals</div></div>' +
        '<div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-value">' + teamStats.meetings + '</div><div class="stat-label">Meetings</div></div></div></div>';
    
    if (needsAttentionHtml || onTrackHtml) {
        html += '<div class="card"><div class="card-header"><h2 class="card-title">üìã KPI Alerts</h2></div><div>' + needsAttentionHtml + onTrackHtml + '</div></div>';
    }
    
    html += '<div class="card"><div class="card-header"><h2 class="card-title">üë• Sales Team</h2></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;">' + repCardsHtml + '</div></div>';
    
    document.getElementById('contentArea').innerHTML = html;
}

function openRepDetailsModal(memberId) {
    var member = state.data.teamMembers.find(function(m) { return m.id === memberId; });
    if (!member) return;
    
    var today = new Date();
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    var todayISO = today.toISOString().split('T')[0];
    var targets = getKPITargets(member.role);
    
    var memberDeals = state.data.deals.filter(function(d) { return d.owner === member.name; });
    var memberActivities = state.data.activities.filter(function(a) { return a.owner === member.name; });
    var memberTodayActivities = memberActivities.filter(function(a) { return a.date && a.date.split('T')[0] === todayISO; });
    
    var memberMonthWon = memberDeals.filter(function(d) {
        if (!d.stage.toLowerCase().includes('won')) return false;
        var dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    var todayStats = getActivityStats(memberTodayActivities);
    var allStats = getActivityStats(memberActivities);
    var memberRevenue = memberMonthWon.reduce(function(sum, d) { return sum + d.value; }, 0);
    var revenuePercentOfMax = (memberRevenue / targets.monthlyRevenueMax) * 100;
    
    var html = '<div class="modal active"><div class="modal-content wide"><div class="modal-header"><h2>' + member.name + ' - Performance</h2></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:12px;margin-bottom:24px;">' +
        '<div class="stat-card"><div style="font-size:11px;color:var(--text-gray);">Today Calls</div><div style="font-size:28px;font-weight:700;color:var(--primary);">' + todayStats.calls + '</div></div>' +
        '<div class="stat-card"><div style="font-size:11px;color:var(--text-gray);">Today Emails</div><div style="font-size:28px;font-weight:700;color:var(--primary);">' + todayStats.emails + '</div></div>' +
        '<div class="stat-card"><div style="font-size:11px;color:var(--text-gray);">Today LinkedIn</div><div style="font-size:28px;font-weight:700;color:var(--primary);">' + todayStats.linkedin + '</div></div>' +
        '<div class="stat-card"><div style="font-size:11px;color:var(--text-gray);">All Calls</div><div style="font-size:28px;font-weight:700;">' + allStats.calls + '</div></div>' +
        '<div class="stat-card"><div style="font-size:11px;color:var(--text-gray);">All Emails</div><div style="font-size:28px;font-weight:700;">' + allStats.emails + '</div></div>' +
        '<div class="stat-card"><div style="font-size:11px;color:var(--text-gray);">All LinkedIn</div><div style="font-size:28px;font-weight:700;">' + allStats.linkedin + '</div></div></div>' +
        
        '<div style="background:var(--bg-light);padding:20px;border-radius:12px;margin-bottom:20px;">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:12px;">' +
        '<div><div style="font-size:12px;color:var(--text-gray);">Monthly Revenue</div><div style="font-size:36px;font-weight:800;color:var(--primary);">$' + (memberRevenue/1000).toFixed(1) + 'K</div></div>' +
        '<div style="text-align:right;"><div style="font-size:12px;color:var(--text-gray);">Target</div><div style="font-size:16px;font-weight:600;">$' + (targets.monthlyRevenueMin/1000).toFixed(1) + 'K-$' + (targets.monthlyRevenueMax/1000).toFixed(1) + 'K</div></div></div>' +
        '<div class="progress-bar" style="height:12px;"><div class="progress-fill" style="width:' + Math.min(revenuePercentOfMax,100) + '%;background:var(--success);"></div></div>' +
        '<div style="text-align:right;margin-top:8px;font-size:14px;font-weight:700;color:var(--success);">' + revenuePercentOfMax.toFixed(0) + '% of Max</div></div>' +
        
        '<div class="modal-actions"><button class="btn btn-warning" onclick="closeModal();openResetPasswordModal(\'' + member.name + '\')">üîë Reset Password</button><button class="btn btn-secondary" onclick="closeModal()">Close</button></div></div></div>';
    document.getElementById('modalContainer').innerHTML = html;
}

function renderLeadershipAnalytics() {
    var allDeals = state.data.deals;
    var today = new Date();
    var yearStart = new Date(today.getFullYear(), 0, 1);
    
    var yearDeals = allDeals.filter(function(d) { var dt = d.createdTime ? new Date(d.createdTime) : null; return dt && dt >= yearStart; });
    var floorDeals = yearDeals.filter(function(d) { return d.pricingType === 'Floor Price'; });
    var totalFloorUsed = floorDeals.length;

    var html = '<div class="charts-grid">' +
        '<div class="chart-card"><h3>üìà Team Revenue (6 Months)</h3><div class="chart-container"><canvas id="teamRevenueTrendChart"></canvas></div></div>' +
        '<div class="chart-card"><h3>ü•ß Revenue by Tier</h3><div class="chart-container"><canvas id="teamRevenueByTierChart"></canvas></div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üö® Floor-Price Capacity (' + today.getFullYear() + ')</h2></div>' +
        '<div class="floor-tracker"><div class="capacity-circle"><div class="capacity-number">' + totalFloorUsed + '/10</div><div class="capacity-label">used</div></div>' +
        '<p style="color:var(--text-gray);margin-top:16px;">Remaining: <strong>' + (10 - totalFloorUsed) + '</strong> floor-price events</p></div></div>';
    
    document.getElementById('contentArea').innerHTML = html;
    
    setTimeout(function() {
        renderRevenueTrendChart('teamRevenueTrendChart', allDeals, 'Team Revenue');
        renderRevenueByTierChart('teamRevenueByTierChart', allDeals);
    }, 100);
}

function renderTeamOverview() {
    var monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    var html = '<div class="card"><div class="card-header"><h2 class="card-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Team Performance</h2></div><table><thead><tr><th>Name</th><th>Role</th><th>Target</th><th>Revenue</th><th>% of Max</th><th>Wins</th><th>Actions</th></tr></thead><tbody>';
    
    var reps = state.data.teamMembers.filter(function(m) { return m.role !== 'Leadership'; });
    for (var i = 0; i < reps.length; i++) {
        var m = reps[i];
        var memberDeals = state.data.deals.filter(function(d) { return d.owner === m.name; });
        var monthWon = memberDeals.filter(function(d) {
            if (!d.stage.toLowerCase().includes('won')) return false;
            var dt = d.closeDate ? new Date(d.closeDate) : null;
            return dt && dt >= monthStart;
        });
        var revenue = monthWon.reduce(function(sum, d) { return sum + d.value; }, 0);
        var targets = getKPITargets(m.role);
        var attainment = (revenue / targets.monthlyRevenueMax) * 100;
        var badgeClass = attainment >= 100 ? 'badge-success' : attainment >= 70 ? 'badge-warning' : 'badge-danger';
        
        html += '<tr><td><strong>' + m.name + '</strong></td><td>' + m.role + '</td><td>$' + targets.monthlyRevenueMax.toLocaleString() + '</td><td>$' + revenue.toLocaleString() + '</td>' +
            '<td><span class="badge ' + badgeClass + '">' + attainment.toFixed(0) + '%</span></td><td>' + monthWon.length + '</td>' +
            '<td><button class="btn btn-small btn-secondary" onclick="openResetPasswordModal(\'' + m.name + '\')">üîë Reset</button></td></tr>';
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

// Pipeline with drag and drop
function renderPipeline() {
    var allDeals = getUserDeals();
    var stages = ['Qualified', 'Proposal Sent', 'Negotiation', 'Closed Won'];
    var isLeadership = state.currentUser.role === 'Leadership';
    var userActivities = state.data.activities.filter(function(a) { return isLeadership || a.owner === state.currentUser.name; });
    
    var deals = allDeals;
    if (state.filters.pipeline.tier) deals = deals.filter(function(d) { return d.tier === state.filters.pipeline.tier; });
    if (state.filters.pipeline.owner) deals = deals.filter(function(d) { return d.owner === state.filters.pipeline.owner; });
    
    var owners = [];
    for (var i = 0; i < allDeals.length; i++) {
        if (allDeals[i].owner && owners.indexOf(allDeals[i].owner) === -1) owners.push(allDeals[i].owner);
    }
    
    var ownerOptions = '';
    for (var i = 0; i < owners.length; i++) {
        ownerOptions += '<option value="' + owners[i] + '"' + (state.filters.pipeline.owner === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    }
    
    var html = '<div class="quick-actions" style="margin-bottom:16px;"><button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï Add New Deal</button></div>' +
        '<div class="filters-bar"><span style="font-weight:600;font-size:14px;">Filters:</span>' +
        '<select class="filter-select" onchange="state.filters.pipeline.tier=this.value;renderPipeline();">' +
        '<option value="">All Tiers</option>' +
        '<option value="Starter"' + (state.filters.pipeline.tier === 'Starter' ? ' selected' : '') + '>Starter</option>' +
        '<option value="Growth"' + (state.filters.pipeline.tier === 'Growth' ? ' selected' : '') + '>Growth</option>' +
        '<option value="Pro"' + (state.filters.pipeline.tier === 'Pro' ? ' selected' : '') + '>Pro</option>' +
        '<option value="Enterprise"' + (state.filters.pipeline.tier === 'Enterprise' ? ' selected' : '') + '>Enterprise</option></select>';
    
    if (isLeadership) {
        html += '<select class="filter-select" onchange="state.filters.pipeline.owner=this.value;renderPipeline();"><option value="">All Owners</option>' + ownerOptions + '</select>';
    }
    
    if (state.filters.pipeline.tier || state.filters.pipeline.owner) {
        html += '<button class="btn btn-secondary btn-small" onclick="state.filters.pipeline={tier:\'\',owner:\'\'};renderPipeline();">Clear</button>';
    }
    html += '</div><div class="kanban-board">';
    
    for (var s = 0; s < stages.length; s++) {
        var stage = stages[s];
        var stageDeals = deals.filter(function(d) { return d.stage === stage; });
        
        html += '<div class="kanban-column" data-stage="' + stage + '" ondrop="handleDrop(event, \'' + stage + '\')" ondragover="handleDragOver(event)" ondragenter="handleDragEnter(event)" ondragleave="handleDragLeave(event)">' +
            '<div class="kanban-header"><span>' + stage + '</span><span class="kanban-count">' + stageDeals.length + '</span></div>';
        
        if (stageDeals.length === 0) {
            html += '<p style="color:var(--text-gray);text-align:center;padding:24px;font-size:13px;">No deals</p>';
        } else {
            for (var d = 0; d < stageDeals.length; d++) {
                var deal = stageDeals[d];
                var lastActivity = userActivities.filter(function(a) { return a.account && deal.name.toLowerCase().includes(a.account.toLowerCase()); }).sort(function(x,y) { return new Date(y.date) - new Date(x.date); })[0];
                var daysSinceActivity = lastActivity ? getDaysSince(lastActivity.date) : 999;
                var isStale = daysSinceActivity >= 5 && !stage.toLowerCase().includes('won');
                var dealAge = getDaysSince(deal.createdTime);
                var currentWeek = Math.min(Math.ceil(dealAge / 7) || 1, 9);
                
                html += '<div class="kanban-card' + (isStale ? ' stale' : '') + '" draggable="true" ondragstart="handleDragStart(event, \'' + deal.id + '\')" ondragend="handleDragEnd(event)" onclick="openDealDetailsModal(\'' + deal.id + '\')" data-deal-id="' + deal.id + '">' +
                    '<div style="display:flex;justify-content:space-between;"><div class="kanban-card-title">' + deal.name + '</div>';
                if (isLeadership) {
                    html += '<button class="btn btn-icon btn-danger" onclick="event.stopPropagation();deleteDeal(\'' + deal.id + '\')" style="padding:3px 6px;font-size:11px;">üóëÔ∏è</button>';
                }
                html += '</div><div class="kanban-card-value">$' + deal.value.toLocaleString() + '</div>' +
                    '<div style="display:flex;gap:6px;align-items:center;"><span class="badge badge-' + deal.tier.toLowerCase() + '">' + deal.tier + '</span><span class="badge badge-info">Week ' + currentWeek + '</span></div>' +
                    '<div class="kanban-card-meta">Owner: ' + deal.owner + '</div>';
                if (isStale) {
                    html += '<div class="stale-indicator">‚ö†Ô∏è ' + daysSinceActivity + '+ days idle</div>';
                }
                html += '</div>';
            }
        }
        html += '</div>';
    }
    html += '</div>';
    
    document.getElementById('contentArea').innerHTML = html;
}

var draggedDealId = null;

function handleDragStart(event, dealId) {
    draggedDealId = dealId;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    var columns = document.querySelectorAll('.kanban-column');
    for (var i = 0; i < columns.length; i++) {
        columns[i].classList.remove('drag-over');
    }
}

function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(event) {
    event.preventDefault();
    var column = event.target.closest('.kanban-column');
    if (column) column.classList.add('drag-over');
}

function handleDragLeave(event) {
    var column = event.target.closest('.kanban-column');
    if (column && !column.contains(event.relatedTarget)) {
        column.classList.remove('drag-over');
    }
}

function handleDrop(event, newStage) {
    event.preventDefault();
    var column = event.target.closest('.kanban-column');
    if (column) column.classList.remove('drag-over');
    
    if (draggedDealId && newStage) {
        updateDealStage(draggedDealId, newStage);
    }
    draggedDealId = null;
}

// Contacts
function renderContacts() {
    var contacts = state.data.contacts;
    var isLeadership = state.currentUser.role === 'Leadership';
    
    if (state.filters.contacts.search) {
        var q = state.filters.contacts.search.toLowerCase();
        contacts = contacts.filter(function(c) { return c.name.toLowerCase().includes(q) || (c.email && c.email.toLowerCase().includes(q)) || (c.company && c.company.toLowerCase().includes(q)); });
    }
    if (state.filters.contacts.owner) {
        contacts = contacts.filter(function(c) { return c.owner === state.filters.contacts.owner; });
    }
    
    var owners = [];
    for (var i = 0; i < state.data.contacts.length; i++) {
        if (state.data.contacts[i].owner && owners.indexOf(state.data.contacts[i].owner) === -1) owners.push(state.data.contacts[i].owner);
    }
    var ownerOptions = '';
    for (var i = 0; i < owners.length; i++) {
        ownerOptions += '<option value="' + owners[i] + '"' + (state.filters.contacts.owner === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    }
    
    var html = '<div class="quick-actions" style="margin-bottom:16px;"><button class="btn btn-primary btn-small" onclick="openAddContactModal()">‚ûï Add New Contact</button></div>' +
        '<div class="filters-bar"><input type="text" class="filter-input" placeholder="Search contacts..." value="' + state.filters.contacts.search + '" oninput="state.filters.contacts.search=this.value;renderContacts();">';
    if (isLeadership) {
        html += '<select class="filter-select" onchange="state.filters.contacts.owner=this.value;renderContacts();"><option value="">All Owners</option>' + ownerOptions + '</select>';
    }
    if (state.filters.contacts.search || state.filters.contacts.owner) {
        html += '<button class="btn btn-secondary btn-small" onclick="state.filters.contacts={search:\'\',owner:\'\'};renderContacts();">Clear</button>';
    }
    html += '</div>' +
        '<div class="card"><div class="card-header"><h2 class="card-title">üë• Contacts</h2><span style="font-size:13px;color:var(--text-gray);">' + contacts.length + ' contacts</span></div>' +
        '<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Company</th><th>Owner</th>' + (isLeadership ? '<th>Actions</th>' : '') + '</tr></thead><tbody>';
    
    if (contacts.length === 0) {
        html += '<tr><td colspan="' + (isLeadership ? 6 : 5) + '" style="text-align:center;padding:40px;color:var(--text-gray);">No contacts found</td></tr>';
    } else {
        for (var i = 0; i < contacts.length; i++) {
            var c = contacts[i];
            html += '<tr class="clickable" onclick="openContactDetailModal(\'' + c.id + '\')">' +
                '<td><strong>' + c.name + '</strong>' + (c.role ? '<br><span style="font-size:12px;color:var(--text-gray);">' + c.role + '</span>' : '') + '</td>' +
                '<td>' + (c.email || '-') + '</td><td>' + (c.phone || '-') + '</td><td>' + (c.company || '-') + '</td><td>' + (c.owner || '-') + '</td>';
            if (isLeadership) {
                html += '<td class="action-buttons" onclick="event.stopPropagation();">' +
                    '<button class="btn btn-icon btn-secondary" onclick="openEditContactModal(\'' + c.id + '\')">‚úèÔ∏è</button>' +
                    '<button class="btn btn-icon btn-danger" onclick="deleteContact(\'' + c.id + '\')">üóëÔ∏è</button></td>';
            }
            html += '</tr>';
        }
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

// Accounts
function renderAccounts() {
    var accounts = state.data.accounts;
    var isLeadership = state.currentUser.role === 'Leadership';
    
    if (state.filters.accounts.search) {
        var q = state.filters.accounts.search.toLowerCase();
        accounts = accounts.filter(function(a) { return a.name.toLowerCase().includes(q); });
    }
    if (state.filters.accounts.industry) {
        accounts = accounts.filter(function(a) { return a.industry === state.filters.accounts.industry; });
    }
    if (state.filters.accounts.owner) {
        accounts = accounts.filter(function(a) { return a.owner === state.filters.accounts.owner; });
    }
    
    var industries = [], owners = [];
    for (var i = 0; i < state.data.accounts.length; i++) {
        if (state.data.accounts[i].industry && industries.indexOf(state.data.accounts[i].industry) === -1) industries.push(state.data.accounts[i].industry);
        if (state.data.accounts[i].owner && owners.indexOf(state.data.accounts[i].owner) === -1) owners.push(state.data.accounts[i].owner);
    }
    var indOptions = '', ownerOptions = '';
    for (var i = 0; i < industries.length; i++) indOptions += '<option value="' + industries[i] + '"' + (state.filters.accounts.industry === industries[i] ? ' selected' : '') + '>' + industries[i] + '</option>';
    for (var i = 0; i < owners.length; i++) ownerOptions += '<option value="' + owners[i] + '"' + (state.filters.accounts.owner === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    
    var html = '<div class="quick-actions" style="margin-bottom:16px;"><button class="btn btn-primary btn-small" onclick="openAddAccountModal()">‚ûï Add New Account</button></div>' +
        '<div class="filters-bar"><input type="text" class="filter-input" placeholder="Search accounts..." value="' + state.filters.accounts.search + '" oninput="state.filters.accounts.search=this.value;renderAccounts();">' +
        '<select class="filter-select" onchange="state.filters.accounts.industry=this.value;renderAccounts();"><option value="">All Industries</option>' + indOptions + '</select>';
    if (isLeadership) {
        html += '<select class="filter-select" onchange="state.filters.accounts.owner=this.value;renderAccounts();"><option value="">All Owners</option>' + ownerOptions + '</select>';
    }
    if (state.filters.accounts.search || state.filters.accounts.industry || state.filters.accounts.owner) {
        html += '<button class="btn btn-secondary btn-small" onclick="state.filters.accounts={search:\'\',industry:\'\',owner:\'\'};renderAccounts();">Clear</button>';
    }
    html += '</div>' +
        '<div class="card"><div class="card-header"><h2 class="card-title">üè¢ Accounts</h2><span style="font-size:13px;color:var(--text-gray);">' + accounts.length + ' accounts</span></div>' +
        '<table><thead><tr><th>Account Name</th><th>Industry</th><th>Contacts</th><th>Deals</th><th>Owner</th>' + (isLeadership ? '<th>Actions</th>' : '') + '</tr></thead><tbody>';
    
    if (accounts.length === 0) {
        html += '<tr><td colspan="' + (isLeadership ? 6 : 5) + '" style="text-align:center;padding:40px;color:var(--text-gray);">No accounts found</td></tr>';
    } else {
        for (var i = 0; i < accounts.length; i++) {
            var a = accounts[i];
            var contactCount = state.data.contacts.filter(function(c) { return c.accountId === a.id || c.company === a.name; }).length;
            var dealCount = state.data.deals.filter(function(d) { return d.name.toLowerCase().includes(a.name.toLowerCase()); }).length;
            html += '<tr class="clickable" onclick="openAccountDetailModal(\'' + a.id + '\')">' +
                '<td><strong>' + a.name + '</strong></td>' +
                '<td>' + (a.industry ? '<span class="badge badge-info">' + a.industry + '</span>' : '-') + '</td>' +
                '<td>' + contactCount + '</td><td>' + dealCount + '</td><td>' + (a.owner || '-') + '</td>';
            if (isLeadership) {
                html += '<td class="action-buttons" onclick="event.stopPropagation();">' +
                    '<button class="btn btn-icon btn-secondary" onclick="openEditAccountModal(\'' + a.id + '\')">‚úèÔ∏è</button>' +
                    '<button class="btn btn-icon btn-danger" onclick="deleteAccount(\'' + a.id + '\')">üóëÔ∏è</button></td>';
            }
            html += '</tr>';
        }
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

// Activity View
function renderActivityView() {
    var activities = state.data.activities;
    var isLeadership = state.currentUser.role === 'Leadership';
    
    if (!isLeadership) {
        activities = activities.filter(function(a) { return a.owner === state.currentUser.name; });
    } else if (state.filterRep) {
        activities = activities.filter(function(a) { return a.owner === state.filterRep; });
    }
    
    activities = activities.sort(function(a, b) { return new Date(b.date || b.createdTime) - new Date(a.date || a.createdTime); }).slice(0, 50);
    
    var owners = [];
    for (var i = 0; i < state.data.activities.length; i++) {
        if (state.data.activities[i].owner && owners.indexOf(state.data.activities[i].owner) === -1) owners.push(state.data.activities[i].owner);
    }
    var ownerOptions = '';
    for (var i = 0; i < owners.length; i++) {
        ownerOptions += '<option value="' + owners[i] + '"' + (state.filterRep === owners[i] ? ' selected' : '') + '>' + owners[i] + '</option>';
    }
    
    var html = '<div class="quick-actions" style="margin-bottom:16px;"><button class="btn btn-primary btn-small" onclick="openLogActivityModal()">üìù Log Activity</button></div>';
    
    if (isLeadership) {
        html += '<div class="filters-bar"><span style="font-weight:600;font-size:14px;">Filter by Rep:</span>' +
            '<select class="filter-select" onchange="state.filterRep=this.value||null;renderActivityView();"><option value="">All Reps</option>' + ownerOptions + '</select>';
        if (state.filterRep) {
            html += '<button class="btn btn-secondary btn-small" onclick="state.filterRep=null;renderActivityView();">Clear Filter</button>';
        }
        html += '</div>';
    }
    
    html += '<div class="card"><div class="card-header"><h2 class="card-title">üìù Activities</h2><span style="font-size:13px;color:var(--text-gray);">' + activities.length + ' activities</span></div>' +
        '<table><thead><tr><th>Type</th><th>Account</th><th>Result</th><th>Date</th><th>Owner</th>' + (isLeadership ? '<th>Actions</th>' : '') + '</tr></thead><tbody>';
    
    if (activities.length === 0) {
        html += '<tr><td colspan="' + (isLeadership ? 6 : 5) + '" style="text-align:center;padding:40px;color:var(--text-gray);">No activities found</td></tr>';
    } else {
        for (var i = 0; i < activities.length; i++) {
            var a = activities[i];
            var typeIcon = 'üìù';
            var t = (a.type || '').toLowerCase();
            if (t.includes('call')) typeIcon = 'üìû';
            else if (t.includes('email')) typeIcon = 'üìß';
            else if (t.includes('linkedin')) typeIcon = 'üíº';
            else if (t.includes('demo')) typeIcon = 'üé•';
            else if (t.includes('proposal')) typeIcon = 'üìÑ';
            else if (t.includes('meeting')) typeIcon = 'üìÖ';
            
            html += '<tr><td>' + typeIcon + ' ' + (a.type || '-') + '</td><td>' + (a.account || '-') + '</td><td style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (a.result || '-') + '</td><td>' + formatDateShort(a.date) + '</td><td>' + (a.owner || '-') + '</td>';
            if (isLeadership) {
                html += '<td><button class="btn btn-icon btn-danger" onclick="deleteActivity(\'' + a.id + '\')">üóëÔ∏è</button></td>';
            }
            html += '</tr>';
        }
    }
    html += '</tbody></table></div>';
    document.getElementById('contentArea').innerHTML = html;
}

// Events View
function renderEvents() {
    var allDeals = state.data.deals;
    var wonDeals = allDeals.filter(function(d) { return d.stage.toLowerCase().includes('won'); });
    
    var today = new Date();
    var thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
    var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    var monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    var upcomingDeals = wonDeals.filter(function(d) {
        var closeDate = d.closeDate ? new Date(d.closeDate) : null;
        return closeDate && closeDate >= today && closeDate <= thirtyDaysFromNow;
    });
    
    var monthDeals = wonDeals.filter(function(d) {
        var closeDate = d.closeDate ? new Date(d.closeDate) : null;
        return closeDate && closeDate >= monthStart && closeDate <= monthEnd;
    });
    
    var html = '<div class="kpi-grid">' +
        '<div class="kpi-card"><div class="kpi-value" style="color:var(--primary);">' + upcomingDeals.length + '</div><div class="kpi-label">üìÖ Upcoming (30 days)</div></div>' +
        '<div class="kpi-card"><div class="kpi-value" style="color:var(--success);">' + monthDeals.length + '</div><div class="kpi-label">üìÜ This Month</div></div>' +
        '<div class="kpi-card"><div class="kpi-value" style="color:var(--warning);">' + wonDeals.length + '</div><div class="kpi-label">üéâ Total Events Won</div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìÖ Upcoming Events (30 Days)</h2></div>';
    
    if (upcomingDeals.length === 0) {
        html += '<p style="color:var(--text-gray);text-align:center;padding:30px;">No upcoming events</p>';
    } else {
        html += '<table><thead><tr><th>Event</th><th>Deal</th><th>Tier</th><th>Value</th><th>Date</th><th>Owner</th></tr></thead><tbody>';
        for (var i = 0; i < upcomingDeals.length; i++) {
            var d = upcomingDeals[i];
            html += '<tr class="clickable" onclick="openDealDetailsModal(\'' + d.id + '\')">' +
                '<td>' + (d.eventName || d.name) + '</td><td>' + d.name + '</td>' +
                '<td><span class="badge badge-' + d.tier.toLowerCase() + '">' + d.tier + '</span></td>' +
                '<td>$' + d.value.toLocaleString() + '</td><td>' + formatDateShort(d.closeDate) + '</td><td>' + d.owner + '</td></tr>';
        }
        html += '</tbody></table>';
    }
    html += '</div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üèÜ All Won Events</h2></div>';
    
    if (wonDeals.length === 0) {
        html += '<p style="color:var(--text-gray);text-align:center;padding:30px;">No events won yet</p>';
    } else {
        html += '<table><thead><tr><th>Event</th><th>Deal</th><th>Tier</th><th>Value</th><th>Close Date</th><th>Owner</th></tr></thead><tbody>';
        var sortedWon = wonDeals.sort(function(a, b) { return new Date(b.closeDate || b.createdTime) - new Date(a.closeDate || a.createdTime); });
        for (var i = 0; i < Math.min(sortedWon.length, 20); i++) {
            var d = sortedWon[i];
            html += '<tr class="clickable" onclick="openDealDetailsModal(\'' + d.id + '\')">' +
                '<td>' + (d.eventName || d.name) + '</td><td>' + d.name + '</td>' +
                '<td><span class="badge badge-' + d.tier.toLowerCase() + '">' + d.tier + '</span></td>' +
                '<td>$' + d.value.toLocaleString() + '</td><td>' + formatDateShort(d.closeDate) + '</td><td>' + d.owner + '</td></tr>';
        }
        html += '</tbody></table>';
    }
    html += '</div>';
    
    document.getElementById('contentArea').innerHTML = html;
}

// Reports View
function renderReports() {
    var allDeals = state.data.deals;
    var allActivities = state.data.activities;
    var wonDeals = allDeals.filter(function(d) { return d.stage.toLowerCase().includes('won'); });
    var lostDeals = allDeals.filter(function(d) { return d.stage.toLowerCase().includes('lost'); });
    
    var totalRevenue = wonDeals.reduce(function(sum, d) { return sum + d.value; }, 0);
    var winRate = wonDeals.length + lostDeals.length > 0 ? (wonDeals.length / (wonDeals.length + lostDeals.length) * 100) : 0;
    
    var pipelineDeals = allDeals.filter(function(d) { return !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost'); });
    var avgDaysInPipeline = pipelineDeals.length > 0 ? pipelineDeals.reduce(function(sum, d) { return sum + (getDaysSince(d.createdTime) || 0); }, 0) / pipelineDeals.length : 0;
    
    // Revenue by tier
    var revenueByTier = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    var dealsByTier = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    for (var i = 0; i < wonDeals.length; i++) {
        if (revenueByTier.hasOwnProperty(wonDeals[i].tier)) {
            revenueByTier[wonDeals[i].tier] += wonDeals[i].value;
            dealsByTier[wonDeals[i].tier]++;
        }
    }
    
    // Revenue by rep
    var revenueByRep = {}, activityByRep = {};
    for (var i = 0; i < wonDeals.length; i++) {
        revenueByRep[wonDeals[i].owner] = (revenueByRep[wonDeals[i].owner] || 0) + wonDeals[i].value;
    }
    for (var i = 0; i < allActivities.length; i++) {
        activityByRep[allActivities[i].owner] = (activityByRep[allActivities[i].owner] || 0) + 1;
    }
    
    // Leaderboard
    var repLeaderboard = Object.entries(revenueByRep).sort(function(a, b) { return b[1] - a[1]; });
    
    // Activity by type
    var activityByType = {};
    for (var i = 0; i < allActivities.length; i++) {
        var type = allActivities[i].type || 'Other';
        activityByType[type] = (activityByType[type] || 0) + 1;
    }
    
    // Conversion by stage
    var stageNames = ['Qualified', 'Proposal Sent', 'Negotiation', 'Closed Won', 'Closed Lost'];
    
    var html = '<div class="kpi-grid">' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;"><div style="font-size:11px;font-weight:600;opacity:0.9;">üí∞ TOTAL REVENUE</div><div style="font-size:36px;font-weight:800;margin-top:8px;">$' + (totalRevenue/1000).toFixed(1) + 'K</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);color:white;"><div style="font-size:11px;font-weight:600;opacity:0.9;">‚úÖ WIN RATE</div><div style="font-size:36px;font-weight:800;margin-top:8px;">' + winRate.toFixed(0) + '%</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:white;"><div style="font-size:11px;font-weight:600;opacity:0.9;">‚è±Ô∏è AVG CYCLE</div><div style="font-size:36px;font-weight:800;margin-top:8px;">' + avgDaysInPipeline.toFixed(0) + '</div><div style="font-size:12px;opacity:0.9;">days</div></div>' +
        '<div class="kpi-card" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;"><div style="font-size:11px;font-weight:600;opacity:0.9;">‚ùå LOST</div><div style="font-size:36px;font-weight:800;margin-top:8px;">' + lostDeals.length + '</div></div></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üèÜ Rep Leaderboard</h2></div>';
    
    if (repLeaderboard.length === 0) {
        html += '<p style="text-align:center;color:var(--text-gray);padding:20px;">No data yet</p>';
    } else {
        for (var i = 0; i < repLeaderboard.length; i++) {
            var rep = repLeaderboard[i];
            html += '<div class="leaderboard-item"><div class="leaderboard-rank">#' + (i + 1) + '</div>' +
                '<div class="leaderboard-info"><div class="leaderboard-name">' + rep[0] + '</div>' +
                '<div class="leaderboard-stats">' + (activityByRep[rep[0]] || 0) + ' activities</div></div>' +
                '<div class="leaderboard-value">$' + (rep[1]/1000).toFixed(1) + 'K</div></div>';
        }
    }
    html += '</div>' +
        
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;">' +
        '<div class="card"><div class="card-header"><h2 class="card-title">üí∞ Revenue by Tier</h2></div>' +
        '<table><thead><tr><th>Tier</th><th>Revenue</th><th>Deals</th></tr></thead><tbody>';
    
    var tiers = ['Starter', 'Growth', 'Pro', 'Enterprise'];
    for (var i = 0; i < tiers.length; i++) {
        var tier = tiers[i];
        html += '<tr><td><span class="badge badge-' + tier.toLowerCase() + '">' + tier + '</span></td>' +
            '<td>$' + revenueByTier[tier].toLocaleString() + '</td><td>' + dealsByTier[tier] + '</td></tr>';
    }
    html += '</tbody></table></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìä Activity Breakdown</h2></div>' +
        '<table><thead><tr><th>Type</th><th>Count</th></tr></thead><tbody>';
    
    var actTypes = Object.entries(activityByType).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 8);
    for (var i = 0; i < actTypes.length; i++) {
        html += '<tr><td>' + actTypes[i][0] + '</td><td>' + actTypes[i][1] + '</td></tr>';
    }
    html += '</tbody></table></div>' +
        
        '<div class="card"><div class="card-header"><h2 class="card-title">üìà Conversion by Stage</h2></div>' +
        '<table><thead><tr><th>Stage</th><th>Count</th><th>Value</th></tr></thead><tbody>';
    
    for (var i = 0; i < stageNames.length; i++) {
        var stage = stageNames[i];
        var stageDeals = allDeals.filter(function(d) { return d.stage === stage; });
        var stageValue = stageDeals.reduce(function(sum, d) { return sum + d.value; }, 0);
        html += '<tr><td>' + stage + '</td><td>' + stageDeals.length + '</td><td>$' + stageValue.toLocaleString() + '</td></tr>';
    }
    html += '</tbody></table></div></div>';
    
    document.getElementById('contentArea').innerHTML = html;
}

// Initialize
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
