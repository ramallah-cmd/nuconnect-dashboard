<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuConnect CRM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-card {
            background: white;
            border-radius: 16px;
            padding: 48px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 440px;
            width: 100%;
        }
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        .login-logo h1 {
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .login-logo p {
            color: #6b7280;
            font-size: 14px;
        }
        .form-group {
            margin-bottom: 24px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            color: #111827;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Main App */
        .app-container {
            display: none;
            min-height: 100vh;
            background: #f9fafb;
        }
        .app-container.active {
            display: block;
        }
        
        /* Header */
        .app-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-logo {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .app-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        .user-role {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .btn-logout {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-logout:hover {
            background: #dc2626;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 0 24px;
            display: flex;
            gap: 8px;
        }
        .nav-tab {
            padding: 12px 20px;
            border: none;
            background: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .nav-tab:hover {
            color: #667eea;
        }
        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        /* Content Area */
        .content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .kpi-title {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }
        .kpi-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 12px;
        }
        .kpi-progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }
        .kpi-progress-bar {
            height: 100%;
            border-radius: 999px;
            transition: width 0.3s;
        }
        
        /* Section Cards */
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
        }
        .btn-secondary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* Deal Cards */
        .deals-grid {
            display: grid;
            gap: 16px;
        }
        .deal-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .deal-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }
        .deal-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 4px;
        }
        .deal-account {
            font-size: 14px;
            color: #6b7280;
        }
        .deal-value {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }
        .deal-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-tier-starter { background: #dbeafe; color: #1e40af; }
        .badge-tier-growth { background: #d1fae5; color: #065f46; }
        .badge-tier-pro { background: #fef3c7; color: #92400e; }
        .badge-tier-enterprise { background: #e9d5ff; color: #6b21a8; }
        .badge-stage { background: #f3f4f6; color: #374151; }
        .badge-floor { background: #fef3c7; color: #92400e; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-close:hover {
            color: #6b7280;
        }
        
        /* Form Styles */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            color: #111827;
            transition: all 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #6b7280;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 48px;
            color: #6b7280;
        }
        .spinner {
            border: 3px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Alert */
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .alert-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        .alert-info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <h1>NuConnect CRM</h1>
                <p>Event Organizer Sales Platform</p>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Your Name</label>
                <select id="userSelect" class="form-select">
                    <option value="">Choose your name...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Airtable Base ID</label>
                <input type="text" id="baseIdInput" class="form-input" placeholder="app..." 
                       value="app0WnWepz3soa88I">
            </div>
            
            <div class="form-group">
                <label class="form-label">Airtable API Token</label>
                <input type="password" id="apiTokenInput" class="form-input" placeholder="pat...">
            </div>
            
            <button id="loginBtn" class="btn btn-primary" disabled>Login to CRM</button>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="app-logo">NuConnect CRM</div>
            <div class="app-user">
                <div>
                    <div class="user-name" id="currentUserName"></div>
                    <div class="user-role" id="currentUserRole"></div>
                </div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('pipeline')">Pipeline</button>
            <button class="nav-tab" onclick="switchTab('activities')">Activities</button>
            <button class="nav-tab leadership-only hidden" onclick="switchTab('approvals')">Approvals</button>
            <button class="nav-tab leadership-only hidden" onclick="switchTab('team')">Team View</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Revenue (MTD)</span>
                            <div class="kpi-icon" style="background: #dbeafe; color: #1e40af;">üí∞</div>
                        </div>
                        <div class="kpi-value" id="kpiRevenue">$0</div>
                        <div class="kpi-subtitle" id="kpiRevenueGoal">Goal: $45K</div>
                        <div class="kpi-progress">
                            <div class="kpi-progress-bar" id="kpiRevenueBar" style="width: 0%; background: #3b82f6;"></div>
                        </div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Events Closed</span>
                            <div class="kpi-icon" style="background: #d1fae5; color: #065f46;">üìÖ</div>
                        </div>
                        <div class="kpi-value" id="kpiEvents">0</div>
                        <div class="kpi-subtitle">This month</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Pipeline Value</span>
                            <div class="kpi-icon" style="background: #fef3c7; color: #92400e;">üìä</div>
                        </div>
                        <div class="kpi-value" id="kpiPipeline">$0</div>
                        <div class="kpi-subtitle">Weighted value</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Active Deals</span>
                            <div class="kpi-icon" style="background: #e9d5ff; color: #6b21a8;">üéØ</div>
                        </div>
                        <div class="kpi-value" id="kpiActive">0</div>
                        <div class="kpi-subtitle">In progress</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Recent Wins üéâ</h2>
                    </div>
                    <div id="recentWins" class="deals-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading deals...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pipeline Tab -->
            <div id="pipelineTab" class="tab-content">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">My Pipeline</h2>
                        <button class="btn-secondary" onclick="openAddDealModal()">+ Add Deal</button>
                    </div>
                    <div id="pipelineDeals" class="deals-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading pipeline...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activities Tab -->
            <div id="activitiesTab" class="tab-content">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Recent Activities</h2>
                        <button class="btn-secondary" onclick="openAddActivityModal()">+ Log Activity</button>
                    </div>
                    <div id="activitiesList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìù</div>
                            <div class="empty-state-title">No activities yet</div>
                            <p>Start logging your calls, emails, and meetings</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Approvals Tab (Leadership Only) -->
            <div id="approvalsTab" class="tab-content">
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Floor Price Approvals</h2>
                    </div>
                    <div id="approvalsList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading approvals...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team View Tab (Leadership Only) -->
            <div id="teamTab" class="tab-content">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Total Revenue (YTD)</span>
                            <div class="kpi-icon" style="background: #dbeafe; color: #1e40af;">üí∞</div>
                        </div>
                        <div class="kpi-value" id="teamRevenue">$0</div>
                        <div class="kpi-subtitle">Goal: $335K-$340K</div>
                    </div>

                    <div class="kpi-card">
                        <div class="kpi-header">
                            <span class="kpi-title">Floor Events Used</span>
                            <div class="kpi-icon" style="background: #fef3c7; color: #92400e;">‚ö°</div>
                        </div>
                        <div class="kpi-value" id="floorUsed">0/10</div>
                        <div class="kpi-subtitle">Company-wide limit</div>
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Team Performance</h2>
                    <div id="teamPerformance"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Deal Modal -->
    <div id="addDealModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Deal</h2>
                <button class="btn-close" onclick="closeModal('addDealModal')">√ó</button>
            </div>

            <div id="floorPriceWarning" class="alert alert-warning hidden">
                ‚ö†Ô∏è <strong>Floor pricing requires leadership approval.</strong> This deal will be marked as "Pending Approval" until reviewed.
            </div>

            <div class="form-group">
                <label class="form-label">Account Name *</label>
                <input type="text" id="dealAccountName" class="form-input" required>
            </div>

            <div class="form-group">
                <label class="form-label">Event Name *</label>
                <input type="text" id="dealEventName" class="form-input" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Event Date</label>
                    <input type="date" id="dealEventDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Expected Attendees</label>
                    <input type="number" id="dealAttendees" class="form-input">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Event Location</label>
                <input type="text" id="dealLocation" class="form-input">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tier *</label>
                    <select id="dealTier" class="form-select" required onchange="updateDealValue()">
                        <option value="">Select tier...</option>
                        <option value="Starter">Starter ($750)</option>
                        <option value="Growth">Growth ($1,250)</option>
                        <option value="Pro">Pro ($2,000)</option>
                        <option value="Enterprise">Enterprise ($4,200)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Pricing Type *</label>
                    <select id="dealPricingType" class="form-select" required onchange="updateDealValue()">
                        <option value="Public Price">Public Price</option>
                        <option value="Floor Price">Floor Price (Needs Approval)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Deal Stage *</label>
                <select id="dealStage" class="form-select" required>
                    <option value="Not Started">Not Started</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea id="dealNotes" class="form-input form-textarea"></textarea>
            </div>

            <div class="alert alert-info">
                <strong>Estimated Deal Value:</strong> <span id="estimatedValue">$0</span>
            </div>

            <button class="btn btn-primary" onclick="createDeal()">Create Deal</button>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let airtableConfig = {
            baseId: '',
            apiToken: ''
        };
        let teamMembers = [];
        let deals = [];
        let activities = [];
        let pricingRules = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredCredentials();
            setupLoginForm();
        });

        function loadStoredCredentials() {
            const stored = localStorage.getItem('airtable_config');
            if (stored) {
                airtableConfig = JSON.parse(stored);
                document.getElementById('baseIdInput').value = airtableConfig.baseId;
                document.getElementById('apiTokenInput').value = airtableConfig.apiToken;
            }
        }

        function setupLoginForm() {
            const userSelect = document.getElementById('userSelect');
            const loginBtn = document.getElementById('loginBtn');

            userSelect.addEventListener('change', function() {
                loginBtn.disabled = !this.value;
            });

            document.getElementById('baseIdInput').addEventListener('input', updateLoginButton);
            document.getElementById('apiTokenInput').addEventListener('input', updateLoginButton);
        }

        function updateLoginButton() {
            const baseId = document.getElementById('baseIdInput').value;
            const apiToken = document.getElementById('apiTokenInput').value;
            const userName = document.getElementById('userSelect').value;
            
            document.getElementById('loginBtn').disabled = !baseId || !apiToken || !userName;
        }

        async function login() {
            const baseId = document.getElementById('baseIdInput').value;
            const apiToken = document.getElementById('apiTokenInput').value;
            const userName = document.getElementById('userSelect').value;

            if (!baseId || !apiToken || !userName) {
                alert('Please fill in all fields');
                return;
            }

            // Save config
            airtableConfig = { baseId, apiToken };
            localStorage.setItem('airtable_config', JSON.stringify(airtableConfig));

            // Find user
            currentUser = teamMembers.find(m => m.name === userName);

            // Show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').classList.add('active');
            
            // Update header
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role;

            // Show/hide leadership tabs
            if (currentUser.role === 'Leadership') {
                document.querySelectorAll('.leadership-only').forEach(el => el.classList.remove('hidden'));
            }

            // Load data
            await loadAllData();
        }

        function logout() {
            currentUser = null;
            document.getElementById('appScreen').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            switchTab('dashboard');
        }

        async function loadTeamMembers() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${airtableConfig.baseId}/Team%20Members`,
                    {
                        headers: {
                            'Authorization': `Bearer ${airtableConfig.apiToken}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load team members');

                const data = await response.json();
                teamMembers = data.records.map(r => ({
                    id: r.id,
                    name: r.fields.Name,
                    role: r.fields.Role,
                    email: r.fields.Email,
                    quota: r.fields['Monthly Quota']
                }));

                // Populate dropdown
                const select = document.getElementById('userSelect');
                select.innerHTML = '<option value="">Choose your name...</option>';
                teamMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = `${member.name} (${member.role})`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading team:', error);
                alert('Error loading team members. Please check your credentials.');
            }
        }

        // Load team members when credentials are entered
        document.getElementById('apiTokenInput').addEventListener('blur', async function() {
            if (this.value && document.getElementById('baseIdInput').value) {
                await loadTeamMembers();
            }
        });

        document.getElementById('loginBtn').addEventListener('click', login);

        async function loadAllData() {
            await Promise.all([
                loadDeals(),
                loadActivities(),
                loadPricingRules()
            ]);
            updateDashboard();
            updatePipeline();
        }

        async function loadDeals() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${airtableConfig.baseId}/Deals`,
                    {
                        headers: {
                            'Authorization': `Bearer ${airtableConfig.apiToken}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load deals');

                const data = await response.json();
                deals = data.records.map(r => ({
                    id: r.id,
                    ...r.fields
                }));

            } catch (error) {
                console.error('Error loading deals:', error);
            }
        }

        async function loadActivities() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${airtableConfig.baseId}/Activities`,
                    {
                        headers: {
                            'Authorization': `Bearer ${airtableConfig.apiToken}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load activities');

                const data = await response.json();
                activities = data.records.map(r => ({
                    id: r.id,
                    ...r.fields
                }));

            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        async function loadPricingRules() {
            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${airtableConfig.baseId}/Pricing%20Rules`,
                    {
                        headers: {
                            'Authorization': `Bearer ${airtableConfig.apiToken}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load pricing');

                const data = await response.json();
                pricingRules = data.records.map(r => ({
                    id: r.id,
                    ...r.fields
                }));

            } catch (error) {
                console.error('Error loading pricing:', error);
            }
        }

        function updateDashboard() {
            const myDeals = deals.filter(d => 
                d.Owner && d.Owner.includes(currentUser.name)
            );

            const closedWon = myDeals.filter(d => d['Deal Stage'] === 'Closed Won');
            const thisMonth = new Date().getMonth();
            const closedThisMonth = closedWon.filter(d => {
                if (!d['Created Time']) return false;
                return new Date(d['Created Time']).getMonth() === thisMonth;
            });

            const revenue = closedThisMonth.reduce((sum, d) => sum + (d['Deal Value'] || 0), 0);
            const quota = currentUser.quota || 45000;
            const quotaPct = (revenue / quota) * 100;

            const pipeline = myDeals.filter(d => 
                d['Deal Stage'] !== 'Closed Won' && d['Deal Stage'] !== 'Lost'
            );
            const pipelineValue = pipeline.reduce((sum, d) => sum + (d['Weighted Pipeline Value'] || 0), 0);

            // Update KPIs
            document.getElementById('kpiRevenue').textContent = `$${(revenue / 1000).toFixed(1)}K`;
            document.getElementById('kpiRevenueGoal').textContent = `Goal: $${(quota / 1000).toFixed(0)}K`;
            document.getElementById('kpiRevenueBar').style.width = `${Math.min(quotaPct, 100)}%`;
            
            document.getElementById('kpiEvents').textContent = closedThisMonth.length;
            document.getElementById('kpiPipeline').textContent = `$${(pipelineValue / 1000).toFixed(1)}K`;
            document.getElementById('kpiActive').textContent = pipeline.length;

            // Recent wins
            const wins = closedWon.slice(0, 5);
            const winsHtml = wins.length > 0 ? wins.map(deal => `
                <div class="deal-card" onclick="viewDeal('${deal.id}')">
                    <div class="deal-header">
                        <div>
                            <div class="deal-name">${deal['Account Name'] || 'Untitled'}</div>
                            <div class="deal-account">${deal['Event Name'] || ''}</div>
                        </div>
                        <div class="deal-value">$${(deal['Deal Value'] || 0).toLocaleString()}</div>
                    </div>
                    <div class="deal-meta">
                        <span class="badge badge-tier-${(deal.Tier || 'starter').toLowerCase()}">${deal.Tier || 'Starter'}</span>
                        <span class="badge badge-stage">Closed Won</span>
                    </div>
                </div>
            `).join('') : `
                <div class="empty-state">
                    <div class="empty-state-icon">üéØ</div>
                    <div class="empty-state-title">No wins yet</div>
                    <p>Close your first deal to see it here!</p>
                </div>
            `;

            document.getElementById('recentWins').innerHTML = winsHtml;
        }

        function updatePipeline() {
            const myDeals = deals.filter(d => 
                d.Owner && d.Owner.includes(currentUser.name) &&
                d['Deal Stage'] !== 'Closed Won' && d['Deal Stage'] !== 'Lost'
            );

            const html = myDeals.length > 0 ? myDeals.map(deal => `
                <div class="deal-card" onclick="viewDeal('${deal.id}')">
                    <div class="deal-header">
                        <div>
                            <div class="deal-name">${deal['Account Name'] || 'Untitled'}</div>
                            <div class="deal-account">${deal['Event Name'] || ''}</div>
                        </div>
                        <div class="deal-value">$${(deal['Deal Value'] || 0).toLocaleString()}</div>
                    </div>
                    <div class="deal-meta">
                        <span class="badge badge-tier-${(deal.Tier || 'starter').toLowerCase()}">${deal.Tier || 'Starter'}</span>
                        <span class="badge badge-stage">${deal['Deal Stage'] || 'Not Started'}</span>
                        ${deal['Pricing Type'] === 'Floor Price' ? '<span class="badge badge-floor">Floor Price</span>' : ''}
                    </div>
                </div>
            `).join('') : `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-title">No active deals</div>
                    <p>Click "Add Deal" to create your first opportunity</p>
                </div>
            `;

            document.getElementById('pipelineDeals').innerHTML = html;
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        function openAddDealModal() {
            document.getElementById('addDealModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function updateDealValue() {
            const tier = document.getElementById('dealTier').value;
            const pricingType = document.getElementById('dealPricingType').value;
            const warning = document.getElementById('floorPriceWarning');

            if (pricingType === 'Floor Price') {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }

            if (!tier) {
                document.getElementById('estimatedValue').textContent = '$0';
                return;
            }

            const prices = {
                'Starter': { public: 750, floor: 500 },
                'Growth': { public: 1250, floor: 800 },
                'Pro': { public: 2000, floor: 1500 },
                'Enterprise': { public: 4200, floor: 3000 }
            };

            const value = pricingType === 'Floor Price' ? prices[tier].floor : prices[tier].public;
            document.getElementById('estimatedValue').textContent = `$${value.toLocaleString()}`;
        }

        async function createDeal() {
            const dealData = {
                'Account Name': document.getElementById('dealAccountName').value,
                'Event Name': document.getElementById('dealEventName').value,
                'Event Date': document.getElementById('dealEventDate').value,
                'Expected Attendee Count': parseInt(document.getElementById('dealAttendees').value) || 0,
                'Event Location': document.getElementById('dealLocation').value,
                'Tier': document.getElementById('dealTier').value,
                'Pricing Type': document.getElementById('dealPricingType').value,
                'Deal Stage': document.getElementById('dealStage').value,
                'Notes': document.getElementById('dealNotes').value,
                'Owner': [currentUser.name],
                'Pipeline Status': 'Lead',
                'Floor Price Approval Status': document.getElementById('dealPricingType').value === 'Floor Price' ? 'Pending' : 'N/A'
            };

            try {
                const response = await fetch(
                    `https://api.airtable.com/v0/${airtableConfig.baseId}/Deals`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${airtableConfig.apiToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fields: dealData })
                    }
                );

                if (!response.ok) throw new Error('Failed to create deal');

                alert('Deal created successfully!');
                closeModal('addDealModal');
                await loadAllData();

                // Clear form
                document.getElementById('dealAccountName').value = '';
                document.getElementById('dealEventName').value = '';
                document.getElementById('dealEventDate').value = '';
                document.getElementById('dealAttendees').value = '';
                document.getElementById('dealLocation').value = '';
                document.getElementById('dealTier').value = '';
                document.getElementById('dealPricingType').value = 'Public Price';
                document.getElementById('dealStage').value = 'Not Started';
                document.getElementById('dealNotes').value = '';

            } catch (error) {
                console.error('Error creating deal:', error);
                alert('Error creating deal. Please try again.');
            }
        }

        function viewDeal(dealId) {
            const deal = deals.find(d => d.id === dealId);
            if (deal) {
                alert(`Deal: ${deal['Account Name']} - ${deal['Event Name']}\nValue: $${(deal['Deal Value'] || 0).toLocaleString()}\nStage: ${deal['Deal Stage']}`);
            }
        }

        function openAddActivityModal() {
            alert('Activity logging coming in next update!');
        }

        // Auto-refresh every 5 minutes
        setInterval(loadAllData, 300000);
    </script>
</body>
</html>
