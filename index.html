<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuConnect CRM - Phase 2 Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #667eea;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --bg-light: #f9fafb;
            --border: #e5e7eb;
            --white: #ffffff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
        }
        body { font-family: 'Inter', sans-serif; background: var(--gradient); min-height: 100vh; color: var(--text-dark); }
        .hidden { display: none !important; }
        
        /* Login */
        .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-card { background: var(--white); padding: 60px 50px; border-radius: 24px; box-shadow: var(--shadow-lg); max-width: 450px; width: 100%; }
        .logo { font-size: 48px; text-align: center; margin-bottom: 10px; }
        .login-card h1 { color: var(--primary); font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 10px; }
        .login-card p { color: var(--text-gray); text-align: center; margin-bottom: 40px; }
        
        /* FORMS - PROPER SIZING */
        .form-group { margin-bottom: 24px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 15px; color: var(--text-dark); }
        .form-group select, .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid var(--border); 
            border-radius: 12px; 
            font-size: 16px; 
            font-family: inherit; 
            background: var(--white);
            color: var(--text-dark);
        }
        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 44px;
        }
        .form-group textarea { min-height: 120px; resize: vertical; }
        .form-group select:focus, .form-group input:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1); 
        }
        .form-group small { display: block; margin-top: 6px; font-size: 13px; color: var(--text-gray); }
        
        /* Buttons */
        .btn { padding: 14px 24px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-family: inherit; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--gradient); color: var(--white); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
        .btn-secondary { background: var(--bg-light); color: var(--text-dark); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-small { padding: 10px 18px; font-size: 14px; }
        .btn-icon { padding: 8px 12px; font-size: 16px; border-radius: 8px; min-width: 40px; }
        .btn-full { width: 100%; }
        
        /* Layout */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: var(--white); box-shadow: var(--shadow-md); padding: 24px 0; position: fixed; height: 100vh; overflow-y: auto; z-index: 100; }
        .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); }
        .sidebar-header h2 { color: var(--primary); font-size: 24px; font-weight: 800; margin-bottom: 4px; }
        .sidebar-nav { padding: 24px 0; }
        .nav-item { display: flex; align-items: center; padding: 14px 24px; color: var(--text-gray); cursor: pointer; transition: all 0.3s; font-weight: 500; font-size: 15px; }
        .nav-item:hover { background: var(--bg-light); color: var(--primary); }
        .nav-item.active { background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, transparent 100%); color: var(--primary); border-left: 4px solid var(--primary); }
        .nav-item-icon { font-size: 20px; margin-right: 12px; }
        .main-content { margin-left: 280px; flex: 1; padding: 24px; min-height: 100vh; }
        
        /* Top Bar */
        .top-bar { background: var(--white); padding: 20px 30px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .top-bar h1 { font-size: 28px; font-weight: 800; color: var(--text-dark); }
        .top-bar-actions { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        
        /* Search */
        .search-container { position: relative; }
        .search-input { padding: 12px 18px 12px 44px; border: 2px solid var(--border); border-radius: 12px; font-size: 15px; width: 300px; font-family: inherit; transition: all 0.3s; }
        .search-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102,126,234,0.1); width: 340px; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--text-gray); }
        .search-results { position: absolute; top: 100%; left: 0; right: 0; background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); margin-top: 8px; max-height: 400px; overflow-y: auto; z-index: 1000; display: none; }
        .search-results.active { display: block; }
        .search-result-item { padding: 14px 18px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .search-result-item:hover { background: var(--bg-light); }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-type { font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 4px; }
        .search-result-title { font-weight: 600; font-size: 15px; margin-bottom: 2px; }
        .search-result-meta { font-size: 13px; color: var(--text-gray); }
        
        /* Nudges */
        .nudge-container { margin-bottom: 24px; }
        .nudge-alert { padding: 18px 24px; border-radius: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 14px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .nudge-alert.warning { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 5px solid var(--warning); }
        .nudge-alert.danger { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border-left: 5px solid var(--danger); }
        .nudge-alert.success { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 5px solid var(--success); }
        .nudge-alert.info { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 5px solid var(--primary); }
        .nudge-icon { font-size: 28px; }
        .nudge-text { flex: 1; font-weight: 500; font-size: 15px; }
        .nudge-dismiss { background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.6; }
        .nudge-dismiss:hover { opacity: 1; }
        
        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .kpi-card { background: var(--white); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-sm); position: relative; transition: transform 0.2s, box-shadow 0.2s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--gradient); border-radius: 16px 0 0 16px; }
        .kpi-value { font-size: 38px; font-weight: 800; margin-bottom: 8px; }
        .kpi-label { font-size: 13px; font-weight: 600; color: var(--text-gray); text-transform: uppercase; }
        .progress-bar { width: 100%; height: 10px; background: var(--bg-light); border-radius: 10px; overflow: hidden; margin: 12px 0; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; }
        
        .card { background: var(--white); padding: 28px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 24px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .card-title { font-size: 20px; font-weight: 700; }
        
        /* Profile Cards */
        .profile-card { background: var(--white); border-radius: 16px; box-shadow: var(--shadow-sm); overflow: hidden; transition: all 0.2s; cursor: pointer; }
        .profile-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .profile-card-header { background: var(--gradient); padding: 24px; color: white; }
        .profile-card-avatar { width: 64px; height: 64px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; margin-bottom: 12px; }
        .profile-card-name { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
        .profile-card-subtitle { font-size: 14px; opacity: 0.9; }
        .profile-card-body { padding: 20px; }
        .profile-card-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 14px; }
        .profile-card-row:last-child { border-bottom: none; }
        .profile-card-label { color: var(--text-gray); }
        .profile-card-value { font-weight: 600; text-align: right; }
        .profile-card-actions { padding: 16px 20px; background: var(--bg-light); display: flex; gap: 10px; flex-wrap: wrap; }
        
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        /* Badges */
        .badge { display: inline-block; padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-starter { background: #dbeafe; color: #1e40af; }
        .badge-growth { background: #d1fae5; color: #065f46; }
        .badge-pro { background: #fef3c7; color: #92400e; }
        .badge-enterprise { background: #e0e7ff; color: #3730a3; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        
        /* Stats */
        .activity-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; }
        .stat-card { text-align: center; padding: 20px 16px; background: var(--bg-light); border-radius: 14px; transition: all 0.2s; }
        .stat-card:hover { background: var(--white); box-shadow: var(--shadow-sm); }
        .stat-icon { font-size: 28px; margin-bottom: 10px; }
        .stat-value { font-size: 32px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 13px; color: var(--text-gray); margin-top: 6px; }
        
        /* Floor Tracker */
        .floor-tracker { text-align: center; padding: 30px; }
        .capacity-circle { width: 180px; height: 180px; margin: 0 auto 20px; border-radius: 50%; background: var(--gradient); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 8px 24px rgba(102,126,234,0.3); }
        .capacity-number { font-size: 48px; font-weight: 800; }
        .capacity-label { font-size: 14px; opacity: 0.9; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        thead { background: var(--bg-light); }
        th { padding: 14px 18px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; color: var(--text-gray); }
        td { padding: 18px; border-bottom: 1px solid var(--border); font-size: 15px; }
        tr:hover { background: rgba(102,126,234,0.03); }
        .action-buttons { display: flex; gap: 8px; }
        
        /* Kanban */
        .kanban-board { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .kanban-column { background: var(--bg-light); border-radius: 14px; padding: 18px; min-height: 450px; }
        .kanban-header { font-weight: 700; font-size: 15px; margin-bottom: 16px; padding-bottom: 14px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; }
        .kanban-count { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; }
        .kanban-card { background: var(--white); padding: 18px; border-radius: 12px; margin-bottom: 14px; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; border-left: 4px solid transparent; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .kanban-card.stale { border-left-color: var(--warning); background: linear-gradient(90deg, rgba(245,158,11,0.05) 0%, transparent 100%); }
        .kanban-card-title { font-weight: 600; font-size: 15px; margin-bottom: 10px; }
        .kanban-card-value { font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
        .kanban-card-meta { font-size: 13px; color: var(--text-gray); margin-top: 10px; }
        .stale-indicator { display: inline-flex; align-items: center; gap: 6px; background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-top: 10px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); padding: 36px; border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-content.wide { max-width: 900px; }
        .modal-content.profile { max-width: 500px; padding: 0; overflow: hidden; }
        .modal-header { margin-bottom: 28px; }
        .modal-header h2 { font-size: 24px; font-weight: 700; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 28px; padding-top: 20px; border-top: 1px solid var(--border); }
        
        /* Charts */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .chart-card { background: var(--white); padding: 24px; border-radius: 16px; box-shadow: var(--shadow-sm); }
        .chart-card h3 { font-size: 17px; font-weight: 700; margin-bottom: 20px; }
        .chart-container { position: relative; height: 300px; }
        
        /* Status Colors */
        .rep-card-green { border-left: 5px solid var(--success) !important; }
        .rep-card-yellow { border-left: 5px solid var(--warning) !important; }
        .rep-card-red { border-left: 5px solid var(--danger) !important; }
        
        .clickable-stat { cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
        .clickable-stat:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: var(--shadow-md); }
        
        .kpi-alerts { margin-top: 20px; }
        .kpi-alert-item { display: flex; align-items: center; gap: 14px; padding: 14px 18px; background: var(--bg-light); border-radius: 10px; margin-bottom: 10px; font-size: 15px; }
        .kpi-alert-item.needs-attention { background: #fee2e2; border-left: 4px solid var(--danger); }
        .kpi-alert-item.on-track { background: #d1fae5; border-left: 4px solid var(--success); }
        
        .quick-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 24px; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .search-input { width: 200px; }
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
            .cards-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="logo">üéØ</div>
            <h1>NuConnect CRM</h1>
            <p>Sign in to your account</p>
            <div class="form-group">
                <label>Team Member</label>
                <select id="userSelect"><option value="">Choose your name...</option></select>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="passwordInput" placeholder="Enter your password">
            </div>
            <div id="loginError" class="hidden" style="color: var(--danger); margin-bottom: 16px; font-size: 14px;"></div>
            <button class="btn btn-primary btn-full" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="appContainer" class="app-container hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üéØ NuConnect</h2>
                <p id="currentUserName" style="color: var(--text-gray); font-size: 14px; margin-top: 4px;"></p>
            </div>
            <nav class="sidebar-nav" id="sidebarNav"></nav>
        </aside>
        <main class="main-content">
            <div class="top-bar">
                <div><h1 id="pageTitle">Dashboard</h1></div>
                <div class="top-bar-actions">
                    <div class="search-container">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="globalSearch" placeholder="Search deals, contacts, accounts..." oninput="handleSearch(this.value)" onfocus="showSearchResults()" onblur="hideSearchResults()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="openSettings()">‚öôÔ∏è</button>
                    <button class="btn btn-danger btn-small" onclick="logout()">Logout</button>
                </div>
            </div>
            <div id="contentArea"></div>
        </main>
    </div>
    <div id="modalContainer"></div>

    <script>
// ============ STATE & CONFIG ============
const state = {
    currentUser: null,
    currentView: 'dashboard',
    baseId: localStorage.getItem('airtable_baseId') || '',
    apiKey: localStorage.getItem('airtable_apiKey') || '',
    charts: {},
    filterRep: null,
    filterMonth: null,
    data: { deals: [], activities: [], tasks: [], contacts: [], accounts: [], teamMembers: [], pricingRules: [] },
    teamMemberMap: {},
    pricingRuleMap: {}
};

const userPasswords = {
    'Javonte': 'nuconnect2025', 'Teslim': 'nuconnect2025', 'Israel': 'nuconnect2025', 'Conrad': 'nuconnect2025',
    'Test User': 'test2024', 'Test Leadership': 'testleader2024', 'Ramallah': 'admin2025', 'Keyna': 'admin2025'
};

const tierPricing = { 'Starter': 750, 'Growth': 1250, 'Pro': 2000, 'Enterprise': 4200 };
const tierColors = { 'Starter': '#9e9e9e', 'Growth': '#22c55e', 'Pro': '#f59e0b', 'Enterprise': '#667eea' };

// FULL Industry Options List
const industryOptions = [
    'Technology', 'Finance & Banking', 'Healthcare', 'Education', 'Retail & E-commerce',
    'Real Estate', 'Manufacturing', 'Entertainment & Media', 'Non-Profit', 'Government',
    'Legal Services', 'Hospitality & Events', 'Sports & Fitness', 'Food & Beverage',
    'Transportation & Logistics', 'Energy & Utilities', 'Construction', 'Agriculture',
    'Telecommunications', 'Marketing & Advertising', 'Professional Services', 'Insurance',
    'Automotive', 'Aerospace', 'Pharmaceuticals', 'Biotechnology', 'Fashion & Apparel',
    'Beauty & Cosmetics', 'Travel & Tourism', 'Gaming & Esports', 'Music & Arts',
    'Consulting', 'Human Resources', 'Security Services', 'Environmental Services', 'Other'
];

const KPI_TARGETS = {
    BDR: { monthlyRevenueMin: 9750, monthlyRevenueMax: 12700, monthlyEventsMin: 6, monthlyEventsMax: 7,
           dailyTouchpointsMin: 20, dailyTouchpointsMax: 25, dailyCalls: 15, dailyDiscovery: 1, dailyDealsMoved: 1, quota: 45000 },
    AE: { monthlyRevenueMin: 15000, monthlyRevenueMax: 20000, monthlyEventsMin: 4, monthlyEventsMax: 6,
          dailyTouchpointsMin: 15, dailyTouchpointsMax: 20, dailyCalls: 10, dailyDiscovery: 2, dailyDealsMoved: 1, quota: 60000 },
    Team: { monthlyRevenueMin: 28000, monthlyRevenueMax: 35000, monthlyEventsMin: 18, monthlyEventsMax: 22 }
};

function getKPITargets(role) { return role === 'AE' ? KPI_TARGETS.AE : KPI_TARGETS.BDR; }

const allNavItems = [
    { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
    { id: 'pipeline', icon: 'üìà', label: 'Pipeline' },
    { id: 'contacts', icon: 'üë•', label: 'Contacts' },
    { id: 'accounts', icon: 'üè¢', label: 'Accounts' },
    { id: 'activity', icon: 'üìù', label: 'Activities' },
    { id: 'tasks', icon: '‚úÖ', label: 'Tasks' }
];
const leadershipNavItems = [
    { id: 'leadership', icon: 'üëî', label: 'Analytics' },
    { id: 'team', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', label: 'Team Overview' }
];

// ============ GLOBAL SEARCH ============
let searchTimeout = null;
window.searchResults = [];

function handleSearch(query) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(query), 300);
}

function performSearch(query) {
    const resultsDiv = document.getElementById('searchResults');
    if (!query || query.length < 2) { resultsDiv.innerHTML = ''; resultsDiv.classList.remove('active'); return; }
    const q = query.toLowerCase();
    const results = [];

    state.data.deals.forEach(deal => {
        if (deal.name.toLowerCase().includes(q) || (deal.eventName && deal.eventName.toLowerCase().includes(q))) {
            results.push({ type: 'Deal', title: deal.name, meta: `${deal.tier} ‚Ä¢ $${deal.value.toLocaleString()} ‚Ä¢ ${deal.stage}`, action: () => { closeSearch(); renderView('pipeline'); }});
        }
    });
    state.data.contacts.forEach(contact => {
        if (contact.name.toLowerCase().includes(q) || (contact.email && contact.email.toLowerCase().includes(q)) || (contact.company && contact.company.toLowerCase().includes(q))) {
            results.push({ type: 'Contact', title: contact.name, meta: `${contact.email || 'No email'} ‚Ä¢ ${contact.company || 'No company'}`, action: () => { closeSearch(); openContactDetailModal(contact.id); }});
        }
    });
    state.data.accounts.forEach(account => {
        if (account.name.toLowerCase().includes(q) || (account.industry && account.industry.toLowerCase().includes(q))) {
            results.push({ type: 'Account', title: account.name, meta: `${account.industry || 'No industry'} ‚Ä¢ Owner: ${account.owner}`, action: () => { closeSearch(); openAccountDetailModal(account.id); }});
        }
    });
    state.data.activities.forEach(activity => {
        if ((activity.account && activity.account.toLowerCase().includes(q)) || (activity.result && activity.result.toLowerCase().includes(q))) {
            results.push({ type: 'Activity', title: `${activity.type} - ${activity.account}`, meta: `${formatDateShort(activity.date)} ‚Ä¢ ${activity.owner}`, action: () => { closeSearch(); renderView('activity'); }});
        }
    });

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item"><div class="search-result-title">No results found</div></div>';
    } else {
        resultsDiv.innerHTML = results.slice(0, 10).map((r, i) => `
            <div class="search-result-item" onmousedown="window.searchResults[${i}].action()">
                <div class="search-result-type">${r.type}</div>
                <div class="search-result-title">${r.title}</div>
                <div class="search-result-meta">${r.meta}</div>
            </div>
        `).join('');
        window.searchResults = results;
    }
    resultsDiv.classList.add('active');
}

function showSearchResults() { const r = document.getElementById('searchResults'); if (r.innerHTML) r.classList.add('active'); }
function hideSearchResults() { setTimeout(() => document.getElementById('searchResults').classList.remove('active'), 200); }
function closeSearch() { document.getElementById('globalSearch').value = ''; document.getElementById('searchResults').classList.remove('active'); }

// ============ NUDGE NOTIFICATIONS ============
function generateNudges() {
    const nudges = [];
    if (state.currentUser.role === 'Leadership') return nudges;
    
    const now = new Date();
    const hour = now.getHours();
    const targets = getKPITargets(state.currentUser.role);
    const today = now.toISOString().split('T')[0];
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    const userActivities = state.data.activities.filter(a => a.owner === state.currentUser.name);
    const todayActivities = userActivities.filter(a => a.date && a.date.split('T')[0] === today);
    const todayTouchpoints = todayActivities.length;
    
    const userDeals = state.data.deals.filter(d => d.owner === state.currentUser.name);
    const monthClosedDeals = userDeals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const monthRevenue = monthClosedDeals.reduce((sum, d) => sum + d.value, 0);
    const revenuePercent = (monthRevenue / targets.monthlyRevenueMin) * 100;
    
    const growthPlusDeals = monthClosedDeals.filter(d => d.tier !== 'Starter').length;
    const qualityScore = monthClosedDeals.length > 0 ? (growthPlusDeals / monthClosedDeals.length) * 100 : 100;
    
    if (revenuePercent < 50) {
        nudges.push({ type: 'danger', icon: 'üö®', text: `You're at ${revenuePercent.toFixed(0)}% of minimum target ($${(targets.monthlyRevenueMin/1000).toFixed(1)}K). Let's pick up the pace!` });
    } else if (revenuePercent >= 100) {
        nudges.push({ type: 'success', icon: 'üéâ', text: `Amazing! You've hit ${revenuePercent.toFixed(0)}% of your minimum target! Keep crushing it!` });
    }
    
    if (hour >= 15 && todayTouchpoints < 15) {
        nudges.push({ type: 'warning', icon: '‚è∞', text: `Only ${todayTouchpoints}/${targets.dailyTouchpointsMax} touchpoints today. It's after 3pm - time to hustle!` });
    }
    
    if (qualityScore < 70 && monthClosedDeals.length >= 2) {
        nudges.push({ type: 'warning', icon: 'üìä', text: `Quality score is ${qualityScore.toFixed(0)}%. Focus on Growth+ tier deals to hit 70%!` });
    }
    
    // Stale deals nudge
    const staleDeals = userDeals.filter(d => {
        if (d.stage.toLowerCase().includes('won') || d.stage.toLowerCase().includes('lost')) return false;
        const lastActivity = userActivities.filter(a => a.account && d.name.toLowerCase().includes(a.account.toLowerCase())).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
        if (!lastActivity) return true;
        return getDaysSince(lastActivity.date) >= 5;
    });
    
    if (staleDeals.length > 0) {
        nudges.push({ type: 'info', icon: 'üìå', text: `${staleDeals.length} deal${staleDeals.length > 1 ? 's need' : ' needs'} attention! Move them forward with a touchpoint today.` });
    }
    
    return nudges;
}

function renderNudges() {
    const nudges = generateNudges();
    if (nudges.length === 0) return '';
    return `<div class="nudge-container">${nudges.map(n => `
        <div class="nudge-alert ${n.type}">
            <span class="nudge-icon">${n.icon}</span>
            <span class="nudge-text">${n.text}</span>
            <button class="nudge-dismiss" onclick="this.parentElement.remove()">√ó</button>
        </div>
    `).join('')}</div>`;
}

// ============ CHARTS ============
function destroyCharts() {
    Object.values(state.charts).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
    state.charts = {};
}

function renderRevenueTrendChart(canvasId, deals, label = 'Revenue') {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    
    const monthlyData = [], labels = [];
    for (let i = 5; i >= 0; i--) {
        let month = currentMonth - i, year = currentYear;
        if (month < 0) { month += 12; year -= 1; }
        const monthStart = new Date(year, month, 1), monthEnd = new Date(year, month + 1, 0);
        const monthDeals = deals.filter(d => {
            if (!d.stage.toLowerCase().includes('won')) return false;
            const closeDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return closeDate && closeDate >= monthStart && closeDate <= monthEnd;
        });
        monthlyData.push(monthDeals.reduce((sum, d) => sum + d.value, 0));
        labels.push(monthNames[month]);
    }
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label, data: monthlyData, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', fill: true, tension: 0.4, pointBackgroundColor: '#667eea', pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 6 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000).toFixed(0) + 'K' } } } }
    });
}

function renderRevenueByTierChart(canvasId, deals) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const wonDeals = deals.filter(d => d.stage.toLowerCase().includes('won'));
    const tierData = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    wonDeals.forEach(d => { if (tierData.hasOwnProperty(d.tier)) tierData[d.tier] += d.value; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'pie',
        data: { labels: Object.keys(tierData), datasets: [{ data: Object.values(tierData), backgroundColor: [tierColors.Starter, tierColors.Growth, tierColors.Pro, tierColors.Enterprise], borderWidth: 3, borderColor: '#fff' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { size: 13 } } }, tooltip: { callbacks: { label: ctx => ' $' + ctx.raw.toLocaleString() } } } }
    });
}

function renderEventsByTierChart(canvasId, deals) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const wonDeals = deals.filter(d => d.stage.toLowerCase().includes('won'));
    const tierCounts = { 'Starter': 0, 'Growth': 0, 'Pro': 0, 'Enterprise': 0 };
    wonDeals.forEach(d => { if (tierCounts.hasOwnProperty(d.tier)) tierCounts[d.tier]++; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: { labels: Object.keys(tierCounts), datasets: [{ label: 'Events', data: Object.values(tierCounts), backgroundColor: [tierColors.Starter, tierColors.Growth, tierColors.Pro, tierColors.Enterprise], borderRadius: 8 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
    });
}

function renderRevenueByPricingChart(canvasId, deals) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const wonDeals = deals.filter(d => d.stage.toLowerCase().includes('won'));
    let publicRevenue = 0, floorRevenue = 0;
    wonDeals.forEach(d => { if (d.pricingType === 'Floor Price') floorRevenue += d.value; else publicRevenue += d.value; });
    
    state.charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['Public Price', 'Floor Price'], datasets: [{ data: [publicRevenue, floorRevenue], backgroundColor: ['#667eea', '#f59e0b'], borderWidth: 3, borderColor: '#fff' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { size: 13 } } }, tooltip: { callbacks: { label: ctx => ' $' + ctx.raw.toLocaleString() } } } }
    });
}

// ============ INITIALIZATION ============
async function init() {
    console.log('%cüöÄ NuConnect CRM v2.4 - Enhanced Phase 2', 'background: #667eea; color: white; font-size: 16px; padding: 10px; font-weight: bold;');
    
    if (state.baseId && state.apiKey) {
        await loadTeamMembers();
        await loadPricingRules();
        populateLoginSelect();
    } else {
        showConfigPrompt();
    }
}

function showConfigPrompt() {
    document.getElementById('loginScreen').innerHTML = `
        <div class="login-card">
            <div class="logo">‚öôÔ∏è</div><h1>Setup Required</h1><p>Configure your Airtable connection</p>
            <div class="form-group"><label>Airtable Base ID</label><input type="text" id="setupBaseId" placeholder="appXXXXXXXXXXXXXX" value="${state.baseId}"></div>
            <div class="form-group"><label>Airtable API Key</label><input type="password" id="setupApiKey" placeholder="patXXXXXXXXXXXXXX"></div>
            <button class="btn btn-primary btn-full" onclick="saveConfig()">Connect to Airtable</button>
        </div>`;
}

function saveConfig() {
    const baseId = document.getElementById('setupBaseId').value.trim();
    const apiKey = document.getElementById('setupApiKey').value.trim();
    if (baseId && apiKey) { localStorage.setItem('airtable_baseId', baseId); localStorage.setItem('airtable_apiKey', apiKey); location.reload(); }
    else alert('Please fill in both fields');
}

function openSettings() {
    const modal = document.getElementById('modalContainer');
    modal.innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚öôÔ∏è Settings</h2></div>
        <div class="form-group"><label>Airtable Base ID</label><input type="text" id="settingsBaseId" value="${state.baseId}"></div>
        <div class="form-group"><label>Airtable API Key</label><input type="password" id="settingsApiKey" value="${state.apiKey}"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveSettings()">Save & Reload</button></div>
    </div></div>`;
}

function saveSettings() {
    const baseId = document.getElementById('settingsBaseId').value.trim();
    const apiKey = document.getElementById('settingsApiKey').value.trim();
    if (!baseId || !apiKey) { alert('Both fields required'); return; }
    localStorage.setItem('airtable_baseId', baseId); localStorage.setItem('airtable_apiKey', apiKey);
    location.reload();
}

async function loadTeamMembers() {
    try {
        const response = await fetchFromAirtable('Team Members');
        if (response && response.records) {
            state.data.teamMembers = response.records.map(r => ({ id: r.id, name: r.fields.Name || '', role: r.fields.Role || '', quota: r.fields['Monthly Quota'] || (r.fields.Role === 'AE' ? 60000 : 45000) }));
            state.teamMemberMap = {};
            response.records.forEach(r => { if (r.fields.Name) state.teamMemberMap[r.fields.Name] = r.id; });
        }
    } catch (error) {
        console.error('Error loading team members:', error);
        state.data.teamMembers = [
            { id: 'rec1', name: 'Javonte', role: 'BDR', quota: 45000 }, { id: 'rec2', name: 'Teslim', role: 'BDR', quota: 45000 },
            { id: 'rec3', name: 'Israel', role: 'BDR', quota: 45000 }, { id: 'rec4', name: 'Conrad', role: 'AE', quota: 60000 },
            { id: 'rec5', name: 'Test User', role: 'BDR', quota: 45000 }, { id: 'rec6', name: 'Test Leadership', role: 'Leadership', quota: 0 },
            { id: 'rec7', name: 'Ramallah', role: 'Leadership', quota: 0 }, { id: 'rec8', name: 'Keyna', role: 'Leadership', quota: 0 }
        ];
        state.teamMemberMap = { 'Javonte': 'rec1', 'Teslim': 'rec2', 'Israel': 'rec3', 'Conrad': 'rec4', 'Test User': 'rec5', 'Test Leadership': 'rec6', 'Ramallah': 'rec7', 'Keyna': 'rec8' };
    }
}

async function loadPricingRules() {
    try {
        const response = await fetchFromAirtable('Pricing Rules');
        if (response && response.records) {
            state.data.pricingRules = response.records.map(r => ({ id: r.id, tier: r.fields.Tier || '', basePrice: r.fields['Base Price'] || 0 }));
            state.pricingRuleMap = {};
            response.records.forEach(r => { if (r.fields.Tier) state.pricingRuleMap[r.fields.Tier] = r.id; });
        }
    } catch (error) { console.error('Error loading pricing rules:', error); }
}

function populateLoginSelect() {
    const select = document.getElementById('userSelect');
    if (!select) return;
    state.data.teamMembers.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = `${member.name} (${member.role})`;
        select.appendChild(option);
    });
}

async function handleLogin() {
    const select = document.getElementById('userSelect');
    const passwordInput = document.getElementById('passwordInput');
    const errorDiv = document.getElementById('loginError');
    const selectedName = select.value, enteredPassword = passwordInput.value;
    
    if (!selectedName) { errorDiv.textContent = 'Please select a team member'; errorDiv.classList.remove('hidden'); return; }
    if (!enteredPassword) { errorDiv.textContent = 'Please enter your password'; errorDiv.classList.remove('hidden'); return; }
    if (userPasswords[selectedName] !== enteredPassword) { errorDiv.textContent = 'Incorrect password'; errorDiv.classList.remove('hidden'); passwordInput.value = ''; return; }
    
    const user = state.data.teamMembers.find(m => m.name === selectedName);
    if (user) { state.currentUser = user; document.getElementById('loginScreen').classList.add('hidden'); document.getElementById('appContainer').classList.remove('hidden'); await initApp(); }
}

async function initApp() {
    document.getElementById('currentUserName').textContent = `${state.currentUser.name} ‚Ä¢ ${state.currentUser.role}`;
    buildNavigation();
    await loadAllData();
    renderView('dashboard');
    setInterval(async () => { await loadAllData(); }, 5 * 60 * 1000);
}

function buildNavigation() {
    const nav = document.getElementById('sidebarNav');
    let items = [...allNavItems];
    if (state.currentUser.role === 'Leadership') items = items.concat(leadershipNavItems);
    nav.innerHTML = items.map(item => `
        <div class="nav-item ${item.id === state.currentView ? 'active' : ''}" onclick="renderView('${item.id}')">
            <span class="nav-item-icon">${item.icon}</span><span>${item.label}</span>
        </div>
    `).join('');
}

function logout() { if (confirm('Are you sure you want to logout?')) location.reload(); }

// ============ AIRTABLE API ============
async function fetchFromAirtable(tableName, method = 'GET', body = null) {
    try {
        let url = `https://api.airtable.com/v0/${state.baseId}/${encodeURIComponent(tableName)}`;
        const options = { method, headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' } };
        if (body && ['POST', 'PATCH', 'PUT'].includes(method)) options.body = JSON.stringify(body);
        const response = await fetch(url, options);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    } catch (error) { console.error(`Error with ${tableName}:`, error); throw error; }
}

async function deleteFromAirtable(tableName, recordId) {
    const url = `https://api.airtable.com/v0/${state.baseId}/${encodeURIComponent(tableName)}/${recordId}`;
    const response = await fetch(url, { method: 'DELETE', headers: { 'Authorization': `Bearer ${state.apiKey}` } });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return true;
}

async function updateInAirtable(tableName, recordId, fields) {
    const url = `https://api.airtable.com/v0/${state.baseId}/${encodeURIComponent(tableName)}/${recordId}`;
    const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ fields }) });
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return await response.json();
}

async function loadAllData() {
    try { await Promise.all([loadDeals(), loadActivities(), loadTasks(), loadContacts(), loadAccounts()]); }
    catch (error) { console.error('Error loading data:', error); }
}

function getOwnerName(ownerField) {
    if (Array.isArray(ownerField) && ownerField.length > 0) {
        const member = state.data.teamMembers.find(m => m.id === ownerField[0]);
        return member ? member.name : '';
    }
    return ownerField || '';
}

function getAccountName(accountField) {
    if (Array.isArray(accountField) && accountField.length > 0) {
        const account = state.data.accounts.find(a => a.id === accountField[0]);
        return account ? account.name : '';
    }
    return '';
}

function formatDateCST(dateString) {
    if (!dateString) return '-';
    try { return new Date(dateString).toLocaleString('en-US', { timeZone: 'America/Chicago', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); }
    catch (e) { return dateString; }
}

function formatDateShort(dateString) {
    if (!dateString) return '-';
    try { return new Date(dateString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    catch (e) { return dateString; }
}

function getDaysSince(dateString) {
    if (!dateString) return null;
    return Math.floor((new Date() - new Date(dateString)) / (1000 * 60 * 60 * 24));
}

async function loadDeals() {
    const response = await fetchFromAirtable('Deals');
    if (response && response.records) {
        state.data.deals = response.records.map(r => ({
            id: r.id, name: r.fields['Deal Name'] || '', owner: getOwnerName(r.fields.Owner),
            tier: Array.isArray(r.fields['Tier (lookup)']) ? r.fields['Tier (lookup)'][0] : r.fields['Tier (lookup)'] || '',
            stage: r.fields.Stage || '', value: r.fields.Amount || 0, eventName: r.fields['Event Name'] || '',
            closeDate: r.fields['Close Date'] || '', createdTime: r.createdTime,
            pricingType: r.fields['Pricing Type'] || 'Public Price'
        }));
    }
}

async function loadActivities() {
    const response = await fetchFromAirtable('Activities');
    if (response && response.records) {
        state.data.activities = response.records.map(r => ({
            id: r.id, name: r.fields['Activity Name'] || '', type: r.fields.Type || '',
            date: r.fields['Activity Date/Time'] || r.fields.Date || '', owner: r.fields.Owner || '',
            account: r.fields.Account || '', contact: Array.isArray(r.fields.Contact) ? r.fields.Contact[0] : r.fields.Contact || '',
            result: r.fields.Result || '', nextSteps: r.fields['Next Steps'] || '', createdTime: r.createdTime
        }));
    }
}

async function loadTasks() {
    const response = await fetchFromAirtable('Tasks');
    if (response && response.records) {
        state.data.tasks = response.records.map(r => ({
            id: r.id, name: r.fields['Task Name'] || '', owner: getOwnerName(r.fields.Owner),
            dueDate: r.fields['Due Date'] || '', status: r.fields.Status || 'Open', type: r.fields.Type || ''
        }));
    }
}

async function loadContacts() {
    const response = await fetchFromAirtable('Contacts');
    if (response && response.records) {
        state.data.contacts = response.records.map(r => ({
            id: r.id, name: r.fields['Full Name'] || '', email: r.fields.Email || '', phone: r.fields.Phone || '',
            company: getAccountName(r.fields.Account), accountId: Array.isArray(r.fields.Account) ? r.fields.Account[0] : null,
            role: r.fields.Title || '', owner: getOwnerName(r.fields['Contact Owner']), createdTime: r.createdTime
        }));
    }
}

async function loadAccounts() {
    const response = await fetchFromAirtable('Accounts');
    if (response && response.records) {
        state.data.accounts = response.records.map(r => ({
            id: r.id, name: r.fields['Account Name'] || '', industry: r.fields.Industry || '',
            website: r.fields.Website || '', phone: r.fields.Phone || '', address: r.fields.Address || '',
            owner: getOwnerName(r.fields['Account Owner']), createdTime: r.createdTime
        }));
    }
}

function getUserDeals() {
    if (state.currentUser.role === 'Leadership') return state.data.deals;
    return state.data.deals.filter(d => d.owner === state.currentUser.name);
}

// ============ CRUD OPERATIONS ============
async function createDeal(dealData) {
    try {
        const response = await fetchFromAirtable('Deals', 'POST', { fields: dealData });
        if (response && response.id) { await loadDeals(); closeModal(); renderView('pipeline'); alert('Deal created successfully!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function createContact(contactData) {
    try {
        const response = await fetchFromAirtable('Contacts', 'POST', { fields: contactData });
        if (response && response.id) { await loadContacts(); closeModal(); renderView('contacts'); alert('Contact created!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function createAccount(accountData) {
    try {
        const response = await fetchFromAirtable('Accounts', 'POST', { fields: accountData });
        if (response && response.id) { await loadAccounts(); closeModal(); renderView('accounts'); alert('Account created!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function logActivity(activityData) {
    try {
        const response = await fetchFromAirtable('Activities', 'POST', { fields: activityData });
        if (response && response.id) { await loadActivities(); closeModal(); renderView(state.currentView); alert('Activity logged!'); }
    } catch (error) { alert('Error: ' + error.message); }
}

async function deleteContact(contactId) {
    if (!confirm('Delete this contact? This cannot be undone.')) return;
    try { await deleteFromAirtable('Contacts', contactId); await loadContacts(); closeModal(); renderView('contacts'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteAccount(accountId) {
    if (!confirm('Delete this account? This cannot be undone.')) return;
    try { await deleteFromAirtable('Accounts', accountId); await loadAccounts(); closeModal(); renderView('accounts'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteDeal(dealId) {
    if (!confirm('Delete this deal? This cannot be undone.')) return;
    try { await deleteFromAirtable('Deals', dealId); await loadDeals(); closeModal(); renderView('pipeline'); }
    catch (error) { alert('Error: ' + error.message); }
}

async function deleteActivity(activityId) {
    if (!confirm('Delete this activity? This cannot be undone.')) return;
    try { await deleteFromAirtable('Activities', activityId); await loadActivities(); renderView('activity'); }
    catch (error) { alert('Error: ' + error.message); }
}

function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }

// ============ DETAIL MODALS ============
function openAccountDetailModal(accountId) {
    const account = state.data.accounts.find(a => a.id === accountId);
    if (!account) return;
    
    const contacts = state.data.contacts.filter(c => c.accountId === accountId || c.company === account.name);
    const deals = state.data.deals.filter(d => d.name.toLowerCase().includes(account.name.toLowerCase()));
    const activities = state.data.activities.filter(a => a.account === account.name);
    const isLeadership = state.currentUser.role === 'Leadership';
    
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal active"><div class="modal-content profile">
            <div class="profile-card-header" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);">
                <div class="profile-card-avatar">üè¢</div>
                <div class="profile-card-name">${account.name}</div>
                <div class="profile-card-subtitle">${account.industry || 'No industry set'}</div>
            </div>
            <div class="profile-card-body">
                <div class="profile-card-row"><span class="profile-card-label">Owner</span><span class="profile-card-value">${account.owner || 'Unassigned'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Website</span><span class="profile-card-value">${account.website || '-'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Phone</span><span class="profile-card-value">${account.phone || '-'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Address</span><span class="profile-card-value">${account.address || '-'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Created</span><span class="profile-card-value">${formatDateShort(account.createdTime)}</span></div>
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div style="font-weight: 600; margin-bottom: 12px;">üìä Related Data</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; text-align: center;">
                        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: var(--primary);">${contacts.length}</div><div style="font-size: 12px; color: var(--text-gray);">Contacts</div></div>
                        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: var(--primary);">${deals.length}</div><div style="font-size: 12px; color: var(--text-gray);">Deals</div></div>
                        <div style="background: var(--bg-light); padding: 12px; border-radius: 8px;"><div style="font-size: 24px; font-weight: 700; color: var(--primary);">${activities.length}</div><div style="font-size: 12px; color: var(--text-gray);">Activities</div></div>
                    </div>
                </div>
            </div>
            <div class="profile-card-actions">
                <button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>
                ${isLeadership ? `<button class="btn btn-secondary btn-small" onclick="closeModal(); openEditAccountModal('${accountId}')">‚úèÔ∏è Edit</button>` : ''}
                ${isLeadership ? `<button class="btn btn-danger btn-small" onclick="deleteAccount('${accountId}')">üóëÔ∏è Delete</button>` : ''}
                <button class="btn btn-primary btn-small" onclick="closeModal(); openLogActivityModalForAccount('${account.name}')">üìù Log Activity</button>
            </div>
        </div></div>
    `;
}

function openContactDetailModal(contactId) {
    const contact = state.data.contacts.find(c => c.id === contactId);
    if (!contact) return;
    
    const activities = state.data.activities.filter(a => a.contact === contactId);
    const isLeadership = state.currentUser.role === 'Leadership';
    
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal active"><div class="modal-content profile">
            <div class="profile-card-header">
                <div class="profile-card-avatar">üë§</div>
                <div class="profile-card-name">${contact.name}</div>
                <div class="profile-card-subtitle">${contact.role || 'No role'}${contact.company ? ` at ${contact.company}` : ''}</div>
            </div>
            <div class="profile-card-body">
                <div class="profile-card-row"><span class="profile-card-label">Email</span><span class="profile-card-value">${contact.email || '-'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Phone</span><span class="profile-card-value">${contact.phone || '-'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Company</span><span class="profile-card-value">${contact.company || '-'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Owner</span><span class="profile-card-value">${contact.owner || 'Unassigned'}</span></div>
                <div class="profile-card-row"><span class="profile-card-label">Created</span><span class="profile-card-value">${formatDateShort(contact.createdTime)}</span></div>
                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div style="background: var(--bg-light); padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; color: var(--primary);">${activities.length}</div>
                        <div style="font-size: 13px; color: var(--text-gray);">Total Activities</div>
                    </div>
                </div>
            </div>
            <div class="profile-card-actions">
                <button class="btn btn-secondary btn-small" onclick="closeModal()">Close</button>
                ${isLeadership ? `<button class="btn btn-secondary btn-small" onclick="closeModal(); openEditContactModal('${contactId}')">‚úèÔ∏è Edit</button>` : ''}
                ${isLeadership ? `<button class="btn btn-danger btn-small" onclick="deleteContact('${contactId}')">üóëÔ∏è Delete</button>` : ''}
                <button class="btn btn-primary btn-small" onclick="closeModal(); openLogActivityModal()">üìù Log Activity</button>
            </div>
        </div></div>
    `;
}

// ============ EDIT MODALS ============
function openEditContactModal(contactId) {
    const contact = state.data.contacts.find(c => c.id === contactId);
    if (!contact) return;
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Contact</h2></div>
        <div class="form-group"><label>Full Name *</label><input type="text" id="editContactName" value="${contact.name}"></div>
        <div class="form-group"><label>Email *</label><input type="email" id="editContactEmail" value="${contact.email}"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="editContactPhone" value="${contact.phone || ''}"></div>
        <div class="form-group"><label>Title / Role</label><input type="text" id="editContactRole" value="${contact.role || ''}"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditContact('${contactId}')">Save Changes</button></div>
    </div></div>`;
}

async function saveEditContact(contactId) {
    const fields = { 'Full Name': document.getElementById('editContactName').value, 'Email': document.getElementById('editContactEmail').value, 'Phone': document.getElementById('editContactPhone').value, 'Title': document.getElementById('editContactRole').value };
    try { await updateInAirtable('Contacts', contactId, fields); await loadContacts(); closeModal(); renderView('contacts'); }
    catch (error) { alert('Error: ' + error.message); }
}

function openEditAccountModal(accountId) {
    const account = state.data.accounts.find(a => a.id === accountId);
    if (!account) return;
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚úèÔ∏è Edit Account</h2></div>
        <div class="form-group"><label>Account Name *</label><input type="text" id="editAccountName" value="${account.name}"></div>
        <div class="form-group"><label>Industry</label>
            <select id="editAccountIndustry">
                <option value="">Select an industry...</option>
                ${industryOptions.map(ind => `<option value="${ind}" ${account.industry === ind ? 'selected' : ''}>${ind}</option>`).join('')}
            </select>
        </div>
        <div class="form-group"><label>Website</label><input type="url" id="editAccountWebsite" value="${account.website || ''}" placeholder="https://"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="editAccountPhone" value="${account.phone || ''}"></div>
        <div class="form-group"><label>Address</label><input type="text" id="editAccountAddress" value="${account.address || ''}"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveEditAccount('${accountId}')">Save Changes</button></div>
    </div></div>`;
}

async function saveEditAccount(accountId) {
    const fields = { 
        'Account Name': document.getElementById('editAccountName').value, 
        'Industry': document.getElementById('editAccountIndustry').value,
        'Website': document.getElementById('editAccountWebsite').value,
        'Phone': document.getElementById('editAccountPhone').value,
        'Address': document.getElementById('editAccountAddress').value
    };
    try { await updateInAirtable('Accounts', accountId, fields); await loadAccounts(); closeModal(); renderView('accounts'); }
    catch (error) { alert('Error: ' + error.message); }
}

// ============ ADD MODALS ============
function openAddDealModal() {
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Deal</h2></div>
        <div class="form-group"><label>Deal Name *</label><input type="text" id="dealName" placeholder="Enter deal name"></div>
        <div class="form-group"><label>Tier *</label>
            <select id="dealTier" onchange="updateDealValue()">
                <option value="">Select a tier...</option>
                <option value="Starter">Starter ($750)</option>
                <option value="Growth">Growth ($1,250)</option>
                <option value="Pro">Pro ($2,000)</option>
                <option value="Enterprise">Enterprise ($4,200)</option>
            </select>
            <small>Selecting a tier auto-fills the deal value</small>
        </div>
        <div class="form-group"><label>Deal Value *</label><input type="number" id="dealValue" readonly style="background: var(--bg-light);"></div>
        <div class="form-group"><label>Stage *</label>
            <select id="dealStage">
                <option value="Qualified">Qualified</option>
                <option value="Proposal Sent">Proposal Sent</option>
                <option value="Negotiation">Negotiation</option>
                <option value="Closed Won">Closed Won</option>
            </select>
        </div>
        <div class="form-group"><label>Event Name</label><input type="text" id="dealEventName" placeholder="Name of the event"></div>
        <div class="form-group"><label>Expected Close Date</label><input type="date" id="dealCloseDate"></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Create Deal</button></div>
    </div></div>`;
}

function updateDealValue() {
    const tier = document.getElementById('dealTier').value;
    document.getElementById('dealValue').value = tier && tierPricing[tier] ? tierPricing[tier] : '';
}

function saveDeal() {
    const dealName = document.getElementById('dealName').value.trim();
    const dealTier = document.getElementById('dealTier').value;
    const dealValue = parseFloat(document.getElementById('dealValue').value) || 0;
    if (!dealName || !dealTier || !dealValue) { alert('Please fill in Deal Name and select Tier'); return; }
    
    const dealData = { 'Deal Name': dealName, 'Amount': dealValue, 'Stage': document.getElementById('dealStage').value };
    if (state.pricingRuleMap[dealTier]) dealData['Pricing Tier'] = [state.pricingRuleMap[dealTier]];
    if (state.teamMemberMap[state.currentUser.name]) dealData['Owner'] = [state.teamMemberMap[state.currentUser.name]];
    const eventName = document.getElementById('dealEventName').value.trim();
    const closeDate = document.getElementById('dealCloseDate').value;
    if (eventName) dealData['Event Name'] = eventName;
    if (closeDate) dealData['Close Date'] = closeDate;
    createDeal(dealData);
}

function openAddContactModal() {
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Contact</h2></div>
        <div class="form-group"><label>Full Name *</label><input type="text" id="contactName" placeholder="John Smith"></div>
        <div class="form-group"><label>Email *</label><input type="email" id="contactEmail" placeholder="john@company.com"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="contactPhone" placeholder="(555) 123-4567"></div>
        <div class="form-group"><label>Company / Account</label>
            <select id="contactAccount">
                <option value="">Select a company...</option>
                ${state.data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
            </select>
        </div>
        <div class="form-group"><label>Title / Role</label><input type="text" id="contactRole" placeholder="Event Coordinator"></div>
        <small style="display: block; margin-top: 16px; color: var(--text-gray);">Owner: <strong>${state.currentUser.name}</strong> (auto-assigned)</small>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveContact()">Create Contact</button></div>
    </div></div>`;
}

function saveContact() {
    const contactData = { 'Full Name': document.getElementById('contactName').value, 'Email': document.getElementById('contactEmail').value, 'Phone': document.getElementById('contactPhone').value, 'Title': document.getElementById('contactRole').value };
    if (!contactData['Full Name'] || !contactData['Email']) { alert('Please fill in Name and Email'); return; }
    if (state.teamMemberMap[state.currentUser.name]) contactData['Contact Owner'] = [state.teamMemberMap[state.currentUser.name]];
    const accountId = document.getElementById('contactAccount').value;
    if (accountId) contactData['Account'] = [accountId];
    createContact(contactData);
}

function openAddAccountModal() {
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>‚ûï Add New Account</h2></div>
        <div class="form-group"><label>Account Name *</label><input type="text" id="accountName" placeholder="Company Name Inc."></div>
        <div class="form-group"><label>Industry *</label>
            <select id="accountIndustry">
                <option value="">Select an industry...</option>
                ${industryOptions.map(ind => `<option value="${ind}">${ind}</option>`).join('')}
            </select>
        </div>
        <div class="form-group"><label>Website</label><input type="url" id="accountWebsite" placeholder="https://company.com"></div>
        <div class="form-group"><label>Phone</label><input type="tel" id="accountPhone" placeholder="(555) 123-4567"></div>
        <div class="form-group"><label>Address</label><input type="text" id="accountAddress" placeholder="123 Main St, City, State"></div>
        <small style="display: block; margin-top: 16px; color: var(--text-gray);">Owner: <strong>${state.currentUser.name}</strong> (auto-assigned)</small>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveAccount()">Create Account</button></div>
    </div></div>`;
}

function saveAccount() {
    const accountData = { 
        'Account Name': document.getElementById('accountName').value, 
        'Industry': document.getElementById('accountIndustry').value,
        'Website': document.getElementById('accountWebsite').value,
        'Phone': document.getElementById('accountPhone').value,
        'Address': document.getElementById('accountAddress').value
    };
    if (!accountData['Account Name']) { alert('Please enter account name'); return; }
    if (state.teamMemberMap[state.currentUser.name]) accountData['Account Owner'] = [state.teamMemberMap[state.currentUser.name]];
    createAccount(accountData);
}

function openLogActivityModal() {
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìù Log Activity</h2></div>
        <div class="form-group"><label>Activity Type *</label>
            <select id="activityType">
                <option value="Call">üìû Call</option>
                <option value="Email">üìß Email</option>
                <option value="LinkedIn">üíº LinkedIn Message</option>
                <option value="Discovery Call">üîç Discovery Call</option>
                <option value="Demo">üé• Demo</option>
                <option value="Proposal">üìÑ Proposal Sent</option>
                <option value="Follow-up">üîÑ Follow-up</option>
                <option value="Meeting Booked">üìÖ Meeting Booked</option>
                <option value="Meeting Held">‚úÖ Meeting Held</option>
            </select>
        </div>
        <div class="form-group"><label>Account *</label>
            <select id="activityAccount">
                <option value="">Select an account...</option>
                ${state.data.accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('')}
            </select>
        </div>
        <div class="form-group"><label>Contact</label>
            <select id="activityContact">
                <option value="">Select a contact (optional)...</option>
                ${state.data.contacts.map(c => `<option value="${c.id}">${c.name}${c.company ? ` - ${c.company}` : ''}</option>`).join('')}
            </select>
        </div>
        <div class="form-group"><label>Result / Outcome *</label><textarea id="activityResult" placeholder="What happened? What was discussed?"></textarea></div>
        <div class="form-group"><label>Next Steps</label><textarea id="activityNextSteps" placeholder="What needs to happen next?" style="min-height: 80px;"></textarea></div>
        <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveActivity()">Log Activity</button></div>
    </div></div>`;
}

function openLogActivityModalForAccount(accountName) {
    openLogActivityModal();
    setTimeout(() => {
        const accountSelect = document.getElementById('activityAccount');
        const account = state.data.accounts.find(a => a.name === accountName);
        if (account && accountSelect) accountSelect.value = account.id;
    }, 100);
}

function saveActivity() {
    const accountRecordId = document.getElementById('activityAccount').value;
    const result = document.getElementById('activityResult').value;
    if (!accountRecordId || !result) { alert('Please select an Account and enter Result'); return; }
    
    const account = state.data.accounts.find(a => a.id === accountRecordId);
    const accountName = account ? account.name : '';
    const activityType = document.getElementById('activityType').value;
    const now = new Date();
    
    const activityData = {
        'Activity Name': `${activityType} - ${accountName}`, 'Type': activityType,
        'Date': now.toISOString().split('T')[0], 'Activity Date/Time': now.toISOString(),
        'Account': accountName, 'Owner': state.currentUser.name, 'Result': result
    };
    
    const contactId = document.getElementById('activityContact').value;
    const nextSteps = document.getElementById('activityNextSteps').value;
    if (contactId) activityData['Contact'] = [contactId];
    if (nextSteps) activityData['Next Steps'] = nextSteps;
    logActivity(activityData);
}

function openDealDetailsModal(dealId) {
    const deal = state.data.deals.find(d => d.id === dealId);
    if (!deal) return;
    const isLeadership = state.currentUser.role === 'Leadership';
    document.getElementById('modalContainer').innerHTML = `<div class="modal active"><div class="modal-content"><div class="modal-header"><h2>üìä ${deal.name}</h2></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div style="background: var(--bg-light); padding: 16px; border-radius: 12px; text-align: center;"><div style="font-size: 28px; font-weight: 700; color: var(--primary);">$${deal.value.toLocaleString()}</div><div style="font-size: 13px; color: var(--text-gray);">Deal Value</div></div>
            <div style="background: var(--bg-light); padding: 16px; border-radius: 12px; text-align: center;"><span class="badge badge-${deal.tier.toLowerCase()}" style="font-size: 14px;">${deal.tier}</span><div style="font-size: 13px; color: var(--text-gray); margin-top: 8px;">Tier</div></div>
        </div>
        <div class="form-group"><label>Event Name</label><input type="text" value="${deal.eventName || 'Not set'}" disabled></div>
        <div class="form-group"><label>Owner</label><input type="text" value="${deal.owner}" disabled></div>
        <div class="form-group"><label>Current Stage</label>
            <select id="dealStageEdit">
                <option value="Qualified" ${deal.stage==='Qualified'?'selected':''}>Qualified</option>
                <option value="Proposal Sent" ${deal.stage==='Proposal Sent'?'selected':''}>Proposal Sent</option>
                <option value="Negotiation" ${deal.stage==='Negotiation'?'selected':''}>Negotiation</option>
                <option value="Closed Won" ${deal.stage==='Closed Won'?'selected':''}>Closed Won</option>
                <option value="Closed Lost" ${deal.stage==='Closed Lost'?'selected':''}>Closed Lost</option>
            </select>
        </div>
        <div class="modal-actions">
            ${isLeadership ? `<button class="btn btn-danger" onclick="deleteDeal('${dealId}')">üóëÔ∏è Delete</button>` : ''}
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="updateDealStage('${dealId}')">Update Stage</button>
        </div>
    </div></div>`;
}

async function updateDealStage(dealId, newStage) {
    if (!newStage) newStage = document.getElementById('dealStageEdit').value;
    try {
        await fetch(`https://api.airtable.com/v0/${state.baseId}/Deals/${dealId}`, {
            method: 'PATCH', headers: { 'Authorization': `Bearer ${state.apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ fields: { 'Stage': newStage } })
        });
        await loadDeals(); closeModal(); renderView('pipeline');
    } catch (error) { alert(`Error: ${error.message}`); }
}

// ============ VIEW RENDERING ============
function renderView(viewName) {
    destroyCharts();
    state.currentView = viewName;
    state.filterRep = null;
    state.filterMonth = null;
    document.getElementById('pageTitle').textContent = {
        'dashboard': 'Dashboard', 'pipeline': 'Pipeline', 'contacts': 'Contacts',
        'accounts': 'Accounts', 'activity': 'Activities', 'tasks': 'Tasks',
        'leadership': 'Analytics', 'team': 'Team Overview'
    }[viewName] || viewName;
    
    const views = { 'dashboard': renderDashboard, 'pipeline': renderPipeline, 'tasks': renderTasks, 'contacts': renderContacts, 'accounts': renderAccounts, 'activity': renderActivityView, 'leadership': renderLeadershipAnalytics, 'team': renderTeamOverview };
    if (views[viewName]) { views[viewName](); buildNavigation(); }
}

function renderDashboard() {
    if (state.currentUser.role === 'Leadership') { renderLeadershipDashboard(); return; }
    renderRepDashboard();
}

function renderRepDashboard() {
    const deals = getUserDeals();
    const targets = getKPITargets(state.currentUser.role);
    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    
    const userActivities = state.data.activities.filter(a => a.owner === state.currentUser.name);
    const todayActivities = userActivities.filter(a => a.date && a.date.split('T')[0] === todayISO);
    const todayTouchpoints = todayActivities.length;
    const todayNewLeads = state.data.contacts.filter(c => c.owner === state.currentUser.name && c.createdTime && c.createdTime.split('T')[0] === todayISO).length;
    const todayDiscoveryCalls = todayActivities.filter(a => a.type && a.type.toLowerCase().includes('call')).length;
    
    const monthClosedDeals = deals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const monthRevenue = monthClosedDeals.reduce((sum, d) => sum + d.value, 0);
    const revenuePercentOfMax = (monthRevenue / targets.monthlyRevenueMax) * 100;
    const eventsPercentOfMax = (monthClosedDeals.length / targets.monthlyEventsMax) * 100;
    
    const growthPlusCount = monthClosedDeals.filter(d => d.tier !== 'Starter').length;
    const qualityScore = monthClosedDeals.length > 0 ? (growthPlusCount / monthClosedDeals.length) * 100 : 0;
    
    const pipelineDeals = deals.filter(d => !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost'));
    
    // Stale deals
    const staleDeals = pipelineDeals.filter(d => {
        const lastActivity = userActivities.filter(a => a.account && d.name.toLowerCase().includes(a.account.toLowerCase())).sort((x,y) => new Date(y.date) - new Date(x.date))[0];
        if (!lastActivity) return true;
        return getDaysSince(lastActivity.date) >= 5;
    });
    
    const getStatusColor = (value, target) => value >= target ? 'var(--success)' : value >= target * 0.5 ? 'var(--warning)' : 'var(--danger)';
    const getStatusIcon = (value, target) => value >= target ? '‚úÖ' : value >= target * 0.5 ? '‚ö†Ô∏è' : '‚ùå';

    document.getElementById('contentArea').innerHTML = `
        ${renderNudges()}
        <div class="quick-actions">
            <button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï New Deal</button>
            <button class="btn btn-secondary btn-small" onclick="openLogActivityModal()">üìù Log Activity</button>
            <button class="btn btn-secondary btn-small" onclick="openAddContactModal()">üë§ Add Contact</button>
            <button class="btn btn-secondary btn-small" onclick="openAddAccountModal()">üè¢ Add Account</button>
        </div>
        
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìÖ Daily Scorecard - ${today.toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric'})}</h2></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;">
                <div class="kpi-card" style="border-left:5px solid ${getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin)};">
                    <div style="display:flex;justify-content:space-between;"><span class="kpi-label">Touchpoints Today</span><span style="font-size:24px;">${getStatusIcon(todayTouchpoints,targets.dailyTouchpointsMin)}</span></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin)};">${todayTouchpoints}</div>
                    <div style="font-size:13px;color:var(--text-gray);">Target: ${targets.dailyTouchpointsMin}-${targets.dailyTouchpointsMax}</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${Math.min((todayTouchpoints/targets.dailyTouchpointsMax)*100,100)}%;background:${getStatusColor(todayTouchpoints,targets.dailyTouchpointsMin)};"></div></div>
                </div>
                <div class="kpi-card" style="border-left:5px solid ${getStatusColor(todayNewLeads,3)};">
                    <div style="display:flex;justify-content:space-between;"><span class="kpi-label">New Leads Today</span><span style="font-size:24px;">${getStatusIcon(todayNewLeads,3)}</span></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayNewLeads,3)};">${todayNewLeads}</div>
                    <div style="font-size:13px;color:var(--text-gray);">Target: 3-5</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${Math.min((todayNewLeads/5)*100,100)}%;background:${getStatusColor(todayNewLeads,3)};"></div></div>
                </div>
                <div class="kpi-card" style="border-left:5px solid ${getStatusColor(todayDiscoveryCalls,targets.dailyDiscovery)};">
                    <div style="display:flex;justify-content:space-between;"><span class="kpi-label">Discovery Calls</span><span style="font-size:24px;">${getStatusIcon(todayDiscoveryCalls,targets.dailyDiscovery)}</span></div>
                    <div class="kpi-value" style="color:${getStatusColor(todayDiscoveryCalls,targets.dailyDiscovery)};">${todayDiscoveryCalls}</div>
                    <div style="font-size:13px;color:var(--text-gray);">Target: ${targets.dailyDiscovery}+</div>
                </div>
                <div class="kpi-card" style="border-left:5px solid ${staleDeals.length > 0 ? 'var(--warning)' : 'var(--success)'};">
                    <div style="display:flex;justify-content:space-between;"><span class="kpi-label">Deals Need Attention</span><span style="font-size:24px;">${staleDeals.length > 0 ? '‚ö†Ô∏è' : '‚úÖ'}</span></div>
                    <div class="kpi-value" style="color:${staleDeals.length > 0 ? 'var(--warning)' : 'var(--success)'};">${staleDeals.length}</div>
                    <div style="font-size:13px;color:var(--text-gray);">No activity in 5+ days</div>
                </div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üí∞ MONTHLY REVENUE</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">$${(monthRevenue/1000).toFixed(1)}K</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: $${(targets.monthlyRevenueMin/1000).toFixed(1)}K - $${(targets.monthlyRevenueMax/1000).toFixed(1)}K</div>
                <div style="background:rgba(255,255,255,0.2);height:10px;border-radius:5px;"><div style="width:${Math.min(revenuePercentOfMax,100)}%;height:100%;background:white;border-radius:5px;"></div></div>
                <div style="font-size:14px;font-weight:600;margin-top:10px;">${revenuePercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üéâ EVENTS CLOSED</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">${monthClosedDeals.length}</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: ${targets.monthlyEventsMin}-${targets.monthlyEventsMax} events</div>
                <div style="background:rgba(255,255,255,0.2);height:10px;border-radius:5px;"><div style="width:${Math.min(eventsPercentOfMax,100)}%;height:100%;background:white;border-radius:5px;"></div></div>
                <div style="font-size:14px;font-weight:600;margin-top:10px;">${eventsPercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üìä QUALITY SCORE</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">${qualityScore.toFixed(0)}%</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">${qualityScore >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} 70%+ Growth+ Required</div>
                <div style="background:rgba(255,255,255,0.2);height:10px;border-radius:5px;"><div style="width:${Math.min(qualityScore,100)}%;height:100%;background:white;border-radius:5px;"></div></div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:16px;opacity:0.9;">üíµ AVG DEAL SIZE</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">${monthClosedDeals.length > 0 ? '$' + Math.round(monthRevenue/monthClosedDeals.length).toLocaleString() : '$0'}</div>
                <div style="font-size:14px;opacity:0.9;">This month</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card"><h3>üìà Revenue Trend (6 Months)</h3><div class="chart-container"><canvas id="repRevenueTrendChart"></canvas></div></div>
            <div class="chart-card"><h3>ü•ß Revenue by Tier</h3><div class="chart-container"><canvas id="repRevenueByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üìä Events by Tier</h3><div class="chart-container"><canvas id="repEventsByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üí∞ Revenue by Pricing Type</h3><div class="chart-container"><canvas id="repRevenueByPricingChart"></canvas></div></div>
        </div>
    `;
    
    setTimeout(() => {
        renderRevenueTrendChart('repRevenueTrendChart', deals);
        renderRevenueByTierChart('repRevenueByTierChart', deals);
        renderEventsByTierChart('repEventsByTierChart', deals);
        renderRevenueByPricingChart('repRevenueByPricingChart', deals);
    }, 100);
}

// Leadership Dashboard - Team KPIs, Alerts, Sales Cards
function renderLeadershipDashboard() {
    const allDeals = state.data.deals;
    const allActivities = state.data.activities;
    const today = new Date();
    const todayISO = today.toISOString().split('T')[0];
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay());
    
    const todayActivities = allActivities.filter(a => a.date && a.date.split('T')[0] === todayISO);
    const weekActivities = allActivities.filter(a => a.date && new Date(a.date) >= weekStart);
    
    const monthClosedDeals = allDeals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const monthRevenue = monthClosedDeals.reduce((sum, d) => sum + d.value, 0);
    const revenuePercentOfMax = (monthRevenue / KPI_TARGETS.Team.monthlyRevenueMax) * 100;
    const eventsPercentOfMax = (monthClosedDeals.length / KPI_TARGETS.Team.monthlyEventsMax) * 100;
    
    const growthPlusDeals = monthClosedDeals.filter(d => d.tier !== 'Starter').length;
    const qualityScore = monthClosedDeals.length > 0 ? (growthPlusDeals / monthClosedDeals.length) * 100 : 0;
    
    const repCards = state.data.teamMembers.filter(m => m.role !== 'Leadership').map(member => {
        const memberDeals = allDeals.filter(d => d.owner === member.name);
        const memberMonthWon = memberDeals.filter(d => {
            if (!d.stage.toLowerCase().includes('won')) return false;
            const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
            return dealDate && dealDate >= monthStart;
        });
        const memberRevenue = memberMonthWon.reduce((sum, d) => sum + d.value, 0);
        const targets = getKPITargets(member.role);
        const attainment = (memberRevenue / targets.monthlyRevenueMax) * 100;
        const memberTouchpoints = todayActivities.filter(a => a.owner === member.name).length;
        
        let statusClass = 'rep-card-green', statusEmoji = 'üü¢';
        if (attainment < 70) { statusClass = 'rep-card-red'; statusEmoji = 'üî¥'; }
        else if (attainment < 100) { statusClass = 'rep-card-yellow'; statusEmoji = 'üü°'; }
        
        return { id: member.id, name: member.name, role: member.role, quota: targets.monthlyRevenueMax, revenue: memberRevenue, attainment, deals: memberMonthWon.length, touchpoints: memberTouchpoints, statusClass, statusEmoji, activePipeline: memberDeals.filter(d => !d.stage.toLowerCase().includes('won') && !d.stage.toLowerCase().includes('lost')).length };
    });
    
    const needsAttention = repCards.filter(r => r.attainment < 70);
    const onTrack = repCards.filter(r => r.attainment >= 100);

    document.getElementById('contentArea').innerHTML = `
        <div class="quick-actions">
            <button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï New Deal</button>
            <button class="btn btn-secondary btn-small" onclick="openLogActivityModal()">üìù Log Activity</button>
            <button class="btn btn-secondary btn-small" onclick="openAddContactModal()">üë§ Add Contact</button>
            <button class="btn btn-secondary btn-small" onclick="openAddAccountModal()">üè¢ Add Account</button>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px;">
            <div class="kpi-card" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üí∞ TEAM MONTHLY REVENUE</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">$${(monthRevenue/1000).toFixed(1)}K</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: $${KPI_TARGETS.Team.monthlyRevenueMin/1000}K - $${KPI_TARGETS.Team.monthlyRevenueMax/1000}K</div>
                <div style="background:rgba(255,255,255,0.2);height:10px;border-radius:5px;"><div style="width:${Math.min(revenuePercentOfMax,100)}%;height:100%;background:white;border-radius:5px;"></div></div>
                <div style="font-size:14px;font-weight:600;margin-top:10px;">${revenuePercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üéâ TEAM EVENTS CLOSED</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">${monthClosedDeals.length}</div>
                <div style="font-size:14px;opacity:0.9;margin-bottom:16px;">Target: ${KPI_TARGETS.Team.monthlyEventsMin}-${KPI_TARGETS.Team.monthlyEventsMax}</div>
                <div style="background:rgba(255,255,255,0.2);height:10px;border-radius:5px;"><div style="width:${Math.min(eventsPercentOfMax,100)}%;height:100%;background:white;border-radius:5px;"></div></div>
                <div style="font-size:14px;font-weight:600;margin-top:10px;">${eventsPercentOfMax.toFixed(0)}% of Max Target</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üìä QUALITY SCORE</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">${qualityScore.toFixed(0)}%</div>
                <div style="font-size:14px;opacity:0.9;">Growth+ Tier (70% Target)</div>
            </div>
            <div class="kpi-card" style="background:linear-gradient(135deg,#fa709a 0%,#fee140 100%);color:white;">
                <div style="font-size:13px;font-weight:600;margin-bottom:12px;opacity:0.9;">üî• TEAM ACTIVITY TODAY</div>
                <div style="font-size:44px;font-weight:800;margin-bottom:8px;">${todayActivities.length}</div>
                <div style="font-size:14px;opacity:0.9;">Touchpoints</div>
                <div style="font-size:13px;opacity:0.8;margin-top:8px;">Week: ${weekActivities.length}</div>
            </div>
        </div>
        
        ${needsAttention.length > 0 || onTrack.length > 0 ? `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìã KPI Alerts</h2></div>
            <div class="kpi-alerts">
                ${needsAttention.map(r => `<div class="kpi-alert-item needs-attention">üî¥ <strong>${r.name}</strong> at ${r.attainment.toFixed(0)}% - needs coaching</div>`).join('')}
                ${onTrack.map(r => `<div class="kpi-alert-item on-track">üü¢ <strong>${r.name}</strong> at ${r.attainment.toFixed(0)}% - exceeding!</div>`).join('')}
            </div>
        </div>
        ` : ''}

        <div class="card">
            <div class="card-header"><h2 class="card-title">üë• Sales Team Performance</h2><span style="font-size:13px;color:var(--text-gray);">Click for details</span></div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;">
                ${repCards.map(rep => `
                    <div class="kpi-card ${rep.statusClass}" onclick="openRepDetailsModal('${rep.id}')" style="cursor:pointer;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:16px;">
                            <div><div style="font-size:18px;font-weight:700;">${rep.statusEmoji} ${rep.name}</div><div style="font-size:13px;color:var(--text-gray);">${rep.role}</div></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:14px;">
                            <div><div style="font-size:13px;color:var(--text-gray);">This Month</div><div style="font-size:30px;font-weight:700;color:var(--primary);">$${(rep.revenue/1000).toFixed(1)}K</div></div>
                            <div style="text-align:right;"><div style="font-size:13px;color:var(--text-gray);">Today</div><div style="font-size:26px;font-weight:700;color:var(--primary);">${rep.touchpoints}</div><div style="font-size:11px;color:var(--text-gray);">touchpoints</div></div>
                        </div>
                        <div style="font-size:13px;color:var(--text-gray);margin-bottom:14px;">${rep.deals} deals ‚Ä¢ ${rep.activePipeline} in pipeline</div>
                        <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(rep.attainment,100)}%;background:${rep.attainment >= 100 ? 'var(--success)' : rep.attainment >= 70 ? 'var(--warning)' : 'var(--danger)'};"></div></div>
                        <div style="display:flex;justify-content:space-between;font-size:13px;margin-top:8px;"><span>Max: $${(rep.quota/1000).toFixed(0)}K</span><span style="font-weight:700;color:${rep.attainment >= 100 ? 'var(--success)' : rep.attainment >= 70 ? 'var(--warning)' : 'var(--danger)'};">${rep.attainment.toFixed(0)}%</span></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Leadership Analytics Tab - Charts, Floor Capacity
function renderLeadershipAnalytics() {
    const allDeals = state.data.deals;
    const today = new Date();
    const yearStart = new Date(today.getFullYear(), 0, 1);
    
    const yearDeals = allDeals.filter(d => { const dt = d.createdTime ? new Date(d.createdTime) : null; return dt && dt >= yearStart; });
    const floorDeals = yearDeals.filter(d => d.pricingType === 'Floor Price');
    const floorStarter = floorDeals.filter(d => d.tier === 'Starter').length;
    const floorGrowth = floorDeals.filter(d => d.tier === 'Growth').length;
    const floorPro = floorDeals.filter(d => d.tier === 'Pro').length;
    const floorEnterprise = floorDeals.filter(d => d.tier === 'Enterprise').length;
    const totalFloorUsed = floorStarter + floorGrowth + floorPro + floorEnterprise;
    const floorCapacity = { total: 10 };

    document.getElementById('contentArea').innerHTML = `
        <div class="charts-grid">
            <div class="chart-card"><h3>üìà Team Revenue Trend (6 Months)</h3><div class="chart-container"><canvas id="teamRevenueTrendChart"></canvas></div></div>
            <div class="chart-card"><h3>ü•ß Team Revenue by Tier</h3><div class="chart-container"><canvas id="teamRevenueByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üìä Team Events by Tier</h3><div class="chart-container"><canvas id="teamEventsByTierChart"></canvas></div></div>
            <div class="chart-card"><h3>üí∞ Team Revenue by Pricing</h3><div class="chart-container"><canvas id="teamRevenueByPricingChart"></canvas></div></div>
        </div>

        <div class="card">
            <div class="card-header"><h2 class="card-title">üö® Floor-Price Capacity (${today.getFullYear()})</h2></div>
            <div class="floor-tracker">
                <div class="capacity-circle"><div class="capacity-number">${totalFloorUsed}/${floorCapacity.total}</div><div class="capacity-label">events used</div></div>
                <div style="font-size:20px;font-weight:700;color:var(--primary);margin-bottom:20px;">${((totalFloorUsed/floorCapacity.total)*100).toFixed(0)}% Utilized</div>
                <p style="color:var(--text-gray);margin-bottom:24px;">Remaining: <strong>${floorCapacity.total - totalFloorUsed}</strong> floor-price events</p>
                <table>
                    <thead><tr><th>Tier</th><th>Max</th><th>Used</th><th>Left</th></tr></thead>
                    <tbody>
                        <tr style="${floorStarter >= 2 ? 'background:#fee2e2;' : ''}"><td><span class="badge badge-starter">Starter</span></td><td>2</td><td>${floorStarter}</td><td>${2 - floorStarter} ${floorStarter >= 2 ? '‚ö†Ô∏è' : ''}</td></tr>
                        <tr style="${floorGrowth >= 2 ? 'background:#fee2e2;' : ''}"><td><span class="badge badge-growth">Growth</span></td><td>2</td><td>${floorGrowth}</td><td>${2 - floorGrowth} ${floorGrowth >= 2 ? '‚ö†Ô∏è' : ''}</td></tr>
                        <tr style="${floorPro >= 3 ? 'background:#fee2e2;' : ''}"><td><span class="badge badge-pro">Pro</span></td><td>3</td><td>${floorPro}</td><td>${3 - floorPro} ${floorPro >= 3 ? '‚ö†Ô∏è' : ''}</td></tr>
                        <tr style="${floorEnterprise >= 3 ? 'background:#fee2e2;' : ''}"><td><span class="badge badge-enterprise">Enterprise</span></td><td>3</td><td>${floorEnterprise}</td><td>${3 - floorEnterprise} ${floorEnterprise >= 3 ? '‚ö†Ô∏è' : ''}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        renderRevenueTrendChart('teamRevenueTrendChart', allDeals, 'Team Revenue');
        renderRevenueByTierChart('teamRevenueByTierChart', allDeals);
        renderEventsByTierChart('teamEventsByTierChart', allDeals);
        renderRevenueByPricingChart('teamRevenueByPricingChart', allDeals);
    }, 100);
}

function openRepDetailsModal(memberId) {
    const member = state.data.teamMembers.find(m => m.id === memberId);
    if (!member) return;
    
    const today = new Date();
    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const todayISO = today.toISOString().split('T')[0];
    const targets = getKPITargets(member.role);
    
    const memberDeals = state.data.deals.filter(d => d.owner === member.name);
    const memberMonthWon = memberDeals.filter(d => {
        if (!d.stage.toLowerCase().includes('won')) return false;
        const dealDate = d.closeDate ? new Date(d.closeDate) : (d.createdTime ? new Date(d.createdTime) : null);
        return dealDate && dealDate >= monthStart;
    });
    
    const memberActivities = state.data.activities.filter(a => a.owner === member.name);
    const memberTodayActivities = memberActivities.filter(a => a.date && a.date.split('T')[0] === todayISO);
    const memberMonthActivities = memberActivities.filter(a => { const dt = a.date ? new Date(a.date) : null; return dt && dt >= monthStart; });
    
    const memberRevenue = memberMonthWon.reduce((sum, d) => sum + d.value, 0);
    const revenuePercentOfMax = (memberRevenue / targets.monthlyRevenueMax) * 100;
    
    const getStatusColor = (value, target) => value >= target ? 'var(--success)' : value >= target * 0.5 ? 'var(--warning)' : 'var(--danger)';
    const getStatusIcon = (value, target) => value >= target ? '‚úÖ' : value >= target * 0.5 ? '‚ö†Ô∏è' : '‚ùå';
    
    document.getElementById('modalContainer').innerHTML = `
        <div class="modal active"><div class="modal-content wide">
            <div class="modal-header"><h2>${member.name} - Performance</h2></div>
            <div style="padding:10px 0;">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">üìÖ Today's KPIs</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:28px;">
                    <div class="stat-card clickable-stat" onclick="state.filterRep='${member.name}';closeModal();renderView('activity');">
                        <div style="font-size:12px;color:var(--text-gray);margin-bottom:8px;">Touchpoints</div>
                        <div style="font-size:34px;font-weight:700;color:${getStatusColor(memberTodayActivities.length,targets.dailyTouchpointsMin)};">${memberTodayActivities.length}</div>
                        <div style="font-size:11px;color:var(--text-gray);">Target: ${targets.dailyTouchpointsMin}-${targets.dailyTouchpointsMax} ${getStatusIcon(memberTodayActivities.length,targets.dailyTouchpointsMin)}</div>
                        <div style="font-size:11px;color:var(--primary);margin-top:6px;">Click to view ‚Üí</div>
                    </div>
                    <div class="stat-card clickable-stat" onclick="state.filterRep='${member.name}';state.filterMonth=true;closeModal();renderView('activity');">
                        <div style="font-size:12px;color:var(--text-gray);margin-bottom:8px;">Month Activities</div>
                        <div style="font-size:34px;font-weight:700;color:var(--primary);">${memberMonthActivities.length}</div>
                        <div style="font-size:11px;color:var(--primary);margin-top:6px;">Click to view ‚Üí</div>
                    </div>
                </div>
                
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">üí∞ Monthly Revenue</h3>
                <div style="background:var(--bg-light);padding:24px;border-radius:14px;margin-bottom:28px;">
                    <div style="display:flex;justify-content:space-between;align-items:end;margin-bottom:16px;">
                        <div><div style="font-size:13px;color:var(--text-gray);margin-bottom:4px;">Revenue</div><div style="font-size:40px;font-weight:800;color:var(--primary);">$${(memberRevenue/1000).toFixed(1)}K</div></div>
                        <div style="text-align:right;"><div style="font-size:13px;color:var(--text-gray);">Target</div><div style="font-size:18px;font-weight:600;color:var(--text-gray);">$${(targets.monthlyRevenueMin/1000).toFixed(1)}K - $${(targets.monthlyRevenueMax/1000).toFixed(1)}K</div></div>
                    </div>
                    <div class="progress-bar" style="height:14px;"><div class="progress-fill" style="width:${Math.min(revenuePercentOfMax,100)}%;background:var(--success);"></div></div>
                    <div style="display:flex;justify-content:space-between;margin-top:12px;"><span style="font-size:14px;color:var(--text-gray);">${memberMonthWon.length} events</span><span style="font-size:16px;font-weight:700;color:var(--success);">${revenuePercentOfMax.toFixed(0)}% of Max</span></div>
                </div>
            </div>
            <div class="modal-actions"><button class="btn btn-secondary" onclick="closeModal()">Close</button></div>
        </div></div>
    `;
}

function renderTeamOverview() {
    const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    const teamPerformance = state.data.teamMembers.filter(m => m.role !== 'Leadership').map(member => {
        const memberDeals = state.data.deals.filter(d => d.owner === member.name);
        const monthWon = memberDeals.filter(d => {
            if (!d.stage.toLowerCase().includes('won')) return false;
            const dt = d.closeDate ? new Date(d.closeDate) : null;
            return dt && dt >= monthStart;
        });
        const revenue = monthWon.reduce((sum, d) => sum + d.value, 0);
        const targets = getKPITargets(member.role);
        const attainment = (revenue / targets.monthlyRevenueMax) * 100;
        return { name: member.name, role: member.role, quota: targets.monthlyRevenueMax, revenue, attainment, won: monthWon.length };
    });
    
    document.getElementById('contentArea').innerHTML = `
        <div class="card">
            <div class="card-header"><h2 class="card-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Team Performance</h2></div>
            <table>
                <thead><tr><th>Name</th><th>Role</th><th>Max Target</th><th>Revenue</th><th>% of Max</th><th>Wins</th></tr></thead>
                <tbody>
                    ${teamPerformance.map(m => `
                        <tr>
                            <td><strong>${m.name}</strong></td><td>${m.role}</td><td>$${m.quota.toLocaleString()}</td><td>$${m.revenue.toLocaleString()}</td>
                            <td><span class="badge ${m.attainment >= 100 ? 'badge-success' : m.attainment >= 70 ? 'badge-warning' : 'badge-danger'}">${m.attainment.toFixed(0)}%</span></td>
                            <td>${m.won}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function renderPipeline() {
    const deals = getUserDeals();
    const stages = ['Qualified', 'Proposal Sent', 'Negotiation', 'Closed Won'];
    const isLeadership = state.currentUser.role === 'Leadership';
    const userActivities = state.data.activities.filter(a => isLeadership || a.owner === state.currentUser.name);
    
    document.getElementById('contentArea').innerHTML = `
        <div class="quick-actions" style="margin-bottom:20px;">
            <button class="btn btn-primary btn-small" onclick="openAddDealModal()">‚ûï Add New Deal</button>
        </div>
        <div class="kanban-board">
            ${stages.map(stage => {
                const stageDeals = deals.filter(d => d.stage === stage);
                return `
                    <div class="kanban-column" data-stage="${stage}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
                        <div class="kanban-header"><span>${stage}</span><span class="kanban-count">${stageDeals.length}</span></div>
                        ${stageDeals.length === 0 ? '<p style="color:var(--text-gray);text-align:center;padding:30px;font-size:14px;">No deals</p>' : stageDeals.map(deal => {
                            const lastActivity = userActivities.filter(a => a.account && deal.name.toLowerCase().includes(a.account.toLowerCase())).sort((x,y) => new Date(y.date) - new Date(x.date))[0];
                            const daysSinceActivity = lastActivity ? getDaysSince(lastActivity.date) : 999;
                            const isStale = daysSinceActivity >= 5 && !stage.toLowerCase().includes('won');
                            
                            return `<div class="kanban-card ${isStale ? 'stale' : ''}" draggable="true" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)" onclick="openDealDetailsModal('${deal.id}')" data-deal-id="${deal.id}">
                                <div style="display:flex;justify-content:space-between;">
                                    <div class="kanban-card-title">${deal.name}</div>
                                    ${isLeadership ? `<button class="btn btn-icon btn-danger" onclick="event.stopPropagation();deleteDeal('${deal.id}')" style="padding:4px 8px;font-size:12px;">üóëÔ∏è</button>` : ''}
                                </div>
                                <div class="kanban-card-value">$${deal.value.toLocaleString()}</div>
                                <span class="badge badge-${deal.tier.toLowerCase()}">${deal.tier}</span>
                                <div class="kanban-card-meta">Owner: ${deal.owner}</div>
                                ${isStale ? `<div class="stale-indicator">‚ö†Ô∏è ${daysSinceActivity}+ days idle</div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

let draggedDealId = null;
function handleDragStart(event) { draggedDealId = event.target.getAttribute('data-deal-id'); event.target.style.opacity = '0.5'; }
function handleDragEnd(event) { event.target.style.opacity = '1'; }
function handleDragOver(event) { event.preventDefault(); }
function handleDrop(event) {
    event.preventDefault();
    const column = event.target.closest('.kanban-column');
    const newStage = column?.getAttribute('data-stage');
    if (draggedDealId && newStage) updateDealStage(draggedDealId, newStage);
    draggedDealId = null;
}

function renderTasks() {
    document.getElementById('contentArea').innerHTML = `<div class="card"><div class="card-header"><h2 class="card-title">‚úÖ Tasks</h2></div><p style="text-align:center;padding:60px;color:var(--text-gray);font-size:16px;">Task management coming in Milestone 4!</p></div>`;
}

function renderContacts() {
    const contacts = state.data.contacts;
    document.getElementById('contentArea').innerHTML = `
        <div class="quick-actions" style="margin-bottom:20px;">
            <button class="btn btn-primary btn-small" onclick="openAddContactModal()">‚ûï Add New Contact</button>
        </div>
        <div class="cards-grid">
            ${contacts.length === 0 ? '<div class="card"><p style="text-align:center;padding:60px;color:var(--text-gray);">No contacts yet.</p></div>' : contacts.map(c => `
                <div class="profile-card" onclick="openContactDetailModal('${c.id}')">
                    <div class="profile-card-header" style="padding:20px;">
                        <div style="display:flex;align-items:center;gap:16px;">
                            <div class="profile-card-avatar" style="width:50px;height:50px;font-size:22px;margin-bottom:0;">üë§</div>
                            <div><div class="profile-card-name" style="font-size:17px;">${c.name}</div><div class="profile-card-subtitle" style="font-size:13px;">${c.role || 'No role'}${c.company ? ` at ${c.company}` : ''}</div></div>
                        </div>
                    </div>
                    <div class="profile-card-body" style="padding:16px;">
                        <div style="font-size:14px;color:var(--text-gray);margin-bottom:8px;">üìß ${c.email || 'No email'}</div>
                        <div style="font-size:14px;color:var(--text-gray);">üìû ${c.phone || 'No phone'}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderAccounts() {
    const accounts = state.data.accounts;
    document.getElementById('contentArea').innerHTML = `
        <div class="quick-actions" style="margin-bottom:20px;">
            <button class="btn btn-primary btn-small" onclick="openAddAccountModal()">‚ûï Add New Account</button>
        </div>
        <div class="cards-grid">
            ${accounts.length === 0 ? '<div class="card"><p style="text-align:center;padding:60px;color:var(--text-gray);">No accounts yet.</p></div>' : accounts.map(a => {
                const contactCount = state.data.contacts.filter(c => c.accountId === a.id || c.company === a.name).length;
                const dealCount = state.data.deals.filter(d => d.name.toLowerCase().includes(a.name.toLowerCase())).length;
                return `
                <div class="profile-card" onclick="openAccountDetailModal('${a.id}')">
                    <div class="profile-card-header" style="padding:20px;background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);">
                        <div style="display:flex;align-items:center;gap:16px;">
                            <div class="profile-card-avatar" style="width:50px;height:50px;font-size:22px;margin-bottom:0;">üè¢</div>
                            <div><div class="profile-card-name" style="font-size:17px;">${a.name}</div><div class="profile-card-subtitle" style="font-size:13px;">${a.industry || 'No industry'}</div></div>
                        </div>
                    </div>
                    <div class="profile-card-body" style="padding:16px;">
                        <div style="display:flex;justify-content:space-around;text-align:center;">
                            <div><div style="font-size:22px;font-weight:700;color:var(--primary);">${contactCount}</div><div style="font-size:12px;color:var(--text-gray);">Contacts</div></div>
                            <div><div style="font-size:22px;font-weight:700;color:var(--primary);">${dealCount}</div><div style="font-size:12px;color:var(--text-gray);">Deals</div></div>
                        </div>
                        <div style="margin-top:12px;font-size:13px;color:var(--text-gray);">Owner: ${a.owner || 'Unassigned'}</div>
                    </div>
                </div>
            `}).join('')}
        </div>
    `;
}

function renderActivityView() {
    let activities = state.data.activities;
    const isLeadership = state.currentUser.role === 'Leadership';
    
    if (state.filterRep) {
        activities = activities.filter(a => a.owner === state.filterRep);
    } else if (!isLeadership) {
        activities = activities.filter(a => a.owner === state.currentUser.name);
    }
    
    if (state.filterMonth) {
        const monthStart = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
        activities = activities.filter(a => { const dt = a.date ? new Date(a.date) : null; return dt && dt >= monthStart; });
    }
    
    activities = activities.sort((a, b) => new Date(b.date || b.createdTime) - new Date(a.date || a.createdTime));
    
    const filterInfo = state.filterRep ? `
        <div style="background:var(--bg-light);padding:16px 20px;border-radius:12px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
            <span style="font-weight:600;color:var(--primary);">üìä Showing: ${state.filterRep} ${state.filterMonth ? '(This Month)' : '(All Time)'}</span>
            <button class="btn btn-secondary btn-small" onclick="state.filterRep=null;state.filterMonth=null;renderView('activity');">‚úï Clear Filter</button>
        </div>
    ` : '';
    
    document.getElementById('contentArea').innerHTML = `
        <div class="quick-actions" style="margin-bottom:20px;">
            <button class="btn btn-primary btn-small" onclick="openLogActivityModal()">üìù Log New Activity</button>
        </div>
        ${filterInfo}
        <div class="card">
            <div class="card-header"><h2 class="card-title">üìù Activity Log</h2><span style="font-size:14px;color:var(--text-gray);">${activities.length} activities</span></div>
            <table>
                <thead><tr><th>Date</th><th>Type</th><th>Account</th><th>Owner</th><th>Result</th>${isLeadership ? '<th>Actions</th>' : ''}</tr></thead>
                <tbody>
                    ${activities.length === 0 ? `<tr><td colspan="${isLeadership ? 6 : 5}" style="text-align:center;padding:60px;color:var(--text-gray);">No activities.</td></tr>` : activities.slice(0, 50).map(a => `
                        <tr>
                            <td style="white-space:nowrap;">${formatDateShort(a.date)}</td>
                            <td><span class="badge" style="background:var(--primary);color:white;">${a.type}</span></td>
                            <td><strong>${a.account || '-'}</strong></td>
                            <td>${a.owner}</td>
                            <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${a.result || '-'}</td>
                            ${isLeadership ? `<td><button class="btn btn-icon btn-danger" onclick="deleteActivity('${a.id}')" style="padding:4px 8px;font-size:12px;">üóëÔ∏è</button></td>` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            ${activities.length > 50 ? `<p style="text-align:center;padding:20px;color:var(--text-gray);">Showing first 50 of ${activities.length}</p>` : ''}
        </div>
    `;
}

window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
